# 钱包调试和购买按钮修复

## 问题描述

在应用中发现以下购买按钮相关问题：

1. **钱包连接状态未正确同步**: 连接钱包后，购买按钮状态有时不会自动更新。
2. **多个钱包状态源不一致**: `walletState`对象、`localStorage`和全局变量之间的状态不一致。
3. **多处函数逻辑冲突**: `wallet.js`和`detail.html`中的函数存在命名和逻辑冲突。
4. **事件监听不完整**: 部分钱包事件未被正确监听和处理。

## 修复方案

创建了新的调试脚本`wallet_debug.js`解决上述问题：

1. 提供统一的钱包状态检测函数，检查多个可能的钱包状态来源
2. 实现全局购买按钮状态更新函数，确保按钮状态与钱包连接状态同步
3. 保存和恢复按钮原始文本，避免按钮文字被永久替换
4. 监听所有可能的钱包事件，确保状态变化及时同步

## 文件说明

- **wallet_debug.js**: 主要修复脚本，负责检测钱包状态和更新按钮
- **deploy_wallet_debug.sh**: 自动部署脚本，用于将修复发布到服务器

## 部署方法

### 方法一：自动部署

使用提供的部署脚本即可完成全部部署：

```bash
./deploy_wallet_debug.sh
```

脚本会自动完成:
1. 将JS文件上传到服务器
2. 在base.html中添加脚本引用
3. 验证部署是否成功

### 方法二：手动部署

1. 将`wallet_debug.js`上传到服务器的`/var/www/html/app/static/js/`目录

```bash
scp -i vincent.pem app/static/js/wallet_debug.js root@47.236.39.134:/var/www/html/app/static/js/
```

2. 编辑服务器上的`base.html`，在wallet.js和wallet_fix.js引用之后添加：

```html
<script src="{{ url_for('static', filename='js/wallet_debug.js') }}"></script>
```

## 验证修复

1. 打开网站并打开浏览器控制台
2. 连接或断开钱包连接
3. 观察控制台输出日志和购买按钮状态变化
4. 确认按钮在连接钱包后是否变为可点击状态

## 故障排除

如果仍然存在问题，请检查以下内容：

1. **脚本未加载**: 检查控制台是否显示"钱包调试脚本已加载"的日志
2. **加载顺序问题**: 确保`wallet_debug.js`在`wallet.js`和`wallet_fix.js`之后加载
3. **缓存问题**: 尝试强制刷新浏览器缓存(Ctrl+F5)
4. **钱包类型兼容性**: 检查控制台是否有与特定钱包相关的错误

## 修复原理

1. **多源检测**：同时检查walletState对象、全局变量和localStorage中的钱包信息
2. **状态同步**：确保所有状态源保持一致
3. **事件监听**：监听多种钱包事件，确保捕获所有可能的状态变化
4. **按钮状态保护**：保存原始按钮状态，避免被错误覆盖
5. **定期检查**：每5秒自动检查一次状态，确保UI与钱包状态同步 