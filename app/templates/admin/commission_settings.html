<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½£é‡‘è®¾ç½®ç®¡ç† - RWA-HUBåå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for("static", filename="fonts/fontawesome/css/all.min.css") }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¼</text></svg>">
<style>
    body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        padding: 20px;
        background-color: #f8f9fc;
    }
    .card {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .card-header {
        background-color: #fff;
        border-bottom: 1px solid #e3e6f0;
        padding: 15px 20px;
    }
    .card-body {
        padding: 20px;
    }
    .border-left-primary {
        border-left: 4px solid #4e73df;
    }
    .border-left-success {
        border-left: 4px solid #1cc88a;
    }
    .border-left-warning {
        border-left: 4px solid #f6c23e;
    }
    .text-primary {
        color: #4e73df !important;
    }
    .text-success {
        color: #1cc88a !important;
    }
    .text-warning {
        color: #f6c23e !important;
    }
    .info-panel {
        background-color: #f8f9fc;
        border-left: 4px solid #36b9cc;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
</style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3 mb-2 text-gray-800">ä½£é‡‘è®¾ç½®ç®¡ç†</h1>
                <p class="mb-4">ç®¡ç†å¹³å°å…¨å±€ä½£é‡‘è®¾ç½®å’Œä¸åŒèµ„äº§ç±»å‹çš„ä½£é‡‘è®¾ç½®</p>
                
                <!-- ä½£é‡‘è®¾ç½®è¯´æ˜ -->
                <div class="info-panel mb-4">
                    <h5><i class="fas fa-info-circle text-info"></i> ä½£é‡‘è®¾ç½®è¯´æ˜</h5>
                    <p>RWA-HUBå¹³å°çš„ä½£é‡‘æ”¶è´¹ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p>
                    <ul>
                        <li><strong>ä¸Šé“¾ä½£é‡‘</strong>ï¼šå½“èµ„äº§æˆåŠŸä¸Šé“¾æ—¶æ”¶å–ï¼Œåœ¨æ­¤é¡µé¢é…ç½®ã€‚é€šå¸¸è®¾ä¸ºè¾ƒä½æ¯”ä¾‹ï¼ˆ0.01%ï¼‰</li>
                        <li><strong>äº¤æ˜“ä½£é‡‘</strong>ï¼šèµ„äº§äº¤æ˜“è¿‡ç¨‹ä¸­æ”¶å–ï¼Œç”±ç³»ç»Ÿåç«¯å¤„ç†ã€‚åŒ…æ‹¬ä»¥ä¸‹è´¹ç‡ï¼š
                            <ul>
                                <li>æ ‡å‡†è´¹ç‡ï¼š3.5%</li>
                                <li>å¤§é¢äº¤æ˜“ä¼˜æƒ è´¹ç‡ï¼š2.5%ï¼ˆäº¤æ˜“é‡‘é¢â‰¥100,000 USDCï¼‰</li>
                                <li>è‡ªæŒäº¤æ˜“ä¼˜æƒ è´¹ç‡ï¼š0.1%ï¼ˆè´­ä¹°è‡ªå·±åˆ›å»ºçš„èµ„äº§ï¼‰</li>
                            </ul>
                        </li>
                    </ul>
                    <p><strong>æ³¨æ„</strong>ï¼šæœ¬é¡µé¢è®¾ç½®çš„æ˜¯ä¸Šé“¾ä½£é‡‘ï¼Œä¿®æ”¹åå°†ç«‹å³åº”ç”¨äºæ–°çš„ä¸Šé“¾èµ„äº§ã€‚</p>
                </div>
            
                <!-- å…¨å±€ä½£é‡‘è®¾ç½® -->
                <div class="card border-left-primary mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="m-0 font-weight-bold text-primary">å…¨å±€ä½£é‡‘è®¾ç½®</h5>
                        <button id="btn-add-global" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#commissionModal">
                            <i class="fa fa-plus"></i> æ·»åŠ å…¨å±€è®¾ç½®
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ä½£é‡‘æ¯”ä¾‹(%)</th>
                                        <th>æœ€ä½é‡‘é¢</th>
                                        <th>æœ€é«˜é‡‘é¢</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºäºº</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="global-settings-tbody">
                                    <!-- JSå¡«å……æ•°æ® -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- èµ„äº§ç±»å‹ä½£é‡‘è®¾ç½® -->
                <div class="card border-left-success">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="m-0 font-weight-bold text-success">èµ„äº§ç±»å‹ä½£é‡‘è®¾ç½®</h5>
                        <button id="btn-add-type" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#commissionModal">
                            <i class="fa fa-plus"></i> æ·»åŠ èµ„äº§ç±»å‹è®¾ç½®
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i> èµ„äº§ç±»å‹è¯´æ˜ï¼š
                            <ul class="mb-0">
                                <li><strong>10</strong>: ä¸åŠ¨äº§ - å½“å‰é…ç½®ï¼š0.01%ï¼Œæœ€ä½100ï¼Œæœ€é«˜2,000,000</li>
                                <li><strong>20</strong>: ç±»ä¸åŠ¨äº§ - å½“å‰é…ç½®ï¼š0.01%ï¼Œæœ€ä½100ï¼Œæœ€é«˜3,000,000</li>
                                <li><strong>30</strong>: å·¥ä¸šåœ°äº§</li>
                                <li><strong>40</strong>: åœŸåœ°èµ„äº§</li>
                                <li><strong>50</strong>: è¯åˆ¸èµ„äº§</li>
                                <li><strong>60</strong>: è‰ºæœ¯å“</li>
                                <li><strong>70</strong>: æ”¶è—å“</li>
                                <li><strong>99</strong>: å…¶ä»–</li>
                            </ul>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>èµ„äº§ç±»å‹ID</th>
                                        <th>ä½£é‡‘æ¯”ä¾‹(%)</th>
                                        <th>æœ€ä½é‡‘é¢</th>
                                        <th>æœ€é«˜é‡‘é¢</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºäºº</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="type-settings-tbody">
                                    <!-- JSå¡«å……æ•°æ® -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ä½£é‡‘è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade" id="commissionModal" tabindex="-1" aria-labelledby="commissionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="commissionModalLabel">æ·»åŠ ä½£é‡‘è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="commission-form">
                        <input type="hidden" id="commission-id">
                        <div class="mb-3" id="asset-type-container">
                            <label for="asset-type-id" class="form-label">èµ„äº§ç±»å‹ID</label>
                            <select class="form-select" id="asset-type-id">
                                <option value="">å…¨å±€è®¾ç½®</option>
                                <!-- JSå¡«å……èµ„äº§ç±»å‹é€‰é¡¹ -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="commission-rate" class="form-label">ä½£é‡‘æ¯”ä¾‹ (%)</label>
                            <input type="number" class="form-control" id="commission-rate" required min="0" max="100" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="min-amount" class="form-label">æœ€ä½é‡‘é¢</label>
                            <input type="number" class="form-control" id="min-amount" min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="max-amount" class="form-label">æœ€é«˜é‡‘é¢</label>
                            <input type="number" class="form-control" id="max-amount" min="0" step="0.01">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is-active" checked>
                            <label class="form-check-label" for="is-active">å¯ç”¨</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="btn-save-commission">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        $(document).ready(function() {
            // è·å–ä½£é‡‘è®¾ç½®
            loadCommissionSettings();
            
            // è·å–èµ„äº§ç±»å‹åˆ—è¡¨
            loadAssetTypes();
            
            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $("#btn-add-global").click(() => openCommissionModal(null, true));
            $("#btn-add-type").click(() => openCommissionModal(null, false));
            $("#btn-save-commission").click(saveCommissionSetting);
        });
        
        // åŠ è½½ä½£é‡‘è®¾ç½®
        function loadCommissionSettings() {
            fetch('/api/admin/v2/commission-settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderCommissionSettings(data.data);
                    } else {
                        alert('åŠ è½½ä½£é‡‘è®¾ç½®å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ä½£é‡‘è®¾ç½®å¤±è´¥:', error);
                    alert('åŠ è½½ä½£é‡‘è®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }
        
        // åŠ è½½èµ„äº§ç±»å‹
        function loadAssetTypes() {
            fetch('/api/asset-types')
                .then(response => response.json())
                .then(data => {
                    const select = $("#asset-type-id");
                    select.empty();
                    select.append('<option value="">å…¨å±€è®¾ç½®</option>');
                    
                    if (data.success && data.data) {
                        data.data.forEach(type => {
                            select.append(`<option value="${type.id}">${type.name} (ID: ${type.id})</option>`);
                        });
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½èµ„äº§ç±»å‹å¤±è´¥:', error);
                });
        }
        
        // æ¸²æŸ“ä½£é‡‘è®¾ç½®
        function renderCommissionSettings(data) {
            // æ¸²æŸ“å…¨å±€è®¾ç½®
            const globalTbody = $("#global-settings-tbody");
            globalTbody.empty();
            
            if (data.global.length === 0) {
                globalTbody.append('<tr><td colspan="8" class="text-center">æš‚æ— å…¨å±€ä½£é‡‘è®¾ç½®</td></tr>');
            } else {
                data.global.forEach(setting => {
                    globalTbody.append(`
                        <tr>
                            <td>${setting.id}</td>
                            <td>${setting.commission_rate}%</td>
                            <td>${setting.min_amount || '-'}</td>
                            <td>${setting.max_amount || '-'}</td>
                            <td>${setting.is_active ? '<span class="badge bg-success">å¯ç”¨</span>' : '<span class="badge bg-secondary">ç¦ç”¨</span>'}</td>
                            <td title="${setting.created_by}">${truncateAddress(setting.created_by)}</td>
                            <td>${formatDateTime(setting.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-edit" data-id="${setting.id}" data-type="global">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-delete" data-id="${setting.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }
            
            // æ¸²æŸ“èµ„äº§ç±»å‹è®¾ç½®
            const typeTbody = $("#type-settings-tbody");
            typeTbody.empty();
            
            if (data.asset_types.length === 0) {
                typeTbody.append('<tr><td colspan="9" class="text-center">æš‚æ— èµ„äº§ç±»å‹ä½£é‡‘è®¾ç½®</td></tr>');
            } else {
                data.asset_types.forEach(setting => {
                    typeTbody.append(`
                        <tr>
                            <td>${setting.id}</td>
                            <td>${setting.asset_type_id}</td>
                            <td>${setting.commission_rate}%</td>
                            <td>${setting.min_amount || '-'}</td>
                            <td>${setting.max_amount || '-'}</td>
                            <td>${setting.is_active ? '<span class="badge bg-success">å¯ç”¨</span>' : '<span class="badge bg-secondary">ç¦ç”¨</span>'}</td>
                            <td title="${setting.created_by}">${truncateAddress(setting.created_by)}</td>
                            <td>${formatDateTime(setting.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-edit" data-id="${setting.id}" data-type="type">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-delete" data-id="${setting.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }
            
            // æ·»åŠ ç¼–è¾‘æŒ‰é’®äº‹ä»¶
            $(".btn-edit").click(function() {
                const id = $(this).data('id');
                const type = $(this).data('type');
                const setting = type === 'global' 
                    ? data.global.find(s => s.id === id)
                    : data.asset_types.find(s => s.id === id);
                
                if (setting) {
                    openCommissionModal(setting, type === 'global');
                }
            });
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
            $(".btn-delete").click(function() {
                const id = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä½£é‡‘è®¾ç½®å—ï¼Ÿ')) {
                    deleteCommissionSetting(id);
                }
            });
        }
        
        // æ‰“å¼€ä½£é‡‘è®¾ç½®æ¨¡æ€æ¡†
        function openCommissionModal(setting = null, isGlobal = true) {
            const modal = $("#commissionModal");
            const modalTitle = $("#commissionModalLabel");
            
            // é‡ç½®è¡¨å•
            $("#commission-form")[0].reset();
            $("#commission-id").val('');
            
            // æ§åˆ¶èµ„äº§ç±»å‹é€‰æ‹©å™¨æ˜¾ç¤º
            $("#asset-type-container").toggle(!isGlobal);
            
            if (setting) {
                modalTitle.text('ç¼–è¾‘ä½£é‡‘è®¾ç½®');
                $("#commission-id").val(setting.id);
                $("#asset-type-id").val(setting.asset_type_id || '');
                $("#commission-rate").val(setting.commission_rate);
                $("#min-amount").val(setting.min_amount || '');
                $("#max-amount").val(setting.max_amount || '');
                $("#is-active").prop('checked', setting.is_active);
            } else {
                modalTitle.text(isGlobal ? 'æ·»åŠ å…¨å±€ä½£é‡‘è®¾ç½®' : 'æ·»åŠ èµ„äº§ç±»å‹ä½£é‡‘è®¾ç½®');
                $("#asset-type-id").val(isGlobal ? '' : null);
            }
            
            // æ‰“å¼€æ¨¡æ€æ¡†
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // ä¿å­˜ä½£é‡‘è®¾ç½®
        function saveCommissionSetting() {
            const id = $("#commission-id").val();
            const assetTypeId = $("#asset-type-id").val() || null;
            const commissionRate = parseFloat($("#commission-rate").val());
            const minAmount = $("#min-amount").val() ? parseFloat($("#min-amount").val()) : null;
            const maxAmount = $("#max-amount").val() ? parseFloat($("#max-amount").val()) : null;
            const isActive = $("#is-active").is(':checked');
            
            if (isNaN(commissionRate) || commissionRate < 0 || commissionRate > 100) {
                alert('ä½£é‡‘æ¯”ä¾‹å¿…é¡»æ˜¯0-100ä¹‹é—´çš„æ•°å­—');
                return;
            }
            
            const data = {
                asset_type_id: assetTypeId,
                commission_rate: commissionRate,
                min_amount: minAmount,
                max_amount: maxAmount,
                is_active: isActive
            };
            
            let url = '/api/admin/v2/commission-settings';
            let method = 'POST';
            
            if (id) {
                url += `/${id}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(id ? 'ä½£é‡‘è®¾ç½®æ›´æ–°æˆåŠŸ' : 'ä½£é‡‘è®¾ç½®åˆ›å»ºæˆåŠŸ');
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('commissionModal'));
                    modal.hide();
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadCommissionSettings();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜ä½£é‡‘è®¾ç½®å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }
        
        // åˆ é™¤ä½£é‡‘è®¾ç½®
        function deleteCommissionSetting(id) {
            fetch(`/api/admin/v2/commission-settings/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ä½£é‡‘è®¾ç½®åˆ é™¤æˆåŠŸ');
                    loadCommissionSettings();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤ä½£é‡‘è®¾ç½®å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }
        
        // è¾…åŠ©å‡½æ•°: æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // è¾…åŠ©å‡½æ•°: æˆªæ–­åœ°å€
        function truncateAddress(address) {
            if (!address) return '-';
            if (address.length <= 13) return address;
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }
    </script>
</body>
</html> 