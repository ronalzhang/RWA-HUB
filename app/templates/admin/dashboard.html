<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ËµÑ‰∫ßÁÆ°ÁêÜÂêéÂè∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ê∑ªÂä†jQueryÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- ÊõøÊç¢‰∏∫Êñ∞ÁöÑFontAwesome CDN -->
    <link rel="stylesheet" href="{{ url_for("static", filename="fonts/fontawesome/css/all.min.css") }}">
    <!-- Ê∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑfavicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíº</text></svg>">
<style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding-top: 56px; /* ‰∏∫Âõ∫ÂÆöÂØºËà™Ê†èÁïôÂá∫Á©∫Èó¥ */
            background-color: #f8f9fc;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e3e6f0;
            padding: 15px 20px;
        }
        .card-body {
            padding: 20px;
        }
        .border-left-primary {
            border-left: 4px solid #4e73df;
        }
        .border-left-success {
            border-left: 4px solid #1cc88a;
        }
        .border-left-info {
            border-left: 4px solid #36b9cc;
        }
        .text-primary {
            color: #4e73df !important;
        }
        .text-success {
            color: #1cc88a !important;
        }
        .text-info {
            color: #36b9cc !important;
        }
        .font-weight-bold {
            font-weight: bold !important;
        }
        .stats-card {
            height: 100%;
            padding: 15px;
        }
        .page-container {
            padding: 20px;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .navbar-nav .nav-link.active {
            font-weight: bold;
            color: #4e73df;
        }
</style>
</head>
<body>
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-building me-2"></i>RWA-HUBÁÆ°ÁêÜÁ≥ªÁªü
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>‰ª™Ë°®Áõò
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/assets">
                            <i class="fas fa-building me-1"></i>ËµÑ‰∫ßÁÆ°ÁêÜ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="fas fa-users me-1"></i>Áî®Êà∑ÁÆ°ÁêÜ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/distribution">
                            <i class="fas fa-network-wired me-1"></i>ÂàÜÈîÄÁÆ°ÁêÜ
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="commissionDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-percentage me-1"></i>‰Ω£ÈáëÁÆ°ÁêÜ
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/commission_settings">‰Ω£ÈáëËÆæÁΩÆ</a></li>
                            <li><a class="dropdown-item" href="/admin/commission_records">‰Ω£ÈáëËÆ∞ÂΩï</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/operation_logs">
                            <i class="fas fa-history me-1"></i>Êìç‰ΩúÊó•Âøó
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="/" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-home me-1"></i>ÂõûÂà∞È¶ñÈ°µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="page-container">
        <div class="container-fluid">
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">‰ª™Ë°®Áõò</h1>
                <div>
                    <!-- Âà∑Êñ∞ÊåâÈíÆ -->
                    <button class="btn btn-primary btn-sm me-2" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Âà∑Êñ∞Êï∞ÊçÆ
                    </button>
                    <!-- Âº∫Âà∂ÈáçÊñ∞ÁªüËÆ°ÊåâÈíÆ -->
                    <button class="btn btn-warning btn-sm" id="forceUpdateBtn">
                        <i class="fas fa-database"></i> Âº∫Âà∂Êõ¥Êñ∞ÁªüËÆ°
                    </button>
                </div>
            </div>
            
            <div id="alertArea" class="mb-4"></div>
            
            <div class="row mt-4">
                <!-- Áî®Êà∑ÊÄªÊï∞ -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-primary shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Áî®Êà∑ÊÄªÊï∞</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUserCount">0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰∫§ÊòìÊÄªÈ¢ù -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-success shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">‰∫§ÊòìÊÄªÈ¢ù</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalTradeAmount">$0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊÄªËµÑ‰∫ß‰ª∑ÂÄº -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-info shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">ÊÄªËµÑ‰∫ß‰ª∑ÂÄº</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalAssetValue">$0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ‰Ω£ÈáëÊÄªÊï∞ -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-warning shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">‰Ω£ÈáëÊÄªÊï∞</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalCommissionAmount">$0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-percentage fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">ËµÑ‰∫ßÁ±ªÂûãÂàÜÂ∏É</h6>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px">
                        <canvas id="assetTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Ê≥®ÂÜåÁî®Êà∑‰∏éËÆøÈóÆË∂ãÂäø</h6>
                        <div class="btn-group" role="group" aria-label="Áî®Êà∑Â¢ûÈïøÂë®Êúü">
                            <button type="button" class="btn btn-sm btn-primary active" id="periodWeek">Âë®</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="periodMonth">Êúà</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="periodYear">Âπ¥</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                        <div class="small text-muted text-center mt-2">
                            <i class="fas fa-info-circle me-1"></i>ÊòæÁ§∫Â∑≤Ê≥®ÂÜåÁî®Êà∑(ÈÄöËøáÈí±ÂåÖËøûÊé•)ÂíåÁΩëÁ´ôËÆøÈóÆÈáèÁöÑÂØπÊØîË∂ãÂäø
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊâßË°å
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÂõæË°®ÂèòÈáè
            window.assetTypeChart = null;
            window.userGrowthChart = null;
            
            // Ê£ÄÊü•Chart.jsÊòØÂê¶Ê≠£Á°ÆÂä†ËΩΩ
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsÂ∫ìÊú™Ê≠£Á°ÆÂä†ËΩΩÔºåÂõæË°®ÂèØËÉΩÊó†Ê≥ïÊòæÁ§∫');
                showAlert('ÂõæË°®Âä†ËΩΩÂ§±Ë¥•: Chart.jsÂ∫ìÊú™Ê≠£Á°ÆÂä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï', 'danger');
                return;
            } else {
                console.log('Chart.jsÂ∫ìÂ∑≤Ê≠£Á°ÆÂä†ËΩΩ', Chart.version);
            }
            
            // Ê∏ÖÈô§ÂèØËÉΩÁöÑÁºìÂ≠ò
            if (window.performance && window.performance.navigation.type === 0) {
                console.log('È°µÈù¢Âà∑Êñ∞ÔºåÊ∏ÖÈô§ÁºìÂ≠òÊï∞ÊçÆ');
            }
            
            // ÂàùÂßãÂåñÂΩìÂâçÈÄâ‰∏≠ÁöÑÂë®Êúü
            window.currentPeriod = 'weekly';
            
            // ËÆæÁΩÆÂë®ÊúüÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('periodWeek').addEventListener('click', function() {
                updatePeriodButtons(this);
                window.currentPeriod = 'weekly';
                loadUserGrowthData();
            });
            
            document.getElementById('periodMonth').addEventListener('click', function() {
                updatePeriodButtons(this);
                window.currentPeriod = 'monthly';
                loadUserGrowthData();
            });
            
            document.getElementById('periodYear').addEventListener('click', function() {
                updatePeriodButtons(this);
                window.currentPeriod = 'yearly';
                loadUserGrowthData();
            });
            
            loadDashboardData();
            
            // Ê∑ªÂä†Âà∑Êñ∞ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('refreshBtn').addEventListener('click', function() {
                console.log('Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆ');
                // ÈîÄÊØÅÂ∑≤ÊúâÂõæË°®‰ª•Á°Æ‰øùÈáçÊñ∞ÂàõÂª∫
                try {
                    if (window.assetTypeChart && typeof window.assetTypeChart.destroy === 'function') {
                        window.assetTypeChart.destroy();
                        window.assetTypeChart = null;
                    }
                } catch(e) {
                    console.error('ÈîÄÊØÅËµÑ‰∫ßÁ±ªÂûãÂõæË°®Âá∫Èîô:', e);
                    window.assetTypeChart = null;
                }
                
                try {
                    if (window.userGrowthChart && typeof window.userGrowthChart.destroy === 'function') {
                        window.userGrowthChart.destroy();
                        window.userGrowthChart = null;
                    }
                } catch(e) {
                    console.error('ÈîÄÊØÅÁî®Êà∑Â¢ûÈïøÂõæË°®Âá∫Èîô:', e);
                    window.userGrowthChart = null;
                }
                
                // Ê∑ªÂä†Êó∂Èó¥Êà≥Èò≤Ê≠¢ÁºìÂ≠ò
                loadDashboardData(true);
            });
            
            // Ê≥®ÂÜåÂº∫Âà∂Êõ¥Êñ∞ÁªüËÆ°ÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('forceUpdateBtn').addEventListener('click', function() {
                if (confirm('Á°ÆÂÆöË¶ÅÂº∫Âà∂Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÂêóÔºüËøôÂ∞ÜÈáçÊñ∞ËÆ°ÁÆóÊâÄÊúâÁªüËÆ°ÊåáÊ†á„ÄÇ')) {
                    forceUpdateStats();
                }
            });
        });
        
        // Ê†ºÂºèÂåñÂáΩÊï∞
        function formatCurrency(num) {
            return '$' + parseFloat(num || 0).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function numberWithCommas(x) {
            return parseInt(x || 0).toLocaleString();
        }
        
        // Âä†ËΩΩ‰ª™Ë°®ÁõòÊï∞ÊçÆ
        function loadDashboardData(forceRefresh = false) {
            showAlert('Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...', 'info');
            
            // Ê∑ªÂä†Êó∂Èó¥Êà≥ÂèÇÊï∞Èò≤Ê≠¢ÁºìÂ≠ò
            const cacheBuster = forceRefresh ? `&_t=${new Date().getTime()}` : '';
            
            // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
            fetch(`/api/admin/stats${cacheBuster ? '?' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    updateStats(data);
                    
                    // Êõ¥Êñ∞‰Ω£ÈáëÊï∞ÊçÆ
                    document.getElementById('totalCommissionAmount').textContent = formatCurrency(data.total_commission || 0);
                    if (data.commission_by_type) {
                        const type10Percent = data.commission_by_type['10'] ? (data.commission_by_type['10'] / data.total_commission * 100).toFixed(1) : 0;
                        const type20Percent = data.commission_by_type['20'] ? (data.commission_by_type['20'] / data.total_commission * 100).toFixed(1) : 0;
                        
                        // Ê£ÄÊü•ÊàñÂàõÂª∫ÊòæÁ§∫‰Ω£ÈáëÁôæÂàÜÊØîÁöÑÂÖÉÁ¥†
                        let commissionDetailsDiv = document.getElementById('commissionDetails');
                        if (!commissionDetailsDiv) {
                            commissionDetailsDiv = document.createElement('div');
                            commissionDetailsDiv.id = 'commissionDetails';
                            commissionDetailsDiv.className = 'small text-muted mt-2';
                            const commissionCard = document.getElementById('totalCommissionAmount').closest('.card-body');
                            if (commissionCard) {
                                commissionCard.appendChild(commissionDetailsDiv);
                            }
                        }
                        
                        // Êõ¥Êñ∞‰Ω£ÈáëËØ¶ÊÉÖÂÜÖÂÆπ
                        commissionDetailsDiv.innerHTML = `
                            <div>‰∏çÂä®‰∫ßÔºö${type10Percent}%</div>
                            <div>Á±ª‰∏çÂä®‰∫ßÔºö${type20Percent}%</div>
                        `;
                    }
                    
                    hideAlert();
                })
                .catch(error => {
                    showAlert('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•: ' + error.message, 'danger');
                });
            
            // Âä†ËΩΩËµÑ‰∫ßÁ±ªÂûãÂàÜÂ∏É
            fetch(`/api/admin/asset-type-stats${cacheBuster ? '?' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    console.log('ËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆ:', data); // Ê∑ªÂä†Êó•ÂøóËæìÂá∫
                    if (data && data.length > 0) {
                        renderAssetTypeChart(data);
                    } else {
                        // Ê≤°ÊúâÊï∞ÊçÆÔºåÊòæÁ§∫Á©∫Êï∞ÊçÆÊèêÁ§∫
                        document.getElementById('assetTypeChart').innerHTML = '<div class="text-center py-5">ÊöÇÊó†ËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆ</div>';
                        console.log('Ê≤°ÊúâËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆ');
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆÂ§±Ë¥•:', error);
                    showAlert('Âä†ËΩΩËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆÂ§±Ë¥•: ' + error.message, 'warning');
                    document.getElementById('assetTypeChart').innerHTML = '<div class="text-center py-5">Âä†ËΩΩËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆÂ§±Ë¥•</div>';
                });
            
            // Âä†ËΩΩÁî®Êà∑Â¢ûÈïøË∂ãÂäø
            loadUserGrowthData(cacheBuster);
            
            // Âä†ËΩΩËµÑ‰∫ßÂàóË°®
            fetch(`/api/admin/v2/assets?page=1&limit=5${cacheBuster ? '&' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    if (data.assets && data.assets.length > 0) {
                        renderAssetList(data.assets);
                        hideAlert(); // Êï∞ÊçÆÂä†ËΩΩÊàêÂäüÂêéÈöêËóèÊèêÁ§∫
                    } else {
                        document.getElementById('assetListContainer').innerHTML = 
                            '<div class="alert alert-info">ÊöÇÊó†ËµÑ‰∫ßÊï∞ÊçÆ</div>';
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩËµÑ‰∫ßÂàóË°®Â§±Ë¥•:', error);
                    showAlert('Âä†ËΩΩËµÑ‰∫ßÂàóË°®Â§±Ë¥•: ' + error.message, 'warning');
                    document.getElementById('assetListContainer').innerHTML = 
                        `<div class="alert alert-warning">Âä†ËΩΩËµÑ‰∫ßÂàóË°®Â§±Ë¥•: ${error.message}</div>`;
                });
        }
        
        // Âä†ËΩΩÁî®Êà∑Â¢ûÈïøÊï∞ÊçÆ
        function loadUserGrowthData(cacheBuster = '') {
            const period = window.currentPeriod || 'weekly';
            
            fetch(`/api/admin/user-stats?period=${period}${cacheBuster ? '&' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    console.log(`Áî®Êà∑Â¢ûÈïøÊï∞ÊçÆ(${period}):`, data); // Ê∑ªÂä†Êó•ÂøóËæìÂá∫
                    if (data && data.length > 0) {
                        renderUserGrowthChart(data, period);
                    } else {
                        // Ê≤°ÊúâÊï∞ÊçÆÔºåÊòæÁ§∫Á©∫Êï∞ÊçÆÊèêÁ§∫
                        if (window.userGrowthChart) {
                            window.userGrowthChart.destroy();
                            window.userGrowthChart = null;
                        }
                        const container = document.getElementById('userGrowthChart').parentNode;
                        container.innerHTML = '<div class="text-center py-5">ÊöÇÊó†Ê≥®ÂÜåÁî®Êà∑‰∏éËÆøÈóÆÈáèÊï∞ÊçÆ</div>';
                        console.log(`Ê≤°ÊúâÁî®Êà∑Â¢ûÈïøÊï∞ÊçÆ(${period})`);
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÁî®Êà∑Â¢ûÈïøÊï∞ÊçÆÂ§±Ë¥•:', error);
                    showAlert('Âä†ËΩΩÁî®Êà∑Â¢ûÈïøÊï∞ÊçÆÂ§±Ë¥•: ' + error.message, 'warning');
                    if (window.userGrowthChart) {
                        window.userGrowthChart.destroy();
                        window.userGrowthChart = null;
                    }
                    const container = document.getElementById('userGrowthChart').parentNode;
                    container.innerHTML = '<div class="text-center py-5">Âä†ËΩΩÁî®Êà∑Â¢ûÈïøÊï∞ÊçÆÂ§±Ë¥•</div>';
                });
        }
        
        // Êõ¥Êñ∞Âë®ÊúüÊåâÈíÆÊ†∑Âºè
        function updatePeriodButtons(activeButton) {
            // ÁßªÈô§ÂÖ∂‰ªñÊåâÈíÆÁöÑÊ¥ªÂä®Áä∂ÊÄÅ
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.remove('active');
                btn.classList.add('btn-outline-primary');
            });
            
            // ËÆæÁΩÆÂΩìÂâçÊ¥ªÂä®ÊåâÈíÆ
            activeButton.classList.remove('btn-outline-primary');
            activeButton.classList.add('btn-primary');
            activeButton.classList.add('active');
        }
        
        // ÊòæÁ§∫Ë≠¶Âëä‰ø°ÊÅØ
        function showAlert(message, type, duration = 3000) {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            setTimeout(hideAlert, duration);
        }
        
        // ÈöêËóèË≠¶Âëä‰ø°ÊÅØ
        function hideAlert() {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = '';
        }
        
        // Â§ÑÁêÜAPIÈîôËØØ
        function handleApiError(response) {
            if (!response.ok) {
                throw new Error(`${response.status}: ${response.statusText}`);
            }
            return response.json();
        }
        
        // Ê†ºÂºèÂåñÂõæË°®Êï∞ÊçÆ
        function formatChartData(data, labelKey = 'date', valueKey = 'count') {
            return {
                labels: data.map(item => item[labelKey]),
                values: data.map(item => item[valueKey])
            };
        }
        
        // Ê∏≤ÊüìËµÑ‰∫ßÁ±ªÂûãÂàÜÂ∏ÉÂõæË°®
        function renderAssetTypeChart(data) {
            const canvas = document.getElementById('assetTypeChart');
            
            // ËµÑ‰∫ßÁ±ªÂûãÂêçÁß∞Êò†Â∞Ñ
            const typeLabels = {
                10: '‰∏çÂä®‰∫ß',
                20: 'Á±ª‰∏çÂä®‰∫ß',
                30: 'Â∑•‰∏öÂú∞‰∫ß',
                40: 'ÂúüÂú∞ËµÑ‰∫ß',
                50: 'ËØÅÂà∏ËµÑ‰∫ß',
                60: 'Ëâ∫ÊúØÂìÅ',
                70: 'Êî∂ËóèÂìÅ',
                99: 'ÂÖ∂‰ªñ'
            };
            
            // È¢úËâ≤
            const colors = [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1', '#858796'
            ];
            
            // Á≠õÈÄâÂá∫Á±ªÂûã10Âíå20ÁöÑËµÑ‰∫ß
            const filteredData = data.filter(item => {
                if (item.hasOwnProperty('asset_type')) {
                    return item.asset_type == 10 || item.asset_type == 20;
                } else if (item.hasOwnProperty('type')) {
                    return item.type == 10 || item.type == 20;
                }
                return false;
            });
            console.log('Á≠õÈÄâÂêéÁöÑËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆ:', filteredData);
            
            // Â¶ÇÊûúÁ≠õÈÄâÂêéÊ≤°ÊúâÊï∞ÊçÆÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
            if (filteredData.length === 0) {
                if (window.assetTypeChart) {
                    window.assetTypeChart.destroy();
                    window.assetTypeChart = null;
                }
                
                const chartContainer = document.getElementById('assetTypeChart').parentNode;
                chartContainer.innerHTML = '<div class="text-center py-5">ÊöÇÊó†ËµÑ‰∫ßÁ±ªÂûãÊï∞ÊçÆ</div>';
                return;
            }
            
            // ÊèêÂèñÊï∞ÊçÆÔºàÁ°Æ‰øù‰ΩøÁî®ÁúüÂÆûÊï∞ÊçÆÔºâ
            const labels = filteredData.map(item => {
                if (item.name) return item.name;
                if (item.type_name) return item.type_name;
                const typeId = item.hasOwnProperty('asset_type') ? item.asset_type : item.type;
                return typeLabels[typeId] || `Á±ªÂûã${typeId}`;
            });
            const values = filteredData.map(item => item.count);
            
            // Â¶ÇÊûúÂ∑≤ÊúâÂõæË°®ÔºåÈîÄÊØÅÂÆÉ
            try {
                if (window.assetTypeChart && typeof window.assetTypeChart.destroy === 'function') {
                    window.assetTypeChart.destroy();
                }
            } catch(e) {
                console.error('ÈîÄÊØÅÊóßÂõæË°®Êó∂Âá∫Èîô:', e);
                // ÈáçÁΩÆÂõæË°®ÂèòÈáè
                window.assetTypeChart = null;
            }
            
            // ÂàõÂª∫Êñ∞ÂõæË°® - Êîπ‰∏∫Êü±Áä∂Âõæ
            window.assetTypeChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ËµÑ‰∫ßÊï∞Èáè',
                        data: values,
                        backgroundColor: colors.slice(0, filteredData.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Ê∏≤ÊüìÁî®Êà∑Â¢ûÈïøË∂ãÂäøÂõæË°® - Á°Æ‰øùÊòØÊõ≤Á∫øÂõæ
        function renderUserGrowthChart(data, period) {
            const canvas = document.getElementById('userGrowthChart');
            
            // ÊèêÂèñÊï∞ÊçÆ
            const labels = data.map(item => item.date);
            const userValues = data.map(item => item.count);
            const visitValues = data.map(item => item.visits || 0);  // Ê∑ªÂä†ËÆøÈóÆÈáèÊï∞ÊçÆÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®ÂàôÈªòËÆ§‰∏∫0
            
            // Â¶ÇÊûúÂ∑≤ÊúâÂõæË°®ÔºåÈîÄÊØÅÂÆÉ
            try {
                if (window.userGrowthChart && typeof window.userGrowthChart.destroy === 'function') {
                    window.userGrowthChart.destroy();
                }
            } catch(e) {
                console.error('ÈîÄÊØÅÊóßÂõæË°®Êó∂Âá∫Èîô:', e);
                // ÈáçÁΩÆÂõæË°®ÂèòÈáè
                window.userGrowthChart = null;
            }
            
            // Ê†πÊçÆ‰∏çÂêåÂë®ÊúüËÆæÁΩÆ‰∏çÂêåÁöÑÂõæË°®È£éÊ†º
            let chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,  // ÊòæÁ§∫Âõæ‰æã
                        position: 'top',
                        labels: {
                            font: {
                                size: 10
                            },
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    title: {
                        display: true,
                        position: 'top',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleFont: {
                            size: 13
                        },
                        bodyFont: {
                            size: 12
                        },
                        padding: 10,
                        cornerRadius: 4,
                        titleColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y;
                                return label;
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                elements: {
                    line: {
                        tension: 0.3
                    },
                    point: {
                        radius: 3,
                        hoverRadius: 5
                    }
                }
            };
            
            // Ê†πÊçÆ‰∏çÂêåÂë®ÊúüËÆæÁΩÆÂõæË°®Ê†∑Âºè
            let chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ê≥®ÂÜåÁî®Êà∑(Èí±ÂåÖËøûÊé•)',
                            data: userValues,
                            borderWidth: 2,
                            fill: false,  // Êîπ‰∏∫‰∏çÂ°´ÂÖÖÔºå‰æø‰∫éÂå∫ÂàÜ‰∏§Êù°Á∫ø
                            yAxisID: 'y'  // ÂÖ±Áî®YËΩ¥
                        },
                        {
                            label: 'ÁΩëÁ´ôËÆøÈóÆÈáè',
                            data: visitValues,
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y'  // ÂÖ±Áî®YËΩ¥
                        }
                    ]
                },
                options: chartOptions
            };
            
            // Ê†πÊçÆÂë®ÊúüËÆæÁΩÆ‰∏çÂêåÁöÑÂõæË°®È£éÊ†º
            if (period === 'weekly') {
                // Áî®Êà∑Êï∞ÈáèÁ∫øËÆæÁΩÆ
                chartConfig.data.datasets[0].borderColor = '#4e73df';
                chartConfig.data.datasets[0].backgroundColor = 'rgba(78, 115, 223, 0.1)';
                chartConfig.data.datasets[0].pointBackgroundColor = '#4e73df';
                chartConfig.data.datasets[0].pointBorderColor = '#fff';
                
                // ËÆøÈóÆÈáèÁ∫øËÆæÁΩÆ
                chartConfig.data.datasets[1].borderColor = '#f6c23e';
                chartConfig.data.datasets[1].backgroundColor = 'rgba(246, 194, 62, 0.1)';
                chartConfig.data.datasets[1].pointBackgroundColor = '#f6c23e';
                chartConfig.data.datasets[1].pointBorderColor = '#fff';
                
                chartOptions.plugins.title.text = 'Âë®Êï∞ÊçÆ - ËøáÂéª7Â§©Ê≥®ÂÜåÁî®Êà∑‰∏éËÆøÈóÆÈáè';
            } else if (period === 'monthly') {
                // Áî®Êà∑Êï∞ÈáèÁ∫øËÆæÁΩÆ
                chartConfig.data.datasets[0].borderColor = '#1cc88a';
                chartConfig.data.datasets[0].backgroundColor = 'rgba(28, 200, 138, 0.1)';
                chartConfig.data.datasets[0].pointBackgroundColor = '#1cc88a';
                chartConfig.data.datasets[0].pointBorderColor = '#fff';
                
                // ËÆøÈóÆÈáèÁ∫øËÆæÁΩÆ
                chartConfig.data.datasets[1].borderColor = '#e74a3b';
                chartConfig.data.datasets[1].backgroundColor = 'rgba(231, 74, 59, 0.1)';
                chartConfig.data.datasets[1].pointBackgroundColor = '#e74a3b';
                chartConfig.data.datasets[1].pointBorderColor = '#fff';
                
                chartOptions.plugins.title.text = 'ÊúàÊï∞ÊçÆ - ËøáÂéª30Â§©Ê≥®ÂÜåÁî®Êà∑‰∏éËÆøÈóÆÈáè';
            } else {
                // Áî®Êà∑Êï∞ÈáèÁ∫øËÆæÁΩÆ
                chartConfig.data.datasets[0].borderColor = '#36b9cc';
                chartConfig.data.datasets[0].backgroundColor = 'rgba(54, 185, 204, 0.1)';
                chartConfig.data.datasets[0].pointBackgroundColor = '#36b9cc';
                chartConfig.data.datasets[0].pointBorderColor = '#fff';
                
                // ËÆøÈóÆÈáèÁ∫øËÆæÁΩÆ
                chartConfig.data.datasets[1].borderColor = '#6f42c1';
                chartConfig.data.datasets[1].backgroundColor = 'rgba(111, 66, 193, 0.1)';
                chartConfig.data.datasets[1].pointBackgroundColor = '#6f42c1';
                chartConfig.data.datasets[1].pointBorderColor = '#fff';
                
                chartOptions.plugins.title.text = 'Âπ¥Êï∞ÊçÆ - ËøáÂéª12‰∏™ÊúàÊ≥®ÂÜåÁî®Êà∑‰∏éËÆøÈóÆÈáè';
            }
            
            // Êï∞ÊçÆ‰∏∫Á©∫ÁöÑÊÉÖÂÜµÊòæÁ§∫ÊèêÁ§∫
            if ((userValues.length === 0 || userValues.every(val => val === 0)) &&
                (visitValues.length === 0 || visitValues.every(val => val === 0))) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ÊöÇÊó†Ê≥®ÂÜåÁî®Êà∑‰∏éËÆøÈóÆÈáèÊï∞ÊçÆ', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // ÂàõÂª∫Êñ∞ÂõæË°® - Êõ≤Á∫øÂõæËÆæÁΩÆ
            window.userGrowthChart = new Chart(canvas, chartConfig);
        }
        
        // Ê∏≤ÊüìËµÑ‰∫ßÂàóË°®
        function renderAssetList(assets) {
            const container = document.getElementById('assetListContainer');
            
            // ËµÑ‰∫ßÁ±ªÂûãÊò†Â∞Ñ
            const assetTypeMap = {
                10: { name: '‰∏çÂä®‰∫ß', badge: 'bg-primary' },
                20: { name: 'Á±ª‰∏çÂä®‰∫ß', badge: 'bg-success' },
                30: { name: 'Â∑•‰∏öÂú∞‰∫ß', badge: 'bg-info' },
                40: { name: 'ÂúüÂú∞ËµÑ‰∫ß', badge: 'bg-warning' },
                50: { name: 'ËØÅÂà∏ËµÑ‰∫ß', badge: 'bg-danger' },
                60: { name: 'Ëâ∫ÊúØÂìÅ', badge: 'bg-secondary' },
                70: { name: 'Êî∂ËóèÂìÅ', badge: 'bg-dark' },
                99: { name: 'ÂÖ∂‰ªñ', badge: 'bg-light text-dark' }
            };
            
            // Áä∂ÊÄÅÊò†Â∞Ñ
            const statusMap = {
                1: { name: 'ÂæÖÂÆ°Ê†∏', badge: 'bg-secondary' },
                2: { name: 'Â∑≤ÈÄöËøá', badge: 'bg-success' },
                3: { name: 'Â∑≤ÊãíÁªù', badge: 'bg-danger' },
                4: { name: 'Â∑≤Âà†Èô§', badge: 'bg-dark' }
            };
            
            let html = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ËµÑ‰∫ßÂêçÁß∞</th>
                            <th>Á±ªÂûã</th>
                            <th>Token</th>
                            <th>‰ª∑Ê†º</th>
                            <th>ÈîÄÂîÆÈ¢ù</th>
                            <th>Áä∂ÊÄÅ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            assets.forEach(asset => {
                const type = assetTypeMap[asset.asset_type] || { name: 'Êú™Áü•', badge: 'bg-secondary' };
                const status = statusMap[asset.status] || { name: 'Êú™Áü•', badge: 'bg-secondary' };
                
                // ËÆ°ÁÆóÈîÄÂîÆÈ¢ù
                const soldTokens = (asset.token_supply || 0) - (asset.remaining_supply || 0);
                const salesVolume = asset.sales_volume !== undefined ? 
                    asset.sales_volume : 
                    soldTokens * (asset.token_price || 0);
                
                html += `
                    <tr>
                        <td>${asset.id}</td>
                        <td>${asset.name}</td>
                        <td><span class="badge ${type.badge}">${type.name}</span></td>
                        <td>${asset.token_symbol || '-'}</td>
                        <td>${asset.token_price ? asset.token_price.toLocaleString() : '0'} USDT</td>
                        <td>${salesVolume.toLocaleString()} USDT</td>
                        <td><span class="badge ${status.badge}">${status.name}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div class="small text-muted mb-3">
                    <i class="fas fa-info-circle"></i> ÈîÄÂîÆÈ¢ù = Â∑≤ÂîÆÈÄöËØÅÊï∞Èáè √ó ÈÄöËØÅ‰ª∑Ê†ºÔºàÂ∑≤ÂîÆÈÄöËØÅÊï∞Èáè = ÊÄªÂèëË°åÈáè - Ââ©‰Ωô‰æõÂ∫îÈáèÔºâ
                </div>
                <div class="text-center">
                    <a href="/admin/assets" class="btn btn-sm btn-outline-primary">Êü•ÁúãÂÖ®ÈÉ®ËµÑ‰∫ß</a>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
        function updateStats(data) {
            $('#totalUserCount').text(data.total_users || 0);
            $('#totalTradeAmount').text('$' + (data.total_trade_amount ? data.total_trade_amount.toLocaleString() : 0));
            $('#totalAssetValue').text('$' + (data.total_asset_value ? data.total_asset_value.toLocaleString() : 0));
            $('#totalCommissionAmount').text('$' + (data.total_commission ? data.total_commission.toLocaleString() : 0));
        }
        
        // ÂÆö‰πâÂº∫Âà∂Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÂáΩÊï∞
        function forceUpdateStats() {
            showAlert('Ê≠£Âú®Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÔºåËØ∑Á®çÂÄô...', 'info');
            
            // Ë∞ÉÁî®Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÁöÑAPI
            fetch('/api/admin/update-dashboard-stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(handleApiError)
            .then(data => {
                showAlert('ÁªüËÆ°Êï∞ÊçÆÊõ¥Êñ∞ÊàêÂäü!', 'success', 3000);
                // Êõ¥Êñ∞ÊàêÂäüÂêéÂà∑Êñ∞È°µÈù¢Êï∞ÊçÆ
                loadDashboardData(true);
            })
            .catch(error => {
                showAlert('Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•: ' + error.message, 'danger');
            });
        }
    </script>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Ê∑ªÂä†ËµÑ‰∫ßÂàóË°®Âå∫Âüü -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">ÊúÄËøëËµÑ‰∫ß</h6>
                    </div>
                    <div class="card-body" id="assetListContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Âä†ËΩΩ‰∏≠...</span>
                            </div>
                            <p class="mt-2">Âä†ËΩΩËµÑ‰∫ßÊï∞ÊçÆ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
