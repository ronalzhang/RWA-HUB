<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>èµ„äº§ç®¡ç†åå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- æ·»åŠ jQueryåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- æ›¿æ¢ä¸ºæ–°çš„FontAwesome CDN -->
    <link rel="stylesheet" href="{{ url_for("static", filename="fonts/fontawesome/css/all.min.css") }}">
    <!-- æ·»åŠ ä¸€ä¸ªç®€å•çš„favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¼</text></svg>">
<style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding-top: 56px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            background-color: #f8f9fc;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e3e6f0;
            padding: 15px 20px;
        }
        .card-body {
            padding: 20px;
        }
        .border-left-primary {
            border-left: 4px solid #4e73df;
        }
        .border-left-success {
            border-left: 4px solid #1cc88a;
        }
        .border-left-info {
            border-left: 4px solid #36b9cc;
        }
        .text-primary {
            color: #4e73df !important;
        }
        .text-success {
            color: #1cc88a !important;
        }
        .text-info {
            color: #36b9cc !important;
        }
        .font-weight-bold {
            font-weight: bold !important;
        }
        .stats-card {
            height: 100%;
            padding: 15px;
        }
        .page-container {
            padding: 20px;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .navbar-nav .nav-link.active {
            font-weight: bold;
            color: #4e73df;
        }
</style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-building me-2"></i>RWA-HUBç®¡ç†ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>ä»ªè¡¨ç›˜
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/assets">
                            <i class="fas fa-building me-1"></i>èµ„äº§ç®¡ç†
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="fas fa-users me-1"></i>ç”¨æˆ·ç®¡ç†
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/distribution">
                            <i class="fas fa-network-wired me-1"></i>åˆ†é”€ç®¡ç†
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="commissionDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-percentage me-1"></i>ä½£é‡‘ç®¡ç†
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/commission_settings">ä½£é‡‘è®¾ç½®</a></li>
                            <li><a class="dropdown-item" href="/admin/commission_records">ä½£é‡‘è®°å½•</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/operation_logs">
                            <i class="fas fa-history me-1"></i>æ“ä½œæ—¥å¿—
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="/" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-home me-1"></i>å›åˆ°é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="page-container">
        <div class="container-fluid">
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">ä»ªè¡¨ç›˜</h1>
                <div>
                    <!-- åˆ·æ–°æŒ‰é’® -->
                    <button class="btn btn-primary btn-sm me-2" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                    </button>
                    <!-- å¼ºåˆ¶é‡æ–°ç»Ÿè®¡æŒ‰é’® -->
                    <button class="btn btn-warning btn-sm" id="forceUpdateBtn">
                        <i class="fas fa-database"></i> å¼ºåˆ¶æ›´æ–°ç»Ÿè®¡
                    </button>
                </div>
            </div>
            
            <div id="alertArea" class="mb-4"></div>
            
            <div class="row mt-4">
                <!-- ç”¨æˆ·æ€»æ•° -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-primary shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">ç”¨æˆ·æ€»æ•°</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalUserCount">0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- äº¤æ˜“æ€»é¢ -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-success shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">äº¤æ˜“æ€»é¢</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalTradeAmount">$0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ€»èµ„äº§ä»·å€¼ -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-info shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">æ€»èµ„äº§ä»·å€¼</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalAssetValue">$0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ä½£é‡‘æ€»æ•° -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100 border-left-warning shadow">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">ä½£é‡‘æ€»æ•°</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalCommissionAmount">$0</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-percentage fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">èµ„äº§ç±»å‹åˆ†å¸ƒ</h6>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px">
                        <canvas id="assetTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">æ³¨å†Œç”¨æˆ·ä¸è®¿é—®è¶‹åŠ¿</h6>
                        <div class="btn-group" role="group" aria-label="ç”¨æˆ·å¢é•¿å‘¨æœŸ">
                            <button type="button" class="btn btn-sm btn-primary active" id="periodWeek">å‘¨</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="periodMonth">æœˆ</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="periodYear">å¹´</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                        <div class="small text-muted text-center mt-2">
                            <i class="fas fa-info-circle me-1"></i>æ˜¾ç¤ºå·²æ³¨å†Œç”¨æˆ·(é€šè¿‡é’±åŒ…è¿æ¥)å’Œç½‘ç«™è®¿é—®é‡çš„å¯¹æ¯”è¶‹åŠ¿
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å›¾è¡¨å˜é‡
            window.assetTypeChart = null;
            window.userGrowthChart = null;
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦æ­£ç¡®åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsåº“æœªæ­£ç¡®åŠ è½½ï¼Œå›¾è¡¨å¯èƒ½æ— æ³•æ˜¾ç¤º');
                showAlert('å›¾è¡¨åŠ è½½å¤±è´¥: Chart.jsåº“æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'danger');
                return;
            } else {
                console.log('Chart.jsåº“å·²æ­£ç¡®åŠ è½½', Chart.version);
            }
            
            // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜
            if (window.performance && window.performance.navigation.type === 0) {
                console.log('é¡µé¢åˆ·æ–°ï¼Œæ¸…é™¤ç¼“å­˜æ•°æ®');
            }
            
            // åˆå§‹åŒ–å½“å‰é€‰ä¸­çš„å‘¨æœŸ
            window.currentPeriod = 'weekly';
            
            // è®¾ç½®å‘¨æœŸåˆ‡æ¢æŒ‰é’®äº‹ä»¶
            document.getElementById('periodWeek').addEventListener('click', function() {
                updatePeriodButtons(this);
                window.currentPeriod = 'weekly';
                loadUserGrowthData();
            });
            
            document.getElementById('periodMonth').addEventListener('click', function() {
                updatePeriodButtons(this);
                window.currentPeriod = 'monthly';
                loadUserGrowthData();
            });
            
            document.getElementById('periodYear').addEventListener('click', function() {
                updatePeriodButtons(this);
                window.currentPeriod = 'yearly';
                loadUserGrowthData();
            });
            
            loadDashboardData();
            
            // æ·»åŠ åˆ·æ–°æŒ‰é’®äº‹ä»¶
            document.getElementById('refreshBtn').addEventListener('click', function() {
                console.log('å¼ºåˆ¶åˆ·æ–°æ•°æ®');
                // é”€æ¯å·²æœ‰å›¾è¡¨ä»¥ç¡®ä¿é‡æ–°åˆ›å»º
                try {
                    if (window.assetTypeChart && typeof window.assetTypeChart.destroy === 'function') {
                        window.assetTypeChart.destroy();
                        window.assetTypeChart = null;
                    }
                } catch(e) {
                    console.error('é”€æ¯èµ„äº§ç±»å‹å›¾è¡¨å‡ºé”™:', e);
                    window.assetTypeChart = null;
                }
                
                try {
                    if (window.userGrowthChart && typeof window.userGrowthChart.destroy === 'function') {
                        window.userGrowthChart.destroy();
                        window.userGrowthChart = null;
                    }
                } catch(e) {
                    console.error('é”€æ¯ç”¨æˆ·å¢é•¿å›¾è¡¨å‡ºé”™:', e);
                    window.userGrowthChart = null;
                }
                
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                loadDashboardData(true);
            });
            
            // æ³¨å†Œå¼ºåˆ¶æ›´æ–°ç»Ÿè®¡æŒ‰é’®äº‹ä»¶
            document.getElementById('forceUpdateBtn').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦å¼ºåˆ¶æ›´æ–°ç»Ÿè®¡æ•°æ®å—ï¼Ÿè¿™å°†é‡æ–°è®¡ç®—æ‰€æœ‰ç»Ÿè®¡æŒ‡æ ‡ã€‚')) {
                    forceUpdateStats();
                }
            });
        });
        
        // æ ¼å¼åŒ–å‡½æ•°
        function formatCurrency(num) {
            return '$' + parseFloat(num || 0).toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function numberWithCommas(x) {
            return parseInt(x || 0).toLocaleString();
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        function loadDashboardData(forceRefresh = false) {
            showAlert('æ­£åœ¨åŠ è½½æ•°æ®...', 'info');
            
            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é˜²æ­¢ç¼“å­˜
            const cacheBuster = forceRefresh ? `&_t=${new Date().getTime()}` : '';
            
            // åŠ è½½ç»Ÿè®¡æ•°æ®
            fetch(`/api/admin/stats${cacheBuster ? '?' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    updateStats(data);
                    
                    // æ›´æ–°ä½£é‡‘æ•°æ®
                    document.getElementById('totalCommissionAmount').textContent = formatCurrency(data.total_commission || 0);
                    if (data.commission_by_type) {
                        const type10Percent = data.commission_by_type['10'] ? (data.commission_by_type['10'] / data.total_commission * 100).toFixed(1) : 0;
                        const type20Percent = data.commission_by_type['20'] ? (data.commission_by_type['20'] / data.total_commission * 100).toFixed(1) : 0;
                        
                        // æ£€æŸ¥æˆ–åˆ›å»ºæ˜¾ç¤ºä½£é‡‘ç™¾åˆ†æ¯”çš„å…ƒç´ 
                        let commissionDetailsDiv = document.getElementById('commissionDetails');
                        if (!commissionDetailsDiv) {
                            commissionDetailsDiv = document.createElement('div');
                            commissionDetailsDiv.id = 'commissionDetails';
                            commissionDetailsDiv.className = 'small text-muted mt-2';
                            const commissionCard = document.getElementById('totalCommissionAmount').closest('.card-body');
                            if (commissionCard) {
                                commissionCard.appendChild(commissionDetailsDiv);
                            }
                        }
                        
                        // æ›´æ–°ä½£é‡‘è¯¦æƒ…å†…å®¹
                        commissionDetailsDiv.innerHTML = `
                            <div>ä¸åŠ¨äº§ï¼š${type10Percent}%</div>
                            <div>ç±»ä¸åŠ¨äº§ï¼š${type20Percent}%</div>
                        `;
                    }
                    
                    hideAlert();
                })
                .catch(error => {
                    showAlert('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message, 'danger');
                });
            
            // åŠ è½½èµ„äº§ç±»å‹åˆ†å¸ƒ
            fetch(`/api/admin/asset-type-stats${cacheBuster ? '?' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    console.log('èµ„äº§ç±»å‹æ•°æ®:', data); // æ·»åŠ æ—¥å¿—è¾“å‡º
                    if (data && data.length > 0) {
                        renderAssetTypeChart(data);
                    } else {
                        // æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºæ•°æ®æç¤º
                        document.getElementById('assetTypeChart').innerHTML = '<div class="text-center py-5">æš‚æ— èµ„äº§ç±»å‹æ•°æ®</div>';
                        console.log('æ²¡æœ‰èµ„äº§ç±»å‹æ•°æ®');
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½èµ„äº§ç±»å‹æ•°æ®å¤±è´¥:', error);
                    showAlert('åŠ è½½èµ„äº§ç±»å‹æ•°æ®å¤±è´¥: ' + error.message, 'warning');
                    document.getElementById('assetTypeChart').innerHTML = '<div class="text-center py-5">åŠ è½½èµ„äº§ç±»å‹æ•°æ®å¤±è´¥</div>';
                });
            
            // åŠ è½½ç”¨æˆ·å¢é•¿è¶‹åŠ¿
            loadUserGrowthData(cacheBuster);
            
            // åŠ è½½èµ„äº§åˆ—è¡¨
            fetch(`/api/admin/v2/assets?page=1&limit=5${cacheBuster ? '&' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    if (data.assets && data.assets.length > 0) {
                        renderAssetList(data.assets);
                        hideAlert(); // æ•°æ®åŠ è½½æˆåŠŸåéšè—æç¤º
                    } else {
                        document.getElementById('assetListContainer').innerHTML = 
                            '<div class="alert alert-info">æš‚æ— èµ„äº§æ•°æ®</div>';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½èµ„äº§åˆ—è¡¨å¤±è´¥:', error);
                    showAlert('åŠ è½½èµ„äº§åˆ—è¡¨å¤±è´¥: ' + error.message, 'warning');
                    document.getElementById('assetListContainer').innerHTML = 
                        `<div class="alert alert-warning">åŠ è½½èµ„äº§åˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
                });
        }
        
        // åŠ è½½ç”¨æˆ·å¢é•¿æ•°æ®
        function loadUserGrowthData(cacheBuster = '') {
            const period = window.currentPeriod || 'weekly';
            
            fetch(`/api/admin/user-stats?period=${period}${cacheBuster ? '&' + cacheBuster.substring(1) : ''}`)
                .then(handleApiError)
                .then(data => {
                    console.log(`ç”¨æˆ·å¢é•¿æ•°æ®(${period}):`, data); // æ·»åŠ æ—¥å¿—è¾“å‡º
                    if (data && data.length > 0) {
                        renderUserGrowthChart(data, period);
                    } else {
                        // æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºæ•°æ®æç¤º
                        if (window.userGrowthChart) {
                            window.userGrowthChart.destroy();
                            window.userGrowthChart = null;
                        }
                        const container = document.getElementById('userGrowthChart').parentNode;
                        container.innerHTML = '<div class="text-center py-5">æš‚æ— æ³¨å†Œç”¨æˆ·ä¸è®¿é—®é‡æ•°æ®</div>';
                        console.log(`æ²¡æœ‰ç”¨æˆ·å¢é•¿æ•°æ®(${period})`);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç”¨æˆ·å¢é•¿æ•°æ®å¤±è´¥:', error);
                    showAlert('åŠ è½½ç”¨æˆ·å¢é•¿æ•°æ®å¤±è´¥: ' + error.message, 'warning');
                    if (window.userGrowthChart) {
                        window.userGrowthChart.destroy();
                        window.userGrowthChart = null;
                    }
                    const container = document.getElementById('userGrowthChart').parentNode;
                    container.innerHTML = '<div class="text-center py-5">åŠ è½½ç”¨æˆ·å¢é•¿æ•°æ®å¤±è´¥</div>';
                });
        }
        
        // æ›´æ–°å‘¨æœŸæŒ‰é’®æ ·å¼
        function updatePeriodButtons(activeButton) {
            // ç§»é™¤å…¶ä»–æŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.btn-group button').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.remove('active');
                btn.classList.add('btn-outline-primary');
            });
            
            // è®¾ç½®å½“å‰æ´»åŠ¨æŒ‰é’®
            activeButton.classList.remove('btn-outline-primary');
            activeButton.classList.add('btn-primary');
            activeButton.classList.add('active');
        }
        
        // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
        function showAlert(message, type, duration = 3000) {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            setTimeout(hideAlert, duration);
        }
        
        // éšè—è­¦å‘Šä¿¡æ¯
        function hideAlert() {
            const alertArea = document.getElementById('alertArea');
            alertArea.innerHTML = '';
        }
        
        // å¤„ç†APIé”™è¯¯
        function handleApiError(response) {
            if (!response.ok) {
                throw new Error(`${response.status}: ${response.statusText}`);
            }
            return response.json();
        }
        
        // æ ¼å¼åŒ–å›¾è¡¨æ•°æ®
        function formatChartData(data, labelKey = 'date', valueKey = 'count') {
            return {
                labels: data.map(item => item[labelKey]),
                values: data.map(item => item[valueKey])
            };
        }
        
        // æ¸²æŸ“èµ„äº§ç±»å‹åˆ†å¸ƒå›¾è¡¨
        function renderAssetTypeChart(data) {
            const canvas = document.getElementById('assetTypeChart');
            
            // èµ„äº§ç±»å‹åç§°æ˜ å°„
            const typeLabels = {
                10: 'ä¸åŠ¨äº§',
                20: 'ç±»ä¸åŠ¨äº§',
                30: 'å·¥ä¸šåœ°äº§',
                40: 'åœŸåœ°èµ„äº§',
                50: 'è¯åˆ¸èµ„äº§',
                60: 'è‰ºæœ¯å“',
                70: 'æ”¶è—å“',
                99: 'å…¶ä»–'
            };
            
            // é¢œè‰²
            const colors = [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1', '#858796'
            ];
            
            // ç­›é€‰å‡ºç±»å‹10å’Œ20çš„èµ„äº§
            const filteredData = data.filter(item => {
                if (item.hasOwnProperty('asset_type')) {
                    return item.asset_type == 10 || item.asset_type == 20;
                } else if (item.hasOwnProperty('type')) {
                    return item.type == 10 || item.type == 20;
                }
                return false;
            });
            console.log('ç­›é€‰åçš„èµ„äº§ç±»å‹æ•°æ®:', filteredData);
            
            // å¦‚æœç­›é€‰åæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (filteredData.length === 0) {
                if (window.assetTypeChart) {
                    window.assetTypeChart.destroy();
                    window.assetTypeChart = null;
                }
                
                const chartContainer = document.getElementById('assetTypeChart').parentNode;
                chartContainer.innerHTML = '<div class="text-center py-5">æš‚æ— èµ„äº§ç±»å‹æ•°æ®</div>';
                return;
            }
            
            // æå–æ•°æ®ï¼ˆç¡®ä¿ä½¿ç”¨çœŸå®æ•°æ®ï¼‰
            const labels = filteredData.map(item => {
                if (item.name) return item.name;
                if (item.type_name) return item.type_name;
                const typeId = item.hasOwnProperty('asset_type') ? item.asset_type : item.type;
                return typeLabels[typeId] || `ç±»å‹${typeId}`;
            });
            const values = filteredData.map(item => item.count);
            
            // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œé”€æ¯å®ƒ
            try {
                if (window.assetTypeChart && typeof window.assetTypeChart.destroy === 'function') {
                    window.assetTypeChart.destroy();
                }
            } catch(e) {
                console.error('é”€æ¯æ—§å›¾è¡¨æ—¶å‡ºé”™:', e);
                // é‡ç½®å›¾è¡¨å˜é‡
                window.assetTypeChart = null;
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨ - æ”¹ä¸ºæŸ±çŠ¶å›¾
            window.assetTypeChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'èµ„äº§æ•°é‡',
                        data: values,
                        backgroundColor: colors.slice(0, filteredData.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“ç”¨æˆ·å¢é•¿è¶‹åŠ¿å›¾è¡¨ - ç¡®ä¿æ˜¯æ›²çº¿å›¾
        function renderUserGrowthChart(data, period) {
            const canvas = document.getElementById('userGrowthChart');
            
            // æå–æ•°æ®
            const labels = data.map(item => item.date);
            const userValues = data.map(item => item.count);
            const visitValues = data.map(item => item.visits || 0);  // æ·»åŠ è®¿é—®é‡æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é»˜è®¤ä¸º0
            
            // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œé”€æ¯å®ƒ
            try {
                if (window.userGrowthChart && typeof window.userGrowthChart.destroy === 'function') {
                    window.userGrowthChart.destroy();
                }
            } catch(e) {
                console.error('é”€æ¯æ—§å›¾è¡¨æ—¶å‡ºé”™:', e);
                // é‡ç½®å›¾è¡¨å˜é‡
                window.userGrowthChart = null;
            }
            
            // æ ¹æ®ä¸åŒå‘¨æœŸè®¾ç½®ä¸åŒçš„å›¾è¡¨é£æ ¼
            let chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 10
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,  // æ˜¾ç¤ºå›¾ä¾‹
                        position: 'top',
                        labels: {
                            font: {
                                size: 10
                            },
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    title: {
                        display: true,
                        position: 'top',
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.7)',
                        titleFont: {
                            size: 13
                        },
                        bodyFont: {
                            size: 12
                        },
                        padding: 10,
                        cornerRadius: 4,
                        titleColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y;
                                return label;
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                elements: {
                    line: {
                        tension: 0.3
                    },
                    point: {
                        radius: 3,
                        hoverRadius: 5
                    }
                }
            };
            
            // æ ¹æ®ä¸åŒå‘¨æœŸè®¾ç½®å›¾è¡¨æ ·å¼
            let chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ³¨å†Œç”¨æˆ·(é’±åŒ…è¿æ¥)',
                            data: userValues,
                            borderWidth: 2,
                            fill: false,  // æ”¹ä¸ºä¸å¡«å……ï¼Œä¾¿äºåŒºåˆ†ä¸¤æ¡çº¿
                            yAxisID: 'y'  // å…±ç”¨Yè½´
                        },
                        {
                            label: 'ç½‘ç«™è®¿é—®é‡',
                            data: visitValues,
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y'  // å…±ç”¨Yè½´
                        }
                    ]
                },
                options: chartOptions
            };
            
            // æ ¹æ®å‘¨æœŸè®¾ç½®ä¸åŒçš„å›¾è¡¨é£æ ¼
            if (period === 'weekly') {
                // ç”¨æˆ·æ•°é‡çº¿è®¾ç½®
                chartConfig.data.datasets[0].borderColor = '#4e73df';
                chartConfig.data.datasets[0].backgroundColor = 'rgba(78, 115, 223, 0.1)';
                chartConfig.data.datasets[0].pointBackgroundColor = '#4e73df';
                chartConfig.data.datasets[0].pointBorderColor = '#fff';
                
                // è®¿é—®é‡çº¿è®¾ç½®
                chartConfig.data.datasets[1].borderColor = '#f6c23e';
                chartConfig.data.datasets[1].backgroundColor = 'rgba(246, 194, 62, 0.1)';
                chartConfig.data.datasets[1].pointBackgroundColor = '#f6c23e';
                chartConfig.data.datasets[1].pointBorderColor = '#fff';
                
                chartOptions.plugins.title.text = 'å‘¨æ•°æ® - è¿‡å»7å¤©æ³¨å†Œç”¨æˆ·ä¸è®¿é—®é‡';
            } else if (period === 'monthly') {
                // ç”¨æˆ·æ•°é‡çº¿è®¾ç½®
                chartConfig.data.datasets[0].borderColor = '#1cc88a';
                chartConfig.data.datasets[0].backgroundColor = 'rgba(28, 200, 138, 0.1)';
                chartConfig.data.datasets[0].pointBackgroundColor = '#1cc88a';
                chartConfig.data.datasets[0].pointBorderColor = '#fff';
                
                // è®¿é—®é‡çº¿è®¾ç½®
                chartConfig.data.datasets[1].borderColor = '#e74a3b';
                chartConfig.data.datasets[1].backgroundColor = 'rgba(231, 74, 59, 0.1)';
                chartConfig.data.datasets[1].pointBackgroundColor = '#e74a3b';
                chartConfig.data.datasets[1].pointBorderColor = '#fff';
                
                chartOptions.plugins.title.text = 'æœˆæ•°æ® - è¿‡å»30å¤©æ³¨å†Œç”¨æˆ·ä¸è®¿é—®é‡';
            } else {
                // ç”¨æˆ·æ•°é‡çº¿è®¾ç½®
                chartConfig.data.datasets[0].borderColor = '#36b9cc';
                chartConfig.data.datasets[0].backgroundColor = 'rgba(54, 185, 204, 0.1)';
                chartConfig.data.datasets[0].pointBackgroundColor = '#36b9cc';
                chartConfig.data.datasets[0].pointBorderColor = '#fff';
                
                // è®¿é—®é‡çº¿è®¾ç½®
                chartConfig.data.datasets[1].borderColor = '#6f42c1';
                chartConfig.data.datasets[1].backgroundColor = 'rgba(111, 66, 193, 0.1)';
                chartConfig.data.datasets[1].pointBackgroundColor = '#6f42c1';
                chartConfig.data.datasets[1].pointBorderColor = '#fff';
                
                chartOptions.plugins.title.text = 'å¹´æ•°æ® - è¿‡å»12ä¸ªæœˆæ³¨å†Œç”¨æˆ·ä¸è®¿é—®é‡';
            }
            
            // æ•°æ®ä¸ºç©ºçš„æƒ…å†µæ˜¾ç¤ºæç¤º
            if ((userValues.length === 0 || userValues.every(val => val === 0)) &&
                (visitValues.length === 0 || visitValues.every(val => val === 0))) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ³¨å†Œç”¨æˆ·ä¸è®¿é—®é‡æ•°æ®', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨ - æ›²çº¿å›¾è®¾ç½®
            window.userGrowthChart = new Chart(canvas, chartConfig);
        }
        
        // æ¸²æŸ“èµ„äº§åˆ—è¡¨
        function renderAssetList(assets) {
            const container = document.getElementById('assetListContainer');
            
            // èµ„äº§ç±»å‹æ˜ å°„
            const assetTypeMap = {
                10: { name: 'ä¸åŠ¨äº§', badge: 'bg-primary' },
                20: { name: 'ç±»ä¸åŠ¨äº§', badge: 'bg-success' },
                30: { name: 'å·¥ä¸šåœ°äº§', badge: 'bg-info' },
                40: { name: 'åœŸåœ°èµ„äº§', badge: 'bg-warning' },
                50: { name: 'è¯åˆ¸èµ„äº§', badge: 'bg-danger' },
                60: { name: 'è‰ºæœ¯å“', badge: 'bg-secondary' },
                70: { name: 'æ”¶è—å“', badge: 'bg-dark' },
                99: { name: 'å…¶ä»–', badge: 'bg-light text-dark' }
            };
            
            // çŠ¶æ€æ˜ å°„
            const statusMap = {
                1: { name: 'å¾…å®¡æ ¸', badge: 'bg-secondary' },
                2: { name: 'å·²é€šè¿‡', badge: 'bg-success' },
                3: { name: 'å·²æ‹’ç»', badge: 'bg-danger' },
                4: { name: 'å·²åˆ é™¤', badge: 'bg-dark' }
            };
            
            let html = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>èµ„äº§åç§°</th>
                            <th>ç±»å‹</th>
                            <th>Token</th>
                            <th>ä»·æ ¼</th>
                            <th>é”€å”®é¢</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            assets.forEach(asset => {
                const type = assetTypeMap[asset.asset_type] || { name: 'æœªçŸ¥', badge: 'bg-secondary' };
                const status = statusMap[asset.status] || { name: 'æœªçŸ¥', badge: 'bg-secondary' };
                
                // è®¡ç®—é”€å”®é¢
                const soldTokens = (asset.token_supply || 0) - (asset.remaining_supply || 0);
                const salesVolume = asset.sales_volume !== undefined ? 
                    asset.sales_volume : 
                    soldTokens * (asset.token_price || 0);
                
                html += `
                    <tr>
                        <td>${asset.id}</td>
                        <td>${asset.name}</td>
                        <td><span class="badge ${type.badge}">${type.name}</span></td>
                        <td>${asset.token_symbol || '-'}</td>
                        <td>${asset.token_price ? asset.token_price.toLocaleString() : '0'} USDT</td>
                        <td>${salesVolume.toLocaleString()} USDT</td>
                        <td><span class="badge ${status.badge}">${status.name}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <div class="small text-muted mb-3">
                    <i class="fas fa-info-circle"></i> é”€å”®é¢ = å·²å”®é€šè¯æ•°é‡ Ã— é€šè¯ä»·æ ¼ï¼ˆå·²å”®é€šè¯æ•°é‡ = æ€»å‘è¡Œé‡ - å‰©ä½™ä¾›åº”é‡ï¼‰
                </div>
                <div class="text-center">
                    <a href="/admin/assets" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹å…¨éƒ¨èµ„äº§</a>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(data) {
            $('#totalUserCount').text(data.total_users || 0);
            $('#totalTradeAmount').text('$' + (data.total_trade_amount ? data.total_trade_amount.toLocaleString() : 0));
            $('#totalAssetValue').text('$' + (data.total_asset_value ? data.total_asset_value.toLocaleString() : 0));
            $('#totalCommissionAmount').text('$' + (data.total_commission ? data.total_commission.toLocaleString() : 0));
        }
        
        // å®šä¹‰å¼ºåˆ¶æ›´æ–°ç»Ÿè®¡æ•°æ®å‡½æ•°
        function forceUpdateStats() {
            showAlert('æ­£åœ¨æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼Œè¯·ç¨å€™...', 'info');
            
            // è°ƒç”¨æ›´æ–°ç»Ÿè®¡æ•°æ®çš„API
            fetch('/api/admin/update-dashboard-stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(handleApiError)
            .then(data => {
                showAlert('ç»Ÿè®¡æ•°æ®æ›´æ–°æˆåŠŸ!', 'success', 3000);
                // æ›´æ–°æˆåŠŸååˆ·æ–°é¡µé¢æ•°æ®
                loadDashboardData(true);
            })
            .catch(error => {
                showAlert('æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error.message, 'danger');
            });
        }
    </script>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- æ·»åŠ èµ„äº§åˆ—è¡¨åŒºåŸŸ -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">æœ€è¿‘èµ„äº§</h6>
                    </div>
                    <div class="card-body" id="assetListContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2">åŠ è½½èµ„äº§æ•°æ®...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
