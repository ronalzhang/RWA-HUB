<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分销管理 - RWA-HUB后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>💼</text></svg>">
<style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            background-color: #f8f9fc;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e3e6f0;
            padding: 15px 20px;
        }
        .card-body {
            padding: 20px;
        }
        .border-left-primary {
            border-left: 4px solid #4e73df;
        }
        .border-left-success {
            border-left: 4px solid #1cc88a;
        }
        .border-left-info {
            border-left: 4px solid #36b9cc;
        }
        .text-primary {
            color: #4e73df !important;
        }
        .text-success {
            color: #1cc88a !important;
        }
        .text-info {
            color: #36b9cc !important;
        }
        .nav-pills .nav-link.active {
            background-color: #4e73df;
        }
        .nav-pills .nav-link {
            color: #4e73df;
        }
        .info-panel {
            background-color: #f8f9fc;
            border-left: 4px solid #36b9cc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
</style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3 mb-2 text-gray-800">分销系统管理</h1>
                <p class="mb-4">管理分销等级和用户推荐关系</p>
                
                <!-- 分销系统说明 -->
                <div class="info-panel mb-4">
                    <h5><i class="fas fa-info-circle text-info"></i> 分销系统说明</h5>
                    <p>RWA-HUB平台采用三级分销模式，将交易佣金按特定比例分配给推荐人：</p>
                    <ul>
                        <li><strong>一级分销（直接推荐）</strong>：获得交易佣金的<strong>30%</strong></li>
                        <li><strong>二级分销（间接推荐）</strong>：获得交易佣金的<strong>20%</strong></li>
                        <li><strong>三级分销（三级推荐）</strong>：获得交易佣金的<strong>10%</strong></li>
                        <li><strong>平台留存</strong>：剩余的<strong>40%</strong>作为平台收入</li>
                    </ul>
                    <p><strong>佣金计算示例</strong>：对于一笔100,000 USDC的大额交易（佣金率2.5%）</p>
                    <ul>
                        <li>交易佣金总额 = 100,000 × 2.5% = 2,500 USDC</li>
                        <li>一级分销佣金 = 2,500 × 30% = 750 USDC</li>
                        <li>二级分销佣金 = 2,500 × 20% = 500 USDC</li>
                        <li>三级分销佣金 = 2,500 × 10% = 250 USDC</li>
                        <li>平台留存 = 2,500 × 40% = 1,000 USDC</li>
                    </ul>
                    <p><strong>注意</strong>：修改分销比例设置将立即对新产生的交易生效。</p>
                </div>
                
                <!-- 顶部导航 -->
                <nav>
                    <div class="nav nav-pills mb-3" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-levels-tab" data-bs-toggle="tab" data-bs-target="#nav-levels" type="button" role="tab" aria-controls="nav-levels" aria-selected="true">分销等级管理</button>
                        <button class="nav-link" id="nav-referrals-tab" data-bs-toggle="tab" data-bs-target="#nav-referrals" type="button" role="tab" aria-controls="nav-referrals" aria-selected="false">用户推荐关系</button>
                        <button class="nav-link" id="nav-network-tab" data-bs-toggle="tab" data-bs-target="#nav-network" type="button" role="tab" aria-controls="nav-network" aria-selected="false">推荐网络查询</button>
                    </div>
                </nav>
                
                <!-- 选项卡内容 -->
                <div class="tab-content" id="nav-tabContent">
                    <!-- 分销等级管理 -->
                    <div class="tab-pane fade show active" id="nav-levels" role="tabpanel" aria-labelledby="nav-levels-tab">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0 font-weight-bold text-primary">分销等级列表</h5>
                                <button id="btn-add-level" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#levelModal">
                                    <i class="fa fa-plus"></i> 添加等级
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-lightbulb"></i> 当前分销比例设置：
                                    <ul class="mb-0">
                                        <li><strong>一级分销（Level 1）</strong>: 佣金比例 30%</li>
                                        <li><strong>二级分销（Level 2）</strong>: 佣金比例 20%</li>
                                        <li><strong>三级分销（Level 3）</strong>: 佣金比例 10%</li>
                                    </ul>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="levels-table" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>等级</th>
                                                <th>佣金比例(%)</th>
                                                <th>描述</th>
                                                <th>状态</th>
                                                <th>创建时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="levels-tbody">
                                            <!-- JS填充数据 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 用户推荐关系 -->
                    <div class="tab-pane fade" id="nav-referrals" role="tabpanel" aria-labelledby="nav-referrals-tab">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0 font-weight-bold text-primary">用户推荐关系</h5>
                                <button id="btn-add-referral" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#referralModal">
                                    <i class="fa fa-plus"></i> 添加推荐关系
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- 搜索框 -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <input type="text" id="search-user" class="form-control" placeholder="搜索用户地址">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" id="search-referrer" class="form-control" placeholder="搜索推荐人地址">
                                    </div>
                                    <div class="col-md-4">
                                        <button id="btn-search-referrals" class="btn btn-primary">搜索</button>
                                        <button id="btn-reset-referrals" class="btn btn-secondary">重置</button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="referrals-table" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>用户地址</th>
                                                <th>推荐人地址</th>
                                                <th>推荐等级</th>
                                                <th>推荐码</th>
                                                <th>加入时间</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="referrals-tbody">
                                            <!-- JS填充数据 -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- 分页 -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        显示 <span id="referrals-showing">0-0</span> 条，共 <span id="referrals-total">0</span> 条
                                    </div>
                                    <div>
                                        <button id="referrals-prev" class="btn btn-sm btn-outline-primary">上一页</button>
                                        <span id="referrals-page" class="mx-2">1</span>
                                        <button id="referrals-next" class="btn btn-sm btn-outline-primary">下一页</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 推荐网络查询 -->
                    <div class="tab-pane fade" id="nav-network" role="tabpanel" aria-labelledby="nav-network-tab">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="m-0 font-weight-bold text-primary">推荐网络查询</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <input type="text" id="network-address" class="form-control" placeholder="输入钱包地址查询推荐网络">
                                    </div>
                                    <div class="col-md-4">
                                        <button id="btn-search-network" class="btn btn-primary">查询</button>
                                    </div>
                                </div>
                                
                                <div id="network-result" class="d-none">
                                    <div class="row">
                                        <!-- 上级链 -->
                                        <div class="col-md-6">
                                            <div class="card border-left-primary">
                                                <div class="card-header">
                                                    <h6 class="m-0 font-weight-bold text-primary">推荐链 (上级)</h6>
                                                </div>
                                                <div class="card-body">
                                                    <ul id="referral-chain" class="list-group">
                                                        <!-- JS填充数据 -->
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 直接推荐的用户 -->
                                        <div class="col-md-6">
                                            <div class="card border-left-success">
                                                <div class="card-header">
                                                    <h6 class="m-0 font-weight-bold text-success">下级用户</h6>
                                                </div>
                                                <div class="card-body">
                                                    <ul id="direct-referrals" class="list-group">
                                                        <!-- JS填充数据 -->
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 分销等级模态框 -->
    <div class="modal fade" id="levelModal" tabindex="-1" aria-labelledby="levelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="levelModalLabel">添加分销等级</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="level-form">
                        <input type="hidden" id="level-id">
                        <div class="mb-3">
                            <label for="level-level" class="form-label">等级</label>
                            <input type="number" class="form-control" id="level-level" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="level-rate" class="form-label">佣金比例 (%)</label>
                            <input type="number" class="form-control" id="level-rate" required min="0" max="100" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="level-description" class="form-label">描述</label>
                            <textarea class="form-control" id="level-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="level-active" checked>
                            <label class="form-check-label" for="level-active">启用</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-level">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 推荐关系模态框 -->
    <div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="referralModalLabel">添加推荐关系</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="referral-form">
                        <input type="hidden" id="referral-id">
                        <div class="mb-3">
                            <label for="referral-user" class="form-label">用户地址</label>
                            <input type="text" class="form-control" id="referral-user" required>
                        </div>
                        <div class="mb-3">
                            <label for="referral-referrer" class="form-label">推荐人地址</label>
                            <input type="text" class="form-control" id="referral-referrer" required>
                        </div>
                        <div class="mb-3">
                            <label for="referral-level" class="form-label">推荐等级</label>
                            <input type="number" class="form-control" id="referral-level" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="referral-code" class="form-label">推荐码</label>
                            <input type="text" class="form-control" id="referral-code">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btn-save-referral">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        // 全局变量
        let currentReferralPage = 1;
        const referralPerPage = 10;
        let totalReferrals = 0;
        let totalReferralPages = 0;
        
        // 页面加载完成后执行
        $(document).ready(function() {
            // 加载分销等级
            loadDistributionLevels();
            
            // 加载用户推荐关系
            loadUserReferrals(1);
            
            // 监听按钮点击事件
            $("#btn-save-level").click(saveDistributionLevel);
            $("#btn-save-referral").click(saveUserReferral);
            $("#btn-search-referrals").click(() => loadUserReferrals(1));
            $("#btn-reset-referrals").click(resetReferralSearch);
            $("#btn-search-network").click(searchReferralNetwork);
            $("#referrals-prev").click(() => loadUserReferrals(currentReferralPage - 1));
            $("#referrals-next").click(() => loadUserReferrals(currentReferralPage + 1));
        });
        
        // 加载分销等级
        function loadDistributionLevels() {
            fetch('/api/admin/v2/distribution-levels')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderDistributionLevels(data.data);
                    } else {
                        alert('加载分销等级失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('加载分销等级失败:', error);
                    alert('加载分销等级失败，请检查网络连接');
                });
        }
        
        // 渲染分销等级表格
        function renderDistributionLevels(levels) {
            const tbody = $("#levels-tbody");
            tbody.empty();
            
            if (levels.length === 0) {
                tbody.append(`<tr><td colspan="7" class="text-center">暂无数据</td></tr>`);
                return;
            }
            
            levels.forEach(level => {
                tbody.append(`
                    <tr>
                        <td>${level.id}</td>
                        <td>${level.level}</td>
                        <td>${level.commission_rate}</td>
                        <td>${level.description || '-'}</td>
                        <td>${level.is_active ? '<span class="badge bg-success">启用</span>' : '<span class="badge bg-secondary">禁用</span>'}</td>
                        <td>${formatDateTime(level.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-edit-level" data-id="${level.id}">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-delete-level" data-id="${level.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // 添加编辑和删除事件
            $(".btn-edit-level").click(function() {
                const id = $(this).data('id');
                const level = levels.find(l => l.id === id);
                if (level) {
                    openLevelModal(level);
                }
            });
            
            $(".btn-delete-level").click(function() {
                const id = $(this).data('id');
                if (confirm('确定要删除此分销等级吗？')) {
                    deleteDistributionLevel(id);
                }
            });
        }
        
        // 打开分销等级模态框
        function openLevelModal(level = null) {
            const modal = $("#levelModal");
            const modalTitle = $("#levelModalLabel");
            
            // 重置表单
            $("#level-form")[0].reset();
            $("#level-id").val('');
            
            if (level) {
                modalTitle.text('编辑分销等级');
                $("#level-id").val(level.id);
                $("#level-level").val(level.level);
                $("#level-rate").val(level.commission_rate);
                $("#level-description").val(level.description);
                $("#level-active").prop('checked', level.is_active);
            } else {
                modalTitle.text('添加分销等级');
            }
            
            // 打开模态框
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // 保存分销等级
        function saveDistributionLevel() {
            const id = $("#level-id").val();
            const level = parseInt($("#level-level").val());
            const rate = parseFloat($("#level-rate").val());
            const description = $("#level-description").val();
            const isActive = $("#level-active").is(':checked');
            
            const data = {
                level: level,
                commission_rate: rate,
                description: description,
                is_active: isActive
            };
            
            let url = '/api/admin/v2/distribution-levels';
            let method = 'POST';
            
            if (id) {
                url += `/${id}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(id ? '分销等级更新成功' : '分销等级创建成功');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('levelModal'));
                    modal.hide();
                    // 重新加载数据
                    loadDistributionLevels();
                } else {
                    alert('操作失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('保存分销等级失败:', error);
                alert('操作失败，请检查网络连接');
            });
        }
        
        // 删除分销等级
        function deleteDistributionLevel(id) {
            fetch(`/api/admin/v2/distribution-levels/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('分销等级删除成功');
                    loadDistributionLevels();
                } else {
                    alert('删除失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('删除分销等级失败:', error);
                alert('删除失败，请检查网络连接');
            });
        }
        
        // 加载用户推荐关系
        function loadUserReferrals(page) {
            const userAddress = $("#search-user").val();
            const referrerAddress = $("#search-referrer").val();
            
            let url = `/api/admin/v2/user-referrals?page=${page}&per_page=${referralPerPage}`;
            
            if (userAddress) {
                url += `&user_address=${userAddress}`;
            }
            
            if (referrerAddress) {
                url += `&referrer_address=${referrerAddress}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderUserReferrals(data.data, data.pagination);
                    } else {
                        alert('加载推荐关系失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('加载推荐关系失败:', error);
                    alert('加载推荐关系失败，请检查网络连接');
                });
        }
        
        // 渲染用户推荐关系表格
        function renderUserReferrals(referrals, pagination) {
            const tbody = $("#referrals-tbody");
            tbody.empty();
            
            currentReferralPage = pagination.page;
            totalReferrals = pagination.total;
            totalReferralPages = pagination.pages;
            
            // 更新分页信息
            const start = (pagination.page - 1) * pagination.per_page + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            $("#referrals-showing").text(`${start}-${end}`);
            $("#referrals-total").text(pagination.total);
            $("#referrals-page").text(pagination.page);
            
            // 更新分页按钮状态
            $("#referrals-prev").prop('disabled', !pagination.has_prev);
            $("#referrals-next").prop('disabled', !pagination.has_next);
            
            if (referrals.length === 0) {
                tbody.append(`<tr><td colspan="7" class="text-center">暂无数据</td></tr>`);
                return;
            }
            
            referrals.forEach(referral => {
                tbody.append(`
                    <tr>
                        <td>${referral.id}</td>
                        <td title="${referral.user_address}">${truncateAddress(referral.user_address)}</td>
                        <td title="${referral.referrer_address}">${truncateAddress(referral.referrer_address)}</td>
                        <td>${referral.referral_level}</td>
                        <td>${referral.referral_code || '-'}</td>
                        <td>${formatDateTime(referral.joined_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-edit-referral" data-id="${referral.id}">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-delete-referral" data-id="${referral.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // 添加编辑和删除事件
            $(".btn-edit-referral").click(function() {
                const id = $(this).data('id');
                const referral = referrals.find(r => r.id === id);
                if (referral) {
                    openReferralModal(referral);
                }
            });
            
            $(".btn-delete-referral").click(function() {
                const id = $(this).data('id');
                if (confirm('确定要删除此推荐关系吗？')) {
                    deleteUserReferral(id);
                }
            });
        }
        
        // 重置推荐关系搜索
        function resetReferralSearch() {
            $("#search-user").val('');
            $("#search-referrer").val('');
            loadUserReferrals(1);
        }
        
        // 打开推荐关系模态框
        function openReferralModal(referral = null) {
            const modal = $("#referralModal");
            const modalTitle = $("#referralModalLabel");
            
            // 重置表单
            $("#referral-form")[0].reset();
            $("#referral-id").val('');
            
            if (referral) {
                modalTitle.text('编辑推荐关系');
                $("#referral-id").val(referral.id);
                $("#referral-user").val(referral.user_address);
                $("#referral-user").prop('disabled', true);  // 不允许修改用户地址
                $("#referral-referrer").val(referral.referrer_address);
                $("#referral-level").val(referral.referral_level);
                $("#referral-code").val(referral.referral_code);
            } else {
                modalTitle.text('添加推荐关系');
                $("#referral-user").prop('disabled', false);
            }
            
            // 打开模态框
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // 保存用户推荐关系
        function saveUserReferral() {
            const id = $("#referral-id").val();
            const userAddress = $("#referral-user").val();
            const referrerAddress = $("#referral-referrer").val();
            const level = parseInt($("#referral-level").val());
            const code = $("#referral-code").val();
            
            if (!userAddress || !referrerAddress) {
                alert('用户地址和推荐人地址不能为空');
                return;
            }
            
            const data = {
                user_address: userAddress,
                referrer_address: referrerAddress,
                referral_level: level,
                referral_code: code
            };
            
            let url = '/api/admin/v2/user-referrals';
            let method = 'POST';
            
            if (id) {
                url += `/${id}`;
                method = 'PUT';
                // 编辑时不传用户地址
                delete data.user_address;
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(id ? '推荐关系更新成功' : '推荐关系创建成功');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('referralModal'));
                    modal.hide();
                    // 重新加载数据
                    loadUserReferrals(currentReferralPage);
                } else {
                    alert('操作失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('保存推荐关系失败:', error);
                alert('操作失败，请检查网络连接');
            });
        }
        
        // 删除用户推荐关系
        function deleteUserReferral(id) {
            fetch(`/api/admin/v2/user-referrals/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('推荐关系删除成功');
                    loadUserReferrals(currentReferralPage);
                } else {
                    alert('删除失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('删除推荐关系失败:', error);
                alert('删除失败，请检查网络连接');
            });
        }
        
        // 查询推荐网络
        function searchReferralNetwork() {
            const address = $("#network-address").val();
            
            if (!address) {
                alert('请输入钱包地址');
                return;
            }
            
            fetch(`/api/admin/v2/user-referrals/network/${address}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderReferralNetwork(data.data);
                    } else {
                        alert('查询失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('查询推荐网络失败:', error);
                    alert('查询失败，请检查网络连接');
                });
        }
        
        // 渲染推荐网络
        function renderReferralNetwork(data) {
            // 显示结果区域
            $("#network-result").removeClass('d-none');
            
            // 渲染推荐链
            const chainList = $("#referral-chain");
            chainList.empty();
            
            if (data.referral_chain.length === 0) {
                chainList.append(`<li class="list-group-item">该用户没有上级推荐人</li>`);
            } else {
                data.referral_chain.forEach(item => {
                    chainList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>第${item.level}级推荐人:</strong> 
                                <span title="${item.referrer_address}">${truncateAddress(item.referrer_address)}</span>
                            </div>
                            <span class="badge bg-primary rounded-pill">${formatDate(item.joined_at)}</span>
                        </li>
                    `);
                });
            }
            
            // 渲染直接推荐的用户
            const referralsList = $("#direct-referrals");
            referralsList.empty();
            
            if (data.direct_referrals.length === 0) {
                referralsList.append(`<li class="list-group-item">该用户没有推荐任何下级用户</li>`);
            } else {
                data.direct_referrals.forEach(item => {
                    referralsList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span title="${item.user_address}">${truncateAddress(item.user_address)}</span>
                            <span class="badge bg-success rounded-pill">${formatDate(item.joined_at)}</span>
                        </li>
                    `);
                });
            }
        }
        
        // 辅助函数: 格式化日期时间
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // 辅助函数: 格式化日期
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-CN');
        }
        
        // 辅助函数: 截断地址
        function truncateAddress(address) {
            if (!address) return '-';
            if (address.length <= 13) return address;
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }
    </script>
</body>
</html> 