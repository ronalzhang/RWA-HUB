<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†é”€ç®¡ç† - RWA-HUBåå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¼</text></svg>">
<style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding: 20px;
            background-color: #f8f9fc;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e3e6f0;
            padding: 15px 20px;
        }
        .card-body {
            padding: 20px;
        }
        .border-left-primary {
            border-left: 4px solid #4e73df;
        }
        .border-left-success {
            border-left: 4px solid #1cc88a;
        }
        .border-left-info {
            border-left: 4px solid #36b9cc;
        }
        .text-primary {
            color: #4e73df !important;
        }
        .text-success {
            color: #1cc88a !important;
        }
        .text-info {
            color: #36b9cc !important;
        }
        .nav-pills .nav-link.active {
            background-color: #4e73df;
        }
        .nav-pills .nav-link {
            color: #4e73df;
        }
        .info-panel {
            background-color: #f8f9fc;
            border-left: 4px solid #36b9cc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
</style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3 mb-2 text-gray-800">åˆ†é”€ç³»ç»Ÿç®¡ç†</h1>
                <p class="mb-4">ç®¡ç†åˆ†é”€ç­‰çº§å’Œç”¨æˆ·æ¨èå…³ç³»</p>
                
                <!-- åˆ†é”€ç³»ç»Ÿè¯´æ˜ -->
                <div class="info-panel mb-4">
                    <h5><i class="fas fa-info-circle text-info"></i> åˆ†é”€ç³»ç»Ÿè¯´æ˜</h5>
                    <p>RWA-HUBå¹³å°é‡‡ç”¨ä¸‰çº§åˆ†é”€æ¨¡å¼ï¼Œå°†äº¤æ˜“ä½£é‡‘æŒ‰ç‰¹å®šæ¯”ä¾‹åˆ†é…ç»™æ¨èäººï¼š</p>
                    <ul>
                        <li><strong>ä¸€çº§åˆ†é”€ï¼ˆç›´æ¥æ¨èï¼‰</strong>ï¼šè·å¾—äº¤æ˜“ä½£é‡‘çš„<strong>30%</strong></li>
                        <li><strong>äºŒçº§åˆ†é”€ï¼ˆé—´æ¥æ¨èï¼‰</strong>ï¼šè·å¾—äº¤æ˜“ä½£é‡‘çš„<strong>20%</strong></li>
                        <li><strong>ä¸‰çº§åˆ†é”€ï¼ˆä¸‰çº§æ¨èï¼‰</strong>ï¼šè·å¾—äº¤æ˜“ä½£é‡‘çš„<strong>10%</strong></li>
                        <li><strong>å¹³å°ç•™å­˜</strong>ï¼šå‰©ä½™çš„<strong>40%</strong>ä½œä¸ºå¹³å°æ”¶å…¥</li>
                    </ul>
                    <p><strong>ä½£é‡‘è®¡ç®—ç¤ºä¾‹</strong>ï¼šå¯¹äºä¸€ç¬”100,000 USDCçš„å¤§é¢äº¤æ˜“ï¼ˆä½£é‡‘ç‡2.5%ï¼‰</p>
                    <ul>
                        <li>äº¤æ˜“ä½£é‡‘æ€»é¢ = 100,000 Ã— 2.5% = 2,500 USDC</li>
                        <li>ä¸€çº§åˆ†é”€ä½£é‡‘ = 2,500 Ã— 30% = 750 USDC</li>
                        <li>äºŒçº§åˆ†é”€ä½£é‡‘ = 2,500 Ã— 20% = 500 USDC</li>
                        <li>ä¸‰çº§åˆ†é”€ä½£é‡‘ = 2,500 Ã— 10% = 250 USDC</li>
                        <li>å¹³å°ç•™å­˜ = 2,500 Ã— 40% = 1,000 USDC</li>
                    </ul>
                    <p><strong>æ³¨æ„</strong>ï¼šä¿®æ”¹åˆ†é”€æ¯”ä¾‹è®¾ç½®å°†ç«‹å³å¯¹æ–°äº§ç”Ÿçš„äº¤æ˜“ç”Ÿæ•ˆã€‚</p>
                </div>
                
                <!-- é¡¶éƒ¨å¯¼èˆª -->
                <nav>
                    <div class="nav nav-pills mb-3" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-levels-tab" data-bs-toggle="tab" data-bs-target="#nav-levels" type="button" role="tab" aria-controls="nav-levels" aria-selected="true">åˆ†é”€ç­‰çº§ç®¡ç†</button>
                        <button class="nav-link" id="nav-referrals-tab" data-bs-toggle="tab" data-bs-target="#nav-referrals" type="button" role="tab" aria-controls="nav-referrals" aria-selected="false">ç”¨æˆ·æ¨èå…³ç³»</button>
                        <button class="nav-link" id="nav-network-tab" data-bs-toggle="tab" data-bs-target="#nav-network" type="button" role="tab" aria-controls="nav-network" aria-selected="false">æ¨èç½‘ç»œæŸ¥è¯¢</button>
                    </div>
                </nav>
                
                <!-- é€‰é¡¹å¡å†…å®¹ -->
                <div class="tab-content" id="nav-tabContent">
                    <!-- åˆ†é”€ç­‰çº§ç®¡ç† -->
                    <div class="tab-pane fade show active" id="nav-levels" role="tabpanel" aria-labelledby="nav-levels-tab">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0 font-weight-bold text-primary">åˆ†é”€ç­‰çº§åˆ—è¡¨</h5>
                                <button id="btn-add-level" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#levelModal">
                                    <i class="fa fa-plus"></i> æ·»åŠ ç­‰çº§
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-lightbulb"></i> å½“å‰åˆ†é”€æ¯”ä¾‹è®¾ç½®ï¼š
                                    <ul class="mb-0">
                                        <li><strong>ä¸€çº§åˆ†é”€ï¼ˆLevel 1ï¼‰</strong>: ä½£é‡‘æ¯”ä¾‹ 30%</li>
                                        <li><strong>äºŒçº§åˆ†é”€ï¼ˆLevel 2ï¼‰</strong>: ä½£é‡‘æ¯”ä¾‹ 20%</li>
                                        <li><strong>ä¸‰çº§åˆ†é”€ï¼ˆLevel 3ï¼‰</strong>: ä½£é‡‘æ¯”ä¾‹ 10%</li>
                                    </ul>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="levels-table" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>ç­‰çº§</th>
                                                <th>ä½£é‡‘æ¯”ä¾‹(%)</th>
                                                <th>æè¿°</th>
                                                <th>çŠ¶æ€</th>
                                                <th>åˆ›å»ºæ—¶é—´</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="levels-tbody">
                                            <!-- JSå¡«å……æ•°æ® -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”¨æˆ·æ¨èå…³ç³» -->
                    <div class="tab-pane fade" id="nav-referrals" role="tabpanel" aria-labelledby="nav-referrals-tab">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="m-0 font-weight-bold text-primary">ç”¨æˆ·æ¨èå…³ç³»</h5>
                                <button id="btn-add-referral" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#referralModal">
                                    <i class="fa fa-plus"></i> æ·»åŠ æ¨èå…³ç³»
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- æœç´¢æ¡† -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <input type="text" id="search-user" class="form-control" placeholder="æœç´¢ç”¨æˆ·åœ°å€">
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" id="search-referrer" class="form-control" placeholder="æœç´¢æ¨èäººåœ°å€">
                                    </div>
                                    <div class="col-md-4">
                                        <button id="btn-search-referrals" class="btn btn-primary">æœç´¢</button>
                                        <button id="btn-reset-referrals" class="btn btn-secondary">é‡ç½®</button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="referrals-table" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>ç”¨æˆ·åœ°å€</th>
                                                <th>æ¨èäººåœ°å€</th>
                                                <th>æ¨èç­‰çº§</th>
                                                <th>æ¨èç </th>
                                                <th>åŠ å…¥æ—¶é—´</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="referrals-tbody">
                                            <!-- JSå¡«å……æ•°æ® -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- åˆ†é¡µ -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        æ˜¾ç¤º <span id="referrals-showing">0-0</span> æ¡ï¼Œå…± <span id="referrals-total">0</span> æ¡
                                    </div>
                                    <div>
                                        <button id="referrals-prev" class="btn btn-sm btn-outline-primary">ä¸Šä¸€é¡µ</button>
                                        <span id="referrals-page" class="mx-2">1</span>
                                        <button id="referrals-next" class="btn btn-sm btn-outline-primary">ä¸‹ä¸€é¡µ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¨èç½‘ç»œæŸ¥è¯¢ -->
                    <div class="tab-pane fade" id="nav-network" role="tabpanel" aria-labelledby="nav-network-tab">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="m-0 font-weight-bold text-primary">æ¨èç½‘ç»œæŸ¥è¯¢</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <input type="text" id="network-address" class="form-control" placeholder="è¾“å…¥é’±åŒ…åœ°å€æŸ¥è¯¢æ¨èç½‘ç»œ">
                                    </div>
                                    <div class="col-md-4">
                                        <button id="btn-search-network" class="btn btn-primary">æŸ¥è¯¢</button>
                                    </div>
                                </div>
                                
                                <div id="network-result" class="d-none">
                                    <div class="row">
                                        <!-- ä¸Šçº§é“¾ -->
                                        <div class="col-md-6">
                                            <div class="card border-left-primary">
                                                <div class="card-header">
                                                    <h6 class="m-0 font-weight-bold text-primary">æ¨èé“¾ (ä¸Šçº§)</h6>
                                                </div>
                                                <div class="card-body">
                                                    <ul id="referral-chain" class="list-group">
                                                        <!-- JSå¡«å……æ•°æ® -->
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- ç›´æ¥æ¨èçš„ç”¨æˆ· -->
                                        <div class="col-md-6">
                                            <div class="card border-left-success">
                                                <div class="card-header">
                                                    <h6 class="m-0 font-weight-bold text-success">ä¸‹çº§ç”¨æˆ·</h6>
                                                </div>
                                                <div class="card-body">
                                                    <ul id="direct-referrals" class="list-group">
                                                        <!-- JSå¡«å……æ•°æ® -->
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ†é”€ç­‰çº§æ¨¡æ€æ¡† -->
    <div class="modal fade" id="levelModal" tabindex="-1" aria-labelledby="levelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="levelModalLabel">æ·»åŠ åˆ†é”€ç­‰çº§</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="level-form">
                        <input type="hidden" id="level-id">
                        <div class="mb-3">
                            <label for="level-level" class="form-label">ç­‰çº§</label>
                            <input type="number" class="form-control" id="level-level" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="level-rate" class="form-label">ä½£é‡‘æ¯”ä¾‹ (%)</label>
                            <input type="number" class="form-control" id="level-rate" required min="0" max="100" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="level-description" class="form-label">æè¿°</label>
                            <textarea class="form-control" id="level-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="level-active" checked>
                            <label class="form-check-label" for="level-active">å¯ç”¨</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="btn-save-level">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ¨èå…³ç³»æ¨¡æ€æ¡† -->
    <div class="modal fade" id="referralModal" tabindex="-1" aria-labelledby="referralModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="referralModalLabel">æ·»åŠ æ¨èå…³ç³»</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="referral-form">
                        <input type="hidden" id="referral-id">
                        <div class="mb-3">
                            <label for="referral-user" class="form-label">ç”¨æˆ·åœ°å€</label>
                            <input type="text" class="form-control" id="referral-user" required>
                        </div>
                        <div class="mb-3">
                            <label for="referral-referrer" class="form-label">æ¨èäººåœ°å€</label>
                            <input type="text" class="form-control" id="referral-referrer" required>
                        </div>
                        <div class="mb-3">
                            <label for="referral-level" class="form-label">æ¨èç­‰çº§</label>
                            <input type="number" class="form-control" id="referral-level" value="1" min="1">
                        </div>
                        <div class="mb-3">
                            <label for="referral-code" class="form-label">æ¨èç </label>
                            <input type="text" class="form-control" id="referral-code">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="btn-save-referral">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentReferralPage = 1;
        const referralPerPage = 10;
        let totalReferrals = 0;
        let totalReferralPages = 0;
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        $(document).ready(function() {
            // åŠ è½½åˆ†é”€ç­‰çº§
            loadDistributionLevels();
            
            // åŠ è½½ç”¨æˆ·æ¨èå…³ç³»
            loadUserReferrals(1);
            
            // ç›‘å¬æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $("#btn-save-level").click(saveDistributionLevel);
            $("#btn-save-referral").click(saveUserReferral);
            $("#btn-search-referrals").click(() => loadUserReferrals(1));
            $("#btn-reset-referrals").click(resetReferralSearch);
            $("#btn-search-network").click(searchReferralNetwork);
            $("#referrals-prev").click(() => loadUserReferrals(currentReferralPage - 1));
            $("#referrals-next").click(() => loadUserReferrals(currentReferralPage + 1));
        });
        
        // åŠ è½½åˆ†é”€ç­‰çº§
        function loadDistributionLevels() {
            fetch('/api/admin/v2/distribution-levels')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderDistributionLevels(data.data);
                    } else {
                        alert('åŠ è½½åˆ†é”€ç­‰çº§å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½åˆ†é”€ç­‰çº§å¤±è´¥:', error);
                    alert('åŠ è½½åˆ†é”€ç­‰çº§å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }
        
        // æ¸²æŸ“åˆ†é”€ç­‰çº§è¡¨æ ¼
        function renderDistributionLevels(levels) {
            const tbody = $("#levels-tbody");
            tbody.empty();
            
            if (levels.length === 0) {
                tbody.append(`<tr><td colspan="7" class="text-center">æš‚æ— æ•°æ®</td></tr>`);
                return;
            }
            
            levels.forEach(level => {
                tbody.append(`
                    <tr>
                        <td>${level.id}</td>
                        <td>${level.level}</td>
                        <td>${level.commission_rate}</td>
                        <td>${level.description || '-'}</td>
                        <td>${level.is_active ? '<span class="badge bg-success">å¯ç”¨</span>' : '<span class="badge bg-secondary">ç¦ç”¨</span>'}</td>
                        <td>${formatDateTime(level.created_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-edit-level" data-id="${level.id}">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-delete-level" data-id="${level.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // æ·»åŠ ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
            $(".btn-edit-level").click(function() {
                const id = $(this).data('id');
                const level = levels.find(l => l.id === id);
                if (level) {
                    openLevelModal(level);
                }
            });
            
            $(".btn-delete-level").click(function() {
                const id = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤åˆ†é”€ç­‰çº§å—ï¼Ÿ')) {
                    deleteDistributionLevel(id);
                }
            });
        }
        
        // æ‰“å¼€åˆ†é”€ç­‰çº§æ¨¡æ€æ¡†
        function openLevelModal(level = null) {
            const modal = $("#levelModal");
            const modalTitle = $("#levelModalLabel");
            
            // é‡ç½®è¡¨å•
            $("#level-form")[0].reset();
            $("#level-id").val('');
            
            if (level) {
                modalTitle.text('ç¼–è¾‘åˆ†é”€ç­‰çº§');
                $("#level-id").val(level.id);
                $("#level-level").val(level.level);
                $("#level-rate").val(level.commission_rate);
                $("#level-description").val(level.description);
                $("#level-active").prop('checked', level.is_active);
            } else {
                modalTitle.text('æ·»åŠ åˆ†é”€ç­‰çº§');
            }
            
            // æ‰“å¼€æ¨¡æ€æ¡†
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // ä¿å­˜åˆ†é”€ç­‰çº§
        function saveDistributionLevel() {
            const id = $("#level-id").val();
            const level = parseInt($("#level-level").val());
            const rate = parseFloat($("#level-rate").val());
            const description = $("#level-description").val();
            const isActive = $("#level-active").is(':checked');
            
            const data = {
                level: level,
                commission_rate: rate,
                description: description,
                is_active: isActive
            };
            
            let url = '/api/admin/v2/distribution-levels';
            let method = 'POST';
            
            if (id) {
                url += `/${id}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(id ? 'åˆ†é”€ç­‰çº§æ›´æ–°æˆåŠŸ' : 'åˆ†é”€ç­‰çº§åˆ›å»ºæˆåŠŸ');
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('levelModal'));
                    modal.hide();
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadDistributionLevels();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜åˆ†é”€ç­‰çº§å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }
        
        // åˆ é™¤åˆ†é”€ç­‰çº§
        function deleteDistributionLevel(id) {
            fetch(`/api/admin/v2/distribution-levels/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('åˆ†é”€ç­‰çº§åˆ é™¤æˆåŠŸ');
                    loadDistributionLevels();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤åˆ†é”€ç­‰çº§å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }
        
        // åŠ è½½ç”¨æˆ·æ¨èå…³ç³»
        function loadUserReferrals(page) {
            const userAddress = $("#search-user").val();
            const referrerAddress = $("#search-referrer").val();
            
            let url = `/api/admin/v2/user-referrals?page=${page}&per_page=${referralPerPage}`;
            
            if (userAddress) {
                url += `&user_address=${userAddress}`;
            }
            
            if (referrerAddress) {
                url += `&referrer_address=${referrerAddress}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderUserReferrals(data.data, data.pagination);
                    } else {
                        alert('åŠ è½½æ¨èå…³ç³»å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ¨èå…³ç³»å¤±è´¥:', error);
                    alert('åŠ è½½æ¨èå…³ç³»å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }
        
        // æ¸²æŸ“ç”¨æˆ·æ¨èå…³ç³»è¡¨æ ¼
        function renderUserReferrals(referrals, pagination) {
            const tbody = $("#referrals-tbody");
            tbody.empty();
            
            currentReferralPage = pagination.page;
            totalReferrals = pagination.total;
            totalReferralPages = pagination.pages;
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const start = (pagination.page - 1) * pagination.per_page + 1;
            const end = Math.min(pagination.page * pagination.per_page, pagination.total);
            $("#referrals-showing").text(`${start}-${end}`);
            $("#referrals-total").text(pagination.total);
            $("#referrals-page").text(pagination.page);
            
            // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
            $("#referrals-prev").prop('disabled', !pagination.has_prev);
            $("#referrals-next").prop('disabled', !pagination.has_next);
            
            if (referrals.length === 0) {
                tbody.append(`<tr><td colspan="7" class="text-center">æš‚æ— æ•°æ®</td></tr>`);
                return;
            }
            
            referrals.forEach(referral => {
                tbody.append(`
                    <tr>
                        <td>${referral.id}</td>
                        <td title="${referral.user_address}">${truncateAddress(referral.user_address)}</td>
                        <td title="${referral.referrer_address}">${truncateAddress(referral.referrer_address)}</td>
                        <td>${referral.referral_level}</td>
                        <td>${referral.referral_code || '-'}</td>
                        <td>${formatDateTime(referral.joined_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-edit-referral" data-id="${referral.id}">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-delete-referral" data-id="${referral.id}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // æ·»åŠ ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
            $(".btn-edit-referral").click(function() {
                const id = $(this).data('id');
                const referral = referrals.find(r => r.id === id);
                if (referral) {
                    openReferralModal(referral);
                }
            });
            
            $(".btn-delete-referral").click(function() {
                const id = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¨èå…³ç³»å—ï¼Ÿ')) {
                    deleteUserReferral(id);
                }
            });
        }
        
        // é‡ç½®æ¨èå…³ç³»æœç´¢
        function resetReferralSearch() {
            $("#search-user").val('');
            $("#search-referrer").val('');
            loadUserReferrals(1);
        }
        
        // æ‰“å¼€æ¨èå…³ç³»æ¨¡æ€æ¡†
        function openReferralModal(referral = null) {
            const modal = $("#referralModal");
            const modalTitle = $("#referralModalLabel");
            
            // é‡ç½®è¡¨å•
            $("#referral-form")[0].reset();
            $("#referral-id").val('');
            
            if (referral) {
                modalTitle.text('ç¼–è¾‘æ¨èå…³ç³»');
                $("#referral-id").val(referral.id);
                $("#referral-user").val(referral.user_address);
                $("#referral-user").prop('disabled', true);  // ä¸å…è®¸ä¿®æ”¹ç”¨æˆ·åœ°å€
                $("#referral-referrer").val(referral.referrer_address);
                $("#referral-level").val(referral.referral_level);
                $("#referral-code").val(referral.referral_code);
            } else {
                modalTitle.text('æ·»åŠ æ¨èå…³ç³»');
                $("#referral-user").prop('disabled', false);
            }
            
            // æ‰“å¼€æ¨¡æ€æ¡†
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // ä¿å­˜ç”¨æˆ·æ¨èå…³ç³»
        function saveUserReferral() {
            const id = $("#referral-id").val();
            const userAddress = $("#referral-user").val();
            const referrerAddress = $("#referral-referrer").val();
            const level = parseInt($("#referral-level").val());
            const code = $("#referral-code").val();
            
            if (!userAddress || !referrerAddress) {
                alert('ç”¨æˆ·åœ°å€å’Œæ¨èäººåœ°å€ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            const data = {
                user_address: userAddress,
                referrer_address: referrerAddress,
                referral_level: level,
                referral_code: code
            };
            
            let url = '/api/admin/v2/user-referrals';
            let method = 'POST';
            
            if (id) {
                url += `/${id}`;
                method = 'PUT';
                // ç¼–è¾‘æ—¶ä¸ä¼ ç”¨æˆ·åœ°å€
                delete data.user_address;
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(id ? 'æ¨èå…³ç³»æ›´æ–°æˆåŠŸ' : 'æ¨èå…³ç³»åˆ›å»ºæˆåŠŸ');
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('referralModal'));
                    modal.hide();
                    // é‡æ–°åŠ è½½æ•°æ®
                    loadUserReferrals(currentReferralPage);
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜æ¨èå…³ç³»å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }
        
        // åˆ é™¤ç”¨æˆ·æ¨èå…³ç³»
        function deleteUserReferral(id) {
            fetch(`/api/admin/v2/user-referrals/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('æ¨èå…³ç³»åˆ é™¤æˆåŠŸ');
                    loadUserReferrals(currentReferralPage);
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤æ¨èå…³ç³»å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }
        
        // æŸ¥è¯¢æ¨èç½‘ç»œ
        function searchReferralNetwork() {
            const address = $("#network-address").val();
            
            if (!address) {
                alert('è¯·è¾“å…¥é’±åŒ…åœ°å€');
                return;
            }
            
            fetch(`/api/admin/v2/user-referrals/network/${address}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderReferralNetwork(data.data);
                    } else {
                        alert('æŸ¥è¯¢å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('æŸ¥è¯¢æ¨èç½‘ç»œå¤±è´¥:', error);
                    alert('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }
        
        // æ¸²æŸ“æ¨èç½‘ç»œ
        function renderReferralNetwork(data) {
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            $("#network-result").removeClass('d-none');
            
            // æ¸²æŸ“æ¨èé“¾
            const chainList = $("#referral-chain");
            chainList.empty();
            
            if (data.referral_chain.length === 0) {
                chainList.append(`<li class="list-group-item">è¯¥ç”¨æˆ·æ²¡æœ‰ä¸Šçº§æ¨èäºº</li>`);
            } else {
                data.referral_chain.forEach(item => {
                    chainList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>ç¬¬${item.level}çº§æ¨èäºº:</strong> 
                                <span title="${item.referrer_address}">${truncateAddress(item.referrer_address)}</span>
                            </div>
                            <span class="badge bg-primary rounded-pill">${formatDate(item.joined_at)}</span>
                        </li>
                    `);
                });
            }
            
            // æ¸²æŸ“ç›´æ¥æ¨èçš„ç”¨æˆ·
            const referralsList = $("#direct-referrals");
            referralsList.empty();
            
            if (data.direct_referrals.length === 0) {
                referralsList.append(`<li class="list-group-item">è¯¥ç”¨æˆ·æ²¡æœ‰æ¨èä»»ä½•ä¸‹çº§ç”¨æˆ·</li>`);
            } else {
                data.direct_referrals.forEach(item => {
                    referralsList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span title="${item.user_address}">${truncateAddress(item.user_address)}</span>
                            <span class="badge bg-success rounded-pill">${formatDate(item.joined_at)}</span>
                        </li>
                    `);
                });
            }
        }
        
        // è¾…åŠ©å‡½æ•°: æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // è¾…åŠ©å‡½æ•°: æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleDateString('zh-CN');
        }
        
        // è¾…åŠ©å‡½æ•°: æˆªæ–­åœ°å€
        function truncateAddress(address) {
            if (!address) return '-';
            if (address.length <= 13) return address;
            return address.substring(0, 6) + '...' + address.substring(address.length - 4);
        }
    </script>
</body>
</html> 