<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Solana APIè°ƒç”¨æ—¥å¿— - RWA-HUBåå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="{{ url_for("static", filename="fonts/fontawesome/css/all.min.css") }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”Œ</text></svg>">
    
<style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            padding-top: 56px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            background-color: #f8f9fc;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e3e6f0;
            padding: 15px 20px;
        }
        .card-body {
            padding: 20px;
        }
        .page-container {
            padding: 20px;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .navbar-nav .nav-link.active {
            font-weight: bold;
            color: #4e73df;
        }
        .badge {
            font-size: 85%;
        }
        .badge-success {
            background-color: #1cc88a;
        }
        .badge-danger {
            background-color: #e74a3b;
        }
        .badge-warning {
            background-color: #f6c23e;
        }
        .filter-card {
            margin-bottom: 20px;
        }
        .json-viewer {
            max-height: 500px;
            overflow-y: auto;
            background: #f8f9fc;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .highlight-row {
            background-color: rgba(78, 115, 223, 0.1);
        }
        .pagination-container {
            margin-top: 20px;
        }
        /* è‡ªå®šä¹‰JSONæ ·å¼ */
        .json-key {
            color: #7e57c2;
        }
        .json-string {
            color: #4caf50;
        }
        .json-number {
            color: #2196f3;
        }
        .json-boolean {
            color: #ff9800;
        }
        .json-null {
            color: #f44336;
        }
        /* APIè°ƒç”¨ç‰¹æœ‰æ ·å¼ */
        .method-get {
            color: #4e73df;
            font-weight: bold;
        }
        .method-post {
            color: #1cc88a;
            font-weight: bold;
        }
        .method-put {
            color: #f6c23e;
            font-weight: bold;
        }
        .method-delete {
            color: #e74a3b;
            font-weight: bold;
        }
        .response-time {
            font-size: 0.9em;
            color: #666;
        }
        .status-success {
            color: #1cc88a;
        }
        .status-error {
            color: #e74a3b;
        }
</style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-building me-2"></i>RWA-HUBç®¡ç†ç³»ç»Ÿ
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>ä»ªè¡¨ç›˜
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/assets">
                            <i class="fas fa-building me-1"></i>èµ„äº§ç®¡ç†
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="solanaDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-solar-panel me-1"></i>Solanaç›‘æ§
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/solana/dashboard">ç›‘æ§ä»ªè¡¨ç›˜</a></li>
                            <li><a class="dropdown-item" href="/admin/solana/transactions">äº¤æ˜“æ—¥å¿—</a></li>
                            <li><a class="dropdown-item active" href="/admin/solana/api-logs">APIè°ƒç”¨æ—¥å¿—</a></li>
                            <li><a class="dropdown-item" href="/admin/solana/error-logs">é”™è¯¯æ—¥å¿—</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/operation_logs">
                            <i class="fas fa-history me-1"></i>æ“ä½œæ—¥å¿—
                        </a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="/" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-home me-1"></i>å›åˆ°é¦–é¡µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="page-container">
        <div class="container-fluid">
            <div class="d-sm-flex align-items-center justify-content-between mb-4">
                <h1 class="h3 mb-0 text-gray-800">Solana APIè°ƒç”¨æ—¥å¿—</h1>
                <button class="btn btn-primary btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                </button>
            </div>
            
            <div id="alertArea" class="mb-4"></div>
            
            <!-- è¿‡æ»¤å™¨å¡ç‰‡ -->
            <div class="card shadow filter-card">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">ç­›é€‰æ¡ä»¶</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="endpoint" class="form-label">ç«¯ç‚¹</label>
                            <input type="text" class="form-control" id="endpoint" placeholder="è¾“å…¥APIç«¯ç‚¹">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="method" class="form-label">è¯·æ±‚æ–¹æ³•</label>
                            <select class="form-select" id="method">
                                <option value="">å…¨éƒ¨</option>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="status_code" class="form-label">çŠ¶æ€ç </label>
                            <input type="text" class="form-control" id="status_code" placeholder="ä¾‹å¦‚: 200, 404">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="response_time" class="form-label">å“åº”æ—¶é—´</label>
                            <select class="form-select" id="response_time">
                                <option value="">å…¨éƒ¨</option>
                                <option value="fast">å¿«é€Ÿ (< 100ms)</option>
                                <option value="medium">ä¸­ç­‰ (100-500ms)</option>
                                <option value="slow">æ…¢é€Ÿ (> 500ms)</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="searchQuery" class="form-label">å…³é”®å­—æœç´¢</label>
                            <input type="text" class="form-control" id="searchQuery" placeholder="æœç´¢å…³é”®å­—...">
                        </div>
                        <div class="col-md-4 mb-3 d-flex align-items-end">
                            <button class="btn btn-primary w-100" id="searchBtn">
                                <i class="fas fa-search me-2"></i>æœç´¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- APIæ—¥å¿—è¡¨æ ¼ -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">APIè°ƒç”¨è®°å½•</h6>
                    <div class="dropdown no-arrow">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end">
                            <button class="dropdown-item" id="exportCsvBtn">å¯¼å‡ºCSV</button>
                            <button class="dropdown-item" id="exportJsonBtn">å¯¼å‡ºJSON</button>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" id="clearFiltersBtn">æ¸…é™¤ç­›é€‰</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>è¯·æ±‚æ–¹æ³•</th>
                                    <th>ç«¯ç‚¹</th>
                                    <th>çŠ¶æ€ç </th>
                                    <th>å“åº”æ—¶é—´</th>
                                    <th>å®¢æˆ·ç«¯IP</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="apiLogsTable">
                                <!-- JavaScriptå°†å¡«å……æ­¤å¤„ -->
                                <tr>
                                    <td colspan="7" class="text-center">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µå¯¼èˆª -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div class="dataTables_info" id="paginationInfo">æ˜¾ç¤º 0 åˆ° 0ï¼Œå…± 0 æ¡è®°å½•</div>
                        <div class="dataTables_paginate paging_simple_numbers">
                            <ul class="pagination" id="pagination">
                                <!-- JavaScriptå°†å¡«å……æ­¤å¤„ -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- APIè°ƒç”¨è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="apiDetailModal" tabindex="-1" aria-labelledby="apiDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="apiDetailModalLabel">APIè°ƒç”¨è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="detailTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">æ¦‚è¦</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="request-tab" data-bs-toggle="tab" data-bs-target="#request" type="button" role="tab">è¯·æ±‚æ•°æ®</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="response-tab" data-bs-toggle="tab" data-bs-target="#response" type="button" role="tab">å“åº”æ•°æ®</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="detailTabsContent">
                        <div class="tab-pane fade show active" id="summary" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>æ—¶é—´:</strong> <span id="detail-timestamp"></span></p>
                                    <p><strong>è¯·æ±‚æ–¹æ³•:</strong> <span id="detail-method"></span></p>
                                    <p><strong>ç«¯ç‚¹:</strong> <span id="detail-endpoint"></span></p>
                                    <p><strong>çŠ¶æ€ç :</strong> <span id="detail-status-code"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>å“åº”æ—¶é—´:</strong> <span id="detail-response-time"></span></p>
                                    <p><strong>å®¢æˆ·ç«¯IP:</strong> <span id="detail-client-ip"></span></p>
                                    <p><strong>ç”¨æˆ·ID:</strong> <span id="detail-user-id"></span></p>
                                    <p><strong>ç”¨æˆ·ä»£ç†:</strong> <span id="detail-user-agent"></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="request" role="tabpanel">
                            <h6>è¯·æ±‚å‚æ•°</h6>
                            <div class="json-viewer" id="detail-request-params"></div>
                            
                            <h6 class="mt-3">è¯·æ±‚å¤´</h6>
                            <div class="json-viewer" id="detail-request-headers"></div>
                        </div>
                        <div class="tab-pane fade" id="response" role="tabpanel">
                            <h6>å“åº”æ•°æ®</h6>
                            <div class="json-viewer" id="detail-response-data"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let pageSize = 20;
        let totalItems = 0;
        let totalPages = 0;
        let currentFilters = {};
        
        // é¡µé¢åŠ è½½åæ‰§è¡Œ
        $(document).ready(function() {
            loadApiLogs();
            
            // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#refreshBtn').click(function() {
                loadApiLogs();
            });
            
            // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#searchBtn').click(function() {
                currentPage = 1;
                collectFilters();
                loadApiLogs();
            });
            
            // æ¸…é™¤ç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#clearFiltersBtn').click(function() {
                clearFilters();
                loadApiLogs();
            });
            
            // å¯¼å‡ºCSVæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#exportCsvBtn').click(function() {
                exportData('csv');
            });
            
            // å¯¼å‡ºJSONæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#exportJsonBtn').click(function() {
                exportData('json');
            });
            
            // å›è½¦é”®æœç´¢
            $('#searchQuery, #endpoint, #status_code').keypress(function(e) {
                if (e.which === 13) {
                    $('#searchBtn').click();
                }
            });
        });
        
        // æ”¶é›†è¿‡æ»¤æ¡ä»¶
        function collectFilters() {
            currentFilters = {};
            
            const endpoint = $('#endpoint').val().trim();
            if (endpoint) currentFilters.endpoint = endpoint;
            
            const method = $('#method').val();
            if (method) currentFilters.method = method;
            
            const statusCode = $('#status_code').val().trim();
            if (statusCode) currentFilters.status_code = statusCode;
            
            const responseTime = $('#response_time').val();
            if (responseTime) currentFilters.response_time = responseTime;
            
            const searchQuery = $('#searchQuery').val().trim();
            if (searchQuery) currentFilters.query = searchQuery;
        }
        
        // æ¸…é™¤è¿‡æ»¤æ¡ä»¶
        function clearFilters() {
            $('#endpoint').val('');
            $('#method').val('');
            $('#status_code').val('');
            $('#response_time').val('');
            $('#searchQuery').val('');
            currentFilters = {};
        }
        
        // åŠ è½½APIæ—¥å¿—æ•°æ®
        function loadApiLogs() {
            showAlert('info', 'æ­£åœ¨åŠ è½½æ•°æ®...');
            
            // æ„å»ºAPIè¯·æ±‚å‚æ•°
            const params = {
                ...currentFilters,
                limit: pageSize,
                offset: (currentPage - 1) * pageSize
            };
            
            let apiEndpoint = '/admin/solana/api/api-logs';
            if (params.query) {
                apiEndpoint = '/admin/solana/api/search';
                params.type = 'api';
            }
            
            $.ajax({
                url: apiEndpoint,
                method: 'GET',
                data: params,
                success: function(data) {
                    updateApiLogsTable(data);
                    updatePagination(data);
                    showAlert('success', 'æ•°æ®åŠ è½½æˆåŠŸ!');
                },
                error: function(xhr, status, error) {
                    showAlert('danger', 'åŠ è½½APIæ—¥å¿—æ•°æ®å¤±è´¥: ' + error);
                    // æ¸…ç©ºè¡¨æ ¼
                    $('#apiLogsTable').html('<tr><td colspan="7" class="text-center">åŠ è½½æ•°æ®å¤±è´¥</td></tr>');
                }
            });
        }
        
        // æ›´æ–°APIæ—¥å¿—è¡¨æ ¼
        function updateApiLogsTable(data) {
            const tableBody = $('#apiLogsTable');
            tableBody.empty();
            
            if (!data.logs || data.logs.length === 0) {
                tableBody.append('<tr><td colspan="7" class="text-center">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„APIè°ƒç”¨è®°å½•</td></tr>');
                return;
            }
            
            data.logs.forEach((log, index) => {
                const rowClass = index % 2 === 0 ? '' : 'highlight-row';
                const methodClass = getMethodClass(log.method);
                const statusClass = getStatusClass(log.status_code);
                
                const row = `<tr class="${rowClass}">
                    <td>${formatDateTime(log.timestamp)}</td>
                    <td><span class="${methodClass}">${log.method || 'UNKNOWN'}</span></td>
                    <td>
                        <span class="text-truncate d-inline-block" style="max-width: 150px;" title="${log.endpoint || ''}">
                            ${log.endpoint || 'æœªçŸ¥'}
                        </span>
                    </td>
                    <td><span class="${statusClass}">${log.status_code || 'æœªçŸ¥'}</span></td>
                    <td><span class="response-time">${formatResponseTime(log.response_time)}</span></td>
                    <td>${log.client_ip || 'æœªçŸ¥'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary viewDetailsBtn" data-log='${JSON.stringify(log)}'>
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>`;
                tableBody.append(row);
            });
            
            // ç»‘å®šæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®äº‹ä»¶
            $('.viewDetailsBtn').click(function() {
                const logData = $(this).data('log');
                showApiDetails(logData);
            });
        }
        
        // æ›´æ–°åˆ†é¡µ
        function updatePagination(data) {
            totalItems = data.total || 0;
            totalPages = Math.ceil(totalItems / pageSize);
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const start = Math.min(totalItems, (currentPage - 1) * pageSize + 1);
            const end = Math.min(totalItems, currentPage * pageSize);
            $('#paginationInfo').text(`æ˜¾ç¤º ${start} åˆ° ${end}ï¼Œå…± ${totalItems} æ¡è®°å½•`);
            
            // ç”Ÿæˆåˆ†é¡µé“¾æ¥
            const pagination = $('#pagination');
            pagination.empty();
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            pagination.append(`
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="ä¸Šä¸€é¡µ">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `);
            
            // é¡µç æŒ‰é’®
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                pagination.append(`
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            pagination.append(`
                <li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="ä¸‹ä¸€é¡µ">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `);
            
            // ç»‘å®šé¡µç ç‚¹å‡»äº‹ä»¶
            $('.page-link').click(function(e) {
                e.preventDefault();
                if ($(this).parent().hasClass('disabled')) return;
                
                const targetPage = $(this).data('page');
                if (targetPage >= 1 && targetPage <= totalPages) {
                    currentPage = targetPage;
                    loadApiLogs();
                }
            });
        }
        
        // æ˜¾ç¤ºAPIè°ƒç”¨è¯¦æƒ…
        function showApiDetails(log) {
            // å¡«å……æ¦‚è¦ä¿¡æ¯
            $('#detail-timestamp').text(formatDateTime(log.timestamp));
            $('#detail-method').html(`<span class="${getMethodClass(log.method)}">${log.method || 'UNKNOWN'}</span>`);
            $('#detail-endpoint').text(log.endpoint || 'æœªçŸ¥');
            $('#detail-status-code').html(`<span class="${getStatusClass(log.status_code)}">${log.status_code || 'æœªçŸ¥'}</span>`);
            $('#detail-response-time').text(formatResponseTime(log.response_time));
            $('#detail-client-ip').text(log.client_ip || 'æœªçŸ¥');
            $('#detail-user-id').text(log.user_id || 'æœªçŸ¥');
            $('#detail-user-agent').text(log.user_agent || 'æœªçŸ¥');
            
            // æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºè¯·æ±‚æ•°æ®
            $('#detail-request-params').html(formatJSON(log.request_params || {}));
            $('#detail-request-headers').html(formatJSON(log.request_headers || {}));
            
            // æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºå“åº”æ•°æ®
            $('#detail-response-data').html(formatJSON(log.response_data || {}));
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('apiDetailModal'));
            modal.show();
        }
        
        // è·å–è¯·æ±‚æ–¹æ³•æ ·å¼ç±»
        function getMethodClass(method) {
            if (!method) return '';
            
            method = method.toUpperCase();
            if (method === 'GET') return 'method-get';
            if (method === 'POST') return 'method-post';
            if (method === 'PUT') return 'method-put';
            if (method === 'DELETE') return 'method-delete';
            return '';
        }
        
        // è·å–çŠ¶æ€ç æ ·å¼ç±»
        function getStatusClass(statusCode) {
            if (!statusCode) return '';
            
            if (statusCode >= 200 && statusCode < 400) {
                return 'status-success';
            } else {
                return 'status-error';
            }
        }
        
        // æ ¼å¼åŒ–å“åº”æ—¶é—´
        function formatResponseTime(time) {
            if (time === undefined || time === null) return 'æœªçŸ¥';
            
            return time.toFixed(2) + 'ms';
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportData(format) {
            // æ˜¾ç¤ºåŠ è½½æç¤º
            showAlert('info', `æ­£åœ¨å‡†å¤‡å¯¼å‡º${format.toUpperCase()}æ•°æ®...`);
            
            // æ„å»ºAPIè¯·æ±‚å‚æ•°ï¼Œè·å–æ‰€æœ‰æ•°æ®ï¼ˆæš‚ä¸è€ƒè™‘åˆ†é¡µï¼‰
            const params = {
                ...currentFilters,
                limit: 1000,
                offset: 0
            };
            
            let apiEndpoint = '/admin/solana/api/api-logs';
            if (params.query) {
                apiEndpoint = '/admin/solana/api/search';
                params.type = 'api';
            }
            
            $.ajax({
                url: apiEndpoint,
                method: 'GET',
                data: params,
                success: function(data) {
                    if (!data.logs || data.logs.length === 0) {
                        showAlert('warning', 'æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                        return;
                    }
                    
                    if (format === 'csv') {
                        exportCSV(data.logs);
                    } else {
                        exportJSON(data.logs);
                    }
                    
                    showAlert('success', `æˆåŠŸå¯¼å‡º${data.logs.length}æ¡è®°å½•`);
                },
                error: function(xhr, status, error) {
                    showAlert('danger', `å¯¼å‡ºæ•°æ®å¤±è´¥: ${error}`);
                }
            });
        }
        
        // å¯¼å‡ºCSV
        function exportCSV(data) {
            // å®šä¹‰CSVå¤´
            const headers = ['æ—¶é—´', 'è¯·æ±‚æ–¹æ³•', 'ç«¯ç‚¹', 'çŠ¶æ€ç ', 'å“åº”æ—¶é—´(ms)', 'å®¢æˆ·ç«¯IP', 'ç”¨æˆ·ID'];
            
            // å°†æ•°æ®è½¬æ¢ä¸ºCSVè¡Œ
            const rows = data.map(log => [
                formatDateTime(log.timestamp),
                log.method || '',
                log.endpoint || '',
                log.status_code || '',
                log.response_time || '',
                log.client_ip || '',
                log.user_id || ''
            ]);
            
            // å°†å¤´å’Œè¡Œåˆå¹¶ï¼Œç„¶åæ¯è¡Œç”¨é€—å·åˆ†éš”
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            downloadFile(csvContent, 'solana_api_logs.csv', 'text/csv');
        }
        
        // å¯¼å‡ºJSON
        function exportJSON(data) {
            const jsonContent = JSON.stringify(data, null, 2);
            downloadFile(jsonContent, 'solana_api_logs.json', 'application/json');
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString();
        }
        
        // æ ¼å¼åŒ–JSONä¸ºé«˜äº®æ˜¾ç¤º
        function formatJSON(obj) {
            return syntaxHighlight(JSON.stringify(obj, null, 2));
        }
        
        // JSONè¯­æ³•é«˜äº®
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        function showAlert(type, message) {
            const alertArea = $('#alertArea');
            alertArea.empty();
            
            const alertClass = type === 'success' ? 'alert-success' :
                               type === 'info' ? 'alert-info' :
                               type === 'warning' ? 'alert-warning' : 'alert-danger';
            
            const alert = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertArea.append(alert);
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸå’Œä¿¡æ¯æç¤º
            if (type === 'success' || type === 'info') {
                setTimeout(function() {
                    $('.alert').alert('close');
                }, 3000);
            }
        }
    </script>
</body>
</html> 