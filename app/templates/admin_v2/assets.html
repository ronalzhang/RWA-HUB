{% extends "admin_v2/base.html" %}

{% block title %}RWA-HUB 管理后台 - 资产管理{% endblock %}

{% block page_title %}资产管理{% endblock %}
{% block page_subtitle %}管理平台上的实物资产{% endblock %}

{% block breadcrumb %}
<li aria-current="page">
    <div class="flex items-center">
        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
        <span class="text-gray-500">资产管理</span>
    </div>
</li>
{% endblock %}

{% block content %}
<div x-data="assetManagement()" x-init="loadData()" x-cloak>
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 mr-4">
                    <i class="fas fa-cubes text-blue-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">总资产数量</h3>
                    <p class="text-2xl font-bold" x-text="stats.totalAssets || 0"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 mr-4">
                    <i class="fas fa-dollar-sign text-green-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">资产总价值</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.totalValue || 0)"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-yellow-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 mr-4">
                    <i class="fas fa-clock text-yellow-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">待审核资产</h3>
                    <p class="text-2xl font-bold" x-text="stats.pendingAssets || 0"></p>
                </div>
            </div>
        </div>
        
        <!-- 总分红量统计 -->
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-orange-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-orange-100 mr-4">
                    <i class="fas fa-coins text-orange-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">总分红量</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.totalDividends || 0)"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 资产管理主面板 -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <!-- 标签页导航 -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button @click="activeTab = 'assets'" 
                        :class="activeTab === 'assets' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-cubes mr-2"></i>资产列表
                </button>
                <button @click="activeTab = 'dividends'" 
                        :class="activeTab === 'dividends' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-coins mr-2"></i>分红列表
                </button>
                <button @click="activeTab = 'onchain'" 
                        :class="activeTab === 'onchain' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    <i class="fas fa-link mr-2"></i>上链历史
                </button>
            </nav>
        </div>

        <!-- 资产列表标签页 -->
        <div x-show="activeTab === 'assets'">
            <!-- 顶部操作栏 -->
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex flex-wrap items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-700">资产列表</h3>
                    <div class="flex space-x-2">
                        <button @click="refreshData()" 
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>刷新
                        </button>
                        <button @click="exportAssets()"
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm">
                            <i class="fas fa-download mr-2"></i>导出
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 筛选条件 -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                        <select x-model="filters.status" @change="loadAssets()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="">全部状态</option>
                            <option value="1">待审核</option>
                            <option value="2">已通过</option>
                            <option value="3">已拒绝</option>
                            <option value="5">支付已确认</option>
                            <option value="6">支付失败</option>
                            <option value="7">部署失败</option>
                            <option value="8">支付处理中</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">资产类型</label>
                        <select x-model="filters.type" @change="loadAssets()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="">全部类型</option>
                            <option value="10">不动产</option>
                            <option value="20">商业地产</option>
                            <option value="30">工业地产</option>
                            <option value="40">土地资产</option>
                            <option value="50">证券资产</option>
                            <option value="60">艺术品</option>
                            <option value="70">收藏品</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">排序</label>
                        <select x-model="filters.sort" @change="loadAssets()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="id">ID</option>
                            <option value="created_at">创建时间</option>
                            <option value="updated_at">更新时间</option>
                            <option value="token_price">价格</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">排序方式</label>
                        <select x-model="filters.order" @change="loadAssets()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="desc">降序</option>
                            <option value="asc">升序</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
                        <input x-model="filters.keyword" @input.debounce.500ms="loadAssets()" 
                               type="text" placeholder="搜索资产名称..." 
                               class="w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
            </div>
            
            <!-- 批量操作 -->
            <div class="px-6 py-3 bg-gray-50 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" x-model="selectAll" @change="toggleSelectAll()" 
                               class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                        <span class="text-sm text-gray-600">全选</span>
                        <span x-show="selectedAssets.length > 0" class="text-sm text-gray-500">
                            （已选择 <span x-text="selectedAssets.length"></span> 项）
                        </span>
                    </div>
                    <div class="flex space-x-2">
                        <button x-show="selectedAssets.length > 0" @click="batchApprove()" 
                                class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                            <i class="fas fa-check mr-1"></i>批量通过
                        </button>
                        <button x-show="selectedAssets.length > 0" @click="batchReject()" 
                                class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600">
                            <i class="fas fa-times mr-1"></i>批量拒绝
                        </button>
                        <button x-show="selectedAssets.length > 0" @click="batchDelete()" 
                                class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            <i class="fas fa-trash mr-1"></i>批量删除
                        </button>
                    </div>
                </div>
            </div>

            <!-- 资产表格 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">选择</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">资产信息</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">价格</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- 加载状态 -->
                        <template x-if="loading">
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>加载资产数据中...
                                </td>
                            </tr>
                        </template>
                        
                        <!-- 无数据 -->
                        <template x-if="!loading && assets.length === 0">
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-box-open text-2xl mb-2"></i>
                                    <p>暂无资产数据</p>
                                </td>
                            </tr>
                        </template>
                        
                        <!-- 资产数据 -->
                        <template x-for="asset in assets" :key="asset.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <input type="checkbox" x-model="selectedAssets" :value="asset.id" 
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="asset.id"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <img x-show="asset.image && asset.image !== '/static/images/placeholder.jpg'" 
                                                 :src="asset.image" :alt="asset.name" 
                                                 class="h-10 w-10 rounded-lg object-cover border border-gray-200">
                                            <div x-show="!asset.image || asset.image === '/static/images/placeholder.jpg'" 
                                                 class="h-10 w-10 rounded-lg bg-gray-200 flex items-center justify-center border border-gray-300">
                                                <i class="fas fa-image text-gray-400 text-sm"></i>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium">
                                                <a :href="'/assets/' + asset.token_symbol" 
                                                   class="text-blue-600 hover:text-blue-800 hover:underline"
                                                   target="_blank"
                                                   x-text="asset.name"></a>
                                            </div>
                                            <div class="text-sm text-gray-500" x-text="asset.token_symbol"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              :class="getTypeClass(asset.asset_type)">
                                            <span class="w-2 h-2 rounded-full mr-1.5" :class="getTypeDotClass(asset.asset_type)"></span>
                                            <span x-text="asset.asset_type_name"></span>
                                        </span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(asset.token_price || 0)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" 
                                          :class="getStatusClass(asset.status)" x-text="getStatusText(asset.status)"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(asset.created_at)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        <button @click="viewAsset(asset)" 
                                                class="text-blue-600 hover:text-blue-900" title="查看详情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button x-show="asset.status === 1" @click="approveAsset(asset.id)" 
                                                class="text-green-600 hover:text-green-900" title="通过">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button x-show="asset.status === 1" @click="rejectAsset(asset.id)" 
                                                class="text-orange-600 hover:text-orange-900" title="拒绝">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <button @click="deleteAsset(asset.id)" 
                                                class="text-red-600 hover:text-red-900" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- 资产分页 -->
            <div x-show="activeTab === 'assets' && assets.length > 0" class="bg-white px-6 py-3 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        显示第 <span x-text="(pagination.page - 1) * pagination.limit + 1"></span> 到
                        <span x-text="Math.min(pagination.page * pagination.limit, pagination.total)"></span> 项，
                        共 <span x-text="pagination.total"></span> 项
                    </div>
                    <div class="flex space-x-2">
                        <button @click="loadAssets(pagination.page - 1)"
                                :disabled="pagination.page <= 1"
                                :class="pagination.page <= 1 ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'"
                                class="px-3 py-1 text-white rounded text-sm">
                            上一页
                        </button>
                        <span class="px-3 py-1 bg-gray-100 rounded text-sm">
                            第 <span x-text="pagination.page"></span> / <span x-text="pagination.pages"></span> 页
                        </span>
                        <button @click="loadAssets(pagination.page + 1)"
                                :disabled="pagination.page >= pagination.pages"
                                :class="pagination.page >= pagination.pages ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'"
                                class="px-3 py-1 text-white rounded text-sm">
                            下一页
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分红列表标签页 -->
        <div x-show="activeTab === 'dividends'">
            <!-- 顶部操作栏 -->
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex flex-wrap items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-700">分红列表</h3>
                    <div class="flex space-x-2">
                        <button @click="refreshDividends()" 
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>刷新
                        </button>
                        <button @click="exportDividends()" 
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm">
                            <i class="fas fa-download mr-2"></i>导出
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 分红筛选条件 -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">资产</label>
                        <select x-model="dividendFilters.asset_id" @change="loadDividends()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="">全部资产</option>
                            <template x-for="asset in assets" :key="asset.id">
                                <option :value="asset.id" x-text="asset.name + ' (' + asset.token_symbol + ')'"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                        <select x-model="dividendFilters.status" @change="loadDividends()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="">全部状态</option>
                            <option value="pending">待发放</option>
                            <option value="completed">已发放</option>
                            <option value="failed">发放失败</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">排序</label>
                        <select x-model="dividendFilters.sort" @change="loadDividends()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="created_at">创建时间</option>
                            <option value="amount">分红金额</option>
                            <option value="distribution_date">分红日期</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">排序方式</label>
                        <select x-model="dividendFilters.order" @change="loadDividends()" 
                                class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="desc">降序</option>
                            <option value="asc">升序</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 分红表格 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">资产信息</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分红金额</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">受益人数</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分红日期</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- 加载状态 -->
                        <template x-if="dividendLoading">
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>加载分红数据中...
                                </td>
                            </tr>
                        </template>
                        
                        <!-- 无数据 -->
                        <template x-if="!dividendLoading && dividends.length === 0">
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-coins text-2xl mb-2"></i>
                                    <p>暂无分红数据</p>
                                </td>
                            </tr>
                        </template>
                        
                        <!-- 分红数据 -->
                        <template x-for="dividend in dividends" :key="dividend.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="dividend.id"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8">
                                            <img x-show="dividend.asset_image" :src="dividend.asset_image" :alt="dividend.asset_name" 
                                                 class="h-8 w-8 rounded-full object-cover">
                                            <div x-show="!dividend.asset_image" 
                                                 class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center">
                                                <i class="fas fa-coins text-gray-400 text-xs"></i>
                                            </div>
                                        </div>
                                        <div class="ml-3">
                                            <div class="text-sm font-medium text-gray-900" x-text="dividend.asset_name"></div>
                                            <div class="text-sm text-gray-500" x-text="dividend.asset_symbol"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span class="font-semibold text-green-600" x-text="formatCurrency(dividend.amount || dividend.total_amount || 0)"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="dividend.recipient_count || 0"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(dividend.distribution_date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" 
                                          :class="getDividendStatusClass(dividend.status)" x-text="getDividendStatusText(dividend.status)"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(dividend.created_at)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex space-x-2">
                                        <button @click="viewDividend(dividend)" 
                                                class="text-blue-600 hover:text-blue-900" title="查看详情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button x-show="dividend.status === 'pending'" @click="processDividend(dividend.id)" 
                                                class="text-green-600 hover:text-green-900" title="处理分红">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button @click="deleteDividend(dividend.id)" 
                                                class="text-red-600 hover:text-red-900" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- 分红分页 -->
            <div x-show="activeTab === 'dividends' && dividends.length > 0" class="bg-white px-6 py-3 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        显示第 <span x-text="(dividendPagination.page - 1) * dividendPagination.limit + 1"></span> 到 
                        <span x-text="Math.min(dividendPagination.page * dividendPagination.limit, dividendPagination.total)"></span> 项，
                        共 <span x-text="dividendPagination.total"></span> 项
                    </div>
                    <div class="flex space-x-2">
                        <button @click="loadDividends(dividendPagination.page - 1)" 
                                :disabled="dividendPagination.page <= 1"
                                :class="dividendPagination.page <= 1 ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'"
                                class="px-3 py-1 text-white rounded text-sm">
                            上一页
                        </button>
                        <span class="px-3 py-1 bg-gray-100 rounded text-sm">
                            第 <span x-text="dividendPagination.page"></span> / <span x-text="dividendPagination.pages"></span> 页
                        </span>
                        <button @click="loadDividends(dividendPagination.page + 1)" 
                                :disabled="dividendPagination.page >= dividendPagination.pages"
                                :class="dividendPagination.page >= dividendPagination.pages ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'"
                                class="px-3 py-1 text-white rounded text-sm">
                            下一页
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上链历史标签页 -->
        <div x-show="activeTab === 'onchain'">
            <!-- 顶部操作栏 -->
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex flex-wrap items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-700">上链历史</h3>
                    <div class="flex space-x-2">
                        <button @click="refreshOnchainHistory()" 
                                :disabled="onchainLoading"
                                :class="onchainLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'"
                                class="text-white px-4 py-2 rounded text-sm">
                            <i :class="onchainLoading ? 'fas fa-spinner fa-spin mr-2' : 'fas fa-sync-alt mr-2'"></i>
                            <span x-text="onchainLoading ? '刷新中...' : '刷新'"></span>
                        </button>
                        <button @click="exportOnchainHistory()" 
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm">
                            <i class="fas fa-download mr-2"></i>导出
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 px-6 py-4">
                <p class="text-sm text-gray-600">
                    记录资产确认支付成功后触发的自动上链操作历史，包括资产创建、更新和交易结算等操作。
                </p>
            </div>

            <!-- 筛选器 -->
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">状态筛选</label>
                        <select x-model="onchainFilter.status" @change="loadOnchainHistory(1)" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">全部状态</option>
                            <option value="pending">待上链</option>
                            <option value="processing">上链中</option>
                            <option value="success">上链成功</option>
                            <option value="failed">上链失败</option>
                            <option value="retry">重试中</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">触发类型</label>
                        <select x-model="onchainFilter.trigger_type" @change="loadOnchainHistory(1)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">全部类型</option>
                            <option value="payment_confirmed">支付确认</option>
                            <option value="manual_trigger">手动触发</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">上链类型</label>
                        <select x-model="onchainFilter.onchain_type" @change="loadOnchainHistory(1)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">全部操作</option>
                            <option value="asset_creation">资产创建</option>
                            <option value="asset_update">资产更新</option>
                            <option value="trade_settlement">交易结算</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 历史记录表格 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">资产信息</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">触发类型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">上链类型</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">交易哈希</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">重试次数</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">触发时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- 加载状态 -->
                        <template x-if="onchainLoading">
                            <tr>
                                <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>加载上链历史记录中...
                                </td>
                            </tr>
                        </template>
                        
                        <!-- 无数据状态 -->
                        <template x-if="!onchainLoading && onchainHistory.length === 0">
                            <tr>
                                <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                                    <i class="fas fa-link text-2xl mb-2"></i>
                                    <p>暂无上链记录</p>
                                </td>
                            </tr>
                        </template>
                        
                        <!-- 上链历史数据 -->
                        <template x-for="record in onchainHistory" :key="record.id">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.id"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900" x-text="record.asset_name || 'N/A'"></div>
                                    <div class="text-sm text-gray-500" x-text="record.asset_symbol || 'N/A'"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                          :class="{
                                              'bg-blue-100 text-blue-800': record.trigger_type === 'payment_confirmed',
                                              'bg-purple-100 text-purple-800': record.trigger_type === 'manual_trigger'
                                          }"
                                          x-text="record.trigger_type === 'payment_confirmed' ? '支付确认' : '手动触发'">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="text-sm text-gray-900"
                                          x-text="record.onchain_type === 'asset_creation' ? '资产创建' : 
                                                 record.onchain_type === 'asset_update' ? '资产更新' : 
                                                 record.onchain_type === 'trade_settlement' ? '交易结算' : record.onchain_type">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                                          :class="{
                                              'bg-yellow-100 text-yellow-800': record.status === 'pending',
                                              'bg-blue-100 text-blue-800': record.status === 'processing',
                                              'bg-green-100 text-green-800': record.status === 'success',
                                              'bg-red-100 text-red-800': record.status === 'failed',
                                              'bg-orange-100 text-orange-800': record.status === 'retry'
                                          }"
                                          x-text="record.status === 'pending' ? '待上链' :
                                                 record.status === 'processing' ? '上链中' :
                                                 record.status === 'success' ? '上链成功' :
                                                 record.status === 'failed' ? '上链失败' :
                                                 record.status === 'retry' ? '重试中' : record.status">
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 font-mono" x-text="record.transaction_hash || 'N/A'"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span x-text="record.retry_count"></span>/<span x-text="record.max_retries"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" 
                                    x-text="new Date(record.triggered_at).toLocaleString()"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button x-show="record.status === 'failed' && record.retry_count < record.max_retries"
                                            @click="retryOnchain(record.id)"
                                            class="text-blue-600 hover:text-blue-900 mr-2">
                                        重试
                                    </button>
                                    <button @click="viewOnchainDetails(record)"
                                            class="text-indigo-600 hover:text-indigo-900">
                                        详情
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            <div x-show="onchainPagination.total > onchainPagination.per_page" class="px-6 py-3 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        显示第 <span x-text="(onchainPagination.page - 1) * onchainPagination.per_page + 1"></span> 到 
                        <span x-text="Math.min(onchainPagination.page * onchainPagination.per_page, onchainPagination.total)"></span> 条，
                        共 <span x-text="onchainPagination.total"></span> 条记录
                    </div>
                    <div class="flex space-x-2">
                        <button @click="loadOnchainHistory(onchainPagination.page - 1)" 
                                :disabled="onchainPagination.page <= 1 || onchainLoading"
                                :class="onchainPagination.page <= 1 || onchainLoading ? 'bg-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300'"
                                class="px-3 py-1 text-sm text-gray-700 rounded">
                            上一页
                        </button>
                        <span class="px-3 py-1 bg-gray-100 rounded text-sm">
                            第 <span x-text="onchainPagination.page"></span> / <span x-text="onchainPagination.pages"></span> 页
                        </span>
                        <button @click="loadOnchainHistory(onchainPagination.page + 1)" 
                                :disabled="onchainPagination.page >= onchainPagination.pages || onchainLoading"
                                :class="onchainPagination.page >= onchainPagination.pages || onchainLoading ? 'bg-gray-300 cursor-not-allowed' : 'bg-gray-200 hover:bg-gray-300'"
                                class="px-3 py-1 text-sm text-gray-700 rounded">
                            下一页
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 资产详情模态框 -->
    <div x-show="showAssetModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="closeAssetModal()"></div>
            <div class="relative bg-white rounded-lg max-w-4xl w-full max-h-96 overflow-y-auto shadow-xl transform transition-all">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900">资产详情</h3>
                        <button @click="closeAssetModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div x-show="selectedAsset" class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <img x-show="selectedAsset?.image" :src="selectedAsset?.image" :alt="selectedAsset?.name" 
                                 class="w-full h-64 object-cover rounded-lg">
                            <div x-show="!selectedAsset?.image" 
                                 class="w-full h-64 bg-gray-200 rounded-lg flex items-center justify-center border border-gray-300">
                                <i class="fas fa-image text-gray-400 text-4xl"></i>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-lg font-semibold" x-text="selectedAsset?.name"></h4>
                                <p class="text-gray-600" x-text="selectedAsset?.token_symbol"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">资产类型：</span>
                                    <span x-text="selectedAsset?.asset_type_name"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">代币价格：</span>
                                    <span x-text="formatCurrency(selectedAsset?.token_price || 0)"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">总价值：</span>
                                    <span x-text="formatCurrency(selectedAsset?.total_value || 0)"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">代币供应量：</span>
                                    <span x-text="selectedAsset?.token_supply || 0"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">创建者：</span>
                                    <span x-text="formatAddress(selectedAsset?.creator_address)"></span>
                                </div>
                                <div>
                                    <span class="text-gray-500">状态：</span>
                                    <span x-text="selectedAsset?.status_text"></span>
                                </div>
                            </div>
                            <div x-show="selectedAsset?.location">
                                <span class="text-gray-500">位置：</span>
                                <span x-text="selectedAsset?.location"></span>
                            </div>
                            <div x-show="selectedAsset?.area">
                                <span class="text-gray-500">面积：</span>
                                <span x-text="selectedAsset?.area + ' 平方米'"></span>
                            </div>
                            <div class="pt-4 border-t">
                                <div class="flex space-x-2">
                                    <button x-show="selectedAsset?.status === 1" @click="approveAsset(selectedAsset?.id)"
                                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 mx-1">
                                        <i class="fas fa-check mr-1"></i>通过
                                    </button>
                                    <button x-show="selectedAsset?.status === 1" @click="rejectAsset(selectedAsset?.id)"
                                            class="px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 mx-1">
                                        <i class="fas fa-times mr-1"></i>拒绝
                                    </button>
                                    <button @click="deleteAsset(selectedAsset?.id)"
                                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 mx-1">
                                        <i class="fas fa-trash mr-1"></i>删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分红详情模态框 -->
    <div x-show="showDividendModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- 模态框头部 -->
                <div class="flex items-center justify-between pb-3 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">分红详情</h3>
                    <button @click="closeDividendModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- 分红详情内容 -->
                <div x-show="selectedDividend" class="mt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">分红ID</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedDividend?.id"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">资产名称</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedDividend?.asset_name"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">资产符号</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedDividend?.asset_symbol"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">分红金额</label>
                            <p class="mt-1 text-sm text-gray-900 font-semibold text-green-600" 
                               x-text="formatCurrency(selectedDividend?.amount || selectedDividend?.total_amount || 0)"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">受益人数</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedDividend?.recipient_count || 0"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">分红日期</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatDate(selectedDividend?.distribution_date)"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">状态</label>
                            <span class="mt-1 px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" 
                                  :class="getDividendStatusClass(selectedDividend?.status)" 
                                  x-text="getDividendStatusText(selectedDividend?.status)"></span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">创建时间</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="formatDate(selectedDividend?.created_at)"></p>
                        </div>
                        <div x-show="selectedDividend?.distributor_address" class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">分发地址</label>
                            <p class="mt-1 text-sm text-gray-900 font-mono" x-text="selectedDividend?.distributor_address"></p>
                        </div>
                        <div x-show="selectedDividend?.description" class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">描述</label>
                            <p class="mt-1 text-sm text-gray-900" x-text="selectedDividend?.description"></p>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="mt-6 flex justify-end space-x-3">
                        <button @click="closeDividendModal()" 
                                class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                            关闭
                        </button>
                        <button x-show="selectedDividend?.status === 'pending' && selectedDividend?.id" 
                                @click="processDividend(selectedDividend?.id)" 
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            <i class="fas fa-play mr-2"></i>处理分红
                        </button>
                        <button @click="deleteDividend(selectedDividend?.id)" 
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            <i class="fas fa-trash mr-2"></i>删除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function assetManagement() {
        return {
            // 数据状态
            loading: false,
            assets: [],
            stats: {},
            selectedAssets: [],
            selectedAsset: null,
            selectAll: false,
            showAssetModal: false,
            activeTab: 'assets',
            
            // 筛选和分页
            filters: {
                status: '',
                type: '',
                keyword: '',
                sort: 'id',
                order: 'desc'
            },
            pagination: {
                page: 1,
                limit: 50,
                total: 0,
                pages: 0
            },
            
            // 分红相关数据
            dividends: [],
            dividendLoading: false,
            selectedDividend: null,
            showDividendModal: false,
            dividendFilters: {
                asset_id: '',
                status: '',
                sort: 'created_at',
                order: 'desc'
            },
            dividendPagination: {
                page: 1,
                limit: 10,
                total: 0,
                pages: 0
            },
            
            // 上链历史相关数据
            onchainHistory: [],
            onchainLoading: false,
            onchainFilter: {
                status: '',
                trigger_type: '',
                onchain_type: ''
            },
            onchainPagination: {
                page: 1,
                per_page: 20,
                total: 0,
                pages: 0
            },
            
            // 获取URL参数中的钱包地址
            getWalletAddress() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('eth_address');
            },
            
            // 创建带认证头的fetch请求
            authFetch(url, options = {}) {
                const walletAddress = this.getWalletAddress();
                return fetch(url, {
                    ...options,
                    headers: {
                        'X-Wallet-Address': walletAddress,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
            },
            
            // 初始化加载数据
            async loadData() {
                console.log('Alpine.js 初始化完成');
                await Promise.all([
                    this.loadStats(),
                    this.loadAssets()
                ]);
                
                // 监听标签页切换
                this.$watch('activeTab', (newTab) => {
                    if (newTab === 'dividends' && this.dividends.length === 0) {
                        this.loadDividends();
                    } else if (newTab === 'onchain' && this.onchainHistory.length === 0) {
                        this.loadOnchainHistory();
                    }
                });
            },
            
            // 加载统计数据
            async loadStats() {
                try {
                    const response = await this.authFetch('/api/admin/assets/stats');
                    if (response.ok) {
                        this.stats = await response.json();
                }
                } catch (error) {
                    console.error('加载统计数据失败:', error);
                }
        },
        
            // 加载资产列表
            async loadAssets(page = null) {
                if (page) this.pagination.page = page;
                this.loading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.pagination.page,
                        limit: this.pagination.limit,
                        ...this.filters
                    });
                    
                    const response = await this.authFetch(`/api/admin/assets?${params}`);
                    if (!response.ok) throw new Error('加载资产失败');
                    
                    const data = await response.json();
                    this.assets = data.items || [];
                    this.pagination.total = data.total || 0;
                    this.pagination.pages = data.pages || 0;
                    
                    // 重置选择状态
                        this.selectedAssets = [];
                    this.selectAll = false;
                    
                } catch (error) {
                        console.error('加载资产失败:', error);
                    alert('加载资产失败: ' + error.message);
                } finally {
                        this.loading = false;
                }
            },
            
            // 刷新数据
            async refreshData() {
                await this.loadData();
            },
            
            // 全选切换
            toggleSelectAll() {
                if (this.selectAll) {
                    this.selectedAssets = this.assets.map(asset => asset.id);
                } else {
                    this.selectedAssets = [];
                }
            },
            
            // 查看资产详情
            viewAsset(asset) {
                this.selectedAsset = asset;
                this.showAssetModal = true;
            },
            
            // 关闭资产详情模态框
            closeAssetModal() {
                this.showAssetModal = false;
                this.selectedAsset = null;
            },
            
            // 单个资产审核通过
            async approveAsset(assetId) {
                if (!confirm('确定要通过这个资产的审核吗？')) return;
                
                try {
                    const response = await this.authFetch(`/api/admin/assets/${assetId}/approve`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('审核失败');
                    
                    alert('资产审核通过成功');
                    await this.refreshData();
                    this.closeAssetModal();
                } catch (error) {
                    console.error('审核失败:', error);
                    alert('审核失败: ' + error.message);
                                    }
            },
            
            // 单个资产审核拒绝
            async rejectAsset(assetId) {
                const reason = prompt('请输入拒绝理由:');
                if (!reason) return;
                
                try {
                    const response = await this.authFetch(`/api/admin/assets/${assetId}/reject`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason })
                    });
                    
                    if (!response.ok) throw new Error('拒绝失败');
                    
                    alert('资产审核拒绝成功');
                    await this.refreshData();
                    this.closeAssetModal();
                } catch (error) {
                    console.error('拒绝失败:', error);
                    alert('拒绝失败: ' + error.message);
                }
            },
            
            // 删除资产
            async deleteAsset(assetId) {
                if (!confirm('确定要删除这个资产吗？此操作无法撤销。')) return;
                
                try {
                    const response = await this.authFetch(`/api/admin/assets/${assetId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) throw new Error('删除失败');
                    
                    alert('资产删除成功');
                    await this.refreshData();
                    this.closeAssetModal();
                } catch (error) {
                    console.error('删除失败:', error);
                    alert('删除失败: ' + error.message);
                }
            },
            
            // 批量审核通过
            async batchApprove() {
                if (this.selectedAssets.length === 0) return;
                if (!confirm(`确定要通过 ${this.selectedAssets.length} 个资产的审核吗？`)) return;
                
                try {
                    const response = await this.authFetch('/api/admin/assets/batch-approve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ asset_ids: this.selectedAssets })
                    });
                    
                    if (!response.ok) throw new Error('批量审核失败');
                    
                    alert('批量审核通过成功');
                    await this.refreshData();
                } catch (error) {
                    console.error('批量审核失败:', error);
                    alert('批量审核失败: ' + error.message);
                }
            },
            
            // 批量审核拒绝
            async batchReject() {
                if (this.selectedAssets.length === 0) return;
                const reason = prompt('请输入拒绝理由:');
                if (!reason) return;
                
                try {
                    const response = await this.authFetch('/api/admin/assets/batch-reject', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            asset_ids: this.selectedAssets,
                            reason: reason
                        })
                    });
                    
                    if (!response.ok) throw new Error('批量拒绝失败');
                    
                    alert('批量拒绝成功');
                    await this.refreshData();
                } catch (error) {
                    console.error('批量拒绝失败:', error);
                    alert('批量拒绝失败: ' + error.message);
                }
            },
            
                    // 批量删除
            async batchDelete() {
                if (this.selectedAssets.length === 0) return;
                if (!confirm(`确定要删除 ${this.selectedAssets.length} 个资产吗？此操作无法撤销。`)) return;
                
                try {
                    const response = await this.authFetch('/api/admin/assets/batch-delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ asset_ids: this.selectedAssets })
                    });
                    
                    if (!response.ok) throw new Error('批量删除失败');
                    
                    const result = await response.json();
                    alert(result.message);
                    await this.refreshData();
                } catch (error) {
                    console.error('批量删除失败:', error);
                    alert('批量删除失败: ' + error.message);
                }
            },
            
            // 导出资产数据
            async exportAssets() {
                try {
                    const response = await this.authFetch('/api/admin/assets/export');
                    if (!response.ok) throw new Error('导出失败');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `assets_${new Date().getTime()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('导出失败:', error);
                    alert('导出失败: ' + error.message);
                }
            },

            // 工具函数
            formatCurrency(value) {
                return '$' + parseFloat(value || 0).toLocaleString();
            },
            
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            },
            
            formatAddress(address) {
                if (!address) return '-';
                return address.slice(0, 6) + '...' + address.slice(-4);
            },
            
            getTypeClass(type) {
                const classes = {
                    10: 'bg-blue-100 text-blue-800',      // 不动产
                    20: 'bg-green-100 text-green-800',    // 商业地产
                    30: 'bg-yellow-100 text-yellow-800',  // 工业地产
                    40: 'bg-purple-100 text-purple-800',  // 土地资产
                    50: 'bg-red-100 text-red-800',        // 证券资产
                    60: 'bg-indigo-100 text-indigo-800',  // 艺术品
                    70: 'bg-pink-100 text-pink-800'       // 收藏品
                };
                return classes[type] || 'bg-gray-100 text-gray-800';
            },
            
            getTypeDotClass(type) {
                const classes = {
                    10: 'bg-blue-500',      // 不动产
                    20: 'bg-green-500',     // 商业地产
                    30: 'bg-yellow-500',    // 工业地产
                    40: 'bg-purple-500',    // 土地资产
                    50: 'bg-red-500',       // 证券资产
                    60: 'bg-indigo-500',    // 艺术品
                    70: 'bg-pink-500'       // 收藏品
                };
                return classes[type] || 'bg-gray-500';
            },
            
            getStatusClass(status) {
                const classes = {
                    1: 'bg-yellow-100 text-yellow-800',  // 待审核
                    2: 'bg-green-100 text-green-800',    // 已通过/已上链
                    3: 'bg-red-100 text-red-800',        // 已拒绝
                    5: 'bg-blue-100 text-blue-800',      // 支付已确认
                    6: 'bg-red-100 text-red-800',        // 支付失败
                    7: 'bg-orange-100 text-orange-800',  // 部署失败
                    8: 'bg-purple-100 text-purple-800'   // 支付处理中
                };
                return classes[status] || 'bg-gray-100 text-gray-800';
            },

            getStatusText(status) {
                const texts = {
                    1: '待审核',
                    2: '已通过',
                    3: '已拒绝',
                    5: '已支付',
                    6: '支付失败',
                    7: '部署失败',
                    8: '支付处理中'
                };
                return texts[status] || '未知状态';
            },
            
            // 分红相关方法
            
            // 加载分红数据
            async loadDividends(page = 1) {
                this.dividendLoading = true;
                try {
                    const params = new URLSearchParams({
                        page: page,
                        limit: this.dividendPagination.limit,
                        ...this.dividendFilters
                    });
                    
                    const response = await this.authFetch(`/api/admin/dividends?${params}`);
                    if (!response.ok) throw new Error('加载分红数据失败');
                    
                    const data = await response.json();
                    this.dividends = data.dividends || [];
                    this.dividendPagination = {
                        page: data.page || 1,
                        limit: data.limit || 10,
                        total: data.total || 0,
                        pages: data.pages || 0
                    };
                } catch (error) {
                    console.error('加载分红数据失败:', error);
                    this.dividends = [];
                } finally {
                    this.dividendLoading = false;
                }
            },
            
            // 刷新分红数据
            async refreshDividends() {
                await this.loadDividends(this.dividendPagination.page);
            },
            
            // 查看分红详情
            viewDividend(dividend) {
                this.selectedDividend = dividend;
                this.showDividendModal = true;
            },
            
            // 关闭分红详情模态框
            closeDividendModal() {
                this.showDividendModal = false;
                this.selectedDividend = null;
            },
            
            // 处理分红
            async processDividend(dividendId) {
                if (!confirm('确定要处理这个分红吗？')) return;
                
                try {
                    const response = await this.authFetch(`/api/admin/dividends/${dividendId}/process`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('处理分红失败');
                    
                    alert('分红处理成功');
                    await this.refreshDividends();
                    this.closeDividendModal();
                } catch (error) {
                    console.error('处理分红失败:', error);
                    alert('处理分红失败: ' + error.message);
                }
            },
            
            // 删除分红
            async deleteDividend(dividendId) {
                if (!confirm('确定要删除这个分红记录吗？此操作无法撤销。')) return;
                
                try {
                    const response = await this.authFetch(`/api/admin/dividends/${dividendId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) throw new Error('删除分红失败');
                    
                    alert('分红删除成功');
                    await this.refreshDividends();
                    this.closeDividendModal();
                } catch (error) {
                    console.error('删除分红失败:', error);
                    alert('删除分红失败: ' + error.message);
                }
            },
            
            // 导出分红数据
            async exportDividends() {
                try {
                    const response = await this.authFetch('/api/admin/dividends/export');
                    if (!response.ok) throw new Error('导出失败');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dividends_${new Date().getTime()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('导出失败:', error);
                    alert('导出失败: ' + error.message);
                }
            },
            
            // 获取分红状态样式
            getDividendStatusClass(status) {
                const classes = {
                    'pending': 'bg-yellow-100 text-yellow-800',    // 待发放
                    'completed': 'bg-green-100 text-green-800',   // 已发放
                    'failed': 'bg-red-100 text-red-800'           // 发放失败
                };
                return classes[status] || 'bg-gray-100 text-gray-800';
            },
            
            // 获取分红状态文本
            getDividendStatusText(status) {
                const texts = {
                    'pending': '待发放',
                    'completed': '已发放',
                    'failed': '发放失败'
                };
                return texts[status] || '未知状态';
            },
            
            // 上链历史相关方法
            
            // 加载上链历史记录
            async loadOnchainHistory(page = null) {
                if (page !== null) {
                    this.onchainPagination.page = page;
                }
                
                this.onchainLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.onchainPagination.page,
                        per_page: this.onchainPagination.per_page,
                        ...this.onchainFilter
                    });
                    
                    const response = await this.authFetch(`/admin/v2/api/onchain-history?${params}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.onchainHistory = result.data || [];
                            this.onchainPagination = {
                                ...this.onchainPagination,
                                ...result.pagination
                            };
                            console.log('上链历史记录已加载:', this.onchainHistory);
                        } else {
                            throw new Error(result.error || '加载失败');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `HTTP ${response.status}: 加载上链历史记录失败`);
                    }
                } catch (error) {
                    console.error('加载上链历史记录时出错:', error);
                    alert('加载上链历史记录失败: ' + error.message);
                } finally {
                    this.onchainLoading = false;
                }
            },
            
            // 刷新上链历史记录（保持当前页码）
            async refreshOnchainHistory() {
                await this.loadOnchainHistory();
            },
            
            // 导出上链历史数据
            async exportOnchainHistory() {
                try {
                    const params = new URLSearchParams(this.onchainFilter);
                    const response = await this.authFetch(`/admin/v2/api/onchain-history/export?${params}`);
                    
                    if (!response.ok) {
                        throw new Error('导出失败');
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `onchain_history_${new Date().getTime()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('导出上链历史失败:', error);
                    alert('导出失败: ' + error.message);
                }
            },
            
            // 重试上链操作
            async retryOnchain(recordId) {
                if (!confirm('确定要重试这个上链操作吗？')) {
                    return;
                }
                
                try {
                    const response = await this.authFetch(`/admin/v2/api/onchain-history/${recordId}/retry`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('重试请求已提交');
                        this.refreshOnchainHistory();
                    } else {
                        alert('重试失败: ' + result.error);
                    }
                } catch (error) {
                    alert('重试失败: ' + error.message);
                }
            },
            
            // 查看上链详情
            viewOnchainDetails(record) {
                let details = `上链记录详情：
                
ID: ${record.id}
资产ID: ${record.asset_id}
资产名称: ${record.asset_name || 'N/A'}
资产符号: ${record.asset_symbol || 'N/A'}
触发类型: ${record.trigger_type === 'payment_confirmed' ? '支付确认' : '手动触发'}
上链类型: ${record.onchain_type === 'asset_creation' ? '资产创建' : 
           record.onchain_type === 'asset_update' ? '资产更新' : 
           record.onchain_type === 'trade_settlement' ? '交易结算' : record.onchain_type}
状态: ${record.status === 'pending' ? '待上链' :
       record.status === 'processing' ? '上链中' :
       record.status === 'success' ? '上链成功' :
       record.status === 'failed' ? '上链失败' :
       record.status === 'retry' ? '重试中' : record.status}
交易哈希: ${record.transaction_hash || 'N/A'}
区块号: ${record.block_number || 'N/A'}
Gas消耗: ${record.gas_used || 'N/A'}
Gas价格: ${record.gas_price || 'N/A'}
重试次数: ${record.retry_count}/${record.max_retries}
触发者: ${record.triggered_by || 'N/A'}
触发时间: ${new Date(record.triggered_at).toLocaleString()}
处理完成时间: ${record.processed_at ? new Date(record.processed_at).toLocaleString() : 'N/A'}`;

                if (record.error_message) {
                    details += `\n错误信息: ${record.error_message}`;
                }
                
                alert(details);
            }
        }
    }
</script>
{% endblock %} 