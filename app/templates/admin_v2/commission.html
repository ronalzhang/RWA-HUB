{% extends "admin_v2/base.html" %}

{% block title %}RWA-HUB ç®¡ç†åå° - ä½£é‡‘ç®¡ç†{% endblock %}

{% block page_title %}ä½£é‡‘ç®¡ç†{% endblock %}
{% block page_subtitle %}ç®¡ç†å¹³å°ä½£é‡‘è®¾ç½®å’Œè®°å½•{% endblock %}

{% block extra_head %}
<style>
    /* ä¿®å¤å¼€å…³æ ·å¼å…¼å®¹æ€§ */
    .toggle-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
    }
    
    .toggle-switch input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }
    
    .toggle-track {
        width: 3rem; /* 48px */
        height: 1.5rem; /* 24px */
        background-color: #d1d5db; /* gray-300 */
        border-radius: 9999px;
        position: relative;
        transition: background-color 0.2s ease-in-out;
    }
    
    .toggle-track.active {
        background-color: #f97316; /* orange-500 */
    }
    
    .toggle-thumb {
        width: 1.25rem; /* 20px */
        height: 1.25rem; /* 20px */
        background-color: white;
        border-radius: 50%;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        position: absolute;
        top: 0.125rem; /* 2px */
        left: 0.125rem; /* 2px */
        transition: transform 0.2s ease-in-out;
    }
    
    .toggle-thumb.active {
        transform: translateX(1.5rem); /* 24px */
    }
    
    /* ä¿®å¤æŒ‰é’®æ ·å¼ */
    .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        background-color: #3b82f6; /* blue-500 */
        color: white;
        font-size: 0.875rem; /* text-sm */
        font-weight: 500;
        border-radius: 0.5rem; /* rounded-lg */
        border: 1px solid transparent;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease-in-out;
        text-decoration: none;
    }
    
    .btn-primary:hover {
        background-color: #2563eb; /* blue-600 */
    }
    
    .btn-orange {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        background-color: #f97316; /* orange-500 */
        color: white;
        font-size: 0.875rem; /* text-sm */
        font-weight: 500;
        border-radius: 0.5rem; /* rounded-lg */
        border: 1px solid transparent;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease-in-out;
        text-decoration: none;
    }
    
    .btn-orange:hover {
        background-color: #ea580c; /* orange-600 */
    }
    
    /* ç¡®ä¿å›¾æ ‡å’Œæ–‡å­—å¯¹é½ */
    .btn-primary i, .btn-orange i {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li aria-current="page">
    <div class="flex items-center">
        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
        <span class="text-gray-500">ä½£é‡‘ç®¡ç†</span>
    </div>
</li>
{% endblock %}

{% block content %}
<div x-data="commissionData()" x-init="loadCommissionData()">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" x-cloak>
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 mr-4">
                    <i class="fas fa-dollar-sign text-green-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">æ€»ä½£é‡‘</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.total_commission || 0)"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 mr-4">
                    <i class="fas fa-users text-blue-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">æ¨èç”¨æˆ·</h3>
                    <p class="text-2xl font-bold" x-text="stats.total_referrals || 0"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-yellow-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 mr-4">
                    <i class="fas fa-clock text-yellow-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">å¾…å‘æ”¾</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.pending_commission || 0)"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-purple-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 mr-4">
                    <i class="fas fa-percentage text-purple-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">ä½£é‡‘ç‡</h3>
                    <p class="text-2xl font-bold" x-text="(settings.commission_rate || stats.commission_rate || 0) + '%'"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½é€‰é¡¹å¡ -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button @click="switchTab('records')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'records', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'records'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    ä½£é‡‘è®°å½•
                </button>
                <button @click="switchTab('settings')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'settings', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'settings'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    ä½£é‡‘è®¾ç½®
                </button>
                <button @click="switchTab('referrals')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'referrals', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'referrals'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    æ¨èå…³ç³»
                </button>
                <button @click="switchTab('withdrawals')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'withdrawals', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'withdrawals'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    è‡ªåŠ¨å–ç°
                </button>
                <button @click="switchTab('automation')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'automation', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'automation'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    ğŸ¤– è‡ªåŠ¨åŒ–ç³»ç»Ÿ
                </button>
            </nav>
        </div>
    </div>

    <!-- ä½£é‡‘è®°å½• -->
    <div x-show="activeTab === 'records'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">ä½£é‡‘è®°å½•</h3>
                <div class="flex space-x-2">
                    <button @click="refreshRecords()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
            </button>
                    <button @click="exportRecords()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-download mr-2"></i>å¯¼å‡º
                </button>
            </div>
                </div>
        </div>

        <!-- ç­›é€‰æ¡ä»¶ -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
                    <select x-model="recordFilters.status" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="pending">å¾…å‘æ”¾</option>
                        <option value="paid">å·²å‘æ”¾</option>
                        <option value="failed">å‘æ”¾å¤±è´¥</option>
                    </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">ä½£é‡‘ç±»å‹</label>
                    <select x-model="recordFilters.type" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="direct">ç›´æ¥ä½£é‡‘</option>
                    <option value="referral">æ¨èä½£é‡‘</option>
                </select>
            </div>
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ—¶é—´èŒƒå›´</label>
                    <select x-model="recordFilters.time_range" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">å…¨éƒ¨æ—¶é—´</option>
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                    </select>
            </div>
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æœç´¢</label>
                    <input x-model="recordFilters.search" @input.debounce.500ms="loadRecords()" 
                           type="text" placeholder="æœç´¢åœ°å€æˆ–äº¤æ˜“ID..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
            </div>
        </div>
        </div>

        <!-- ä½£é‡‘è®°å½•è¡¨æ ¼ -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¥æ”¶åœ°å€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä½£é‡‘é‡‘é¢</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç±»å‹</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ›å»ºæ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="recordsLoading">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½ä½£é‡‘è®°å½•ä¸­...
                        </td>
                    </tr>
                    </template>
                    
                    <template x-if="!recordsLoading && records.length === 0">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">æš‚æ— ä½£é‡‘è®°å½•</td>
                    </tr>
                    </template>
                    
                    <template x-for="record in records" :key="record.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="record.id"></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="record.recipient_address ? record.recipient_address.slice(0, 8) + '...' + record.recipient_address.slice(-6) : '-'"></div>
                        </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(record.amount || 0)"></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-blue-100 text-blue-800': record.commission_type === 'direct',
                                    'bg-green-100 text-green-800': record.commission_type === 'referral'
                                }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="record.commission_type === 'direct' ? 'ç›´æ¥ä½£é‡‘' : 'æ¨èä½£é‡‘'"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span :class="{
                                'bg-yellow-100 text-yellow-800': record.status === 'pending',
                                'bg-green-100 text-green-800': record.status === 'paid',
                                'bg-red-100 text-red-800': record.status === 'failed'
                            }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="getStatusText(record.status)"></span>
                            </span>
                        </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(record.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button x-show="record.status === 'pending'" @click="payCommission(record)" 
                                        class="text-green-600 hover:text-green-900 mr-2">
                                    <i class="fas fa-check"></i> å‘æ”¾
                                </button>
                                <button @click="viewRecord(record)" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                        </td>
                    </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                    æ˜¾ç¤º <span x-text="(recordPagination.page - 1) * recordPagination.limit + 1"></span> åˆ° 
                    <span x-text="Math.min(recordPagination.page * recordPagination.limit, recordPagination.total)"></span> æ¡ï¼Œ
                    å…± <span x-text="recordPagination.total"></span> æ¡è®°å½•
            </div>
                <div class="flex space-x-2">
                    <button @click="loadRecords(1)" :disabled="recordPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">é¦–é¡µ</button>
                    <button @click="loadRecords(recordPagination.page - 1)" :disabled="recordPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <button @click="loadRecords(recordPagination.page + 1)" :disabled="recordPagination.page >= recordPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                    <button @click="loadRecords(recordPagination.pages)" :disabled="recordPagination.page >= recordPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">æœ«é¡µ</button>
            </div>
        </div>
            </div>
        </div>

    <!-- ä½£é‡‘è®¾ç½® -->
    <div x-show="activeTab === 'settings'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700" x-text="(settings.commission_rate || 35) + '%åˆ†é”€ä½“ç³»é…ç½®'"></h3>
            <p class="text-sm text-gray-500 mt-1">é…ç½®æ¨èä½£é‡‘ã€åˆ†äº«åŠŸèƒ½å’Œæç°è§„åˆ™</p>
        </div>

        <div class="px-6 py-6 space-y-8">
            <!-- æ ¸å¿ƒåˆ†é”€è®¾ç½® -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-blue-100 rounded-lg mr-3">
                        <i class="fas fa-percentage text-blue-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">æ ¸å¿ƒåˆ†é”€è§„åˆ™</h4>
                </div>
                
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æ¨èä½£é‡‘ç‡ (%)
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input x-model="settings.commission_rate" type="number" step="0.1" min="0" max="100"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-12">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">%</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">å¥½å‹è´­ä¹°åæ‚¨è·å¾—çš„ä½£é‡‘æ¯”ä¾‹</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é”€æè¿°æ–‡æ¡ˆ</label>
                        <input x-model="settings.commission_description" type="text" 
                               placeholder="ğŸ’° æ¨èå¥½å‹å³äº«35%è¶…é«˜ä½£é‡‘ï¼Œäººäººéƒ½æ˜¯èµšé’±è¾¾äººï¼"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">å‰ç«¯å±•ç¤ºçš„ä½£é‡‘åŠŸèƒ½æè¿°ï¼Œæ”¯æŒemoji</p>
        </div>

        <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¤šçº§åˆ†é”€</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input x-model="settings.enable_multi_level" type="checkbox" 
                                       class="rounded border-gray-300 text-blue-600 shadow-sm">
                                <span class="ml-2 text-sm text-gray-700">å¯ç”¨å¤šçº§åˆ†é”€</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1" x-text="'å¼€å¯åä¸‹çº§çš„ä½£é‡‘æ”¶ç›Šä¹Ÿä¼šç»™æ‚¨åˆ†æˆ' + (settings.commission_rate || 35) + '%'"></p>
    </div>

                                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å¤§åˆ†é”€å±‚çº§</label>
                        <select x-model="settings.max_referral_levels" class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="1">1çº§ï¼ˆåªæœ‰ç›´æ¥æ¨èï¼‰</option>
                            <option value="2">2çº§ï¼ˆç›´æ¥+é—´æ¥æ¨èï¼‰</option>
                            <option value="3">3çº§ï¼ˆä¸‰çº§åˆ†é”€ï¼‰</option>
                            <option value="5">5çº§ï¼ˆäº”çº§åˆ†é”€ï¼‰</option>
                            <option value="10">10çº§ï¼ˆåçº§åˆ†é”€ï¼‰</option>
                            <option value="999">âˆ æ— é™çº§ï¼ˆæ‰€æœ‰ä¸‹çº¿éƒ½ä¸Šè´¡ï¼‰</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1" x-text="'æ¯å¢åŠ ä¸€çº§ï¼Œä½£é‡‘æŒ‰' + (settings.commission_rate || 35) + '%é€’å‡ä¼ é€’ç»™ä¸Šçº§'"></p>
                    </div>
                                    </div>
                                </div>
                                
            <!-- åˆ†äº«åŠŸèƒ½é…ç½® -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-green-100 rounded-lg mr-3">
                        <i class="fas fa-share-alt text-green-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">åˆ†äº«åŠŸèƒ½é…ç½®</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†äº«æŒ‰é’®æ–‡æ¡ˆ</label>
                        <input x-model="settings.share_button_text" type="text" 
                               placeholder="ğŸš€ åˆ†äº«èµšå¤§é’±"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">åˆ†äº«æŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—ï¼Œå»ºè®®ç®€çŸ­æœ‰åŠ›</p>
                                </div>
                                
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†äº«æˆåŠŸæç¤º</label>
                        <input x-model="settings.share_success_message" type="text" 
                               placeholder="ğŸ‰ åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼å¿«å»é‚€è¯·å¥½å‹èµšå–35%ä½£é‡‘å§ï¼"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">åˆ†äº«æˆåŠŸåæ˜¾ç¤ºçš„æ¶ˆæ¯ï¼Œé¼“åŠ±ç”¨æˆ·è¡ŒåŠ¨</p>
    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†äº«è¯´æ˜æ–‡æ¡ˆ</label>
                        <textarea x-model="settings.share_description" rows="2" 
                                  placeholder="ğŸ¯ æ¨èå¥½å‹è´­ä¹°é¡¹ç›®ï¼Œæ‚¨ç«‹å³è·å¾—35%ç°é‡‘å¥–åŠ±ï¼å¤šçº§åˆ†é”€ï¼Œæ”¶ç›Šæ— ä¸Šé™ï¼"
                                  class="w-full border-gray-300 rounded-md shadow-sm"></textarea>
                        <p class="text-xs text-gray-500 mt-1">åˆ†äº«åŠŸèƒ½çš„è¯¦ç»†è¯´æ˜ï¼Œçªå‡ºé«˜æ”¶ç›Šå’Œç®€å•æ€§</p>
                    </div>
                </div>
            </div>

            <!-- æç°é…ç½® -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-purple-100 rounded-lg mr-3">
                        <i class="fas fa-wallet text-purple-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">æç°é…ç½®</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æœ€ä½æç°é‡‘é¢ (USDC)
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input x-model="settings.min_withdraw_amount" type="number" step="0.01" min="0"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-16">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">USDC</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">é—¨æ§›è¶Šä½ï¼Œç”¨æˆ·æç°æ„æ„¿è¶Šå¼º</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æç°æ‰‹ç»­è´¹ç‡ (%)</label>
                        <div class="relative">
                            <input x-model="settings.withdraw_fee_rate" type="number" step="0.01" min="0" max="100"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-12">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">%</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">å»ºè®®è®¾ä¸º0%ï¼Œé›¶æ‰‹ç»­è´¹æ›´å¸å¼•ç”¨æˆ·</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ğŸ¤– è‡ªåŠ¨å¤„ç†å»¶è¿Ÿæ—¶é—´ (åˆ†é’Ÿ)
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input x-model="settings.withdrawal_delay_minutes" type="number" step="1" min="1" max="60"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-16">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">åˆ†é’Ÿ</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ç³»ç»Ÿå»¶è¿Ÿå¤„ç†æç°ç”³è¯·çš„æ—¶é—´ï¼Œ1åˆ†é’Ÿä¸ºå…¨è‡ªåŠ¨</p>
                    </div>
                    
                    <div class="md:col-span-1">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h5 class="text-sm font-semibold text-blue-700 mb-1">âš¡ è‡ªåŠ¨åŒ–è¯´æ˜</h5>
                            <div class="text-xs text-blue-600 space-y-1">
                                <p>â€¢ <strong>1åˆ†é’Ÿ</strong>ï¼šå…¨è‡ªåŠ¨åŒ–ï¼Œé›¶äººå·¥å¹²é¢„</p>
                                <p>â€¢ <strong>5-10åˆ†é’Ÿ</strong>ï¼šå¹³è¡¡å®‰å…¨æ€§ä¸æ•ˆç‡</p>
                                <p>â€¢ <strong>30åˆ†é’Ÿä»¥ä¸Š</strong>ï¼šé«˜å®‰å…¨è¦æ±‚åœºæ™¯</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æç°è¯´æ˜æ–‡æ¡ˆ</label>
                        <textarea x-model="settings.withdraw_description" rows="2" 
                                  placeholder="ğŸ’ æœ€ä½æç°10 USDCï¼Œé›¶æ‰‹ç»­è´¹ï¼Œç§’åˆ°è´¦ï¼éšæ—¶æç°ï¼Œè‡ªç”±æ”¯é…ï¼"
                                  class="w-full border-gray-300 rounded-md shadow-sm"></textarea>
                        <p class="text-xs text-gray-500 mt-1">çªå‡ºå¿«é€Ÿã€å…è´¹ã€ä¾¿æ·çš„æç°ä½“éªŒ</p>
                    </div>
                </div>
            </div>

            <!-- å¹³å°æ¨èäººè®¾ç½® -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-orange-100 rounded-lg mr-3">
                        <i class="fas fa-crown text-orange-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">ğŸ† å¹³å°æ¨èäººè®¾ç½®</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- å¯ç”¨å¹³å°æ¨èäººåŠŸèƒ½ -->
                    <div class="md:col-span-2">
                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-orange-200 rounded-lg">
                            <div>
                                <label class="block text-lg font-semibold text-gray-800">ğŸ† å¯ç”¨å¹³å°æ¨èäººåŠŸèƒ½</label>
                                <p class="text-sm text-gray-600 mt-1" x-text="'å¼€å¯åï¼Œæ‰€æœ‰æ— æ¨èäººçš„ç”¨æˆ·å°†è‡ªåŠ¨æˆä¸ºå¹³å°çš„ä¸‹çº¿ï¼Œç¡®ä¿å¹³å°ä»æ¯ç¬”äº¤æ˜“è·å¾—' + (settings.commission_rate || 35) + '%æ”¶ç›Š'"></p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-medium" :class="{
                                    'text-green-600': settings.enable_platform_referrer,
                                    'text-gray-500': !settings.enable_platform_referrer
                                }" x-text="settings.enable_platform_referrer ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'"></span>
                                
                                <!-- ä½¿ç”¨è‡ªå®šä¹‰å¼€å…³æ ·å¼ -->
                                <label class="toggle-switch">
                                    <input type="checkbox" x-model="settings.enable_platform_referrer">
                                    <div class="toggle-track" :class="{'active': settings.enable_platform_referrer}">
                                        <div class="toggle-thumb" :class="{'active': settings.enable_platform_referrer}"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¹³å°æ¨èäººåœ°å€ -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            å¹³å°æ¨èäººåœ°å€ <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            x-model="settings.platform_referrer_address"
                            placeholder="è¯·è¾“å…¥å¹³å°æ”¶ç›Šé’±åŒ…åœ°å€ï¼ˆæ”¯æŒä»¥å¤ªåŠå’ŒSolanaåœ°å€ï¼‰"
                            class="w-full border-gray-300 rounded-md shadow-sm"
                            :disabled="!settings.enable_platform_referrer">
                        <p class="text-xs text-gray-500 mt-1" x-text="'æ­¤åœ°å€å°†æ”¶åˆ°æ‰€æœ‰æ— æ¨èäººç”¨æˆ·äº§ç”Ÿçš„' + (settings.commission_rate || 35) + '%ä½£é‡‘'"></p>
                    </div>
                    
                    <!-- å¹³å°æ”¶ç›Šè¯´æ˜ -->
                    <div class="md:col-span-2">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-green-800">ğŸ’° å¹³å°æ”¶ç›Šæœºåˆ¶</h3>
                                    <div class="mt-2 text-sm text-green-700">
                                        <ul class="list-disc pl-5 space-y-1">
                                            <li><strong>è‡ªåŠ¨å½’å±</strong>ï¼šæ‰€æœ‰ç›´æ¥è®¿é—®ç½‘ç«™å¹¶è¿æ¥é’±åŒ…çš„ç”¨æˆ·ï¼ˆæ— æ¨èäººï¼‰å°†è‡ªåŠ¨æˆä¸ºå¹³å°çš„ä¸‹çº¿</li>
                                            <li><strong>ç›´æ¥æ”¶ç›Š</strong>ï¼šå¹³å°å°†è·å¾—è¿™äº›ç”¨æˆ·æ‰€æœ‰äº¤æ˜“çš„35%ä½£é‡‘</li>
                                            <li><strong>é—´æ¥æ”¶ç›Š</strong>ï¼šå¦‚æœè¿™äº›ç”¨æˆ·åˆæ¨èäº†å…¶ä»–äººï¼Œå¹³å°è¿˜å°†è·å¾—æ¨èä½£é‡‘çš„35%</li>
                                            <li><strong>æŒç»­æ”¶ç›Š</strong>ï¼šå½¢æˆå®Œæ•´çš„å¹³å°ç›ˆåˆ©ä½“ç³»ï¼Œç¡®ä¿æ¯ç¬”äº¤æ˜“éƒ½æœ‰å¹³å°æ”¶ç›Š</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ”¶ç›Šç¤ºä¾‹ -->
                    <div class="md:col-span-2">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h5 class="text-sm font-semibold text-blue-700 mb-2">ğŸ“Š å¹³å°æ”¶ç›Šç¤ºä¾‹</h5>
                            <div class="text-xs text-blue-600 space-y-1">
                                <p x-text="'â€¢ ç”¨æˆ·Aç›´æ¥è®¿é—®ï¼šAè´­ä¹°100 USDCèµ„äº§ï¼Œå¹³å°è·å¾—' + (settings.commission_rate || 35) + ' USDC'"></p>
                                <p x-text="'â€¢ ç”¨æˆ·Aæ¨èBï¼šBè´­ä¹°100 USDCï¼ŒAè·å¾—' + (settings.commission_rate || 35) + ' USDCï¼Œå¹³å°è·å¾—Açš„ä½£é‡‘' + (settings.commission_rate || 35) + '%=' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p x-text="'â€¢ ç”¨æˆ·Bæ¨èCï¼šCè´­ä¹°100 USDCï¼ŒBè·å¾—' + (settings.commission_rate || 35) + ' USDCï¼ŒAè·å¾—' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDCï¼Œå¹³å°è·å¾—' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100 * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p class="font-semibold text-blue-800">ğŸ’ å¹³å°ä»æ¯ä¸ªæ— æ¨èäººç”¨æˆ·çš„å®Œæ•´åˆ†é”€ç½‘ç»œä¸­æŒç»­è·å¾—æ”¶ç›Šï¼</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä½£é‡‘è®¡ç®—è§„åˆ™è¯´æ˜ -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-yellow-100 rounded-lg mr-3">
                        <i class="fas fa-calculator text-yellow-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">ä½£é‡‘è®¡ç®—è§„åˆ™</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç›´æ¥æ¨èä½£é‡‘è¯´æ˜</label>
                        <input x-model="settings.commission_rules.direct_commission" type="text" 
                               placeholder="ğŸ”¥ ç›´æ¥æ¨èä½£é‡‘ï¼šå¥½å‹è´­ä¹°é‡‘é¢çš„35%ç«‹å³åˆ°è´¦"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">ä¸€çº§æ¨èçš„ä½£é‡‘è®¡ç®—å’Œåˆ°è´¦è¯´æ˜</p>
                                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¤šçº§æ¨èä½£é‡‘è¯´æ˜</label>
                        <input x-model="settings.commission_rules.indirect_commission" type="text" 
                               placeholder="ğŸ’° å¤šçº§æ¨èä½£é‡‘ï¼šä¸‹çº§ä½£é‡‘æ”¶ç›Šçš„35%æŒç»­èººèµš"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">äºŒçº§åŠä»¥ä¸Šæ¨èçš„ä½£é‡‘è¯´æ˜</p>
                                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç»“ç®—æ—¶é—´è¯´æ˜</label>
                        <input x-model="settings.commission_rules.settlement_time" type="text" 
                               placeholder="âš¡ ä½£é‡‘å®æ—¶åˆ°è´¦ï¼Œéšæ—¶æç°ï¼Œç§’é€Ÿå˜ç°"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">ä½£é‡‘åˆ°è´¦å’Œç»“ç®—æ—¶é—´çš„æè¿°</p>
                                </div>
                                
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è®¡ä»·è´§å¸</label>
                        <select x-model="settings.commission_rules.currency" class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="USDC">USDCï¼ˆç¾å…ƒç¨³å®šå¸ï¼‰</option>
                            <option value="USDT">USDTï¼ˆæ³°è¾¾å¸ï¼‰</option>
                            <option value="USD">USDï¼ˆç¾å…ƒï¼‰</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ä½£é‡‘çš„è®¡ä»·å’Œæ”¯ä»˜è´§å¸å•ä½</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h5 class="text-sm font-semibold text-blue-700 mb-2">ğŸš€ æ— é™çº§åˆ†é”€è¯´æ˜</h5>
                            <div class="text-xs text-blue-600 space-y-1">
                                <p x-text="'â€¢ ç›´æ¥æ¨èï¼šAæ¨èBï¼ŒBè´­ä¹°100 USDCï¼ŒAè·å¾—' + (settings.commission_rate || 35) + ' USDC'"></p>
                                <p x-text="'â€¢ äºŒçº§æ¨èï¼šBæ¨èCï¼ŒCè´­ä¹°100 USDCï¼ŒBè·å¾—' + (settings.commission_rate || 35) + ' USDCï¼ŒAè·å¾—' + (settings.commission_rate || 35) + 'Ã—' + (settings.commission_rate || 35) + '%=' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p x-text="'â€¢ ä¸‰çº§æ¨èï¼šCæ¨èDï¼ŒDè´­ä¹°100 USDCï¼ŒCè·å¾—' + (settings.commission_rate || 35) + ' USDCï¼ŒBè·å¾—' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDCï¼ŒAè·å¾—' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100 * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p x-text="'â€¢ ä¾æ­¤ç±»æ¨ï¼šæ¯çº§å‘ä¸Šä¼ é€’' + (settings.commission_rate || 35) + '%ï¼Œå½¢æˆæ— é™çº§åˆ†é”€ç½‘ç»œï¼'"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¿å­˜æŒ‰é’® -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <div class="text-sm text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    é…ç½®ä¿®æ”¹åå°†ç«‹å³ç”Ÿæ•ˆï¼Œå½±å“æ–°çš„æ¨èå’Œä½£é‡‘è®¡ç®—
                </div>
                <div class="flex space-x-3">
                    <button @click="resetSettings()" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-undo mr-2"></i>é‡ç½®
                    </button>
                <button @click="saveSettings()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-save mr-2"></i>ä¿å­˜é…ç½®
                </button>
                </div>
                                    </div>
                                    </div>
                                </div>
                                
    <!-- æ¨èå…³ç³» -->
    <div x-show="activeTab === 'referrals'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">ç”¨æˆ·æ¨èå…³ç³»</h3>
                <div class="flex items-center space-x-3">
                    <!-- åˆ·æ–°æŒ‰é’® -->
                    <button @click="refreshReferrals()" class="btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        <span>åˆ·æ–°</span>
                    </button>
                    
                    <!-- æ‰¹é‡å¤„ç†æŒ‰é’® -->
                    <button @click="batchUpdatePlatformReferrer()" class="btn-orange">
                        <i class="fas fa-crown"></i>
                        <span>æ‰¹é‡è®¾ä¸ºå¹³å°ä¸‹çº¿</span>
                    </button>
                    
                    <!-- å¹³å°åœ°å€ç®¡ç†æŒ‰é’® -->
                    <button @click="showAddressMigrationDialog()" class="inline-flex items-center px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white text-sm font-weight-500 rounded-lg border border-transparent shadow-sm transition-colors duration-200">
                        <i class="fas fa-exchange-alt"></i>
                        <span>åœ°å€ç®¡ç†</span>
                    </button>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-2">æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„æ¨èå…³ç³»å’Œä¸‹çº§ç»Ÿè®¡ä¿¡æ¯</p>
        </div>
        
        <!-- å¹³å°æ¨èäººåŠŸèƒ½çŠ¶æ€ -->
        <div class="px-6 py-4 border-b border-gray-200" :class="{
            'bg-gradient-to-r from-green-50 to-emerald-50': settings.enable_platform_referrer && settings.platform_referrer_address,
            'bg-gradient-to-r from-red-50 to-pink-50': !settings.enable_platform_referrer || !settings.platform_referrer_address
        }">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg mr-4" :class="{
                        'bg-green-500': settings.enable_platform_referrer && settings.platform_referrer_address,
                        'bg-red-500': !settings.enable_platform_referrer || !settings.platform_referrer_address
                    }">
                        <i class="fas fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold" :class="{
                            'text-green-700': settings.enable_platform_referrer && settings.platform_referrer_address,
                            'text-red-700': !settings.enable_platform_referrer || !settings.platform_referrer_address
                        }">ğŸ¤– è‡ªåŠ¨æ¨èäººåŠŸèƒ½</h4>
                        <p class="text-sm mt-1" :class="{
                            'text-green-600': settings.enable_platform_referrer && settings.platform_referrer_address,
                            'text-red-600': !settings.enable_platform_referrer || !settings.platform_referrer_address
                        }">
                            <span x-show="settings.enable_platform_referrer && settings.platform_referrer_address">
                                âœ… <strong>å·²å¯ç”¨</strong> - æ–°ç”¨æˆ·è¿æ¥é’±åŒ…æ—¶è‡ªåŠ¨è®¾ç½®ä¸ºå¹³å°ä¸‹çº¿
                            </span>
                            <span x-show="!settings.enable_platform_referrer || !settings.platform_referrer_address">
                                âŒ <strong>æœªå¯ç”¨</strong> - è¯·åœ¨"ä½£é‡‘è®¾ç½®"é¡µé¢é…ç½®å¹³å°æ¨èäººåŠŸèƒ½
                            </span>
                        </p>
                        <div class="mt-2 text-xs font-mono" x-show="settings.platform_referrer_address" :class="{
                            'text-green-500': settings.enable_platform_referrer,
                            'text-gray-500': !settings.enable_platform_referrer
                        }">
                            å¹³å°åœ°å€: <span x-text="settings.platform_referrer_address"></span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="space-y-1 text-xs text-gray-600">
                        <div>ğŸ”„ <strong>æ–°ç”¨æˆ·</strong>ï¼šé¦–æ¬¡è¿æ¥é’±åŒ…æ—¶è‡ªåŠ¨ç”Ÿæ•ˆ</div>
                        <div>ğŸ“Š <strong>ç°æœ‰ç”¨æˆ·</strong>ï¼šå¯ä½¿ç”¨å³ä¾§æ‰¹é‡å¤„ç†æŒ‰é’®</div>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" :class="{
                                'bg-green-100 text-green-800': settings.enable_platform_referrer && settings.platform_referrer_address,
                                'bg-red-100 text-red-800': !settings.enable_platform_referrer || !settings.platform_referrer_address
                            }">
                                <span x-text="settings.enable_platform_referrer && settings.platform_referrer_address ? 'åŠŸèƒ½æ­£å¸¸è¿è¡Œ' : 'éœ€è¦é…ç½®å¯ç”¨'"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div x-show="referralStats" class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center">
                    <div class="font-semibold text-blue-600" x-text="referralStats?.total_users || 0"></div>
                    <div class="text-gray-500">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-green-600" x-text="referralStats?.users_with_referrer || 0"></div>
                    <div class="text-gray-500">æœ‰æ¨èäºº</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-purple-600" x-text="referralStats?.platform_users || 0"></div>
                    <div class="text-gray-500">å¹³å°ä¸‹çº¿</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-orange-600" x-text="referralStats?.orphan_users || 0"></div>
                    <div class="text-gray-500">æ— æ¨èäºº</div>
                </div>
            </div>
        </div>
        
        <!-- æœç´¢ç­›é€‰ -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æœç´¢ç”¨æˆ·</label>
                    <input x-model="referralFilters.search" @input.debounce.500ms="loadReferrals()" 
                           type="text" placeholder="æœç´¢ç”¨æˆ·åæˆ–åœ°å€..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ¨èäººç±»å‹</label>
                    <select x-model="referralFilters.referrer_type" @change="loadReferrals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="platform">å¹³å°ä¸‹çº¿</option>
                        <option value="normal">æ™®é€šæ¨è</option>
                        <option value="none">æ— æ¨èäºº</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">é’±åŒ…ç±»å‹</label>
                    <select x-model="referralFilters.wallet_type" @change="loadReferrals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">å…¨éƒ¨é’±åŒ…</option>
                        <option value="ethereum">ä»¥å¤ªåŠ</option>
                        <option value="solana">Solana</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
            </div>
                                </div>
                                
        <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”¨æˆ·ä¿¡æ¯</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ¨èå…³ç³»</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸‹çº§ç”¨æˆ·</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€ & æ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="referralsLoading">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½ç”¨æˆ·æ•°æ®ä¸­...
                                                    </td>
                        </tr>
                    </template>
                    
                    <template x-if="!referralsLoading && referrals.length === 0">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">æš‚æ— ç”¨æˆ·æ•°æ®</td>
                        </tr>
                    </template>
                    
                    <template x-for="referral in referrals" :key="referral.id">
                        <tr class="hover:bg-gray-50">
                            <!-- ç”¨æˆ·ä¿¡æ¯ -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center">
                                            <span class="text-sm font-medium text-white" x-text="referral.username ? referral.username.charAt(0).toUpperCase() : '?'"></span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900" x-text="referral.username"></div>
                                        <div class="text-xs text-gray-500" x-text="'ID: ' + referral.id"></div>
                                        <!-- é’±åŒ…åœ°å€ -->
                                        <div class="mt-1 space-y-1">
                                            <div x-show="referral.eth_address" class="text-xs">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                                    ETH
                                                </span>
                                                <span class="ml-1 text-gray-600" x-text="referral.eth_address ? referral.eth_address.slice(0, 8) + '...' + referral.eth_address.slice(-4) : '-'"></span>
                                            </div>
                                            <div x-show="referral.solana_address" class="text-xs">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                                    SOL
                                                </span>
                                                <span class="ml-1 text-gray-600" x-text="referral.solana_address ? referral.solana_address.slice(0, 8) + '...' + referral.solana_address.slice(-4) : '-'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- æ¨èå…³ç³» -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div x-show="referral.referrer_address">
                                    <div class="flex items-center mb-1">
                                <span :class="{
                                            'bg-orange-100 text-orange-800 border-orange-200': referral.referrer_type === 'platform',
                                            'bg-green-100 text-green-800 border-green-200': referral.referrer_type === 'normal'
                                        }" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border">
                                            <span x-text="referral.referrer_type === 'platform' ? 'ğŸ† å¹³å°ä¸‹çº¿' : 'ğŸ‘¤ æ™®é€šæ¨è'"></span>
                                </span>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        æ¨èäºº: <span x-text="referral.referrer_address ? referral.referrer_address.slice(0, 10) + '...' + referral.referrer_address.slice(-4) : '-'"></span>
                                    </div>
                                </div>
                                <div x-show="!referral.referrer_address">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                        âŒ æ— æ¨èäºº
                                    </span>
                                </div>
                                                    </td>
                            
                            <!-- ä¸‹çº§ç”¨æˆ· -->
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="text-2xl font-bold" :class="{
                                    'text-green-600': referral.downline_count > 0,
                                    'text-gray-400': referral.downline_count === 0
                                }" x-text="referral.downline_count"></div>
                                <div class="text-xs text-gray-500">ä¸ªä¸‹çº§</div>
                                <div x-show="referral.downline_count > 0" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                        ğŸ’° æœ‰æ”¶ç›Š
                                    </span>
                                </div>
                            </td>
                            
                            <!-- çŠ¶æ€ & æ—¶é—´ -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <!-- è´¦æˆ·çŠ¶æ€ -->
                                <div class="mb-2">
                                    <span :class="{
                                        'bg-green-100 text-green-800 border-green-200': referral.is_active,
                                        'bg-red-100 text-red-800 border-red-200': !referral.is_active
                                    }" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border">
                                        <span x-text="referral.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ ç¦ç”¨'"></span>
                                    </span>
                                </div>
                                <!-- æ—¶é—´ä¿¡æ¯ -->
                                <div class="text-xs text-gray-500 space-y-1">
                                    <div>
                                        <span class="font-medium">åŠ å…¥:</span>
                                        <span x-text="formatDate(referral.joined_at)"></span>
                                    </div>
                                    <div x-show="referral.last_login_at">
                                        <span class="font-medium">ç™»å½•:</span>
                                        <span x-text="formatDate(referral.last_login_at)"></span>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- æ“ä½œ -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button @click="viewUserDetail(referral)" 
                                            class="text-blue-600 hover:text-blue-900 px-2 py-1 rounded text-xs bg-blue-50 hover:bg-blue-100">
                                        <i class="fas fa-eye"></i> è¯¦æƒ…
                                    </button>
                                    <button x-show="!referral.referrer_address" 
                                            @click="setPlatformReferrer(referral)"
                                            class="text-orange-600 hover:text-orange-900 px-2 py-1 rounded text-xs bg-orange-50 hover:bg-orange-100">
                                        <i class="fas fa-crown"></i> è®¾ä¸ºå¹³å°ä¸‹çº¿
                                    </button>
                                </div>
                            </td>
                                                </tr>
                    </template>
                                            </tbody>
                                        </table>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    æ˜¾ç¤º <span x-text="(referralPagination.page - 1) * referralPagination.limit + 1"></span> åˆ° 
                    <span x-text="Math.min(referralPagination.page * referralPagination.limit, referralPagination.total)"></span> æ¡ï¼Œ
                    å…± <span x-text="referralPagination.total"></span> æ¡è®°å½•
                </div>
                <div class="flex space-x-2">
                    <button @click="loadReferrals(1)" :disabled="referralPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">é¦–é¡µ</button>
                    <button @click="loadReferrals(referralPagination.page - 1)" :disabled="referralPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <button @click="loadReferrals(referralPagination.page + 1)" :disabled="referralPagination.page >= referralPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                    <button @click="loadReferrals(referralPagination.pages)" :disabled="referralPagination.page >= referralPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">æœ«é¡µ</button>
                </div>
            </div>
        </div>
        
        <!-- ğŸ”„ å¹³å°åœ°å€è¿ç§»å¼¹çª— -->
        <div x-show="showAddressMigration" 
             class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"
             style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-exchange-alt text-purple-500 mr-2"></i>
                        ğŸ”„ å¹³å°æ¨èäººåœ°å€ç®¡ç†
                    </h3>
                    <button @click="showAddressMigration = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- å½“å‰çŠ¶æ€æ¦‚è§ˆ -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        å½“å‰å¹³å°åœ°å€çŠ¶æ€
                    </h4>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><strong>å½“å‰åœ°å€ï¼š</strong> <span x-text="platformAddressData.current_platform_address || 'æœªè®¾ç½®'" class="font-mono"></span></p>
                        <p><strong>æ€»å¹³å°ç”¨æˆ·ï¼š</strong> <span x-text="platformAddressData.total_platform_users || 0"></span> ä¸ª</p>
                    </div>
                </div>
                
                <!-- å†å²å¹³å°åœ°å€åˆ—è¡¨ -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-history text-green-500 mr-2"></i>
                        å†å²å¹³å°åœ°å€åˆ†å¸ƒ
                    </h4>
                    <div class="space-y-2">
                        <template x-if="platformAddressData.platform_addresses && platformAddressData.platform_addresses.length > 0">
                            <div>
                                <template x-for="address in platformAddressData.platform_addresses" :key="address.address">
                                    <div class="flex items-center justify-between p-3 border rounded-lg" :class="{
                                        'bg-green-50 border-green-200': address.is_current,
                                        'bg-yellow-50 border-yellow-200': !address.is_current && address.user_count > 0,
                                        'bg-gray-50 border-gray-200': !address.is_current && address.user_count === 0
                                    }">
                                        <div>
                                            <div class="font-mono text-sm" x-text="address.address"></div>
                                            <div class="text-xs text-gray-600">
                                                <span x-text="address.user_count"></span> ä¸ªç”¨æˆ· 
                                                <span x-show="address.is_current" class="text-green-600 font-medium">â€¢ å½“å‰ä½¿ç”¨</span>
                                                <span x-show="!address.is_current && address.user_count > 0" class="text-yellow-600 font-medium">â€¢ éœ€è¦è¿ç§»</span>
                                            </div>
                                        </div>
                                        <div>
                                            <span x-show="address.is_current" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                âœ… å½“å‰åœ°å€
                                            </span>
                                            <span x-show="!address.is_current && address.user_count > 0" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                âš ï¸ å¾…è¿ç§»
                                            </span>
                                            <span x-show="!address.is_current && address.user_count === 0" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                ğŸ’¤ ç©ºåœ°å€
                                            </span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        
                        <template x-if="!platformAddressData.platform_addresses || platformAddressData.platform_addresses.length === 0">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-inbox text-2xl mb-2"></i>
                                <p>æš‚æ— å†å²å¹³å°åœ°å€</p>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- è¿ç§»æ“ä½œè¡¨å• -->
                <div x-show="platformAddressData.platform_addresses && platformAddressData.platform_addresses.length > 1" class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-exchange-alt text-purple-500 mr-2"></i>
                        æ‰§è¡Œåœ°å€è¿ç§»
                    </h4>
                    <form @submit.prevent="executeMigration()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    é€‰æ‹©æ—§åœ°å€ï¼ˆè¿ç§»æºï¼‰
                                </label>
                                <select x-model="migrationForm.old_address" class="w-full border-gray-300 rounded-md shadow-sm" required>
                                    <option value="">è¯·é€‰æ‹©è¦è¿ç§»çš„æ—§åœ°å€...</option>
                                    <template x-for="address in platformAddressData.platform_addresses" :key="address.address">
                                        <option x-show="!address.is_current && address.user_count > 0" 
                                                :value="address.address" 
                                                x-text="`${address.address.slice(0, 20)}... (${address.user_count}ä¸ªç”¨æˆ·)`"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    æ–°åœ°å€ï¼ˆè¿ç§»ç›®æ ‡ï¼‰
                                </label>
                                <input x-model="migrationForm.new_address" 
                                       type="text" 
                                       readonly
                                       class="w-full border-gray-300 rounded-md shadow-sm bg-gray-50"
                                       :value="platformAddressData.current_platform_address">
                                <p class="text-xs text-gray-500 mt-1">è‡ªåŠ¨ä½¿ç”¨å½“å‰é…ç½®çš„å¹³å°åœ°å€</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 mr-3"></i>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-medium mb-1">âš ï¸ é‡è¦æé†’</p>
                                    <ul class="list-disc pl-4 space-y-1">
                                        <li>æ­¤æ“ä½œå°†æŠŠé€‰å®šæ—§åœ°å€çš„æ‰€æœ‰ç”¨æˆ·æ¨èå…³ç³»æ›´æ–°ä¸ºæ–°åœ°å€</li>
                                        <li>è¿ç§»åï¼Œè¿™äº›ç”¨æˆ·çš„ä½£é‡‘å°†æµå‘æ–°åœ°å€</li>
                                        <li>æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·ç¡®è®¤åœ°å€æ­£ç¡®</li>
                                        <li>å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œæ­¤æ“ä½œ</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" 
                                    @click="showAddressMigration = false"
                                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                                <i class="fas fa-times mr-2"></i>å–æ¶ˆ
                            </button>
                            <button type="submit"
                                    :disabled="!migrationForm.old_address"
                                    class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-exchange-alt mr-2"></i>æ‰§è¡Œè¿ç§»
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- æ“ä½œå†å² -->
                <div x-show="platformAddressData.migration_logs && platformAddressData.migration_logs.length > 0" class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-clock text-blue-500 mr-2"></i>
                        æœ€è¿‘æ“ä½œå†å²
                    </h4>
                    <div class="space-y-2 max-h-32 overflow-y-auto">
                        <template x-for="log in platformAddressData.migration_logs" :key="log.timestamp">
                            <div class="text-xs bg-gray-50 border border-gray-200 rounded p-2">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="font-medium text-gray-800">åœ°å€è¿ç§»</span>
                                        <span class="text-gray-600">æ›´æ–°äº† <span x-text="log.updated_users_count"></span> ä¸ªç”¨æˆ·</span>
                                    </div>
                                    <span class="text-gray-500" x-text="new Date(log.timestamp).toLocaleString('zh-CN')"></span>
                                </div>
                                <div class="mt-1 text-gray-600">
                                    <div>æ—§å€: <span class="font-mono" x-text="log.old_address.slice(0, 20) + '...'"></span></div>
                                    <div>æ–°å€: <span class="font-mono" x-text="log.new_address.slice(0, 20) + '...'"></span></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- å¸®åŠ©è¯´æ˜ -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h5 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-question-circle mr-1"></i>
                        ä½¿ç”¨è¯´æ˜
                    </h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><strong>1. åœ°å€æ›´æ¢ï¼š</strong>åœ¨"ä½£é‡‘è®¾ç½®"é¡µé¢ä¿®æ”¹å¹³å°æ¨èäººåœ°å€</p>
                        <p><strong>2. è‡ªåŠ¨æ£€æµ‹ï¼š</strong>ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹åœ°å€å˜æ›´å¹¶æç¤ºè¿ç§»</p>
                        <p><strong>3. æ‰¹é‡è¿ç§»ï¼š</strong>ä¸€é”®å°†æ—§åœ°å€çš„ç”¨æˆ·è¿ç§»åˆ°æ–°åœ°å€</p>
                        <p><strong>4. æ”¶ç›Šç»Ÿä¸€ï¼š</strong>ç¡®ä¿æ‰€æœ‰å¹³å°æ”¶ç›Šæµå‘åŒä¸€ä¸ªåœ°å€</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å–ç°è®°å½• -->
    <div x-show="activeTab === 'withdrawals'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">å–ç°è®°å½•</h3>
                <div class="flex space-x-2">
                    <button @click="refreshWithdrawals()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°
                    </button>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰æ¡ä»¶ -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">çŠ¶æ€</label>
                    <select x-model="withdrawalFilters.status" @change="loadWithdrawals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="pending">å¾…å¤„ç†</option>
                        <option value="processing">å¤„ç†ä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="failed">å¤±è´¥</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ—¶é—´èŒƒå›´</label>
                    <select x-model="withdrawalFilters.time_range" @change="loadWithdrawals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">å…¨éƒ¨æ—¶é—´</option>
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æœç´¢</label>
                    <input x-model="withdrawalFilters.search" @input.debounce.500ms="loadWithdrawals()" 
                           type="text" placeholder="æœç´¢åœ°å€æˆ–äº¤æ˜“å“ˆå¸Œ..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="flex items-end">
                    <button @click="loadWithdrawals()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-search mr-2"></i>æœç´¢
                    </button>
                </div>
            </div>
        </div>

        <!-- å–ç°è®°å½•è¡¨æ ¼ -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”¨æˆ·åœ°å€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æç°åœ°å€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¢</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å»¶è¿Ÿæ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç”³è¯·æ—¶é—´</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="withdrawalsLoading">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½å–ç°è®°å½•ä¸­...
                            </td>
                        </tr>
                    </template>
                    
                    <template x-if="!withdrawalsLoading && withdrawals.length === 0">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">æš‚æ— å–ç°è®°å½•</td>
                        </tr>
                    </template>
                    
                    <template x-for="withdrawal in withdrawals" :key="withdrawal.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="withdrawal.id"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="withdrawal.user_address ? withdrawal.user_address.slice(0, 8) + '...' + withdrawal.user_address.slice(-6) : '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="withdrawal.to_address ? withdrawal.to_address.slice(0, 8) + '...' + withdrawal.to_address.slice(-6) : '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(withdrawal.amount || 0)"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-yellow-100 text-yellow-800': withdrawal.status === 'pending',
                                    'bg-blue-100 text-blue-800': withdrawal.status === 'processing',
                                    'bg-green-100 text-green-800': withdrawal.status === 'completed',
                                    'bg-red-100 text-red-800': withdrawal.status === 'failed',
                                    'bg-gray-100 text-gray-800': withdrawal.status === 'cancelled'
                                }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="getWithdrawalStatusText(withdrawal.status)"></span>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div x-show="withdrawal.status === 'pending' && withdrawal.remaining_delay_seconds > 0">
                                    <span x-text="Math.ceil(withdrawal.remaining_delay_seconds / 60)"></span> åˆ†é’Ÿ
                                </div>
                                <div x-show="withdrawal.status === 'pending' && withdrawal.remaining_delay_seconds <= 0">
                                    <span class="text-green-600">å¯å¤„ç†</span>
                                </div>
                                <div x-show="withdrawal.status !== 'pending'">-</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(withdrawal.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button x-show="withdrawal.status === 'pending' && withdrawal.is_ready_to_process" 
                                        @click="processWithdrawal(withdrawal)" 
                                        class="text-green-600 hover:text-green-900 mr-2">
                                    <i class="fas fa-check"></i> å¤„ç†
                                </button>
                                <button x-show="withdrawal.status === 'pending'" 
                                        @click="cancelWithdrawal(withdrawal)" 
                                        class="text-red-600 hover:text-red-900 mr-2">
                                    <i class="fas fa-times"></i> å–æ¶ˆ
                                </button>
                                <button @click="viewWithdrawal(withdrawal)" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    æ˜¾ç¤º <span x-text="(withdrawalPagination.page - 1) * withdrawalPagination.limit + 1"></span> åˆ° 
                    <span x-text="Math.min(withdrawalPagination.page * withdrawalPagination.limit, withdrawalPagination.total)"></span> æ¡ï¼Œ
                    å…± <span x-text="withdrawalPagination.total"></span> æ¡è®°å½•
                </div>
                <div class="flex space-x-2">
                    <button @click="loadWithdrawals(1)" :disabled="withdrawalPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">é¦–é¡µ</button>
                    <button @click="loadWithdrawals(withdrawalPagination.page - 1)" :disabled="withdrawalPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">ä¸Šä¸€é¡µ</button>
                    <button @click="loadWithdrawals(withdrawalPagination.page + 1)" :disabled="withdrawalPagination.page >= withdrawalPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">ä¸‹ä¸€é¡µ</button>
                    <button @click="loadWithdrawals(withdrawalPagination.pages)" :disabled="withdrawalPagination.page >= withdrawalPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">æœ«é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªåŠ¨åŒ–ç³»ç»Ÿ -->
    <div x-show="activeTab === 'automation'" class="space-y-6" x-cloak>
        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 border border-blue-200">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="p-3 bg-blue-500 rounded-lg">
                        <i class="fas fa-robot text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-blue-700">ğŸ¤– å…¨è‡ªåŠ¨åŒ–åˆ†é”€ç³»ç»Ÿè¯´æ˜</h3>
                    <div class="mt-2 text-sm text-blue-600 space-y-2">
                        <p><strong>ğŸ’° è‡ªåŠ¨ä½£é‡‘è®¡ç®—</strong>ï¼šç³»ç»Ÿå®æ—¶è®¡ç®—ç”¨æˆ·çš„35%æ— é™çº§åˆ†é”€ä½£é‡‘ï¼Œæ— éœ€äººå·¥å¹²é¢„</p>
                        <p><strong>âš¡ è‡ªåŠ¨æç°å¤„ç†</strong>ï¼šç”¨æˆ·ç”³è¯·æç°åï¼Œç³»ç»Ÿå»¶è¿Ÿ1åˆ†é’Ÿè‡ªåŠ¨å¤„ç†ï¼Œé›¶äººå·¥æˆæœ¬</p>
                        <p><strong>ğŸ† å¹³å°è‡ªåŠ¨å½’å±</strong>ï¼šæ‰€æœ‰æ— æ¨èäººç”¨æˆ·è‡ªåŠ¨æˆä¸ºå¹³å°ä¸‹çº¿ï¼Œç¡®ä¿å¹³å°æ”¶ç›Š</p>
                        <p><strong>ğŸ”„ å®æ—¶ç›‘æ§</strong>ï¼šç³»ç»Ÿ24å°æ—¶è¿è¡Œï¼Œå®æ—¶ç›‘æ§å¾…å¤„ç†å–ç°å’Œç³»ç»ŸçŠ¶æ€</p>
                        <p><strong>ğŸ“Š æ™ºèƒ½ç»Ÿè®¡</strong>ï¼šè‡ªåŠ¨ç»Ÿè®¡ç”¨æˆ·æ¨èå…³ç³»ã€ä½£é‡‘æ”¶ç›Šå’Œå–ç°è®°å½•</p>
                    </div>
                    <div class="mt-3 p-3 bg-white rounded border border-blue-200">
                        <p class="text-xs text-blue-800"><strong>ğŸ¯ æ ¸å¿ƒä»·å€¼</strong>ï¼šå®Œå…¨æ— äººå‚ä¸çš„åˆ†é”€ç³»ç»Ÿï¼Œè®©æ‚¨ä¸“æ³¨ä¸šåŠ¡å‘å±•ï¼Œä½£é‡‘ç®¡ç†å…¨éƒ¨è‡ªåŠ¨åŒ–å¤„ç†ï¼</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-700">ğŸ¤– ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</h3>
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-green-600">ç³»ç»Ÿè¿è¡Œä¸­</span>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-1">å…¨è‡ªåŠ¨åŒ–ä½£é‡‘è®¡ç®—ã€å–ç°å¤„ç†å’Œåˆ†é”€ç®¡ç†ç³»ç»Ÿ</p>
            </div>

            <div class="p-6">
                <!-- ç³»ç»ŸçŠ¶æ€æŒ‡æ ‡ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-500 rounded-lg mr-3">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-blue-700">è‡ªåŠ¨åŒ–çŠ¶æ€</h4>
                                <p class="text-lg font-bold text-blue-800" x-text="automationStatus.system_status || 'active'"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-500 rounded-lg mr-3">
                                <i class="fas fa-clock text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-yellow-700">å¾…å¤„ç†å–ç°</h4>
                                <p class="text-lg font-bold text-yellow-800" x-text="automationStatus.pending_withdrawals_count || 0"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-500 rounded-lg mr-3">
                                <i class="fas fa-check-circle text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-green-700">å¯ç«‹å³å¤„ç†</h4>
                                <p class="text-lg font-bold text-green-800" x-text="automationStatus.ready_to_process_count || 0"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-500 rounded-lg mr-3">
                                <i class="fas fa-infinity text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-purple-700">åˆ†é”€å±‚çº§</h4>
                                <p class="text-lg font-bold text-purple-800" x-text="automationStatus.automation_config?.max_referral_levels === 999 ? 'âˆ æ— é™çº§' : (automationStatus.automation_config?.max_referral_levels || 2) + 'çº§'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è‡ªåŠ¨åŒ–é…ç½®å±•ç¤º -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">
                            <i class="fas fa-cogs text-blue-500 mr-2"></i>ç³»ç»Ÿé…ç½®
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">ä½£é‡‘ç‡</span>
                                <span class="font-medium" x-text="(automationStatus.automation_config?.commission_rate || settings.commission_rate || 0) + '%'"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">å–ç°å»¶è¿Ÿ</span>
                                <span class="font-medium" x-text="(automationStatus.automation_config?.withdrawal_delay_minutes || settings.withdrawal_delay_minutes || 0) + ' åˆ†é’Ÿ'"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">æœ€ä½å–ç°é‡‘é¢</span>
                                <span class="font-medium" x-text="'$' + (automationStatus.automation_config?.min_withdraw_amount || settings.min_withdraw_amount || 0)"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">å¤šçº§åˆ†é”€</span>
                                <span class="font-medium" x-text="automationStatus.automation_config?.enable_multi_level ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨'"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">
                            <i class="fas fa-calculator text-green-500 mr-2"></i>æ— é™çº§åˆ†é”€ç®—æ³•
                        </h4>
                        <div class="text-sm text-gray-600 space-y-2">
                            <div x-text="'ğŸ¯ Aæ¨èBï¼šBè´­ä¹°100U â†’ Aå¾—' + (settings.commission_rate || 35) + 'U'"></div>
                            <div x-text="'ğŸ’° Bæ¨èCï¼šCè´­ä¹°100U â†’ Bå¾—' + (settings.commission_rate || 35) + 'Uï¼ŒAå¾—' + (settings.commission_rate || 35) + 'Ã—' + (settings.commission_rate || 35) + '%=' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + 'U'"></div>
                            <div x-text="'ğŸš€ Cæ¨èDï¼šDè´­ä¹°100U â†’ Cå¾—' + (settings.commission_rate || 35) + 'Uï¼ŒBå¾—' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + 'Uï¼ŒAå¾—' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100 * (settings.commission_rate || 35) / 100).toFixed(2) + 'U'"></div>
                            <div class="text-blue-600 font-medium" x-text="'âœ¨ ä¾æ­¤ç±»æ¨ï¼Œæ¯çº§å‘ä¸Šä¼ é€’' + (settings.commission_rate || 35) + '%ï¼Œå½¢æˆæ— é™çº§æ”¶ç›Šç½‘ç»œï¼'"></div>
                        </div>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨æ“ä½œåŒºåŸŸ -->
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-700">
                            <i class="fas fa-play-circle text-purple-500 mr-2"></i>æ‰‹åŠ¨æ“ä½œ
                        </h4>
                        <div class="text-sm text-gray-500">
                            ç³»ç»Ÿæ¯åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button @click="runAutomation()" 
                                class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-robot mr-2"></i>è¿è¡Œè‡ªåŠ¨åŒ–å‘¨æœŸ
                        </button>
                        
                        <button @click="refreshAutomationStatus()" 
                                class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>åˆ·æ–°ç³»ç»ŸçŠ¶æ€
                        </button>
                        
                        <button @click="showCreateWithdrawal = true" 
                                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>ä»£ç†åˆ›å»ºå–ç°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ›å»ºå–ç°ç”³è¯·å¼¹çª— -->
        <div x-show="showCreateWithdrawal" 
             class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"
             style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ä»£ç†åˆ›å»ºå–ç°ç”³è¯·</h3>
                    <button @click="showCreateWithdrawal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form @submit.prevent="createWithdrawal()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·åœ°å€</label>
                            <input x-model="withdrawalForm.user_address" type="text" required
                                   placeholder="0x..."
                                   class="w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æç°åˆ°åœ°å€</label>
                            <input x-model="withdrawalForm.to_address" type="text" required
                                   placeholder="0x..."
                                   class="w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æç°é‡‘é¢</label>
                            <div class="relative">
                                <input x-model="withdrawalForm.amount" type="number" step="0.01" min="0.01" required
                                       class="w-full border-gray-300 rounded-md shadow-sm pr-16">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 text-sm">USDC</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showCreateWithdrawal = false"
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                                å–æ¶ˆ
                            </button>
                            <button type="submit"
                                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                åˆ›å»ºç”³è¯·
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function commissionData() {
        return {
            activeTab: 'records',
            stats: {},
            records: [],
            referrals: [],
            withdrawals: [],
            settings: {
                commission_rate: 35.0,
                commission_description: 'ğŸ’° æ¨èå¥½å‹å³äº«35%è¶…é«˜ä½£é‡‘ï¼Œäººäººéƒ½æ˜¯èµšé’±è¾¾äººï¼',
                share_button_text: 'ğŸš€ åˆ†äº«èµšå¤§é’±',
                share_description: 'ğŸ¯ æ¨èå¥½å‹è´­ä¹°é¡¹ç›®ï¼Œæ‚¨ç«‹å³è·å¾—35%ç°é‡‘å¥–åŠ±ï¼å¤šçº§åˆ†é”€ï¼Œæ”¶ç›Šæ— ä¸Šé™ï¼',
                share_success_message: 'ğŸ‰ åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼å¿«å»é‚€è¯·å¥½å‹èµšå–35%ä½£é‡‘å§ï¼',
                min_withdraw_amount: 10.0,
                withdraw_fee_rate: 0.0,
                withdraw_description: 'ğŸ’ æœ€ä½æç°10 USDCï¼Œé›¶æ‰‹ç»­è´¹ï¼Œç§’åˆ°è´¦ï¼éšæ—¶æç°ï¼Œè‡ªç”±æ”¯é…ï¼',
                withdrawal_delay_minutes: 1,
                max_referral_levels: 2,
                enable_multi_level: true,
                platform_referrer_address: '',
                enable_platform_referrer: true,
                commission_rules: {
                    direct_commission: 'ğŸ”¥ ç›´æ¥æ¨èä½£é‡‘ï¼šå¥½å‹è´­ä¹°é‡‘é¢çš„35%ç«‹å³åˆ°è´¦',
                    indirect_commission: 'ğŸ’° å¤šçº§æ¨èä½£é‡‘ï¼šä¸‹çº§ä½£é‡‘æ”¶ç›Šçš„35%æŒç»­èººèµš',
                    settlement_time: 'âš¡ ä½£é‡‘å®æ—¶åˆ°è´¦ï¼Œéšæ—¶æç°ï¼Œç§’é€Ÿå˜ç°',
                    currency: 'USDC',
                    platform_earnings: 'ğŸ† å¹³å°æ”¶ç›Šï¼šæ‰€æœ‰æ— æ¨èäººç”¨æˆ·çš„35%ä½£é‡‘å½’å¹³å°æ‰€æœ‰'
                }
            },
            recordsLoading: false,
            referralsLoading: false,
            withdrawalsLoading: false,
            
            // è‡ªåŠ¨åŒ–ç³»ç»Ÿç›¸å…³
            automationStatus: {},
            showCreateWithdrawal: false,
            withdrawalForm: {
                user_address: '',
                to_address: '',
                amount: ''
            },
            
            // ğŸ”„ å¹³å°åœ°å€ç®¡ç†ç›¸å…³
            platformAddressData: {},
            showAddressMigration: false,
            migrationForm: {
                old_address: '',
                new_address: ''
            },
            
            // æ•°æ®è¿‡æ»¤å’Œåˆ†é¡µ
        recordFilters: {
                status: '',
            type: '',
                time_range: '',
                search: ''
        },
            referralFilters: {
                search: '',
                referrer_type: '',
                wallet_type: ''
            },
            withdrawalFilters: {
                status: '',
                time_range: '',
                search: ''
            },
            recordPagination: {
                page: 1,
                limit: 10,
                total: 0,
                pages: 0
            },
            referralPagination: {
                page: 1,
                limit: 50,
                total: 0,
                pages: 0
            },
            withdrawalPagination: {
                page: 1,
                limit: 10,
                total: 0,
                pages: 0
            },
            
            // æ¨èå…³ç³»ç»Ÿè®¡
            referralStats: null,
            
            async loadCommissionData() {
                try {
                    // é¦–å…ˆåŠ è½½è®¾ç½®ï¼Œå› ä¸ºå…¶ä»–åŠŸèƒ½ä¾èµ–è®¾ç½®æ•°æ®
                    await this.loadSettings();
                    console.log('è®¾ç½®åŠ è½½å®Œæˆ:', {
                        enable_platform_referrer: this.settings.enable_platform_referrer,
                        platform_referrer_address: this.settings.platform_referrer_address
                    });
                    
                    // å¹¶è¡ŒåŠ è½½å…¶ä»–æ•°æ®
                await Promise.all([
                    this.loadStats(),
                    this.loadRecords(),
                        this.refreshAutomationStatus()
                ]);
                } catch (error) {
                    console.error('åŠ è½½ä½£é‡‘æ•°æ®å¤±è´¥:', error);
                }
            },
            
            switchTab(tab) {
                this.activeTab = tab;
                // åˆ‡æ¢åˆ°æ¨èå…³ç³»æ ‡ç­¾é¡µæ—¶åŠ è½½æ•°æ®å’Œè®¾ç½®
                if (tab === 'referrals') {
                    // ç¡®ä¿è®¾ç½®æ•°æ®å·²åŠ è½½
                    this.loadSettings().then(() => {
                        // å¦‚æœæ¨èå…³ç³»æ•°æ®ä¸ºç©ºåˆ™åŠ è½½
                        if (this.referrals.length === 0) {
                    this.loadReferrals();
                        }
                    });
                }
                // åˆ‡æ¢åˆ°å–ç°è®°å½•æ ‡ç­¾é¡µæ—¶åŠ è½½æ•°æ®
                if (tab === 'withdrawals' && this.withdrawals.length === 0) {
                    this.loadWithdrawals();
                }
                // åˆ‡æ¢åˆ°è‡ªåŠ¨åŒ–æ ‡ç­¾é¡µæ—¶åŠ è½½çŠ¶æ€
                if (tab === 'automation') {
                    this.refreshAutomationStatus();
                }
            },
            
            async loadStats() {
                try {
                    const response = await fetch('/api/admin/commission/stats');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.stats = {
                                total_commission: data.total_commission || 0,
                                total_referrals: data.total_referrals || 0,
                                pending_commission: data.pending_commission || 0,
                                commission_rate: data.commission_rate || 0
                            };
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                }
            },
            
            async loadRecords(page = null) {
                if (page) this.recordPagination.page = page;
                this.recordsLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.recordPagination.page,
                        limit: this.recordPagination.limit,
                        ...this.recordFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/records?${params}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.records = data.data || [];
                            this.recordPagination.total = data.pagination?.total || 0;
                            this.recordPagination.pages = data.pagination?.pages || 0;
                        } else {
                            throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ä½£é‡‘è®°å½•å¤±è´¥:', error);
                    alert('åŠ è½½ä½£é‡‘è®°å½•å¤±è´¥: ' + error.message);
                } finally {
                    this.recordsLoading = false;
                }
            },
            
            async loadReferrals(page = null) {
                if (page) this.referralPagination.page = page;
                this.referralsLoading = true;
                try {
                    const params = new URLSearchParams({
                        page: this.referralPagination.page,
                        limit: this.referralPagination.limit,
                        ...this.referralFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/referrals?${params}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.referrals = data.items || [];
                            this.referralPagination.total = data.total || 0;
                            this.referralPagination.pages = data.pages || 0;
                            this.referralStats = data.statistics || null;
                        } else {
                            throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¨èå…³ç³»å¤±è´¥:', error);
                    alert('åŠ è½½æ¨èå…³ç³»å¤±è´¥: ' + error.message);
                } finally {
                    this.referralsLoading = false;
                }
            },
            
            async refreshReferrals() {
                await this.loadReferrals();
            },
            
            async batchUpdatePlatformReferrer() {
                // æ£€æŸ¥å¹³å°æ¨èäººé…ç½®
                if (!this.settings.enable_platform_referrer) {
                    alert('âš ï¸ å¹³å°æ¨èäººåŠŸèƒ½æœªå¯ç”¨\n\nè¯·å…ˆåœ¨"ä½£é‡‘è®¾ç½®"é¡µé¢å¼€å¯"å¯ç”¨å¹³å°æ¨èäººåŠŸèƒ½"å¼€å…³');
                    return;
                }
                
                if (!this.settings.platform_referrer_address) {
                    alert('âš ï¸ å¹³å°æ¨èäººåœ°å€æœªé…ç½®\n\nè¯·å…ˆåœ¨"ä½£é‡‘è®¾ç½®"é¡µé¢é…ç½®"å¹³å°æ¨èäººåœ°å€"');
                    return;
                }
                
                if (!confirm('ğŸ† æ‰¹é‡è®¾ç½®å¹³å°æ¨èäºº\n\nç¡®å®šè¦å°†æ‰€æœ‰æ— æ¨èäººçš„ç”¨æˆ·è®¾ç½®ä¸ºå¹³å°ä¸‹çº¿å—ï¼Ÿ\n\nâœ… è®¾ç½®åè¿™äº›ç”¨æˆ·çš„æ¨èäººå°†å˜ä¸ºå¹³å°åœ°å€\nğŸ’° å¹³å°å°†è·å¾—ä»–ä»¬æ‰€æœ‰äº¤æ˜“çš„35%ä½£é‡‘\nğŸ”’ æ­¤æ“ä½œä¸å¯æ’¤é”€\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­')) return;
                
                try {
                    const response = await fetch('/api/admin/commission/platform-referrer/batch-update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error('æ‰¹é‡æ›´æ–°å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        const message = [
                            'ğŸ‰ æ‰¹é‡æ›´æ–°æˆåŠŸï¼',
                            '',
                            `ğŸ“Š å¤„ç†ç»“æœï¼š`,
                            `â€¢ æ›´æ–°ç”¨æˆ·æ•°ï¼š${data.data.updated_count} ä¸ª`,
                            `â€¢ å¹³å°åœ°å€ï¼š${data.data.platform_address}`,
                            `â€¢ æ›´æ–°æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`,
                            '',
                            'ğŸ’° è¿™äº›ç”¨æˆ·ç°åœ¨æ˜¯å¹³å°çš„ä¸‹çº¿ï¼Œ',
                            '   æ‰€æœ‰äº¤æ˜“éƒ½å°†ä¸ºå¹³å°äº§ç”Ÿ35%ä½£é‡‘æ”¶ç›Šï¼'
                        ];
                        alert(message.join('\n'));
                        await this.loadReferrals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || 'æ‰¹é‡æ›´æ–°å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æ‰¹é‡æ›´æ–°å¹³å°æ¨èäººå¤±è´¥:', error);
                    alert('âŒ æ‰¹é‡æ›´æ–°å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ');
                }
            },
            
            async setPlatformReferrer(referral) {
                if (!this.settings.platform_referrer_address) {
                    alert('è¯·å…ˆåœ¨ä½£é‡‘è®¾ç½®ä¸­é…ç½®å¹³å°æ¨èäººåœ°å€');
                    return;
                }
                
                if (!confirm(`ç¡®å®šè¦å°†ç”¨æˆ· ${referral.username} è®¾ç½®ä¸ºå¹³å°ä¸‹çº¿å—ï¼Ÿ\n\nç”¨æˆ·ID: ${referral.id}\nå½“å‰æ¨èäºº: æ— \nå°†è®¾ç½®ä¸º: å¹³å°æ¨èäºº`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/user/${referral.id}/set-platform-referrer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error('è®¾ç½®å¹³å°æ¨èäººå¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert(`è®¾ç½®æˆåŠŸï¼\n\n${data.message}\n\nç”¨æˆ·: ${data.data.username}\nå¹³å°åœ°å€: ${data.data.platform_address}`);
                        // åˆ·æ–°æ¨èå…³ç³»åˆ—è¡¨
                        await this.loadReferrals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || 'è®¾ç½®å¹³å°æ¨èäººå¤±è´¥');
                    }
                } catch (error) {
                    console.error('è®¾ç½®å¹³å°æ¨èäººå¤±è´¥:', error);
                    alert('è®¾ç½®å¤±è´¥: ' + error.message);
                }
            },
            
            viewUserDetail(referral) {
                // æ˜¾ç¤ºç”¨æˆ·è¯¦ç»†ä¿¡æ¯
                const details = [
                    `ç”¨æˆ·è¯¦æƒ…`,
                    `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
                    `ğŸ‘¤ ç”¨æˆ·å: ${referral.username}`,
                    `ğŸ†” ç”¨æˆ·ID: ${referral.id}`,
                    ``,
                    `ğŸ’° é’±åŒ…ä¿¡æ¯:`,
                    referral.eth_address ? `ğŸ”¹ ä»¥å¤ªåŠ: ${referral.eth_address}` : '',
                    referral.solana_address ? `ğŸ”¹ Solana: ${referral.solana_address}` : '',
                    ``,
                    `ğŸ‘¥ æ¨èå…³ç³»:`,
                    referral.referrer_address ? `ğŸ”¹ æ¨èäºº: ${referral.referrer_address}` : 'ğŸ”¹ æ¨èäºº: æ— ',
                    `ğŸ”¹ æ¨èç±»å‹: ${referral.referrer_type === 'platform' ? 'ğŸ† å¹³å°ä¸‹çº¿' : (referral.referrer_type === 'normal' ? 'ğŸ‘¤ æ™®é€šæ¨è' : 'âŒ æ— æ¨è')}`,
                    `ğŸ”¹ ä¸‹çº§ç”¨æˆ·: ${referral.downline_count} äºº`,
                    ``,
                    `ğŸ“Š è´¦æˆ·çŠ¶æ€:`,
                    `ğŸ”¹ çŠ¶æ€: ${referral.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ ç¦ç”¨'}`,
                    `ğŸ”¹ åŠ å…¥æ—¶é—´: ${this.formatDateTime(referral.joined_at)}`,
                    referral.last_login_at ? `ğŸ”¹ æœ€åç™»å½•: ${this.formatDateTime(referral.last_login_at)}` : ''
                ].filter(Boolean);
                
                alert(details.join('\n'));
            },
            
            async loadWithdrawals(page = null) {
                if (page) this.withdrawalPagination.page = page;
                this.withdrawalsLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.withdrawalPagination.page,
                        limit: this.withdrawalPagination.limit,
                        ...this.withdrawalFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/withdrawals?${params}`);
                    if (!response.ok) throw new Error('åŠ è½½å–ç°è®°å½•å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.withdrawals = data.data || [];
                        this.withdrawalPagination.total = data.pagination?.total || 0;
                        this.withdrawalPagination.pages = data.pagination?.pages || 0;
                    } else {
                        throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½å–ç°è®°å½•å¤±è´¥:', error);
                    alert('åŠ è½½å–ç°è®°å½•å¤±è´¥: ' + error.message);
                } finally {
                    this.withdrawalsLoading = false;
                }
            },
            
            async processWithdrawal(withdrawal) {
                if (!confirm(`ç¡®å®šè¦å¤„ç†æç°ç”³è¯·å—ï¼Ÿ\nç”¨æˆ·åœ°å€: ${withdrawal.user_address}\næç°é‡‘é¢: ${this.formatCurrency(withdrawal.amount)}\næç°åœ°å€: ${withdrawal.to_address}`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/withdrawals/${withdrawal.id}/process`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('å¤„ç†å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('æç°å¤„ç†æˆåŠŸï¼\näº¤æ˜“å“ˆå¸Œ: ' + data.tx_hash);
                        await this.loadWithdrawals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || 'å¤„ç†å¤±è´¥');
                    }
                } catch (error) {
                    console.error('å¤„ç†æç°å¤±è´¥:', error);
                    alert('å¤„ç†æç°å¤±è´¥: ' + error.message);
                }
            },
            
            async cancelWithdrawal(withdrawal) {
                const reason = prompt('è¯·è¾“å…¥å–æ¶ˆåŸå› ï¼ˆå¯é€‰ï¼‰:', 'ç®¡ç†å‘˜å–æ¶ˆ');
                if (reason === null) return; // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ
                
                if (!confirm(`ç¡®å®šè¦å–æ¶ˆæ­¤æç°ç”³è¯·å—ï¼Ÿ\nç”¨æˆ·åœ°å€: ${withdrawal.user_address}\næç°é‡‘é¢: ${this.formatCurrency(withdrawal.amount)}\nå–æ¶ˆåŸå› : ${reason}`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/withdrawals/${withdrawal.id}/cancel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason: reason })
                    });
                    
                    if (!response.ok) throw new Error('å–æ¶ˆå¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('æç°ç”³è¯·å·²å–æ¶ˆï¼Œé‡‘é¢å·²é€€è¿˜åˆ°ç”¨æˆ·ä½™é¢');
                        await this.loadWithdrawals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || 'å–æ¶ˆå¤±è´¥');
                    }
                } catch (error) {
                    console.error('å–æ¶ˆæç°å¤±è´¥:', error);
                    alert('å–æ¶ˆæç°å¤±è´¥: ' + error.message);
                }
            },
            
            viewWithdrawal(withdrawal) {
                // æ˜¾ç¤ºæç°è®°å½•è¯¦æƒ…
                const details = [
                    `æç°ID: ${withdrawal.id}`,
                    `ç”¨æˆ·åœ°å€: ${withdrawal.user_address}`,
                    `æç°åœ°å€: ${withdrawal.to_address}`,
                    `æç°é‡‘é¢: ${this.formatCurrency(withdrawal.amount)}`,
                    `å¸ç§: ${withdrawal.currency || 'USDC'}`,
                    `çŠ¶æ€: ${this.getWithdrawalStatusText(withdrawal.status)}`,
                    `å»¶è¿Ÿæ—¶é—´: ${withdrawal.delay_minutes} åˆ†é’Ÿ`,
                    `ç”³è¯·æ—¶é—´: ${this.formatDateTime(withdrawal.created_at)}`,
                    `é¢„è®¡å¤„ç†æ—¶é—´: ${this.formatDateTime(withdrawal.process_at)}`,
                    withdrawal.processed_at ? `å®é™…å¤„ç†æ—¶é—´: ${this.formatDateTime(withdrawal.processed_at)}` : '',
                    withdrawal.tx_hash ? `äº¤æ˜“å“ˆå¸Œ: ${withdrawal.tx_hash}` : '',
                    withdrawal.note ? `ç”¨æˆ·å¤‡æ³¨: ${withdrawal.note}` : '',
                    withdrawal.admin_note ? `ç®¡ç†å‘˜å¤‡æ³¨: ${withdrawal.admin_note}` : '',
                    withdrawal.failure_reason ? `å¤±è´¥åŸå› : ${withdrawal.failure_reason}` : ''
                ].filter(Boolean);
                
                alert(details.join('\n'));
            },
            
            async refreshWithdrawals() {
                await this.loadWithdrawals();
            },
            
            async loadSettings() {
                try {
                    const response = await fetch('/api/admin/commission/settings');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data) {
                            // åˆå¹¶è¿”å›çš„é…ç½®æ•°æ®ï¼Œä¿æŒé»˜è®¤å€¼ä½œä¸ºåå¤‡
                            this.settings = { ...this.settings, ...data.data };
                            
                            // ç¡®ä¿commission_rulesæ˜¯å¯¹è±¡
                            if (data.data.commission_rules && typeof data.data.commission_rules === 'object') {
                                this.settings.commission_rules = { ...this.settings.commission_rules, ...data.data.commission_rules };
                            }
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ä½£é‡‘è®¾ç½®å¤±è´¥:', error);
                    alert('åŠ è½½ä½£é‡‘è®¾ç½®å¤±è´¥: ' + error.message);
                }
            },
            
            async saveSettings() {
                try {
                    // éªŒè¯å¿…å¡«é¡¹
                    if (!this.settings.commission_rate || this.settings.commission_rate < 0 || this.settings.commission_rate > 100) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä½£é‡‘ç‡ï¼ˆ0-100%ï¼‰');
                        return;
                    }
                    
                    if (!this.settings.min_withdraw_amount || this.settings.min_withdraw_amount < 0) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€ä½æç°é‡‘é¢');
                        return;
                    }
                    
                    const response = await fetch('/api/admin/commission/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.settings)
                    });
                    
                    if (!response.ok) throw new Error('ä¿å­˜å¤±è´¥');
                    
                    const result = await response.json();
                    if (result.success) {
                        // ğŸ” æ£€æŸ¥æ˜¯å¦æœ‰åœ°å€å˜æ›´
                        if (result.address_changed) {
                            const confirmMessage = [
                                'ğŸ”„ æ£€æµ‹åˆ°å¹³å°æ¨èäººåœ°å€å·²æ›´æ¢ï¼',
                                '',
                                `ğŸ“ æ—§åœ°å€: ${result.old_address}`,
                                `ğŸ“ æ–°åœ°å€: ${result.new_address}`,
                                `ğŸ‘¥ å—å½±å“ç”¨æˆ·: ${result.old_address_users_count} ä¸ª`,
                                '',
                                'â— æ³¨æ„ï¼šè¿™äº›ç”¨æˆ·ä»åœ¨ä½¿ç”¨æ—§åœ°å€ä½œä¸ºæ¨èäºº',
                                'ğŸ’° å¦‚ä¸å¤„ç†ï¼Œå¹³å°æ”¶ç›Šå°†åˆ†æ•£åˆ°å¤šä¸ªåœ°å€',
                                '',
                                'æ˜¯å¦ç«‹å³å°†è¿™äº›ç”¨æˆ·çš„æ¨èäººåœ°å€æ›´æ–°ä¸ºæ–°åœ°å€ï¼Ÿ',
                                '',
                                'âœ… ç‚¹å‡»"ç¡®å®š"ï¼šç«‹å³æ‰¹é‡æ›´æ–°ï¼ˆæ¨èï¼‰',
                                'âŒ ç‚¹å‡»"å–æ¶ˆ"ï¼šç¨ååœ¨"æ¨èå…³ç³»"é¡µé¢æ‰‹åŠ¨å¤„ç†'
                            ].join('\\n');
                            
                            if (confirm(confirmMessage)) {
                                await this.migrateOldPlatformAddress(result.old_address, result.new_address);
                            } else {
                                alert('âš ï¸ åœ°å€æ›´æ¢å®Œæˆï¼Œä½†ç”¨æˆ·æ¨èå…³ç³»æœªæ›´æ–°\\n\\nè¯·åœ¨"æ¨èå…³ç³»"é¡µé¢æ‰‹åŠ¨æ‰¹é‡æ›´æ–°ï¼Œä»¥ç¡®ä¿å¹³å°æ”¶ç›Šç»Ÿä¸€ã€‚');
                            }
                        } else {
                            alert(`é…ç½®ä¿å­˜æˆåŠŸï¼\\n${result.message || 'æ›´æ–°äº†ä½£é‡‘è®¾ç½®'}`);
                        }
                        
                        // é‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®ä»¥åæ˜ æ–°çš„ä½£é‡‘ç‡
                        await this.loadStats();
                    } else {
                        throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                    }
                } catch (error) {
                    console.error('ä¿å­˜ä½£é‡‘è®¾ç½®å¤±è´¥:', error);
                    alert('ä¿å­˜ä½£é‡‘è®¾ç½®å¤±è´¥: ' + error.message);
                }
            },
            
            resetSettings() {
                if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®åˆ°é»˜è®¤å€¼å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®ã€‚')) return;
                
                // é‡ç½®ä¸ºé»˜è®¤å€¼
                this.settings = {
                    // æ ¸å¿ƒåˆ†é”€è®¾ç½®
                    commission_rate: 35.0,
                    commission_description: 'ğŸ’° æ¨èå¥½å‹å³äº«35%è¶…é«˜ä½£é‡‘ï¼Œäººäººéƒ½æ˜¯èµšé’±è¾¾äººï¼',
                    enable_multi_level: true,
                    max_referral_levels: 2,
                    
                    // åˆ†äº«åŠŸèƒ½è®¾ç½®
                    share_button_text: 'ğŸš€ åˆ†äº«èµšå¤§é’±',
                    share_description: 'ğŸ¯ æ¨èå¥½å‹è´­ä¹°é¡¹ç›®ï¼Œæ‚¨ç«‹å³è·å¾—35%ç°é‡‘å¥–åŠ±ï¼å¤šçº§åˆ†é”€ï¼Œæ”¶ç›Šæ— ä¸Šé™ï¼',
                    share_success_message: 'ğŸ‰ åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼å¿«å»é‚€è¯·å¥½å‹èµšå–35%ä½£é‡‘å§ï¼',
                    
                    // æç°é…ç½®
                    min_withdraw_amount: 10.0,
                    withdraw_fee_rate: 0.0,
                    withdraw_description: 'ğŸ’ æœ€ä½æç°10 USDCï¼Œé›¶æ‰‹ç»­è´¹ï¼Œç§’åˆ°è´¦ï¼éšæ—¶æç°ï¼Œè‡ªç”±æ”¯é…ï¼',
                    
                    // ä½£é‡‘è®¡ç®—è§„åˆ™
                    commission_rules: {
                        direct_commission: 'ğŸ”¥ ç›´æ¥æ¨èä½£é‡‘ï¼šå¥½å‹è´­ä¹°é‡‘é¢çš„35%ç«‹å³åˆ°è´¦',
                        indirect_commission: 'ğŸ’° å¤šçº§æ¨èä½£é‡‘ï¼šä¸‹çº§ä½£é‡‘æ”¶ç›Šçš„35%æŒç»­èººèµš',
                        settlement_time: 'âš¡ ä½£é‡‘å®æ—¶åˆ°è´¦ï¼Œéšæ—¶æç°ï¼Œç§’é€Ÿå˜ç°',
                        currency: 'USDC',
                        platform_earnings: 'ğŸ† å¹³å°æ”¶ç›Šï¼šæ‰€æœ‰æ— æ¨èäººç”¨æˆ·çš„35%ä½£é‡‘å½’å¹³å°æ‰€æœ‰'
                    }
                };
                
                alert('é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æ¥åº”ç”¨æ›´æ”¹ã€‚');
            },
            
            async payCommission(record) {
                if (!confirm(`ç¡®å®šè¦å‘æ”¾ä½£é‡‘ ${this.formatCurrency(record.amount)} ç»™åœ°å€ ${record.recipient_address} å—ï¼Ÿ`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/records/${record.id}/pay`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('å‘æ”¾å¤±è´¥');
                    
                    record.status = 'paid';
                    record.payment_time = new Date().toISOString();
                    alert('ä½£é‡‘å‘æ”¾æˆåŠŸ');
                    await this.loadStats();
                } catch (error) {
                    console.error('å‘æ”¾ä½£é‡‘å¤±è´¥:', error);
                    alert('å‘æ”¾ä½£é‡‘å¤±è´¥: ' + error.message);
            }
            },
            
            viewRecord(record) {
                // æ˜¾ç¤ºä½£é‡‘è®°å½•è¯¦æƒ…
                const details = [
                    `ä½£é‡‘ID: ${record.id}`,
                    `æ¥æ”¶åœ°å€: ${record.recipient_address}`,
                    `ä½£é‡‘é‡‘é¢: ${this.formatCurrency(record.amount)}`,
                    `ä½£é‡‘ç±»å‹: ${record.commission_type === 'direct' ? 'ç›´æ¥ä½£é‡‘' : 'æ¨èä½£é‡‘'}`,
                    `çŠ¶æ€: ${this.getStatusText(record.status)}`,
                    `åˆ›å»ºæ—¶é—´: ${this.formatDateTime(record.created_at)}`
                ];
                alert(details.join('\n'));
            },
            
            async refreshRecords() {
                await this.loadRecords();
            },
            
            async exportRecords() {
                try {
                    const response = await fetch('/api/admin/commission/records/export');
                    if (!response.ok) throw new Error('å¯¼å‡ºå¤±è´¥');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `commission_records_${new Date().getTime()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
                }
            },
            
            formatCurrency(value) {
                return '$' + parseFloat(value || 0).toFixed(2);
            },
            
            formatDateTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN') + ' ' + 
                       date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            },
            
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    return 'ä»Šå¤©';
                } else if (diffDays === 2) {
                    return 'æ˜¨å¤©';
                } else if (diffDays <= 7) {
                    return `${diffDays - 1}å¤©å‰`;
                } else {
                    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                }
            },
            
            getStatusText(status) {
                const statusMap = {
                    'pending': 'å¾…å‘æ”¾',
                    'paid': 'å·²å‘æ”¾',
                    'failed': 'å‘æ”¾å¤±è´¥'
                };
                return statusMap[status] || 'æœªçŸ¥';
            },
            
            getWithdrawalStatusText(status) {
                const statusMap = {
                    'pending': 'å¾…å¤„ç†',
                    'processing': 'å¤„ç†ä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'failed': 'å¤±è´¥',
                    'cancelled': 'å·²å–æ¶ˆ'
                };
                return statusMap[status] || 'æœªçŸ¥';
            },
            
            async createWithdrawal() {
                try {
                    const response = await fetch('/api/admin/commission/create_withdrawal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.withdrawalForm)
                    });
                    
                    if (!response.ok) throw new Error('åˆ›å»ºå–ç°ç”³è¯·å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('å–ç°ç”³è¯·åˆ›å»ºæˆåŠŸï¼');
                        await this.loadWithdrawals();
                        this.showCreateWithdrawal = false;
                    } else {
                        throw new Error(data.error || 'åˆ›å»ºå–ç°ç”³è¯·å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ›å»ºå–ç°ç”³è¯·å¤±è´¥:', error);
                    alert('åˆ›å»ºå–ç°ç”³è¯·å¤±è´¥: ' + error.message);
                }
            },
            
            async runAutomation() {
                try {
                    const response = await fetch('/api/admin/commission/automation/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (!response.ok) throw new Error('è¿è¡Œè‡ªåŠ¨åŒ–å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('è‡ªåŠ¨åŒ–è¿è¡ŒæˆåŠŸï¼');
                        await this.refreshAutomationStatus();
                    } else {
                        throw new Error(data.error || 'è¿è¡Œè‡ªåŠ¨åŒ–å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è¿è¡Œè‡ªåŠ¨åŒ–å¤±è´¥:', error);
                    alert('è¿è¡Œè‡ªåŠ¨åŒ–å¤±è´¥: ' + error.message);
                }
            },
            
            async refreshAutomationStatus() {
                try {
                    const response = await fetch('/api/admin/commission/automation/status');
                    if (!response.ok) throw new Error('åˆ·æ–°è‡ªåŠ¨åŒ–çŠ¶æ€å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.automationStatus = data.data || {};
                    } else {
                        throw new Error(data.error || 'åˆ·æ–°è‡ªåŠ¨åŒ–çŠ¶æ€å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ·æ–°è‡ªåŠ¨åŒ–çŠ¶æ€å¤±è´¥:', error);
                    // ä¸æ˜¾ç¤ºé”™è¯¯å¼¹çª—ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
                }
            },
            
            // ğŸ”„ å¹³å°åœ°å€ç®¡ç†æ–¹æ³•
            async migrateOldPlatformAddress(oldAddress, newAddress) {
                try {
                    const response = await fetch('/api/admin/commission/platform-referrer/migrate-old-address', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            old_address: oldAddress,
                            new_address: newAddress
                        })
                    });
                    
                    if (!response.ok) throw new Error('åœ°å€è¿ç§»å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        const successMessage = [
                            'ğŸ‰ åœ°å€è¿ç§»æˆåŠŸï¼',
                            '',
                            `ğŸ“Š è¿ç§»ç»“æœï¼š`,
                            `â€¢ æ—§åœ°å€ï¼š${data.data.old_address}`,
                            `â€¢ æ–°åœ°å€ï¼š${data.data.new_address}`,
                            `â€¢ æ›´æ–°ç”¨æˆ·æ•°ï¼š${data.data.updated_count} ä¸ª`,
                            `â€¢ æ“ä½œæ—¶é—´ï¼š${new Date(data.data.operation_time).toLocaleString('zh-CN')}`,
                            '',
                            'ğŸ’° ç°åœ¨æ‰€æœ‰å¹³å°ä¸‹çº¿çš„æ”¶ç›Šéƒ½ä¼šç»Ÿä¸€åˆ°æ–°åœ°å€ï¼'
                        ].join('\\n');
                        
                        alert(successMessage);
                        
                        // åˆ·æ–°ç›¸å…³æ•°æ®
                        await this.loadReferrals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || 'åœ°å€è¿ç§»å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åœ°å€è¿ç§»å¤±è´¥:', error);
                    alert('âŒ åœ°å€è¿ç§»å¤±è´¥\\n\\né”™è¯¯ä¿¡æ¯: ' + error.message);
                }
            },
            
            async loadPlatformAddressData() {
                try {
                    const response = await fetch('/api/admin/commission/platform-referrer/old-addresses');
                    if (!response.ok) throw new Error('åŠ è½½å¹³å°åœ°å€æ•°æ®å¤±è´¥');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.platformAddressData = data.data || {};
                    } else {
                        throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½å¹³å°åœ°å€æ•°æ®å¤±è´¥:', error);
                    // ä¸æ˜¾ç¤ºé”™è¯¯å¼¹çª—ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
                }
            },
            
            async showAddressMigrationDialog() {
                await this.loadPlatformAddressData();
                
                if (!this.platformAddressData.platform_addresses || 
                    this.platformAddressData.platform_addresses.length <= 1) {
                    alert('âœ… å½“å‰åªæœ‰ä¸€ä¸ªå¹³å°åœ°å€ï¼Œæ— éœ€è¿ç§»ã€‚\\n\\nå¦‚æœæ‚¨åˆšåˆšæ›´æ¢äº†åœ°å€ï¼Œè¯·ç¡®ä¿åœ¨ä½£é‡‘è®¾ç½®ä¸­ä¿å­˜æ–°åœ°å€åå†è¿›è¡Œè¿ç§»æ“ä½œã€‚');
                    return;
                }
                
                // å‡†å¤‡è¿ç§»è¡¨å•æ•°æ®
                this.migrationForm.new_address = this.platformAddressData.current_platform_address;
                this.showAddressMigration = true;
            },
            
            async executeMigration() {
                if (!this.migrationForm.old_address || !this.migrationForm.new_address) {
                    alert('è¯·é€‰æ‹©æ—§åœ°å€å’Œæ–°åœ°å€');
                    return;
                }
                
                if (this.migrationForm.old_address === this.migrationForm.new_address) {
                    alert('æ–°æ—§åœ°å€ä¸èƒ½ç›¸åŒ');
                    return;
                }
                
                const oldAddressInfo = this.platformAddressData.platform_addresses.find(
                    addr => addr.address === this.migrationForm.old_address
                );
                
                if (!oldAddressInfo) {
                    alert('æœªæ‰¾åˆ°é€‰æ‹©çš„æ—§åœ°å€ä¿¡æ¯');
                    return;
                }
                
                const confirmMessage = [
                    'âš ï¸ ç¡®è®¤æ‰§è¡Œåœ°å€è¿ç§»ï¼Ÿ',
                    '',
                    `ğŸ“ æ—§åœ°å€: ${this.migrationForm.old_address}`,
                    `ğŸ“ æ–°åœ°å€: ${this.migrationForm.new_address}`,
                    `ğŸ‘¥ å—å½±å“ç”¨æˆ·: ${oldAddressInfo.user_count} ä¸ª`,
                    '',
                    'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ'
                ].join('\\n');
                
                if (!confirm(confirmMessage)) return;
                
                await this.migrateOldPlatformAddress(this.migrationForm.old_address, this.migrationForm.new_address);
                this.showAddressMigration = false;
            }
        }
    }
    
    // ç›‘å¬æ ‡ç­¾åˆ‡æ¢ï¼ŒåŠ è½½å¯¹åº”æ•°æ®
    document.addEventListener('alpine:init', () => {
        Alpine.effect(() => {
            if (window.commissionData && window.commissionData.activeTab === 'referrals' && window.commissionData.referrals.length === 0) {
                window.commissionData.loadReferrals();
            }
        });
});
</script>
{% endblock %} 