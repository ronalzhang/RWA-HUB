{% extends "admin_v2/base.html" %}

{% block title %}RWA-HUB 管理后台 - 佣金管理{% endblock %}

{% block page_title %}佣金管理{% endblock %}
{% block page_subtitle %}管理平台佣金设置和记录{% endblock %}

{% block extra_head %}
<style>
    /* 修复开关样式兼容性 */
    .toggle-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
    }
    
    .toggle-switch input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }
    
    .toggle-track {
        width: 3rem; /* 48px */
        height: 1.5rem; /* 24px */
        background-color: #d1d5db; /* gray-300 */
        border-radius: 9999px;
        position: relative;
        transition: background-color 0.2s ease-in-out;
    }
    
    .toggle-track.active {
        background-color: #f97316; /* orange-500 */
    }
    
    .toggle-thumb {
        width: 1.25rem; /* 20px */
        height: 1.25rem; /* 20px */
        background-color: white;
        border-radius: 50%;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        position: absolute;
        top: 0.125rem; /* 2px */
        left: 0.125rem; /* 2px */
        transition: transform 0.2s ease-in-out;
    }
    
    .toggle-thumb.active {
        transform: translateX(1.5rem); /* 24px */
    }
    
    /* 修复按钮样式 */
    .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        background-color: #3b82f6; /* blue-500 */
        color: white;
        font-size: 0.875rem; /* text-sm */
        font-weight: 500;
        border-radius: 0.5rem; /* rounded-lg */
        border: 1px solid transparent;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease-in-out;
        text-decoration: none;
    }
    
    .btn-primary:hover {
        background-color: #2563eb; /* blue-600 */
    }
    
    .btn-orange {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 1rem;
        background-color: #f97316; /* orange-500 */
        color: white;
        font-size: 0.875rem; /* text-sm */
        font-weight: 500;
        border-radius: 0.5rem; /* rounded-lg */
        border: 1px solid transparent;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease-in-out;
        text-decoration: none;
    }
    
    .btn-orange:hover {
        background-color: #ea580c; /* orange-600 */
    }
    
    /* 确保图标和文字对齐 */
    .btn-primary i, .btn-orange i {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li aria-current="page">
    <div class="flex items-center">
        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
        <span class="text-gray-500">佣金管理</span>
    </div>
</li>
{% endblock %}

{% block content %}
<div x-data="commissionData()" x-init="loadCommissionData()">
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" x-cloak>
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 mr-4">
                    <i class="fas fa-dollar-sign text-green-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">总佣金</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.total_commission || 0)"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 mr-4">
                    <i class="fas fa-users text-blue-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">推荐用户</h3>
                    <p class="text-2xl font-bold" x-text="stats.total_referrals || 0"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-yellow-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 mr-4">
                    <i class="fas fa-clock text-yellow-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">待发放</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.pending_commission || 0)"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-purple-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 mr-4">
                    <i class="fas fa-percentage text-purple-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">佣金率</h3>
                    <p class="text-2xl font-bold" x-text="(settings.commission_rate || stats.commission_rate || 0) + '%'"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 功能选项卡 -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button @click="switchTab('records')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'records', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'records'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    佣金记录
                </button>
                <button @click="switchTab('settings')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'settings', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'settings'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    佣金设置
                </button>
                <button @click="switchTab('referrals')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'referrals', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'referrals'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    推荐关系
                </button>
                <button @click="switchTab('withdrawals')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'withdrawals', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'withdrawals'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    自动取现
                </button>
                <button @click="switchTab('automation')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'automation', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'automation'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    🤖 自动化系统
                </button>
            </nav>
        </div>
    </div>

    <!-- 佣金记录 -->
    <div x-show="activeTab === 'records'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">佣金记录</h3>
                <div class="flex space-x-2">
                    <button @click="refreshRecords()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync-alt mr-2"></i>刷新
            </button>
                    <button @click="exportRecords()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-download mr-2"></i>导出
                </button>
            </div>
                </div>
        </div>

        <!-- 筛选条件 -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                    <select x-model="recordFilters.status" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部状态</option>
                        <option value="pending">待发放</option>
                        <option value="paid">已发放</option>
                        <option value="failed">发放失败</option>
                    </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">佣金类型</label>
                    <select x-model="recordFilters.type" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                    <option value="">全部类型</option>
                    <option value="direct">直接佣金</option>
                    <option value="referral">推荐佣金</option>
                </select>
            </div>
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">时间范围</label>
                    <select x-model="recordFilters.time_range" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
            </div>
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
                    <input x-model="recordFilters.search" @input.debounce.500ms="loadRecords()" 
                           type="text" placeholder="搜索地址或交易ID..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
            </div>
        </div>
        </div>

        <!-- 佣金记录表格 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">接收地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">佣金金额</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="recordsLoading">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>加载佣金记录中...
                        </td>
                    </tr>
                    </template>
                    
                    <template x-if="!recordsLoading && records.length === 0">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">暂无佣金记录</td>
                    </tr>
                    </template>
                    
                    <template x-for="record in records" :key="record.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="record.id"></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="record.recipient_address ? record.recipient_address.slice(0, 8) + '...' + record.recipient_address.slice(-6) : '-'"></div>
                        </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(record.amount || 0)"></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-blue-100 text-blue-800': record.commission_type === 'direct',
                                    'bg-green-100 text-green-800': record.commission_type === 'referral'
                                }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="record.commission_type === 'direct' ? '直接佣金' : '推荐佣金'"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span :class="{
                                'bg-yellow-100 text-yellow-800': record.status === 'pending',
                                'bg-green-100 text-green-800': record.status === 'paid',
                                'bg-red-100 text-red-800': record.status === 'failed'
                            }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="getStatusText(record.status)"></span>
                            </span>
                        </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(record.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button x-show="record.status === 'pending'" @click="payCommission(record)" 
                                        class="text-green-600 hover:text-green-900 mr-2">
                                    <i class="fas fa-check"></i> 发放
                                </button>
                                <button @click="viewRecord(record)" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                        </td>
                    </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                    显示 <span x-text="(recordPagination.page - 1) * recordPagination.limit + 1"></span> 到 
                    <span x-text="Math.min(recordPagination.page * recordPagination.limit, recordPagination.total)"></span> 条，
                    共 <span x-text="recordPagination.total"></span> 条记录
            </div>
                <div class="flex space-x-2">
                    <button @click="loadRecords(1)" :disabled="recordPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">首页</button>
                    <button @click="loadRecords(recordPagination.page - 1)" :disabled="recordPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">上一页</button>
                    <button @click="loadRecords(recordPagination.page + 1)" :disabled="recordPagination.page >= recordPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">下一页</button>
                    <button @click="loadRecords(recordPagination.pages)" :disabled="recordPagination.page >= recordPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">末页</button>
            </div>
        </div>
            </div>
        </div>

    <!-- 佣金设置 -->
    <div x-show="activeTab === 'settings'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700" x-text="(settings.commission_rate || 35) + '%分销体系配置'"></h3>
            <p class="text-sm text-gray-500 mt-1">配置推荐佣金、分享功能和提现规则</p>
        </div>

        <div class="px-6 py-6 space-y-8">
            <!-- 核心分销设置 -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-blue-100 rounded-lg mr-3">
                        <i class="fas fa-percentage text-blue-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">核心分销规则</h4>
                </div>
                
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            推荐佣金率 (%)
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input x-model="settings.commission_rate" type="number" step="0.1" min="0" max="100"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-12">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">%</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">好友购买后您获得的佣金比例</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分销描述文案</label>
                        <input x-model="settings.commission_description" type="text" 
                               placeholder="💰 推荐好友即享35%超高佣金，人人都是赚钱达人！"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">前端展示的佣金功能描述，支持emoji</p>
        </div>

        <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">多级分销</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input x-model="settings.enable_multi_level" type="checkbox" 
                                       class="rounded border-gray-300 text-blue-600 shadow-sm">
                                <span class="ml-2 text-sm text-gray-700">启用多级分销</span>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-1" x-text="'开启后下级的佣金收益也会给您分成' + (settings.commission_rate || 35) + '%'"></p>
    </div>

                                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大分销层级</label>
                        <select x-model="settings.max_referral_levels" class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="1">1级（只有直接推荐）</option>
                            <option value="2">2级（直接+间接推荐）</option>
                            <option value="3">3级（三级分销）</option>
                            <option value="5">5级（五级分销）</option>
                            <option value="10">10级（十级分销）</option>
                            <option value="999">∞ 无限级（所有下线都上贡）</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1" x-text="'每增加一级，佣金按' + (settings.commission_rate || 35) + '%递减传递给上级'"></p>
                    </div>
                                    </div>
                                </div>
                                
            <!-- 分享功能配置 -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-green-100 rounded-lg mr-3">
                        <i class="fas fa-share-alt text-green-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">分享功能配置</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分享按钮文案</label>
                        <input x-model="settings.share_button_text" type="text" 
                               placeholder="🚀 分享赚大钱"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">分享按钮显示的文字，建议简短有力</p>
                                </div>
                                
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分享成功提示</label>
                        <input x-model="settings.share_success_message" type="text" 
                               placeholder="🎉 分享链接已复制！快去邀请好友赚取35%佣金吧！"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">分享成功后显示的消息，鼓励用户行动</p>
    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">分享说明文案</label>
                        <textarea x-model="settings.share_description" rows="2" 
                                  placeholder="🎯 推荐好友购买项目，您立即获得35%现金奖励！多级分销，收益无上限！"
                                  class="w-full border-gray-300 rounded-md shadow-sm"></textarea>
                        <p class="text-xs text-gray-500 mt-1">分享功能的详细说明，突出高收益和简单性</p>
                    </div>
                </div>
            </div>

            <!-- 提现配置 -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-purple-100 rounded-lg mr-3">
                        <i class="fas fa-wallet text-purple-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">提现配置</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            最低提现金额 (USDC)
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input x-model="settings.min_withdraw_amount" type="number" step="0.01" min="0"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-16">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">USDC</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">门槛越低，用户提现意愿越强</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">提现手续费率 (%)</label>
                        <div class="relative">
                            <input x-model="settings.withdraw_fee_rate" type="number" step="0.01" min="0" max="100"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-12">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">%</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">建议设为0%，零手续费更吸引用户</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            🤖 自动处理延迟时间 (分钟)
                            <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input x-model="settings.withdrawal_delay_minutes" type="number" step="1" min="1" max="60"
                                   class="w-full border-gray-300 rounded-md shadow-sm pr-16">
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 text-sm">分钟</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">系统延迟处理提现申请的时间，1分钟为全自动</p>
                    </div>
                    
                    <div class="md:col-span-1">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h5 class="text-sm font-semibold text-blue-700 mb-1">⚡ 自动化说明</h5>
                            <div class="text-xs text-blue-600 space-y-1">
                                <p>• <strong>1分钟</strong>：全自动化，零人工干预</p>
                                <p>• <strong>5-10分钟</strong>：平衡安全性与效率</p>
                                <p>• <strong>30分钟以上</strong>：高安全要求场景</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">提现说明文案</label>
                        <textarea x-model="settings.withdraw_description" rows="2" 
                                  placeholder="💎 最低提现10 USDC，零手续费，秒到账！随时提现，自由支配！"
                                  class="w-full border-gray-300 rounded-md shadow-sm"></textarea>
                        <p class="text-xs text-gray-500 mt-1">突出快速、免费、便捷的提现体验</p>
                    </div>
                </div>
            </div>

            <!-- 平台推荐人设置 -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-orange-100 rounded-lg mr-3">
                        <i class="fas fa-crown text-orange-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">🏆 平台推荐人设置</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 启用平台推荐人功能 -->
                    <div class="md:col-span-2">
                        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-yellow-50 to-orange-50 border border-orange-200 rounded-lg">
                            <div>
                                <label class="block text-lg font-semibold text-gray-800">🏆 启用平台推荐人功能</label>
                                <p class="text-sm text-gray-600 mt-1" x-text="'开启后，所有无推荐人的用户将自动成为平台的下线，确保平台从每笔交易获得' + (settings.commission_rate || 35) + '%收益'"></p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm font-medium" :class="{
                                    'text-green-600': settings.enable_platform_referrer,
                                    'text-gray-500': !settings.enable_platform_referrer
                                }" x-text="settings.enable_platform_referrer ? '✅ 已启用' : '❌ 已禁用'"></span>
                                
                                <!-- 使用自定义开关样式 -->
                                <label class="toggle-switch">
                                    <input type="checkbox" x-model="settings.enable_platform_referrer">
                                    <div class="toggle-track" :class="{'active': settings.enable_platform_referrer}">
                                        <div class="toggle-thumb" :class="{'active': settings.enable_platform_referrer}"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 平台推荐人地址 -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            平台推荐人地址 <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            x-model="settings.platform_referrer_address"
                            placeholder="请输入平台收益钱包地址（支持以太坊和Solana地址）"
                            class="w-full border-gray-300 rounded-md shadow-sm"
                            :disabled="!settings.enable_platform_referrer">
                        <p class="text-xs text-gray-500 mt-1" x-text="'此地址将收到所有无推荐人用户产生的' + (settings.commission_rate || 35) + '%佣金'"></p>
                    </div>
                    
                    <!-- 平台收益说明 -->
                    <div class="md:col-span-2">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-green-800">💰 平台收益机制</h3>
                                    <div class="mt-2 text-sm text-green-700">
                                        <ul class="list-disc pl-5 space-y-1">
                                            <li><strong>自动归属</strong>：所有直接访问网站并连接钱包的用户（无推荐人）将自动成为平台的下线</li>
                                            <li><strong>直接收益</strong>：平台将获得这些用户所有交易的35%佣金</li>
                                            <li><strong>间接收益</strong>：如果这些用户又推荐了其他人，平台还将获得推荐佣金的35%</li>
                                            <li><strong>持续收益</strong>：形成完整的平台盈利体系，确保每笔交易都有平台收益</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 收益示例 -->
                    <div class="md:col-span-2">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h5 class="text-sm font-semibold text-blue-700 mb-2">📊 平台收益示例</h5>
                            <div class="text-xs text-blue-600 space-y-1">
                                <p x-text="'• 用户A直接访问：A购买100 USDC资产，平台获得' + (settings.commission_rate || 35) + ' USDC'"></p>
                                <p x-text="'• 用户A推荐B：B购买100 USDC，A获得' + (settings.commission_rate || 35) + ' USDC，平台获得A的佣金' + (settings.commission_rate || 35) + '%=' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p x-text="'• 用户B推荐C：C购买100 USDC，B获得' + (settings.commission_rate || 35) + ' USDC，A获得' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC，平台获得' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100 * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p class="font-semibold text-blue-800">💎 平台从每个无推荐人用户的完整分销网络中持续获得收益！</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 佣金计算规则说明 -->
            <div class="border border-gray-200 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-yellow-100 rounded-lg mr-3">
                        <i class="fas fa-calculator text-yellow-600"></i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700">佣金计算规则</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">直接推荐佣金说明</label>
                        <input x-model="settings.commission_rules.direct_commission" type="text" 
                               placeholder="🔥 直接推荐佣金：好友购买金额的35%立即到账"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">一级推荐的佣金计算和到账说明</p>
                                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">多级推荐佣金说明</label>
                        <input x-model="settings.commission_rules.indirect_commission" type="text" 
                               placeholder="💰 多级推荐佣金：下级佣金收益的35%持续躺赚"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">二级及以上推荐的佣金说明</p>
                                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">结算时间说明</label>
                        <input x-model="settings.commission_rules.settlement_time" type="text" 
                               placeholder="⚡ 佣金实时到账，随时提现，秒速变现"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">佣金到账和结算时间的描述</p>
                                </div>
                                
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">计价货币</label>
                        <select x-model="settings.commission_rules.currency" class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="USDC">USDC（美元稳定币）</option>
                            <option value="USDT">USDT（泰达币）</option>
                            <option value="USD">USD（美元）</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">佣金的计价和支付货币单位</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h5 class="text-sm font-semibold text-blue-700 mb-2">🚀 无限级分销说明</h5>
                            <div class="text-xs text-blue-600 space-y-1">
                                <p x-text="'• 直接推荐：A推荐B，B购买100 USDC，A获得' + (settings.commission_rate || 35) + ' USDC'"></p>
                                <p x-text="'• 二级推荐：B推荐C，C购买100 USDC，B获得' + (settings.commission_rate || 35) + ' USDC，A获得' + (settings.commission_rate || 35) + '×' + (settings.commission_rate || 35) + '%=' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p x-text="'• 三级推荐：C推荐D，D购买100 USDC，C获得' + (settings.commission_rate || 35) + ' USDC，B获得' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC，A获得' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100 * (settings.commission_rate || 35) / 100).toFixed(2) + ' USDC'"></p>
                                <p x-text="'• 依此类推：每级向上传递' + (settings.commission_rate || 35) + '%，形成无限级分销网络！'"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 保存按钮 -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <div class="text-sm text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    配置修改后将立即生效，影响新的推荐和佣金计算
                </div>
                <div class="flex space-x-3">
                    <button @click="resetSettings()" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-undo mr-2"></i>重置
                    </button>
                <button @click="saveSettings()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-save mr-2"></i>保存配置
                </button>
                </div>
                                    </div>
                                    </div>
                                </div>
                                
    <!-- 推荐关系 -->
    <div x-show="activeTab === 'referrals'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">用户推荐关系</h3>
                <div class="flex items-center space-x-3">
                    <!-- 刷新按钮 -->
                    <button @click="refreshReferrals()" class="btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        <span>刷新</span>
                    </button>
                    
                    <!-- 批量处理按钮 -->
                    <button @click="batchUpdatePlatformReferrer()" class="btn-orange">
                        <i class="fas fa-crown"></i>
                        <span>批量设为平台下线</span>
                    </button>
                    
                    <!-- 平台地址管理按钮 -->
                    <button @click="showAddressMigrationDialog()" class="inline-flex items-center px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white text-sm font-weight-500 rounded-lg border border-transparent shadow-sm transition-colors duration-200">
                        <i class="fas fa-exchange-alt"></i>
                        <span>地址管理</span>
                    </button>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-2">显示所有用户的推荐关系和下级统计信息</p>
        </div>
        
        <!-- 平台推荐人功能状态 -->
        <div class="px-6 py-4 border-b border-gray-200" :class="{
            'bg-gradient-to-r from-green-50 to-emerald-50': settings.enable_platform_referrer && settings.platform_referrer_address,
            'bg-gradient-to-r from-red-50 to-pink-50': !settings.enable_platform_referrer || !settings.platform_referrer_address
        }">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-3 rounded-lg mr-4" :class="{
                        'bg-green-500': settings.enable_platform_referrer && settings.platform_referrer_address,
                        'bg-red-500': !settings.enable_platform_referrer || !settings.platform_referrer_address
                    }">
                        <i class="fas fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold" :class="{
                            'text-green-700': settings.enable_platform_referrer && settings.platform_referrer_address,
                            'text-red-700': !settings.enable_platform_referrer || !settings.platform_referrer_address
                        }">🤖 自动推荐人功能</h4>
                        <p class="text-sm mt-1" :class="{
                            'text-green-600': settings.enable_platform_referrer && settings.platform_referrer_address,
                            'text-red-600': !settings.enable_platform_referrer || !settings.platform_referrer_address
                        }">
                            <span x-show="settings.enable_platform_referrer && settings.platform_referrer_address">
                                ✅ <strong>已启用</strong> - 新用户连接钱包时自动设置为平台下线
                            </span>
                            <span x-show="!settings.enable_platform_referrer || !settings.platform_referrer_address">
                                ❌ <strong>未启用</strong> - 请在"佣金设置"页面配置平台推荐人功能
                            </span>
                        </p>
                        <div class="mt-2 text-xs font-mono" x-show="settings.platform_referrer_address" :class="{
                            'text-green-500': settings.enable_platform_referrer,
                            'text-gray-500': !settings.enable_platform_referrer
                        }">
                            平台地址: <span x-text="settings.platform_referrer_address"></span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="space-y-1 text-xs text-gray-600">
                        <div>🔄 <strong>新用户</strong>：首次连接钱包时自动生效</div>
                        <div>📊 <strong>现有用户</strong>：可使用右侧批量处理按钮</div>
                        <div class="mt-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" :class="{
                                'bg-green-100 text-green-800': settings.enable_platform_referrer && settings.platform_referrer_address,
                                'bg-red-100 text-red-800': !settings.enable_platform_referrer || !settings.platform_referrer_address
                            }">
                                <span x-text="settings.enable_platform_referrer && settings.platform_referrer_address ? '功能正常运行' : '需要配置启用'"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 统计信息 -->
        <div x-show="referralStats" class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="text-center">
                    <div class="font-semibold text-blue-600" x-text="referralStats?.total_users || 0"></div>
                    <div class="text-gray-500">总用户数</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-green-600" x-text="referralStats?.users_with_referrer || 0"></div>
                    <div class="text-gray-500">有推荐人</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-purple-600" x-text="referralStats?.platform_users || 0"></div>
                    <div class="text-gray-500">平台下线</div>
                </div>
                <div class="text-center">
                    <div class="font-semibold text-orange-600" x-text="referralStats?.orphan_users || 0"></div>
                    <div class="text-gray-500">无推荐人</div>
                </div>
            </div>
        </div>
        
        <!-- 搜索筛选 -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">搜索用户</label>
                    <input x-model="referralFilters.search" @input.debounce.500ms="loadReferrals()" 
                           type="text" placeholder="搜索用户名或地址..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">推荐人类型</label>
                    <select x-model="referralFilters.referrer_type" @change="loadReferrals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部类型</option>
                        <option value="platform">平台下线</option>
                        <option value="normal">普通推荐</option>
                        <option value="none">无推荐人</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">钱包类型</label>
                    <select x-model="referralFilters.wallet_type" @change="loadReferrals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部钱包</option>
                        <option value="ethereum">以太坊</option>
                        <option value="solana">Solana</option>
                        <option value="other">其他</option>
                    </select>
                </div>
            </div>
                                </div>
                                
        <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户信息</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">推荐关系</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">下级用户</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态 & 时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="referralsLoading">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>加载用户数据中...
                                                    </td>
                        </tr>
                    </template>
                    
                    <template x-if="!referralsLoading && referrals.length === 0">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无用户数据</td>
                        </tr>
                    </template>
                    
                    <template x-for="referral in referrals" :key="referral.id">
                        <tr class="hover:bg-gray-50">
                            <!-- 用户信息 -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center">
                                            <span class="text-sm font-medium text-white" x-text="referral.username ? referral.username.charAt(0).toUpperCase() : '?'"></span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900" x-text="referral.username"></div>
                                        <div class="text-xs text-gray-500" x-text="'ID: ' + referral.id"></div>
                                        <!-- 钱包地址 -->
                                        <div class="mt-1 space-y-1">
                                            <div x-show="referral.eth_address" class="text-xs">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                                    ETH
                                                </span>
                                                <span class="ml-1 text-gray-600" x-text="referral.eth_address ? referral.eth_address.slice(0, 8) + '...' + referral.eth_address.slice(-4) : '-'"></span>
                                            </div>
                                            <div x-show="referral.solana_address" class="text-xs">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                                    SOL
                                                </span>
                                                <span class="ml-1 text-gray-600" x-text="referral.solana_address ? referral.solana_address.slice(0, 8) + '...' + referral.solana_address.slice(-4) : '-'"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- 推荐关系 -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div x-show="referral.referrer_address">
                                    <div class="flex items-center mb-1">
                                <span :class="{
                                            'bg-orange-100 text-orange-800 border-orange-200': referral.referrer_type === 'platform',
                                            'bg-green-100 text-green-800 border-green-200': referral.referrer_type === 'normal'
                                        }" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border">
                                            <span x-text="referral.referrer_type === 'platform' ? '🏆 平台下线' : '👤 普通推荐'"></span>
                                </span>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        推荐人: <span x-text="referral.referrer_address ? referral.referrer_address.slice(0, 10) + '...' + referral.referrer_address.slice(-4) : '-'"></span>
                                    </div>
                                </div>
                                <div x-show="!referral.referrer_address">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                        ❌ 无推荐人
                                    </span>
                                </div>
                                                    </td>
                            
                            <!-- 下级用户 -->
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="text-2xl font-bold" :class="{
                                    'text-green-600': referral.downline_count > 0,
                                    'text-gray-400': referral.downline_count === 0
                                }" x-text="referral.downline_count"></div>
                                <div class="text-xs text-gray-500">个下级</div>
                                <div x-show="referral.downline_count > 0" class="mt-1">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                        💰 有收益
                                    </span>
                                </div>
                            </td>
                            
                            <!-- 状态 & 时间 -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <!-- 账户状态 -->
                                <div class="mb-2">
                                    <span :class="{
                                        'bg-green-100 text-green-800 border-green-200': referral.is_active,
                                        'bg-red-100 text-red-800 border-red-200': !referral.is_active
                                    }" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border">
                                        <span x-text="referral.is_active ? '✅ 活跃' : '❌ 禁用'"></span>
                                    </span>
                                </div>
                                <!-- 时间信息 -->
                                <div class="text-xs text-gray-500 space-y-1">
                                    <div>
                                        <span class="font-medium">加入:</span>
                                        <span x-text="formatDate(referral.joined_at)"></span>
                                    </div>
                                    <div x-show="referral.last_login_at">
                                        <span class="font-medium">登录:</span>
                                        <span x-text="formatDate(referral.last_login_at)"></span>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- 操作 -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button @click="viewUserDetail(referral)" 
                                            class="text-blue-600 hover:text-blue-900 px-2 py-1 rounded text-xs bg-blue-50 hover:bg-blue-100">
                                        <i class="fas fa-eye"></i> 详情
                                    </button>
                                    <button x-show="!referral.referrer_address" 
                                            @click="setPlatformReferrer(referral)"
                                            class="text-orange-600 hover:text-orange-900 px-2 py-1 rounded text-xs bg-orange-50 hover:bg-orange-100">
                                        <i class="fas fa-crown"></i> 设为平台下线
                                    </button>
                                </div>
                            </td>
                                                </tr>
                    </template>
                                            </tbody>
                                        </table>
        </div>

        <!-- 分页 -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    显示 <span x-text="(referralPagination.page - 1) * referralPagination.limit + 1"></span> 到 
                    <span x-text="Math.min(referralPagination.page * referralPagination.limit, referralPagination.total)"></span> 条，
                    共 <span x-text="referralPagination.total"></span> 条记录
                </div>
                <div class="flex space-x-2">
                    <button @click="loadReferrals(1)" :disabled="referralPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">首页</button>
                    <button @click="loadReferrals(referralPagination.page - 1)" :disabled="referralPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">上一页</button>
                    <button @click="loadReferrals(referralPagination.page + 1)" :disabled="referralPagination.page >= referralPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">下一页</button>
                    <button @click="loadReferrals(referralPagination.pages)" :disabled="referralPagination.page >= referralPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">末页</button>
                </div>
            </div>
        </div>
        
        <!-- 🔄 平台地址迁移弹窗 -->
        <div x-show="showAddressMigration" 
             class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"
             style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-exchange-alt text-purple-500 mr-2"></i>
                        🔄 平台推荐人地址管理
                    </h3>
                    <button @click="showAddressMigration = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- 当前状态概览 -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        当前平台地址状态
                    </h4>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><strong>当前地址：</strong> <span x-text="platformAddressData.current_platform_address || '未设置'" class="font-mono"></span></p>
                        <p><strong>总平台用户：</strong> <span x-text="platformAddressData.total_platform_users || 0"></span> 个</p>
                    </div>
                </div>
                
                <!-- 历史平台地址列表 -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-history text-green-500 mr-2"></i>
                        历史平台地址分布
                    </h4>
                    <div class="space-y-2">
                        <template x-if="platformAddressData.platform_addresses && platformAddressData.platform_addresses.length > 0">
                            <div>
                                <template x-for="address in platformAddressData.platform_addresses" :key="address.address">
                                    <div class="flex items-center justify-between p-3 border rounded-lg" :class="{
                                        'bg-green-50 border-green-200': address.is_current,
                                        'bg-yellow-50 border-yellow-200': !address.is_current && address.user_count > 0,
                                        'bg-gray-50 border-gray-200': !address.is_current && address.user_count === 0
                                    }">
                                        <div>
                                            <div class="font-mono text-sm" x-text="address.address"></div>
                                            <div class="text-xs text-gray-600">
                                                <span x-text="address.user_count"></span> 个用户 
                                                <span x-show="address.is_current" class="text-green-600 font-medium">• 当前使用</span>
                                                <span x-show="!address.is_current && address.user_count > 0" class="text-yellow-600 font-medium">• 需要迁移</span>
                                            </div>
                                        </div>
                                        <div>
                                            <span x-show="address.is_current" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                ✅ 当前地址
                                            </span>
                                            <span x-show="!address.is_current && address.user_count > 0" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                ⚠️ 待迁移
                                            </span>
                                            <span x-show="!address.is_current && address.user_count === 0" class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                💤 空地址
                                            </span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        
                        <template x-if="!platformAddressData.platform_addresses || platformAddressData.platform_addresses.length === 0">
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-inbox text-2xl mb-2"></i>
                                <p>暂无历史平台地址</p>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- 迁移操作表单 -->
                <div x-show="platformAddressData.platform_addresses && platformAddressData.platform_addresses.length > 1" class="mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-exchange-alt text-purple-500 mr-2"></i>
                        执行地址迁移
                    </h4>
                    <form @submit.prevent="executeMigration()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    选择旧地址（迁移源）
                                </label>
                                <select x-model="migrationForm.old_address" class="w-full border-gray-300 rounded-md shadow-sm" required>
                                    <option value="">请选择要迁移的旧地址...</option>
                                    <template x-for="address in platformAddressData.platform_addresses" :key="address.address">
                                        <option x-show="!address.is_current && address.user_count > 0" 
                                                :value="address.address" 
                                                x-text="`${address.address.slice(0, 20)}... (${address.user_count}个用户)`"></option>
                                    </template>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    新地址（迁移目标）
                                </label>
                                <input x-model="migrationForm.new_address" 
                                       type="text" 
                                       readonly
                                       class="w-full border-gray-300 rounded-md shadow-sm bg-gray-50"
                                       :value="platformAddressData.current_platform_address">
                                <p class="text-xs text-gray-500 mt-1">自动使用当前配置的平台地址</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 mr-3"></i>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-medium mb-1">⚠️ 重要提醒</p>
                                    <ul class="list-disc pl-4 space-y-1">
                                        <li>此操作将把选定旧地址的所有用户推荐关系更新为新地址</li>
                                        <li>迁移后，这些用户的佣金将流向新地址</li>
                                        <li>操作不可撤销，请确认地址正确</li>
                                        <li>建议在低峰期执行此操作</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" 
                                    @click="showAddressMigration = false"
                                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                                <i class="fas fa-times mr-2"></i>取消
                            </button>
                            <button type="submit"
                                    :disabled="!migrationForm.old_address"
                                    class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-exchange-alt mr-2"></i>执行迁移
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- 操作历史 -->
                <div x-show="platformAddressData.migration_logs && platformAddressData.migration_logs.length > 0" class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-clock text-blue-500 mr-2"></i>
                        最近操作历史
                    </h4>
                    <div class="space-y-2 max-h-32 overflow-y-auto">
                        <template x-for="log in platformAddressData.migration_logs" :key="log.timestamp">
                            <div class="text-xs bg-gray-50 border border-gray-200 rounded p-2">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="font-medium text-gray-800">地址迁移</span>
                                        <span class="text-gray-600">更新了 <span x-text="log.updated_users_count"></span> 个用户</span>
                                    </div>
                                    <span class="text-gray-500" x-text="new Date(log.timestamp).toLocaleString('zh-CN')"></span>
                                </div>
                                <div class="mt-1 text-gray-600">
                                    <div>旧址: <span class="font-mono" x-text="log.old_address.slice(0, 20) + '...'"></span></div>
                                    <div>新址: <span class="font-mono" x-text="log.new_address.slice(0, 20) + '...'"></span></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <!-- 帮助说明 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h5 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-question-circle mr-1"></i>
                        使用说明
                    </h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p><strong>1. 地址更换：</strong>在"佣金设置"页面修改平台推荐人地址</p>
                        <p><strong>2. 自动检测：</strong>系统会自动检测地址变更并提示迁移</p>
                        <p><strong>3. 批量迁移：</strong>一键将旧地址的用户迁移到新地址</p>
                        <p><strong>4. 收益统一：</strong>确保所有平台收益流向同一个地址</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 取现记录 -->
    <div x-show="activeTab === 'withdrawals'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">取现记录</h3>
                <div class="flex space-x-2">
                    <button @click="refreshWithdrawals()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync-alt mr-2"></i>刷新
                    </button>
                </div>
            </div>
        </div>

        <!-- 筛选条件 -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                    <select x-model="withdrawalFilters.status" @change="loadWithdrawals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部状态</option>
                        <option value="pending">待处理</option>
                        <option value="processing">处理中</option>
                        <option value="completed">已完成</option>
                        <option value="failed">失败</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">时间范围</label>
                    <select x-model="withdrawalFilters.time_range" @change="loadWithdrawals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
                    <input x-model="withdrawalFilters.search" @input.debounce.500ms="loadWithdrawals()" 
                           type="text" placeholder="搜索地址或交易哈希..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="flex items-end">
                    <button @click="loadWithdrawals()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-search mr-2"></i>搜索
                    </button>
                </div>
            </div>
        </div>

        <!-- 取现记录表格 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">提现地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">延迟时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="withdrawalsLoading">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>加载取现记录中...
                            </td>
                        </tr>
                    </template>
                    
                    <template x-if="!withdrawalsLoading && withdrawals.length === 0">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">暂无取现记录</td>
                        </tr>
                    </template>
                    
                    <template x-for="withdrawal in withdrawals" :key="withdrawal.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="withdrawal.id"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="withdrawal.user_address ? withdrawal.user_address.slice(0, 8) + '...' + withdrawal.user_address.slice(-6) : '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="withdrawal.to_address ? withdrawal.to_address.slice(0, 8) + '...' + withdrawal.to_address.slice(-6) : '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(withdrawal.amount || 0)"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-yellow-100 text-yellow-800': withdrawal.status === 'pending',
                                    'bg-blue-100 text-blue-800': withdrawal.status === 'processing',
                                    'bg-green-100 text-green-800': withdrawal.status === 'completed',
                                    'bg-red-100 text-red-800': withdrawal.status === 'failed',
                                    'bg-gray-100 text-gray-800': withdrawal.status === 'cancelled'
                                }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="getWithdrawalStatusText(withdrawal.status)"></span>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div x-show="withdrawal.status === 'pending' && withdrawal.remaining_delay_seconds > 0">
                                    <span x-text="Math.ceil(withdrawal.remaining_delay_seconds / 60)"></span> 分钟
                                </div>
                                <div x-show="withdrawal.status === 'pending' && withdrawal.remaining_delay_seconds <= 0">
                                    <span class="text-green-600">可处理</span>
                                </div>
                                <div x-show="withdrawal.status !== 'pending'">-</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(withdrawal.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button x-show="withdrawal.status === 'pending' && withdrawal.is_ready_to_process" 
                                        @click="processWithdrawal(withdrawal)" 
                                        class="text-green-600 hover:text-green-900 mr-2">
                                    <i class="fas fa-check"></i> 处理
                                </button>
                                <button x-show="withdrawal.status === 'pending'" 
                                        @click="cancelWithdrawal(withdrawal)" 
                                        class="text-red-600 hover:text-red-900 mr-2">
                                    <i class="fas fa-times"></i> 取消
                                </button>
                                <button @click="viewWithdrawal(withdrawal)" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    显示 <span x-text="(withdrawalPagination.page - 1) * withdrawalPagination.limit + 1"></span> 到 
                    <span x-text="Math.min(withdrawalPagination.page * withdrawalPagination.limit, withdrawalPagination.total)"></span> 条，
                    共 <span x-text="withdrawalPagination.total"></span> 条记录
                </div>
                <div class="flex space-x-2">
                    <button @click="loadWithdrawals(1)" :disabled="withdrawalPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">首页</button>
                    <button @click="loadWithdrawals(withdrawalPagination.page - 1)" :disabled="withdrawalPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">上一页</button>
                    <button @click="loadWithdrawals(withdrawalPagination.page + 1)" :disabled="withdrawalPagination.page >= withdrawalPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">下一页</button>
                    <button @click="loadWithdrawals(withdrawalPagination.pages)" :disabled="withdrawalPagination.page >= withdrawalPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">末页</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自动化系统 -->
    <div x-show="activeTab === 'automation'" class="space-y-6" x-cloak>
        <!-- 功能说明 -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 border border-blue-200">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <div class="p-3 bg-blue-500 rounded-lg">
                        <i class="fas fa-robot text-white text-xl"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-blue-700">🤖 全自动化分销系统说明</h3>
                    <div class="mt-2 text-sm text-blue-600 space-y-2">
                        <p><strong>💰 自动佣金计算</strong>：系统实时计算用户的35%无限级分销佣金，无需人工干预</p>
                        <p><strong>⚡ 自动提现处理</strong>：用户申请提现后，系统延迟1分钟自动处理，零人工成本</p>
                        <p><strong>🏆 平台自动归属</strong>：所有无推荐人用户自动成为平台下线，确保平台收益</p>
                        <p><strong>🔄 实时监控</strong>：系统24小时运行，实时监控待处理取现和系统状态</p>
                        <p><strong>📊 智能统计</strong>：自动统计用户推荐关系、佣金收益和取现记录</p>
                    </div>
                    <div class="mt-3 p-3 bg-white rounded border border-blue-200">
                        <p class="text-xs text-blue-800"><strong>🎯 核心价值</strong>：完全无人参与的分销系统，让您专注业务发展，佣金管理全部自动化处理！</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 系统状态概览 -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-700">🤖 系统运行状态</h3>
                    <div class="flex items-center space-x-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="text-sm text-green-600">系统运行中</span>
                        </div>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-1">全自动化佣金计算、取现处理和分销管理系统</p>
            </div>

            <div class="p-6">
                <!-- 系统状态指标 -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-500 rounded-lg mr-3">
                                <i class="fas fa-robot text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-blue-700">自动化状态</h4>
                                <p class="text-lg font-bold text-blue-800" x-text="automationStatus.system_status || 'active'"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-500 rounded-lg mr-3">
                                <i class="fas fa-clock text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-yellow-700">待处理取现</h4>
                                <p class="text-lg font-bold text-yellow-800" x-text="automationStatus.pending_withdrawals_count || 0"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-500 rounded-lg mr-3">
                                <i class="fas fa-check-circle text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-green-700">可立即处理</h4>
                                <p class="text-lg font-bold text-green-800" x-text="automationStatus.ready_to_process_count || 0"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-500 rounded-lg mr-3">
                                <i class="fas fa-infinity text-white"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium text-purple-700">分销层级</h4>
                                <p class="text-lg font-bold text-purple-800" x-text="automationStatus.automation_config?.max_referral_levels === 999 ? '∞ 无限级' : (automationStatus.automation_config?.max_referral_levels || 2) + '级'"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 自动化配置展示 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">
                            <i class="fas fa-cogs text-blue-500 mr-2"></i>系统配置
                        </h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">佣金率</span>
                                <span class="font-medium" x-text="(automationStatus.automation_config?.commission_rate || settings.commission_rate || 0) + '%'"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">取现延迟</span>
                                <span class="font-medium" x-text="(automationStatus.automation_config?.withdrawal_delay_minutes || settings.withdrawal_delay_minutes || 0) + ' 分钟'"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">最低取现金额</span>
                                <span class="font-medium" x-text="'$' + (automationStatus.automation_config?.min_withdraw_amount || settings.min_withdraw_amount || 0)"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">多级分销</span>
                                <span class="font-medium" x-text="automationStatus.automation_config?.enable_multi_level ? '✅ 已启用' : '❌ 已禁用'"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">
                            <i class="fas fa-calculator text-green-500 mr-2"></i>无限级分销算法
                        </h4>
                        <div class="text-sm text-gray-600 space-y-2">
                            <div x-text="'🎯 A推荐B：B购买100U → A得' + (settings.commission_rate || 35) + 'U'"></div>
                            <div x-text="'💰 B推荐C：C购买100U → B得' + (settings.commission_rate || 35) + 'U，A得' + (settings.commission_rate || 35) + '×' + (settings.commission_rate || 35) + '%=' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + 'U'"></div>
                            <div x-text="'🚀 C推荐D：D购买100U → C得' + (settings.commission_rate || 35) + 'U，B得' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100).toFixed(2) + 'U，A得' + ((settings.commission_rate || 35) * (settings.commission_rate || 35) / 100 * (settings.commission_rate || 35) / 100).toFixed(2) + 'U'"></div>
                            <div class="text-blue-600 font-medium" x-text="'✨ 依此类推，每级向上传递' + (settings.commission_rate || 35) + '%，形成无限级收益网络！'"></div>
                        </div>
                    </div>
                </div>

                <!-- 手动操作区域 -->
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-700">
                            <i class="fas fa-play-circle text-purple-500 mr-2"></i>手动操作
                        </h4>
                        <div class="text-sm text-gray-500">
                            系统每分钟自动运行，您也可以手动触发
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button @click="runAutomation()" 
                                class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-robot mr-2"></i>运行自动化周期
                        </button>
                        
                        <button @click="refreshAutomationStatus()" 
                                class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>刷新系统状态
                        </button>
                        
                        <button @click="showCreateWithdrawal = true" 
                                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>代理创建取现
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 创建取现申请弹窗 -->
        <div x-show="showCreateWithdrawal" 
             class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"
             style="display: none;">
            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">代理创建取现申请</h3>
                    <button @click="showCreateWithdrawal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form @submit.prevent="createWithdrawal()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">用户地址</label>
                            <input x-model="withdrawalForm.user_address" type="text" required
                                   placeholder="0x..."
                                   class="w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">提现到地址</label>
                            <input x-model="withdrawalForm.to_address" type="text" required
                                   placeholder="0x..."
                                   class="w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">提现金额</label>
                            <div class="relative">
                                <input x-model="withdrawalForm.amount" type="number" step="0.01" min="0.01" required
                                       class="w-full border-gray-300 rounded-md shadow-sm pr-16">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 text-sm">USDC</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" @click="showCreateWithdrawal = false"
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                                取消
                            </button>
                            <button type="submit"
                                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                创建申请
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function commissionData() {
        return {
            activeTab: 'records',
            stats: {},
            records: [],
            referrals: [],
            withdrawals: [],
            settings: {
                commission_rate: 35.0,
                commission_description: '💰 推荐好友即享35%超高佣金，人人都是赚钱达人！',
                share_button_text: '🚀 分享赚大钱',
                share_description: '🎯 推荐好友购买项目，您立即获得35%现金奖励！多级分销，收益无上限！',
                share_success_message: '🎉 分享链接已复制！快去邀请好友赚取35%佣金吧！',
                min_withdraw_amount: 10.0,
                withdraw_fee_rate: 0.0,
                withdraw_description: '💎 最低提现10 USDC，零手续费，秒到账！随时提现，自由支配！',
                withdrawal_delay_minutes: 1,
                max_referral_levels: 2,
                enable_multi_level: true,
                platform_referrer_address: '',
                enable_platform_referrer: true,
                commission_rules: {
                    direct_commission: '🔥 直接推荐佣金：好友购买金额的35%立即到账',
                    indirect_commission: '💰 多级推荐佣金：下级佣金收益的35%持续躺赚',
                    settlement_time: '⚡ 佣金实时到账，随时提现，秒速变现',
                    currency: 'USDC',
                    platform_earnings: '🏆 平台收益：所有无推荐人用户的35%佣金归平台所有'
                }
            },
            recordsLoading: false,
            referralsLoading: false,
            withdrawalsLoading: false,
            
            // 自动化系统相关
            automationStatus: {},
            showCreateWithdrawal: false,
            withdrawalForm: {
                user_address: '',
                to_address: '',
                amount: ''
            },
            
            // 🔄 平台地址管理相关
            platformAddressData: {},
            showAddressMigration: false,
            migrationForm: {
                old_address: '',
                new_address: ''
            },
            
            // 数据过滤和分页
        recordFilters: {
                status: '',
            type: '',
                time_range: '',
                search: ''
        },
            referralFilters: {
                search: '',
                referrer_type: '',
                wallet_type: ''
            },
            withdrawalFilters: {
                status: '',
                time_range: '',
                search: ''
            },
            recordPagination: {
                page: 1,
                limit: 10,
                total: 0,
                pages: 0
            },
            referralPagination: {
                page: 1,
                limit: 50,
                total: 0,
                pages: 0
            },
            withdrawalPagination: {
                page: 1,
                limit: 10,
                total: 0,
                pages: 0
            },
            
            // 推荐关系统计
            referralStats: null,
            
            async loadCommissionData() {
                try {
                    // 首先加载设置，因为其他功能依赖设置数据
                    await this.loadSettings();
                    console.log('设置加载完成:', {
                        enable_platform_referrer: this.settings.enable_platform_referrer,
                        platform_referrer_address: this.settings.platform_referrer_address
                    });
                    
                    // 并行加载其他数据
                await Promise.all([
                    this.loadStats(),
                    this.loadRecords(),
                        this.refreshAutomationStatus()
                ]);
                } catch (error) {
                    console.error('加载佣金数据失败:', error);
                }
            },
            
            switchTab(tab) {
                this.activeTab = tab;
                // 切换到推荐关系标签页时加载数据和设置
                if (tab === 'referrals') {
                    // 确保设置数据已加载
                    this.loadSettings().then(() => {
                        // 如果推荐关系数据为空则加载
                        if (this.referrals.length === 0) {
                    this.loadReferrals();
                        }
                    });
                }
                // 切换到取现记录标签页时加载数据
                if (tab === 'withdrawals' && this.withdrawals.length === 0) {
                    this.loadWithdrawals();
                }
                // 切换到自动化标签页时加载状态
                if (tab === 'automation') {
                    this.refreshAutomationStatus();
                }
            },
            
            async loadStats() {
                try {
                    const response = await fetch('/api/admin/commission/stats');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.stats = {
                                total_commission: data.total_commission || 0,
                                total_referrals: data.total_referrals || 0,
                                pending_commission: data.pending_commission || 0,
                                commission_rate: data.commission_rate || 0
                            };
                        }
                    }
                } catch (error) {
                    console.error('加载统计数据失败:', error);
                }
            },
            
            async loadRecords(page = null) {
                if (page) this.recordPagination.page = page;
                this.recordsLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.recordPagination.page,
                        limit: this.recordPagination.limit,
                        ...this.recordFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/records?${params}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.records = data.data || [];
                            this.recordPagination.total = data.pagination?.total || 0;
                            this.recordPagination.pages = data.pagination?.pages || 0;
                        } else {
                            throw new Error(data.error || '加载失败');
                        }
                    }
                } catch (error) {
                    console.error('加载佣金记录失败:', error);
                    alert('加载佣金记录失败: ' + error.message);
                } finally {
                    this.recordsLoading = false;
                }
            },
            
            async loadReferrals(page = null) {
                if (page) this.referralPagination.page = page;
                this.referralsLoading = true;
                try {
                    const params = new URLSearchParams({
                        page: this.referralPagination.page,
                        limit: this.referralPagination.limit,
                        ...this.referralFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/referrals?${params}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.referrals = data.items || [];
                            this.referralPagination.total = data.total || 0;
                            this.referralPagination.pages = data.pages || 0;
                            this.referralStats = data.statistics || null;
                        } else {
                            throw new Error(data.error || '加载失败');
                        }
                    }
                } catch (error) {
                    console.error('加载推荐关系失败:', error);
                    alert('加载推荐关系失败: ' + error.message);
                } finally {
                    this.referralsLoading = false;
                }
            },
            
            async refreshReferrals() {
                await this.loadReferrals();
            },
            
            async batchUpdatePlatformReferrer() {
                // 检查平台推荐人配置
                if (!this.settings.enable_platform_referrer) {
                    alert('⚠️ 平台推荐人功能未启用\n\n请先在"佣金设置"页面开启"启用平台推荐人功能"开关');
                    return;
                }
                
                if (!this.settings.platform_referrer_address) {
                    alert('⚠️ 平台推荐人地址未配置\n\n请先在"佣金设置"页面配置"平台推荐人地址"');
                    return;
                }
                
                if (!confirm('🏆 批量设置平台推荐人\n\n确定要将所有无推荐人的用户设置为平台下线吗？\n\n✅ 设置后这些用户的推荐人将变为平台地址\n💰 平台将获得他们所有交易的35%佣金\n🔒 此操作不可撤销\n\n点击"确定"继续')) return;
                
                try {
                    const response = await fetch('/api/admin/commission/platform-referrer/batch-update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error('批量更新失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        const message = [
                            '🎉 批量更新成功！',
                            '',
                            `📊 处理结果：`,
                            `• 更新用户数：${data.data.updated_count} 个`,
                            `• 平台地址：${data.data.platform_address}`,
                            `• 更新时间：${new Date().toLocaleString('zh-CN')}`,
                            '',
                            '💰 这些用户现在是平台的下线，',
                            '   所有交易都将为平台产生35%佣金收益！'
                        ];
                        alert(message.join('\n'));
                        await this.loadReferrals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || '批量更新失败');
                    }
                } catch (error) {
                    console.error('批量更新平台推荐人失败:', error);
                    alert('❌ 批量更新失败\n\n错误信息: ' + error.message + '\n\n请检查网络连接或联系技术支持');
                }
            },
            
            async setPlatformReferrer(referral) {
                if (!this.settings.platform_referrer_address) {
                    alert('请先在佣金设置中配置平台推荐人地址');
                    return;
                }
                
                if (!confirm(`确定要将用户 ${referral.username} 设置为平台下线吗？\n\n用户ID: ${referral.id}\n当前推荐人: 无\n将设置为: 平台推荐人`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/user/${referral.id}/set-platform-referrer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error('设置平台推荐人失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert(`设置成功！\n\n${data.message}\n\n用户: ${data.data.username}\n平台地址: ${data.data.platform_address}`);
                        // 刷新推荐关系列表
                        await this.loadReferrals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || '设置平台推荐人失败');
                    }
                } catch (error) {
                    console.error('设置平台推荐人失败:', error);
                    alert('设置失败: ' + error.message);
                }
            },
            
            viewUserDetail(referral) {
                // 显示用户详细信息
                const details = [
                    `用户详情`,
                    `━━━━━━━━━━━━━━━━━━━━━━`,
                    `👤 用户名: ${referral.username}`,
                    `🆔 用户ID: ${referral.id}`,
                    ``,
                    `💰 钱包信息:`,
                    referral.eth_address ? `🔹 以太坊: ${referral.eth_address}` : '',
                    referral.solana_address ? `🔹 Solana: ${referral.solana_address}` : '',
                    ``,
                    `👥 推荐关系:`,
                    referral.referrer_address ? `🔹 推荐人: ${referral.referrer_address}` : '🔹 推荐人: 无',
                    `🔹 推荐类型: ${referral.referrer_type === 'platform' ? '🏆 平台下线' : (referral.referrer_type === 'normal' ? '👤 普通推荐' : '❌ 无推荐')}`,
                    `🔹 下级用户: ${referral.downline_count} 人`,
                    ``,
                    `📊 账户状态:`,
                    `🔹 状态: ${referral.is_active ? '✅ 活跃' : '❌ 禁用'}`,
                    `🔹 加入时间: ${this.formatDateTime(referral.joined_at)}`,
                    referral.last_login_at ? `🔹 最后登录: ${this.formatDateTime(referral.last_login_at)}` : ''
                ].filter(Boolean);
                
                alert(details.join('\n'));
            },
            
            async loadWithdrawals(page = null) {
                if (page) this.withdrawalPagination.page = page;
                this.withdrawalsLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.withdrawalPagination.page,
                        limit: this.withdrawalPagination.limit,
                        ...this.withdrawalFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/withdrawals?${params}`);
                    if (!response.ok) throw new Error('加载取现记录失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.withdrawals = data.data || [];
                        this.withdrawalPagination.total = data.pagination?.total || 0;
                        this.withdrawalPagination.pages = data.pagination?.pages || 0;
                    } else {
                        throw new Error(data.error || '加载失败');
                    }
                } catch (error) {
                    console.error('加载取现记录失败:', error);
                    alert('加载取现记录失败: ' + error.message);
                } finally {
                    this.withdrawalsLoading = false;
                }
            },
            
            async processWithdrawal(withdrawal) {
                if (!confirm(`确定要处理提现申请吗？\n用户地址: ${withdrawal.user_address}\n提现金额: ${this.formatCurrency(withdrawal.amount)}\n提现地址: ${withdrawal.to_address}`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/withdrawals/${withdrawal.id}/process`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('处理失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('提现处理成功！\n交易哈希: ' + data.tx_hash);
                        await this.loadWithdrawals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || '处理失败');
                    }
                } catch (error) {
                    console.error('处理提现失败:', error);
                    alert('处理提现失败: ' + error.message);
                }
            },
            
            async cancelWithdrawal(withdrawal) {
                const reason = prompt('请输入取消原因（可选）:', '管理员取消');
                if (reason === null) return; // 用户点击了取消
                
                if (!confirm(`确定要取消此提现申请吗？\n用户地址: ${withdrawal.user_address}\n提现金额: ${this.formatCurrency(withdrawal.amount)}\n取消原因: ${reason}`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/withdrawals/${withdrawal.id}/cancel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason: reason })
                    });
                    
                    if (!response.ok) throw new Error('取消失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('提现申请已取消，金额已退还到用户余额');
                        await this.loadWithdrawals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || '取消失败');
                    }
                } catch (error) {
                    console.error('取消提现失败:', error);
                    alert('取消提现失败: ' + error.message);
                }
            },
            
            viewWithdrawal(withdrawal) {
                // 显示提现记录详情
                const details = [
                    `提现ID: ${withdrawal.id}`,
                    `用户地址: ${withdrawal.user_address}`,
                    `提现地址: ${withdrawal.to_address}`,
                    `提现金额: ${this.formatCurrency(withdrawal.amount)}`,
                    `币种: ${withdrawal.currency || 'USDC'}`,
                    `状态: ${this.getWithdrawalStatusText(withdrawal.status)}`,
                    `延迟时间: ${withdrawal.delay_minutes} 分钟`,
                    `申请时间: ${this.formatDateTime(withdrawal.created_at)}`,
                    `预计处理时间: ${this.formatDateTime(withdrawal.process_at)}`,
                    withdrawal.processed_at ? `实际处理时间: ${this.formatDateTime(withdrawal.processed_at)}` : '',
                    withdrawal.tx_hash ? `交易哈希: ${withdrawal.tx_hash}` : '',
                    withdrawal.note ? `用户备注: ${withdrawal.note}` : '',
                    withdrawal.admin_note ? `管理员备注: ${withdrawal.admin_note}` : '',
                    withdrawal.failure_reason ? `失败原因: ${withdrawal.failure_reason}` : ''
                ].filter(Boolean);
                
                alert(details.join('\n'));
            },
            
            async refreshWithdrawals() {
                await this.loadWithdrawals();
            },
            
            async loadSettings() {
                try {
                    const response = await fetch('/api/admin/commission/settings');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data) {
                            // 合并返回的配置数据，保持默认值作为后备
                            this.settings = { ...this.settings, ...data.data };
                            
                            // 确保commission_rules是对象
                            if (data.data.commission_rules && typeof data.data.commission_rules === 'object') {
                                this.settings.commission_rules = { ...this.settings.commission_rules, ...data.data.commission_rules };
                            }
                        }
                    }
                } catch (error) {
                    console.error('加载佣金设置失败:', error);
                    alert('加载佣金设置失败: ' + error.message);
                }
            },
            
            async saveSettings() {
                try {
                    // 验证必填项
                    if (!this.settings.commission_rate || this.settings.commission_rate < 0 || this.settings.commission_rate > 100) {
                        alert('请输入有效的佣金率（0-100%）');
                        return;
                    }
                    
                    if (!this.settings.min_withdraw_amount || this.settings.min_withdraw_amount < 0) {
                        alert('请输入有效的最低提现金额');
                        return;
                    }
                    
                    const response = await fetch('/api/admin/commission/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.settings)
                    });
                    
                    if (!response.ok) throw new Error('保存失败');
                    
                    const result = await response.json();
                    if (result.success) {
                        // 🔍 检查是否有地址变更
                        if (result.address_changed) {
                            const confirmMessage = [
                                '🔄 检测到平台推荐人地址已更换！',
                                '',
                                `📍 旧地址: ${result.old_address}`,
                                `📍 新地址: ${result.new_address}`,
                                `👥 受影响用户: ${result.old_address_users_count} 个`,
                                '',
                                '❗ 注意：这些用户仍在使用旧地址作为推荐人',
                                '💰 如不处理，平台收益将分散到多个地址',
                                '',
                                '是否立即将这些用户的推荐人地址更新为新地址？',
                                '',
                                '✅ 点击"确定"：立即批量更新（推荐）',
                                '❌ 点击"取消"：稍后在"推荐关系"页面手动处理'
                            ].join('\\n');
                            
                            if (confirm(confirmMessage)) {
                                await this.migrateOldPlatformAddress(result.old_address, result.new_address);
                            } else {
                                alert('⚠️ 地址更换完成，但用户推荐关系未更新\\n\\n请在"推荐关系"页面手动批量更新，以确保平台收益统一。');
                            }
                        } else {
                            alert(`配置保存成功！\\n${result.message || '更新了佣金设置'}`);
                        }
                        
                        // 重新加载统计数据以反映新的佣金率
                        await this.loadStats();
                    } else {
                        throw new Error(result.error || '保存失败');
                    }
                } catch (error) {
                    console.error('保存佣金设置失败:', error);
                    alert('保存佣金设置失败: ' + error.message);
                }
            },
            
            resetSettings() {
                if (!confirm('确定要重置所有配置到默认值吗？这将清除所有自定义设置。')) return;
                
                // 重置为默认值
                this.settings = {
                    // 核心分销设置
                    commission_rate: 35.0,
                    commission_description: '💰 推荐好友即享35%超高佣金，人人都是赚钱达人！',
                    enable_multi_level: true,
                    max_referral_levels: 2,
                    
                    // 分享功能设置
                    share_button_text: '🚀 分享赚大钱',
                    share_description: '🎯 推荐好友购买项目，您立即获得35%现金奖励！多级分销，收益无上限！',
                    share_success_message: '🎉 分享链接已复制！快去邀请好友赚取35%佣金吧！',
                    
                    // 提现配置
                    min_withdraw_amount: 10.0,
                    withdraw_fee_rate: 0.0,
                    withdraw_description: '💎 最低提现10 USDC，零手续费，秒到账！随时提现，自由支配！',
                    
                    // 佣金计算规则
                    commission_rules: {
                        direct_commission: '🔥 直接推荐佣金：好友购买金额的35%立即到账',
                        indirect_commission: '💰 多级推荐佣金：下级佣金收益的35%持续躺赚',
                        settlement_time: '⚡ 佣金实时到账，随时提现，秒速变现',
                        currency: 'USDC',
                        platform_earnings: '🏆 平台收益：所有无推荐人用户的35%佣金归平台所有'
                    }
                };
                
                alert('配置已重置为默认值，请点击"保存配置"来应用更改。');
            },
            
            async payCommission(record) {
                if (!confirm(`确定要发放佣金 ${this.formatCurrency(record.amount)} 给地址 ${record.recipient_address} 吗？`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/records/${record.id}/pay`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('发放失败');
                    
                    record.status = 'paid';
                    record.payment_time = new Date().toISOString();
                    alert('佣金发放成功');
                    await this.loadStats();
                } catch (error) {
                    console.error('发放佣金失败:', error);
                    alert('发放佣金失败: ' + error.message);
            }
            },
            
            viewRecord(record) {
                // 显示佣金记录详情
                const details = [
                    `佣金ID: ${record.id}`,
                    `接收地址: ${record.recipient_address}`,
                    `佣金金额: ${this.formatCurrency(record.amount)}`,
                    `佣金类型: ${record.commission_type === 'direct' ? '直接佣金' : '推荐佣金'}`,
                    `状态: ${this.getStatusText(record.status)}`,
                    `创建时间: ${this.formatDateTime(record.created_at)}`
                ];
                alert(details.join('\n'));
            },
            
            async refreshRecords() {
                await this.loadRecords();
            },
            
            async exportRecords() {
                try {
                    const response = await fetch('/api/admin/commission/records/export');
                    if (!response.ok) throw new Error('导出失败');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `commission_records_${new Date().getTime()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('导出失败:', error);
                    alert('导出失败: ' + error.message);
                }
            },
            
            formatCurrency(value) {
                return '$' + parseFloat(value || 0).toFixed(2);
            },
            
            formatDateTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN') + ' ' + 
                       date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            },
            
            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    return '今天';
                } else if (diffDays === 2) {
                    return '昨天';
                } else if (diffDays <= 7) {
                    return `${diffDays - 1}天前`;
                } else {
                    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                }
            },
            
            getStatusText(status) {
                const statusMap = {
                    'pending': '待发放',
                    'paid': '已发放',
                    'failed': '发放失败'
                };
                return statusMap[status] || '未知';
            },
            
            getWithdrawalStatusText(status) {
                const statusMap = {
                    'pending': '待处理',
                    'processing': '处理中',
                    'completed': '已完成',
                    'failed': '失败',
                    'cancelled': '已取消'
                };
                return statusMap[status] || '未知';
            },
            
            async createWithdrawal() {
                try {
                    const response = await fetch('/api/admin/commission/create_withdrawal', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.withdrawalForm)
                    });
                    
                    if (!response.ok) throw new Error('创建取现申请失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('取现申请创建成功！');
                        await this.loadWithdrawals();
                        this.showCreateWithdrawal = false;
                    } else {
                        throw new Error(data.error || '创建取现申请失败');
                    }
                } catch (error) {
                    console.error('创建取现申请失败:', error);
                    alert('创建取现申请失败: ' + error.message);
                }
            },
            
            async runAutomation() {
                try {
                    const response = await fetch('/api/admin/commission/automation/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (!response.ok) throw new Error('运行自动化失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('自动化运行成功！');
                        await this.refreshAutomationStatus();
                    } else {
                        throw new Error(data.error || '运行自动化失败');
                    }
                } catch (error) {
                    console.error('运行自动化失败:', error);
                    alert('运行自动化失败: ' + error.message);
                }
            },
            
            async refreshAutomationStatus() {
                try {
                    const response = await fetch('/api/admin/commission/automation/status');
                    if (!response.ok) throw new Error('刷新自动化状态失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.automationStatus = data.data || {};
                    } else {
                        throw new Error(data.error || '刷新自动化状态失败');
                    }
                } catch (error) {
                    console.error('刷新自动化状态失败:', error);
                    // 不显示错误弹窗，避免干扰用户
                }
            },
            
            // 🔄 平台地址管理方法
            async migrateOldPlatformAddress(oldAddress, newAddress) {
                try {
                    const response = await fetch('/api/admin/commission/platform-referrer/migrate-old-address', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            old_address: oldAddress,
                            new_address: newAddress
                        })
                    });
                    
                    if (!response.ok) throw new Error('地址迁移失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        const successMessage = [
                            '🎉 地址迁移成功！',
                            '',
                            `📊 迁移结果：`,
                            `• 旧地址：${data.data.old_address}`,
                            `• 新地址：${data.data.new_address}`,
                            `• 更新用户数：${data.data.updated_count} 个`,
                            `• 操作时间：${new Date(data.data.operation_time).toLocaleString('zh-CN')}`,
                            '',
                            '💰 现在所有平台下线的收益都会统一到新地址！'
                        ].join('\\n');
                        
                        alert(successMessage);
                        
                        // 刷新相关数据
                        await this.loadReferrals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || '地址迁移失败');
                    }
                } catch (error) {
                    console.error('地址迁移失败:', error);
                    alert('❌ 地址迁移失败\\n\\n错误信息: ' + error.message);
                }
            },
            
            async loadPlatformAddressData() {
                try {
                    const response = await fetch('/api/admin/commission/platform-referrer/old-addresses');
                    if (!response.ok) throw new Error('加载平台地址数据失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.platformAddressData = data.data || {};
                    } else {
                        throw new Error(data.error || '加载失败');
                    }
                } catch (error) {
                    console.error('加载平台地址数据失败:', error);
                    // 不显示错误弹窗，避免干扰用户
                }
            },
            
            async showAddressMigrationDialog() {
                await this.loadPlatformAddressData();
                
                if (!this.platformAddressData.platform_addresses || 
                    this.platformAddressData.platform_addresses.length <= 1) {
                    alert('✅ 当前只有一个平台地址，无需迁移。\\n\\n如果您刚刚更换了地址，请确保在佣金设置中保存新地址后再进行迁移操作。');
                    return;
                }
                
                // 准备迁移表单数据
                this.migrationForm.new_address = this.platformAddressData.current_platform_address;
                this.showAddressMigration = true;
            },
            
            async executeMigration() {
                if (!this.migrationForm.old_address || !this.migrationForm.new_address) {
                    alert('请选择旧地址和新地址');
                    return;
                }
                
                if (this.migrationForm.old_address === this.migrationForm.new_address) {
                    alert('新旧地址不能相同');
                    return;
                }
                
                const oldAddressInfo = this.platformAddressData.platform_addresses.find(
                    addr => addr.address === this.migrationForm.old_address
                );
                
                if (!oldAddressInfo) {
                    alert('未找到选择的旧地址信息');
                    return;
                }
                
                const confirmMessage = [
                    '⚠️ 确认执行地址迁移？',
                    '',
                    `📍 旧地址: ${this.migrationForm.old_address}`,
                    `📍 新地址: ${this.migrationForm.new_address}`,
                    `👥 受影响用户: ${oldAddressInfo.user_count} 个`,
                    '',
                    '此操作不可撤销，确定继续吗？'
                ].join('\\n');
                
                if (!confirm(confirmMessage)) return;
                
                await this.migrateOldPlatformAddress(this.migrationForm.old_address, this.migrationForm.new_address);
                this.showAddressMigration = false;
            }
        }
    }
    
    // 监听标签切换，加载对应数据
    document.addEventListener('alpine:init', () => {
        Alpine.effect(() => {
            if (window.commissionData && window.commissionData.activeTab === 'referrals' && window.commissionData.referrals.length === 0) {
                window.commissionData.loadReferrals();
            }
        });
});
</script>
{% endblock %} 