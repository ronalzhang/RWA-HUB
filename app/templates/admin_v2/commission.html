{% extends "admin_v2/base.html" %}

{% block title %}RWA-HUB 管理后台 - 佣金管理{% endblock %}

{% block page_title %}佣金管理{% endblock %}
{% block page_subtitle %}管理平台佣金设置和记录{% endblock %}

{% block breadcrumb %}
<li aria-current="page">
    <div class="flex items-center">
        <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
        <span class="text-gray-500">佣金管理</span>
    </div>
</li>
{% endblock %}

{% block content %}
<div x-data="commissionData()" x-init="loadCommissionData()">
    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" x-cloak>
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 mr-4">
                    <i class="fas fa-dollar-sign text-green-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">总佣金</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.total_commission || 0)"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 mr-4">
                    <i class="fas fa-users text-blue-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">推荐用户</h3>
                    <p class="text-2xl font-bold" x-text="stats.total_referrals || 0"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-yellow-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 mr-4">
                    <i class="fas fa-clock text-yellow-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">待发放</h3>
                    <p class="text-2xl font-bold" x-text="formatCurrency(stats.pending_commission || 0)"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm p-6 border-l-4 border-purple-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 mr-4">
                    <i class="fas fa-percentage text-purple-500"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-500">佣金率</h3>
                    <p class="text-2xl font-bold" x-text="(stats.commission_rate || 0) + '%'"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 功能选项卡 -->
    <div class="bg-white rounded-lg shadow-sm mb-6">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button @click="switchTab('records')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'records', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'records'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    佣金记录
                </button>
                <button @click="switchTab('settings')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'settings', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'settings'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    佣金设置
                </button>
                <button @click="switchTab('referrals')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'referrals', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'referrals'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    推荐关系
                </button>
                <button @click="switchTab('withdrawals')" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'withdrawals', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': activeTab !== 'withdrawals'}"
                        class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                    取现记录
                </button>
            </nav>
        </div>
    </div>

    <!-- 佣金记录 -->
    <div x-show="activeTab === 'records'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">佣金记录</h3>
                <div class="flex space-x-2">
                    <button @click="refreshRecords()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync-alt mr-2"></i>刷新
            </button>
                    <button @click="exportRecords()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-download mr-2"></i>导出
                </button>
            </div>
                </div>
        </div>

        <!-- 筛选条件 -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                    <select x-model="recordFilters.status" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部状态</option>
                        <option value="pending">待发放</option>
                        <option value="paid">已发放</option>
                        <option value="failed">发放失败</option>
                    </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">佣金类型</label>
                    <select x-model="recordFilters.type" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                    <option value="">全部类型</option>
                    <option value="direct">直接佣金</option>
                    <option value="referral">推荐佣金</option>
                </select>
            </div>
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">时间范围</label>
                    <select x-model="recordFilters.time_range" @change="loadRecords()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
            </div>
            <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
                    <input x-model="recordFilters.search" @input.debounce.500ms="loadRecords()" 
                           type="text" placeholder="搜索地址或交易ID..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
            </div>
        </div>
        </div>

        <!-- 佣金记录表格 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">接收地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">佣金金额</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">创建时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="recordsLoading">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>加载佣金记录中...
                        </td>
                    </tr>
                    </template>
                    
                    <template x-if="!recordsLoading && records.length === 0">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">暂无佣金记录</td>
                    </tr>
                    </template>
                    
                    <template x-for="record in records" :key="record.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="record.id"></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="record.recipient_address ? record.recipient_address.slice(0, 8) + '...' + record.recipient_address.slice(-6) : '-'"></div>
                        </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(record.amount || 0)"></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-blue-100 text-blue-800': record.commission_type === 'direct',
                                    'bg-green-100 text-green-800': record.commission_type === 'referral'
                                }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="record.commission_type === 'direct' ? '直接佣金' : '推荐佣金'"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span :class="{
                                'bg-yellow-100 text-yellow-800': record.status === 'pending',
                                'bg-green-100 text-green-800': record.status === 'paid',
                                'bg-red-100 text-red-800': record.status === 'failed'
                            }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="getStatusText(record.status)"></span>
                            </span>
                        </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(record.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button x-show="record.status === 'pending'" @click="payCommission(record)" 
                                        class="text-green-600 hover:text-green-900 mr-2">
                                    <i class="fas fa-check"></i> 发放
                                </button>
                                <button @click="viewRecord(record)" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                        </td>
                    </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
            <div class="text-sm text-gray-700">
                    显示 <span x-text="(recordPagination.page - 1) * recordPagination.limit + 1"></span> 到 
                    <span x-text="Math.min(recordPagination.page * recordPagination.limit, recordPagination.total)"></span> 条，
                    共 <span x-text="recordPagination.total"></span> 条记录
            </div>
                <div class="flex space-x-2">
                    <button @click="loadRecords(1)" :disabled="recordPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">首页</button>
                    <button @click="loadRecords(recordPagination.page - 1)" :disabled="recordPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">上一页</button>
                    <button @click="loadRecords(recordPagination.page + 1)" :disabled="recordPagination.page >= recordPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">下一页</button>
                    <button @click="loadRecords(recordPagination.pages)" :disabled="recordPagination.page >= recordPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">末页</button>
            </div>
        </div>
            </div>
        </div>

    <!-- 佣金设置 -->
    <div x-show="activeTab === 'settings'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700">佣金设置</h3>
        </div>

        <div class="px-6 py-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <h4 class="text-md font-semibold text-gray-700">基础设置</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">全局佣金率 (%)</label>
                        <input x-model="settings.global_rate" type="number" step="0.01" min="0" max="100"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                        <p class="text-xs text-gray-500 mt-1">适用于所有资产类型的默认佣金率</p>
        </div>

        <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">最低佣金金额 (USDC)</label>
                        <input x-model="settings.min_amount" type="number" step="0.01" min="0"
                               class="w-full border-gray-300 rounded-md shadow-sm">
    </div>

                                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">推荐等级</label>
                        <select x-model="settings.referral_levels" class="w-full border-gray-300 rounded-md shadow-sm">
                            <option value="1">一级推荐</option>
                            <option value="2">二级推荐</option>
                            <option value="3">三级推荐</option>
                        </select>
                                    </div>
                                </div>
                                
                <div class="space-y-4">
                    <h4 class="text-md font-semibold text-gray-700">分级佣金率</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">一级推荐佣金率 (%)</label>
                        <input x-model="settings.level1_rate" type="number" step="0.01" min="0" max="100"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                                </div>
                                
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">二级推荐佣金率 (%)</label>
                        <input x-model="settings.level2_rate" type="number" step="0.01" min="0" max="100"
                               class="w-full border-gray-300 rounded-md shadow-sm">
    </div>

                                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">三级推荐佣金率 (%)</label>
                        <input x-model="settings.level3_rate" type="number" step="0.01" min="0" max="100"
                               class="w-full border-gray-300 rounded-md shadow-sm">
                                    </div>
                                    </div>
                                </div>
                                
            <div class="mt-6 flex justify-end">
                <button @click="saveSettings()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                    <i class="fas fa-save mr-2"></i>保存设置
                </button>
                                    </div>
                                    </div>
                                </div>
                                
    <!-- 推荐关系 -->
    <div x-show="activeTab === 'referrals'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700">推荐关系</h3>
                                </div>
                                
        <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">推荐人地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">推荐等级</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">推荐码</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">加入时间</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="referralsLoading">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>加载推荐关系中...
                                                    </td>
                        </tr>
                    </template>
                    
                    <template x-if="!referralsLoading && referrals.length === 0">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">暂无推荐关系</td>
                        </tr>
                    </template>
                    
                    <template x-for="referral in referrals" :key="referral.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" 
                                x-text="referral.user_address ? referral.user_address.slice(0, 8) + '...' + referral.user_address.slice(-6) : '-'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" 
                                x-text="referral.referrer_address ? referral.referrer_address.slice(0, 8) + '...' + referral.referrer_address.slice(-6) : '-'"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-green-100 text-green-800': referral.referral_level === 1,
                                    'bg-blue-100 text-blue-800': referral.referral_level === 2,
                                    'bg-purple-100 text-purple-800': referral.referral_level === 3
                                }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="'L' + referral.referral_level"></span>
                                </span>
                                                    </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="referral.referral_code || '-'"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(referral.joined_at)"></td>
                                                </tr>
                    </template>
                                            </tbody>
                                        </table>
        </div>
    </div>

    <!-- 取现记录 -->
    <div x-show="activeTab === 'withdrawals'" class="bg-white rounded-lg shadow-sm" x-cloak>
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-700">取现记录</h3>
                <div class="flex space-x-2">
                    <button @click="refreshWithdrawals()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-sync-alt mr-2"></i>刷新
                    </button>
                </div>
            </div>
        </div>

        <!-- 筛选条件 -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">状态</label>
                    <select x-model="withdrawalFilters.status" @change="loadWithdrawals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部状态</option>
                        <option value="pending">待处理</option>
                        <option value="processing">处理中</option>
                        <option value="completed">已完成</option>
                        <option value="failed">失败</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">时间范围</label>
                    <select x-model="withdrawalFilters.time_range" @change="loadWithdrawals()" class="w-full border-gray-300 rounded-md shadow-sm">
                        <option value="">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">搜索</label>
                    <input x-model="withdrawalFilters.search" @input.debounce.500ms="loadWithdrawals()" 
                           type="text" placeholder="搜索地址或交易哈希..." 
                           class="w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="flex items-end">
                    <button @click="loadWithdrawals()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        <i class="fas fa-search mr-2"></i>搜索
                    </button>
                </div>
            </div>
        </div>

        <!-- 取现记录表格 -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">用户地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">提现地址</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">延迟时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请时间</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="withdrawalsLoading">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i>加载取现记录中...
                            </td>
                        </tr>
                    </template>
                    
                    <template x-if="!withdrawalsLoading && withdrawals.length === 0">
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">暂无取现记录</td>
                        </tr>
                    </template>
                    
                    <template x-for="withdrawal in withdrawals" :key="withdrawal.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="withdrawal.id"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="withdrawal.user_address ? withdrawal.user_address.slice(0, 8) + '...' + withdrawal.user_address.slice(-6) : '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" x-text="withdrawal.to_address ? withdrawal.to_address.slice(0, 8) + '...' + withdrawal.to_address.slice(-6) : '-'"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatCurrency(withdrawal.amount || 0)"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span :class="{
                                    'bg-yellow-100 text-yellow-800': withdrawal.status === 'pending',
                                    'bg-blue-100 text-blue-800': withdrawal.status === 'processing',
                                    'bg-green-100 text-green-800': withdrawal.status === 'completed',
                                    'bg-red-100 text-red-800': withdrawal.status === 'failed',
                                    'bg-gray-100 text-gray-800': withdrawal.status === 'cancelled'
                                }" class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full">
                                    <span x-text="getWithdrawalStatusText(withdrawal.status)"></span>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <div x-show="withdrawal.status === 'pending' && withdrawal.remaining_delay_seconds > 0">
                                    <span x-text="Math.ceil(withdrawal.remaining_delay_seconds / 60)"></span> 分钟
                                </div>
                                <div x-show="withdrawal.status === 'pending' && withdrawal.remaining_delay_seconds <= 0">
                                    <span class="text-green-600">可处理</span>
                                </div>
                                <div x-show="withdrawal.status !== 'pending'">-</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(withdrawal.created_at)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button x-show="withdrawal.status === 'pending' && withdrawal.is_ready_to_process" 
                                        @click="processWithdrawal(withdrawal)" 
                                        class="text-green-600 hover:text-green-900 mr-2">
                                    <i class="fas fa-check"></i> 处理
                                </button>
                                <button x-show="withdrawal.status === 'pending'" 
                                        @click="cancelWithdrawal(withdrawal)" 
                                        class="text-red-600 hover:text-red-900 mr-2">
                                    <i class="fas fa-times"></i> 取消
                                </button>
                                <button @click="viewWithdrawal(withdrawal)" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    显示 <span x-text="(withdrawalPagination.page - 1) * withdrawalPagination.limit + 1"></span> 到 
                    <span x-text="Math.min(withdrawalPagination.page * withdrawalPagination.limit, withdrawalPagination.total)"></span> 条，
                    共 <span x-text="withdrawalPagination.total"></span> 条记录
                </div>
                <div class="flex space-x-2">
                    <button @click="loadWithdrawals(1)" :disabled="withdrawalPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">首页</button>
                    <button @click="loadWithdrawals(withdrawalPagination.page - 1)" :disabled="withdrawalPagination.page === 1" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">上一页</button>
                    <button @click="loadWithdrawals(withdrawalPagination.page + 1)" :disabled="withdrawalPagination.page >= withdrawalPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">下一页</button>
                    <button @click="loadWithdrawals(withdrawalPagination.pages)" :disabled="withdrawalPagination.page >= withdrawalPagination.pages" 
                            class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50">末页</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function commissionData() {
        return {
            activeTab: 'records',
            stats: {},
            records: [],
            referrals: [],
            withdrawals: [],
            settings: {
                global_rate: 5.0,
                min_amount: 1.0,
                referral_levels: 3,
                level1_rate: 5.0,
                level2_rate: 3.0,
                level3_rate: 1.0
            },
            recordsLoading: false,
            referralsLoading: false,
            withdrawalsLoading: false,
        recordFilters: {
                status: '',
            type: '',
                time_range: '',
                search: ''
        },
            withdrawalFilters: {
                status: '',
                time_range: '',
                search: ''
            },
            recordPagination: {
                page: 1,
                limit: 10,
                total: 0,
                pages: 0
            },
            withdrawalPagination: {
                page: 1,
                limit: 10,
                total: 0,
                pages: 0
            },
            
            async loadCommissionData() {
                await Promise.all([
                    this.loadStats(),
                    this.loadRecords(),
                    this.loadReferrals(),
                    this.loadWithdrawals(),
                    this.loadSettings()
                ]);
            },
            
            switchTab(tab) {
                this.activeTab = tab;
                // 切换到推荐关系标签页时加载数据
                if (tab === 'referrals' && this.referrals.length === 0) {
                    this.loadReferrals();
                }
                // 切换到取现记录标签页时加载数据
                if (tab === 'withdrawals' && this.withdrawals.length === 0) {
                    this.loadWithdrawals();
                }
            },
            
            async loadStats() {
                try {
                    const response = await fetch('/api/admin/commission/stats');
                    if (response.ok) {
                        this.stats = await response.json();
                    }
                } catch (error) {
                    console.error('加载佣金统计失败:', error);
                }
            },
            
            async loadRecords(page = null) {
                if (page) this.recordPagination.page = page;
                this.recordsLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.recordPagination.page,
                        limit: this.recordPagination.limit,
                        ...this.recordFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/records?${params}`);
                    if (!response.ok) throw new Error('加载佣金记录失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.records = data.data || [];
                        this.recordPagination.total = data.pagination?.total || 0;
                        this.recordPagination.pages = data.pagination?.pages || 0;
                    } else {
                        throw new Error(data.error || '加载失败');
                    }
                } catch (error) {
                    console.error('加载佣金记录失败:', error);
                    alert('加载佣金记录失败: ' + error.message);
                } finally {
                    this.recordsLoading = false;
                }
            },
            
            async loadReferrals() {
                this.referralsLoading = true;
                try {
                    const response = await fetch('/api/admin/commission/referrals');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.referrals = data.items || [];
                        } else {
                            throw new Error(data.error || '加载失败');
                        }
                    }
                } catch (error) {
                    console.error('加载推荐关系失败:', error);
                    alert('加载推荐关系失败: ' + error.message);
                } finally {
                    this.referralsLoading = false;
                }
            },
            
            async loadWithdrawals(page = null) {
                if (page) this.withdrawalPagination.page = page;
                this.withdrawalsLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: this.withdrawalPagination.page,
                        limit: this.withdrawalPagination.limit,
                        ...this.withdrawalFilters
                    });
                    
                    const response = await fetch(`/api/admin/commission/withdrawals?${params}`);
                    if (!response.ok) throw new Error('加载取现记录失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        this.withdrawals = data.data || [];
                        this.withdrawalPagination.total = data.pagination?.total || 0;
                        this.withdrawalPagination.pages = data.pagination?.pages || 0;
                    } else {
                        throw new Error(data.error || '加载失败');
                    }
                } catch (error) {
                    console.error('加载取现记录失败:', error);
                    alert('加载取现记录失败: ' + error.message);
                } finally {
                    this.withdrawalsLoading = false;
                }
            },
            
            async processWithdrawal(withdrawal) {
                if (!confirm(`确定要处理提现申请吗？\n用户地址: ${withdrawal.user_address}\n提现金额: ${this.formatCurrency(withdrawal.amount)}\n提现地址: ${withdrawal.to_address}`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/withdrawals/${withdrawal.id}/process`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('处理失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('提现处理成功！\n交易哈希: ' + data.tx_hash);
                        await this.loadWithdrawals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || '处理失败');
                    }
                } catch (error) {
                    console.error('处理提现失败:', error);
                    alert('处理提现失败: ' + error.message);
                }
            },
            
            async cancelWithdrawal(withdrawal) {
                const reason = prompt('请输入取消原因（可选）:', '管理员取消');
                if (reason === null) return; // 用户点击了取消
                
                if (!confirm(`确定要取消此提现申请吗？\n用户地址: ${withdrawal.user_address}\n提现金额: ${this.formatCurrency(withdrawal.amount)}\n取消原因: ${reason}`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/withdrawals/${withdrawal.id}/cancel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reason: reason })
                    });
                    
                    if (!response.ok) throw new Error('取消失败');
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('提现申请已取消，金额已退还到用户余额');
                        await this.loadWithdrawals();
                        await this.loadStats();
                    } else {
                        throw new Error(data.error || '取消失败');
                    }
                } catch (error) {
                    console.error('取消提现失败:', error);
                    alert('取消提现失败: ' + error.message);
                }
            },
            
            viewWithdrawal(withdrawal) {
                // 显示提现记录详情
                const details = [
                    `提现ID: ${withdrawal.id}`,
                    `用户地址: ${withdrawal.user_address}`,
                    `提现地址: ${withdrawal.to_address}`,
                    `提现金额: ${this.formatCurrency(withdrawal.amount)}`,
                    `币种: ${withdrawal.currency || 'USDC'}`,
                    `状态: ${this.getWithdrawalStatusText(withdrawal.status)}`,
                    `延迟时间: ${withdrawal.delay_minutes} 分钟`,
                    `申请时间: ${this.formatDateTime(withdrawal.created_at)}`,
                    `预计处理时间: ${this.formatDateTime(withdrawal.process_at)}`,
                    withdrawal.processed_at ? `实际处理时间: ${this.formatDateTime(withdrawal.processed_at)}` : '',
                    withdrawal.tx_hash ? `交易哈希: ${withdrawal.tx_hash}` : '',
                    withdrawal.note ? `用户备注: ${withdrawal.note}` : '',
                    withdrawal.admin_note ? `管理员备注: ${withdrawal.admin_note}` : '',
                    withdrawal.failure_reason ? `失败原因: ${withdrawal.failure_reason}` : ''
                ].filter(Boolean);
                
                alert(details.join('\n'));
            },
            
            async refreshWithdrawals() {
                await this.loadWithdrawals();
            },
            
            async loadSettings() {
                try {
                    const response = await fetch('/api/admin/commission/settings');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // 移除success字段，其余字段合并到settings
                            const { success, ...settingsData } = data;
                            this.settings = { ...this.settings, ...settingsData };
                        }
                    }
                } catch (error) {
                    console.error('加载佣金设置失败:', error);
                }
            },
            
            async saveSettings() {
                try {
                    const response = await fetch('/api/admin/commission/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.settings)
                    });
                    
                    if (!response.ok) throw new Error('保存失败');
                    
                    alert('佣金设置保存成功');
                } catch (error) {
                    console.error('保存佣金设置失败:', error);
                    alert('保存佣金设置失败: ' + error.message);
                }
            },
            
            async payCommission(record) {
                if (!confirm(`确定要发放佣金 ${this.formatCurrency(record.amount)} 给地址 ${record.recipient_address} 吗？`)) return;
                
                try {
                    const response = await fetch(`/api/admin/commission/records/${record.id}/pay`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) throw new Error('发放失败');
                    
                    record.status = 'paid';
                    record.payment_time = new Date().toISOString();
                    alert('佣金发放成功');
                    await this.loadStats();
                } catch (error) {
                    console.error('发放佣金失败:', error);
                    alert('发放佣金失败: ' + error.message);
            }
            },
            
            viewRecord(record) {
                // 显示佣金记录详情
                const details = [
                    `佣金ID: ${record.id}`,
                    `接收地址: ${record.recipient_address}`,
                    `佣金金额: ${this.formatCurrency(record.amount)}`,
                    `佣金类型: ${record.commission_type === 'direct' ? '直接佣金' : '推荐佣金'}`,
                    `状态: ${this.getStatusText(record.status)}`,
                    `创建时间: ${this.formatDateTime(record.created_at)}`
                ];
                alert(details.join('\n'));
            },
            
            async refreshRecords() {
                await this.loadRecords();
            },
            
            async exportRecords() {
                try {
                    const response = await fetch('/api/admin/commission/records/export');
                    if (!response.ok) throw new Error('导出失败');
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `commission_records_${new Date().getTime()}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('导出失败:', error);
                    alert('导出失败: ' + error.message);
                }
            },
            
            formatCurrency(value) {
                return '$' + parseFloat(value || 0).toFixed(2);
            },
            
            formatDateTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN') + ' ' + 
                       date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            },
            
            getStatusText(status) {
                const statusMap = {
                    'pending': '待发放',
                    'paid': '已发放',
                    'failed': '发放失败'
                };
                return statusMap[status] || '未知';
            },
            
            getWithdrawalStatusText(status) {
                const statusMap = {
                    'pending': '待处理',
                    'processing': '处理中',
                    'completed': '已完成',
                    'failed': '失败',
                    'cancelled': '已取消'
                };
                return statusMap[status] || '未知';
            }
        }
    }
    
    // 监听标签切换，加载对应数据
    document.addEventListener('alpine:init', () => {
        Alpine.effect(() => {
            if (window.commissionData && window.commissionData.activeTab === 'referrals' && window.commissionData.referrals.length === 0) {
                window.commissionData.loadReferrals();
            }
        });
});
</script>
{% endblock %} 