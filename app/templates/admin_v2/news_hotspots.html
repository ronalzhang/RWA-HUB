{% extends "admin_v2/base.html" %}

{% block title %}热点新闻管理 - 管理后台{% endblock %}

{% block content %}
<div class="main-content">
    <!-- 页面标题和操作区 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h4 mb-0">热点新闻管理</h2>
            <p class="text-muted mt-1">管理首页展示的热点新闻内容</p>
        </div>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addHotspotModal">
            <i class="fas fa-plus me-2"></i>添加热点新闻
        </button>
    </div>

    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar bg-primary bg-opacity-10 text-primary">
                                <i class="fas fa-newspaper"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="row">
                                <div class="col">
                                    <p class="small text-muted mb-0">总新闻数</p>
                                    <h6 class="fw-bold mb-0" id="totalCount">-</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar bg-success bg-opacity-10 text-success">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="row">
                                <div class="col">
                                    <p class="small text-muted mb-0">活跃显示</p>
                                    <h6 class="fw-bold mb-0" id="activeCount">-</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar bg-info bg-opacity-10 text-info">
                                <i class="fas fa-tags"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="row">
                                <div class="col">
                                    <p class="small text-muted mb-0">分类数量</p>
                                    <h6 class="fw-bold mb-0" id="categoryCount">-</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="avatar bg-warning bg-opacity-10 text-warning">
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="row">
                                <div class="col">
                                    <p class="small text-muted mb-0">优先级最高</p>
                                    <h6 class="fw-bold mb-0" id="maxPriority">-</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label small">分类筛选</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">全部分类</option>
                            <option value="general">通用</option>
                            <option value="crypto">加密货币</option>
                            <option value="defi">DeFi</option>
                            <option value="market">市场动态</option>
                            <option value="announcement">公告</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">状态筛选</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="true">活跃</option>
                            <option value="false">禁用</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small">关键词搜索</label>
                        <input type="text" class="form-control" id="searchKeyword" placeholder="搜索标题或内容...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-search me-1"></i>搜索
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 热点新闻列表 -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
            <h6 class="mb-0">热点新闻列表</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;">ID</th>
                            <th style="width: 80px;">封面</th>
                            <th>标题</th>
                            <th style="width: 100px;">分类</th>
                            <th style="width: 80px;">优先级</th>
                            <th style="width: 80px;">状态</th>
                            <th style="width: 120px;">创建时间</th>
                            <th style="width: 120px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="hotspotsTableBody">
                        <!-- 动态加载内容 -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white">
            <nav aria-label="分页导航">
                <ul class="pagination pagination-sm mb-0" id="pagination">
                    <!-- 分页按钮 -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- 添加/编辑热点新闻模态框 -->
<div class="modal fade" id="addHotspotModal" tabindex="-1" aria-labelledby="addHotspotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addHotspotModalLabel">添加热点新闻</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="hotspotForm">
                <div class="modal-body">
                    <input type="hidden" id="hotspotId">

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="title" class="form-label">新闻标题 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" required maxlength="200">
                            <div class="form-text">标题最多200个字符</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">分类</label>
                            <select class="form-select" id="category" required>
                                <option value="general">通用</option>
                                <option value="crypto">加密货币</option>
                                <option value="defi">DeFi</option>
                                <option value="market">市场动态</option>
                                <option value="announcement">公告</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="priority" class="form-label">优先级</label>
                            <input type="number" class="form-control" id="priority" value="0" min="0" max="999">
                            <div class="form-text">数字越大优先级越高</div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="displayOrder" class="form-label">显示顺序</label>
                            <input type="number" class="form-control" id="displayOrder" value="0" min="0">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="summary" class="form-label">摘要</label>
                            <textarea class="form-control" id="summary" rows="3" placeholder="简短描述，用于首页卡片显示"></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="imageUrl" class="form-label">封面图片URL</label>
                            <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                            <div class="form-text">推荐尺寸: 400x300px，格式: JPG/PNG</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="linkUrl" class="form-label">链接URL（可选）</label>
                            <input type="url" class="form-control" id="linkUrl" placeholder="https://example.com/news">
                            <div class="form-text">点击卡片时跳转的链接</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="tags" class="form-label">标签</label>
                            <input type="text" class="form-control" id="tags" placeholder="标签1,标签2,标签3">
                            <div class="form-text">多个标签用逗号分隔</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="content" class="form-label">详细内容（可选）</label>
                            <textarea class="form-control" id="content" rows="6" placeholder="详细的新闻内容..."></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" checked>
                                <label class="form-check-label" for="isActive">
                                    立即启用并在首页显示
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>保存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentPage = 1;
    let isEditing = false;

    // 加载热点新闻列表
    function loadHotspots(page = 1) {
        const params = new URLSearchParams({
            page: page,
            per_page: 10,
            category: $('#categoryFilter').val(),
            is_active: $('#statusFilter').val()
        });

        $.get(`/api/admin/v2/news/hotspots?${params}`)
            .done(function(response) {
                if (response.success) {
                    renderHotspots(response.data.hotspots);
                    renderPagination(response.data.pagination);
                    updateStats(response.data.stats);
                    currentPage = page;
                }
            })
            .fail(function(xhr) {
                console.error('加载热点新闻失败:', xhr.responseJSON);
                showAlert('danger', '加载热点新闻失败');
            });
    }

    // 渲染热点新闻列表
    function renderHotspots(hotspots) {
        const tbody = $('#hotspotsTableBody');
        tbody.empty();

        if (hotspots.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="8" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                        暂无热点新闻数据
                    </td>
                </tr>
            `);
            return;
        }

        hotspots.forEach(function(hotspot) {
            const statusBadge = hotspot.is_active
                ? '<span class="badge bg-success">活跃</span>'
                : '<span class="badge bg-secondary">禁用</span>';

            const categoryText = getCategoryText(hotspot.category);
            const imagePreview = hotspot.image_url
                ? `<img src="${hotspot.image_url}" class="rounded" style="width: 50px; height: 40px; object-fit: cover;" onerror="this.style.display='none'">`
                : '<i class="fas fa-image text-muted"></i>';

            const createdAt = hotspot.created_at ? new Date(hotspot.created_at).toLocaleDateString() : '-';

            tbody.append(`
                <tr>
                    <td>${hotspot.id}</td>
                    <td class="text-center">${imagePreview}</td>
                    <td>
                        <div class="fw-medium">${escapeHtml(hotspot.title)}</div>
                        <small class="text-muted">${escapeHtml(hotspot.summary || '').substring(0, 50)}${hotspot.summary && hotspot.summary.length > 50 ? '...' : ''}</small>
                    </td>
                    <td><span class="badge bg-info bg-opacity-10 text-info">${categoryText}</span></td>
                    <td><span class="badge bg-warning bg-opacity-10 text-warning">${hotspot.priority}</span></td>
                    <td>${statusBadge}</td>
                    <td class="small text-muted">${createdAt}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="editHotspot(${hotspot.id})" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-${hotspot.is_active ? 'warning' : 'success'} btn-sm" onclick="toggleHotspotStatus(${hotspot.id}, ${hotspot.is_active})" title="${hotspot.is_active ? '禁用' : '启用'}">
                                <i class="fas fa-${hotspot.is_active ? 'eye-slash' : 'eye'}"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteHotspot(${hotspot.id}, '${escapeHtml(hotspot.title)}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `);
        });
    }

    // 渲染分页
    function renderPagination(pagination) {
        const paginationEl = $('#pagination');
        paginationEl.empty();

        if (pagination.pages <= 1) return;

        // 上一页
        if (pagination.has_prev) {
            paginationEl.append(`
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadHotspots(${pagination.page - 1})">上一页</a>
                </li>
            `);
        }

        // 页码
        const startPage = Math.max(1, pagination.page - 2);
        const endPage = Math.min(pagination.pages, pagination.page + 2);

        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === pagination.page ? 'active' : '';
            paginationEl.append(`
                <li class="page-item ${isActive}">
                    <a class="page-link" href="#" onclick="loadHotspots(${i})">${i}</a>
                </li>
            `);
        }

        // 下一页
        if (pagination.has_next) {
            paginationEl.append(`
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadHotspots(${pagination.page + 1})">下一页</a>
                </li>
            `);
        }
    }

    // 更新统计信息
    function updateStats(stats) {
        $('#totalCount').text(stats.total || 0);
        $('#activeCount').text(stats.active || 0);
        $('#categoryCount').text(stats.categories ? stats.categories.length : 0);

        // 计算最大优先级（这里简化处理）
        $('#maxPriority').text('-');
    }

    // 表单提交
    $('#hotspotForm').on('submit', function(e) {
        e.preventDefault();

        const formData = {
            title: $('#title').val().trim(),
            summary: $('#summary').val().trim(),
            content: $('#content').val().trim(),
            image_url: $('#imageUrl').val().trim(),
            link_url: $('#linkUrl').val().trim(),
            category: $('#category').val(),
            priority: parseInt($('#priority').val()) || 0,
            display_order: parseInt($('#displayOrder').val()) || 0,
            tags: $('#tags').val().trim(),
            is_active: $('#isActive').is(':checked')
        };

        if (!formData.title) {
            showAlert('warning', '请输入新闻标题');
            return;
        }

        const hotspotId = $('#hotspotId').val();
        const url = isEditing ? `/api/admin/v2/news/hotspots/${hotspotId}` : '/api/admin/v2/news/hotspots';
        const method = isEditing ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            method: method,
            data: JSON.stringify(formData),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message);
                    $('#addHotspotModal').modal('hide');
                    loadHotspots(currentPage);
                } else {
                    showAlert('danger', response.error || '操作失败');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : '操作失败';
                showAlert('danger', error);
            }
        });
    });

    // 筛选表单提交
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        loadHotspots(1);
    });

    // 重置表单
    function resetForm() {
        $('#hotspotForm')[0].reset();
        $('#hotspotId').val('');
        $('#priority').val('0');
        $('#displayOrder').val('0');
        $('#isActive').prop('checked', true);
        isEditing = false;
        $('#addHotspotModalLabel').text('添加热点新闻');
    }

    // 模态框关闭时重置表单
    $('#addHotspotModal').on('hidden.bs.modal', function () {
        resetForm();
    });

    // 工具函数
    function getCategoryText(category) {
        const categoryMap = {
            'general': '通用',
            'crypto': '加密货币',
            'defi': 'DeFi',
            'market': '市场动态',
            'announcement': '公告'
        };
        return categoryMap[category] || category;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('.main-content').prepend(alertHtml);

        // 3秒后自动关闭
        setTimeout(function() {
            $('.alert').alert('close');
        }, 3000);
    }

    // 全局函数
    window.editHotspot = function(id) {
        $.get(`/api/admin/v2/news/hotspots?per_page=100`)
            .done(function(response) {
                if (response.success) {
                    const hotspot = response.data.hotspots.find(h => h.id === id);
                    if (hotspot) {
                        $('#hotspotId').val(hotspot.id);
                        $('#title').val(hotspot.title);
                        $('#summary').val(hotspot.summary);
                        $('#content').val(hotspot.content);
                        $('#imageUrl').val(hotspot.image_url);
                        $('#linkUrl').val(hotspot.link_url);
                        $('#category').val(hotspot.category);
                        $('#priority').val(hotspot.priority);
                        $('#displayOrder').val(hotspot.display_order);
                        $('#tags').val(hotspot.tags ? hotspot.tags.join(',') : '');
                        $('#isActive').prop('checked', hotspot.is_active);

                        isEditing = true;
                        $('#addHotspotModalLabel').text('编辑热点新闻');
                        $('#addHotspotModal').modal('show');
                    }
                }
            });
    };

    window.toggleHotspotStatus = function(id, currentStatus) {
        const action = currentStatus ? '禁用' : '启用';
        if (confirm(`确定要${action}这条热点新闻吗？`)) {
            $.post(`/api/admin/v2/news/hotspots/${id}/toggle`)
                .done(function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        loadHotspots(currentPage);
                    } else {
                        showAlert('danger', response.error || '操作失败');
                    }
                })
                .fail(function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : '操作失败';
                    showAlert('danger', error);
                });
        }
    };

    window.deleteHotspot = function(id, title) {
        if (confirm(`确定要删除热点新闻"${title}"吗？此操作不可恢复。`)) {
            $.ajax({
                url: `/api/admin/v2/news/hotspots/${id}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        loadHotspots(currentPage);
                    } else {
                        showAlert('danger', response.error || '删除失败');
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : '删除失败';
                    showAlert('danger', error);
                }
            });
        }
    };

    // 页面加载时获取数据
    loadHotspots();
});
</script>
{% endblock %}