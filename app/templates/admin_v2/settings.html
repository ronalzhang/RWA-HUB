{% extends 'admin_v2/base.html' %}

{% block page_title %}{{ _('System Settings') }}{% endblock %}
{% block page_subtitle %}{{ _('Manage platform configuration, including payment settings and private key security.') }}{% endblock %}

{% block breadcrumb %}
<li>
    <span class="mx-1 text-gray-500">/</span>
</li>
<li>
    <span class="text-gray-500">{{ _('Settings') }}</span>
</li>
{% endblock %}

{% block content %}
<div x-data="settingsManager()" class="space-y-6">
    
    <!-- ç³»ç»Ÿé…ç½® -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">{{ _('Payment Configuration') }}</h2>

        {# Display flashed messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                {% for category, message in messages %}
                    <div class="p-4 rounded-md {{ 'bg-red-100 text-red-700' if category == 'error' else 'bg-green-100 text-green-700' }}" role="alert">
                        <p class="font-medium">{{ message }}</p>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('admin.update_settings_v2') }}">
            {{ csrf_token() }}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {# --- Asset Purchase Settings --- #}
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-4 border-b pb-2">{{ _('Asset Purchase Settings') }}</h3>
                    
                    <div class="mb-4">
                        <label for="platform_fee_basis_points" class="block text-sm font-medium text-gray-700 mb-1">{{ _('Platform Fee Rate (Basis Points)') }}</label>
                        <input type="number" id="platform_fee_basis_points" name="platform_fee_basis_points" min="0" max="10000" step="1"
                               value="{{ configs.PLATFORM_FEE_BASIS_POINTS }}" required 
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="e.g., 350 for 3.5%">
                        <p class="mt-1 text-xs text-gray-500">{{ _('Percentage points (out of 10000) charged on asset purchases. 350 = 3.5%') }}</p>
                    </div>

                    <div class="mb-4">
                        <label for="platform_fee_address" class="block text-sm font-medium text-gray-700 mb-1">{{ _('Platform Fee Address (Solana)') }}</label>
                        <input type="text" id="platform_fee_address" name="platform_fee_address" 
                               value="{{ configs.PLATFORM_FEE_ADDRESS }}" required 
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="Solana address for receiving purchase fees">
                    </div>

                    <div class="mb-4">
                        <label for="purchase_contract_address" class="block text-sm font-medium text-gray-700 mb-1">{{ _('Purchase Smart Contract Address (Solana)') }}</label>
                        <input type="text" id="purchase_contract_address" name="purchase_contract_address" 
                               value="{{ configs.PURCHASE_CONTRACT_ADDRESS }}" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="Solana address of the purchase/escrow contract">
                    </div>
                </div>

                {# --- Asset Creation Settings --- #}
                <div>
                    <h3 class="text-lg font-medium text-gray-700 mb-4 border-b pb-2">{{ _('Asset Creation Settings') }}</h3>

                    <div class="mb-4">
                        <label for="asset_creation_fee_amount" class="block text-sm font-medium text-gray-700 mb-1">{{ _('Asset Creation Fee Amount (USDC)') }}</label>
                        <input type="number" id="asset_creation_fee_amount" name="asset_creation_fee_amount" min="0" step="0.000001" 
                               value="{{ configs.ASSET_CREATION_FEE_AMOUNT }}" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="e.g., 1.0">
                         <p class="mt-1 text-xs text-gray-500">{{ _('Fee charged in USDC for creating a new asset.') }}</p>
                   </div>

                    <div class="mb-4">
                        <label for="asset_creation_fee_address" class="block text-sm font-medium text-gray-700 mb-1">{{ _('Asset Creation Fee Address (Solana)') }}</label>
                        <input type="text" id="asset_creation_fee_address" name="asset_creation_fee_address" 
                               value="{{ configs.ASSET_CREATION_FEE_ADDRESS }}" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                               placeholder="Solana address for receiving asset creation fees">
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-5 border-t border-gray-200">
                <div class="flex justify-end">
                    <button type="submit" 
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        {{ _('Save Settings') }}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- ç§é’¥å®‰å…¨ç®¡ç† -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">ğŸ” ç§é’¥å®‰å…¨ç®¡ç†</h2>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">å®‰å…¨æé†’</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <ul class="list-disc pl-5 space-y-1">
                            <li>ç§é’¥å°†ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•è¿›è¡Œä¿æŠ¤</li>
                            <li>è¯·ç¡®ä¿å·²è®¾ç½® CRYPTO_PASSWORD ç¯å¢ƒå˜é‡</li>
                            <li>åŠ å¯†åçš„ç§é’¥å¯ä»¥å®‰å…¨åœ°å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Š</li>
                            <li>è¯·å¦¥å–„ä¿ç®¡åŠ å¯†å¯†ç ï¼Œä¸¢å¤±å°†æ— æ³•æ¢å¤ç§é’¥</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç§é’¥åŠ å¯†å·¥å…· -->
        <div class="space-y-6">
            <div>
                <h3 class="text-lg font-medium text-gray-700 mb-4">ç§é’¥åŠ å¯†å·¥å…·</h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- åŠ å¯†ç§é’¥ -->
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-700">1. åŠ å¯†æ–°ç§é’¥</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å…¥ç§é’¥</label>
                            <textarea x-model="privateKey" 
                                    placeholder="è¾“å…¥Base58ã€åå…­è¿›åˆ¶æˆ–Base64æ ¼å¼çš„ç§é’¥"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    rows="3"></textarea>
                        </div>
                        
                        <button @click="encryptPrivateKey()" 
                                :disabled="!privateKey || encrypting"
                                class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:bg-gray-400">
                            <span x-show="!encrypting">ğŸ”’ åŠ å¯†ç§é’¥</span>
                            <span x-show="encrypting">åŠ å¯†ä¸­...</span>
                        </button>
                        
                        <div x-show="encryptedKey" class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">åŠ å¯†åçš„ç§é’¥</label>
                            <textarea x-model="encryptedKey" readonly
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-sm"
                                    rows="4"></textarea>
                            <div x-show="walletAddress" class="text-sm text-gray-600">
                                <strong>å¯¹åº”é’±åŒ…åœ°å€:</strong> <span x-text="walletAddress"></span>
                            </div>
                            <button @click="copyToClipboard(encryptedKey)" 
                                    class="text-sm bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
                                ğŸ“‹ å¤åˆ¶åŠ å¯†ç§é’¥
                            </button>
                        </div>
                    </div>
                    
                    <!-- æµ‹è¯•åŠ å¯†ç§é’¥ -->
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-700">2. æµ‹è¯•åŠ å¯†ç§é’¥</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">åŠ å¯†çš„ç§é’¥</label>
                            <textarea x-model="testEncryptedKey" 
                                    placeholder="è¾“å…¥è¦æµ‹è¯•çš„åŠ å¯†ç§é’¥"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    rows="3"></textarea>
                        </div>
                        
                        <button @click="testEncryptedKey()" 
                                :disabled="!testEncryptedKey || testing"
                                class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:bg-gray-400">
                            <span x-show="!testing">ğŸ”“ æµ‹è¯•è§£å¯†</span>
                            <span x-show="testing">æµ‹è¯•ä¸­...</span>
                        </button>
                        
                        <div x-show="testResult" class="space-y-2">
                            <div :class="testSuccess ? 'text-green-600' : 'text-red-600'" class="text-sm font-medium">
                                <span x-text="testMessage"></span>
                            </div>
                            <div x-show="testWalletAddress" class="text-sm text-gray-600">
                                <strong>è§£å¯†åé’±åŒ…åœ°å€:</strong> <span x-text="testWalletAddress"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- éƒ¨ç½²è¯´æ˜ -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-medium text-gray-700 mb-4">æœåŠ¡å™¨éƒ¨ç½²è¯´æ˜</h3>
                
                <div class="bg-gray-50 rounded-md p-4">
                    <h4 class="font-medium text-gray-700 mb-2">ç¯å¢ƒå˜é‡è®¾ç½®</h4>
                    <pre class="text-sm text-gray-600 bg-gray-100 p-3 rounded overflow-x-auto"><code># 1. è®¾ç½®åŠ å¯†å¯†ç ï¼ˆå¿…éœ€ï¼‰
export CRYPTO_PASSWORD='your_very_strong_password_here'

# 2. è®¾ç½®åŠ å¯†çš„ç§é’¥ï¼ˆæ¨èï¼‰
export SOLANA_PRIVATE_KEY_ENCRYPTED='your_encrypted_private_key_here'

# 3. åˆ é™¤æ˜æ–‡ç§é’¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
unset SOLANA_PRIVATE_KEY</code></pre>
                    
                    <div class="mt-4 text-sm text-gray-600">
                        <p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
                        <ul class="list-disc pl-5 space-y-1 mt-2">
                            <li>CRYPTO_PASSWORD åº”è¯¥æ˜¯ä¸€ä¸ªå¼ºå¯†ç ï¼Œå»ºè®®ä½¿ç”¨å¯†é’¥ç®¡ç†ç³»ç»Ÿå­˜å‚¨</li>
                            <li>åŠ å¯†ç§é’¥å¯ä»¥å®‰å…¨åœ°å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­</li>
                            <li>ç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨åŠ å¯†ç§é’¥ï¼Œå¦‚æœä¸å¯ç”¨åˆ™å›é€€åˆ°æ˜æ–‡ç§é’¥</li>
                            <li>å»ºè®®å®šæœŸè½®æ¢åŠ å¯†å¯†ç å’Œç§é’¥</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function settingsManager() {
    return {
        privateKey: '',
        encryptedKey: '',
        walletAddress: '',
        encrypting: false,
        
        testEncryptedKey: '',
        testResult: false,
        testSuccess: false,
        testMessage: '',
        testWalletAddress: '',
        testing: false,
        
        async encryptPrivateKey() {
            if (!this.privateKey.trim()) {
                alert('è¯·è¾“å…¥ç§é’¥');
                return;
            }
            
            this.encrypting = true;
            try {
                const response = await fetch('/admin/v2/api/crypto/encrypt-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        private_key: this.privateKey.trim()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.encryptedKey = data.encrypted_key;
                    this.walletAddress = data.wallet_address;
                    alert('ç§é’¥åŠ å¯†æˆåŠŸï¼');
                } else {
                    alert('åŠ å¯†å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åŠ å¯†ç§é’¥å¤±è´¥:', error);
                alert('åŠ å¯†å¤±è´¥: ' + error.message);
            } finally {
                this.encrypting = false;
            }
        },
        
        async testEncryptedKey() {
            if (!this.testEncryptedKey.trim()) {
                alert('è¯·è¾“å…¥è¦æµ‹è¯•çš„åŠ å¯†ç§é’¥');
                return;
            }
            
            this.testing = true;
            this.testResult = false;
            
            try {
                const response = await fetch('/admin/v2/api/crypto/test-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        encrypted_key: this.testEncryptedKey.trim()
                    })
                });
                
                const data = await response.json();
                
                this.testResult = true;
                this.testSuccess = data.success;
                this.testMessage = data.success ? data.message : data.error;
                this.testWalletAddress = data.wallet_address || '';
                
            } catch (error) {
                console.error('æµ‹è¯•åŠ å¯†ç§é’¥å¤±è´¥:', error);
                this.testResult = true;
                this.testSuccess = false;
                this.testMessage = 'æµ‹è¯•å¤±è´¥: ' + error.message;
                this.testWalletAddress = '';
            } finally {
                this.testing = false;
            }
        },
        
        async copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }
    }
}
</script>
{% endblock %} 