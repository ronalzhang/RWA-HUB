{% extends "base.html" %}

{% block title %}{{ _('Create Asset') }} - RWA-HUB{% endblock %}

{% block head %}
<style>
    .dropzone[data-page="create-asset"] {
        border: 3px dashed #bbb;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
    }

    .dropzone[data-page="create-asset"]:hover,
    .dropzone[data-page="create-asset"].border-primary {
        border-color: #0d6efd;
        background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(13, 110, 253, 0.15);
    }

    .dropzone[data-page="create-asset"] i {
        font-size: 3.5rem;
        color: #6c757d;
        margin-bottom: 1.5rem;
        display: block;
        transition: all 0.3s ease;
    }

    .dropzone[data-page="create-asset"]:hover i {
        color: #0d6efd;
        transform: scale(1.1);
    }

    .form-control.bg-light {
        background-color: #f8f9fa !important;
        border: 1px solid #e9ecef;
        color: #495057;
        font-weight: 500;
    }

    .token-info {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .token-info .form-label {
        color: #6c757d;
        font-size: 0.875rem;
    }

    .token-info .form-control {
        font-size: 1.125rem;
        font-weight: 500;
    }

    .document-suggestion {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .document-suggestion h6 {
        color: #6c757d;
        margin-bottom: 0.75rem;
    }

    .document-suggestion ul li {
        margin-bottom: 0.5rem;
        color: #6c757d;
    }

    .document-suggestion ul li i {
        color: #adb5bd;
    }

    .input-group-text {
        background-color: #e9ecef;
        color: #495057;
        font-weight: 500;
    }

    #tokenSymbol {
        font-weight: 500;
        color: #495057;
        background-color: #f8f9fa;
    }

    #imagePreview img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 0.5rem;
    }

    .upload-progress {
        display: none;
        margin-top: 1rem;
    }

    .upload-progress .progress {
        height: 0.5rem;
        border-radius: 1rem;
    }

    .draft-info {
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
    }

    .form-control:disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }

    .asset-type-field {
        transition: all 0.3s ease;
    }

    .asset-type-field.hidden {
        display: none;
    }

    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border-radius: 0.5rem;
    }

    .card-header {
        background-color: transparent;
        border-bottom: 1px solid #dee2e6;
        padding: 1.5rem;
    }

    .card-body {
        padding: 1.5rem;
    }

    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 0.375rem;
        padding: 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .btn-gradient-primary[data-page="create-asset"] {
        color: #fff;
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        border-color: #0d6efd;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        box-shadow: 0 0.125rem 0.25rem rgba(13, 110, 253, 0.4);
        transition: all 0.3s ease;
    }

    .btn-gradient-primary[data-page="create-asset"]:hover {
        background: linear-gradient(135deg, #0b5ed7 0%, #0a58ca 100%);
        border-color: #0a58ca;
        transform: translateY(-1px);
        box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.5);
        color: #fff;
    }

    .btn-gradient-primary[data-page="create-asset"]:active {
        transform: translateY(0);
        box-shadow: 0 0.125rem 0.25rem rgba(13, 110, 253, 0.4);
    }

    .alert-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .document-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .document-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
    }

    /* Token Symbol Validation Styles */
    #tokenSymbolSuccess {
        font-size: 0.875rem;
        padding: 0.25rem 0;
        color: #198754;  /* Bootstrap success color */
        font-weight: 500;
    }

    #tokenSymbolSuccess i {
        color: #198754;
    }

    .token-symbol-container {
        position: relative;
    }

    .token-symbol-container .form-control {
        background-color: #f8f9fa;
    }

    .token-symbol-container .form-control:disabled {
        cursor: not-allowed;
    }

    /* å¢å¼ºæ‹–æ‹½åŒºåŸŸçš„ç‚¹å‡»æç¤ºå’Œè§†è§‰æ•ˆæœ */
    .dropzone[data-page="create-asset"]::after {
        content: "ğŸ“¤ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ";
        position: absolute;
        bottom: 15px;
        right: 20px;
        font-size: 0.75rem;
        color: #6c757d;
        background: rgba(255,255,255,0.9);
        padding: 6px 12px;
        border-radius: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        backdrop-filter: blur(4px);
        transition: all 0.3s ease;
        font-weight: 500;
        border: 1px solid rgba(108, 117, 125, 0.2);
    }

    .dropzone[data-page="create-asset"]:hover::after {
        color: #0d6efd;
        background: rgba(13, 110, 253, 0.15);
        border-color: rgba(13, 110, 253, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
    }

    /* ç¡®ä¿å›¾ç‰‡ä¸Šä¼ åŒºåŸŸä¼˜å…ˆçº§æœ€é«˜ */
    #imageDropzone {
        border: 3px dashed #bbb !important;
        border-radius: 12px !important;
        padding: 3rem 2rem !important;
        text-align: center !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        background-color: #f8f9fa !important;
        min-height: 150px !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        position: relative !important;
    }

    #imageDropzone:hover {
        border-color: #0d6efd !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 20px rgba(13, 110, 253, 0.15) !important;
    }

    #imageDropzone i {
        font-size: 3.5rem !important;
        color: #6c757d !important;
        margin-bottom: 1.5rem !important;
        display: block !important;
        transition: all 0.3s ease !important;
    }

    #imageDropzone:hover i {
        color: #0d6efd !important;
        transform: scale(1.1) !important;
    }

    #imageDropzone h6 {
        color: #495057 !important;
        margin-bottom: 1rem !important;
        font-weight: 600 !important;
    }

    #imageDropzone p {
        color: #6c757d !important;
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
    }

    /* æ–‡æ¡£ä¸Šä¼ åŒºåŸŸä¿æŒè¾ƒå° */
    #documentDropzone {
        min-height: 100px;
        padding: 2rem;
    }

    #documentDropzone i {
        font-size: 2.5rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="mb-4">{{ _('Create Asset') }}</h2>
            
            <!-- è‰ç¨¿æç¤º -->
            <div id="draftInfo" class="draft-info" style="display: none;">
                <div class="d-flex justify-content-between align-items-center">
                    <span>{{ _('You have an unsaved draft from') }} <span id="draftTime"></span></span>
                    <div class="draft-actions">
                        <button type="button" class="btn btn-sm btn-primary" id="loadDraft">{{ _('Load Draft') }}</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="discardDraft">{{ _('Discard') }}</button>
                    </div>
                </div>
            </div>
            
            <!-- é’±åŒ…è¿æ¥æ£€æŸ¥ -->
            <div id="walletCheck" class="alert alert-warning" style="display: none;">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ _('Please connect your wallet first') }}
                <button class="btn btn-primary btn-sm ms-3" id="connectWalletBtn">
                    <i class="fas fa-wallet me-2"></i>{{ _('Connect Wallet') }}
                </button>
            </div>
            
            <!-- è¡¨å•å†…å®¹ -->
            <div id="formContent" style="display: none;">
                <form id="assetForm" class="needs-validation" novalidate>
                    <!-- èµ„äº§è¯¦æƒ… -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">{{ _('Asset Details') }}</h5>
                        </div>
                        <div class="card-body">
                            <!-- åˆ›å»ºè€…åœ°å€ -->
                            <input type="hidden" id="creator_address" name="creator_address" value="{{ creator_address }}">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="name" class="form-label">{{ _('Asset Name') }}</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                    <div class="invalid-feedback">{{ _('Please enter asset name') }}</div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="type" class="form-label">{{ _('Asset Type') }}</label>
                                    <select class="form-select" id="type" name="type" required>
                                        <option value="">{{ _('Please select asset type') }}</option>
                                        <option value="10">{{ _('Real Property') }}</option>
                                        <option value="20">{{ _('Securities') }}</option>
                                        <option value="30">{{ _('Quasi Property') }}</option>
                                    </select>
                                    <div class="invalid-feedback">{{ _('Please select asset type') }}</div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="location" class="form-label">{{ _('Asset Location') }}</label>
                                <input type="text" class="form-control" id="location" name="location" required>
                                <div class="invalid-feedback">{{ _('Please enter asset location') }}</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">{{ _('Asset Description') }}</label>
                                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                                <div class="invalid-feedback">{{ _('Please enter asset description') }}</div>
                            </div>
                            
                            <!-- ä»£å¸ä»£ç å’Œå‘è¡Œè´¹ç”¨ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="tokensymbol">{{ _('Token Symbol') }} <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="tokensymbol" name="tokensymbol" readonly>
                                        <small class="form-text text-muted">{{ _('Token symbol will be automatically generated and cannot be modified') }}</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>{{ _('Publishing Fee') }} <span class="text-danger">*</span></label>
                                        <div class="form-control bg-light" id="publishingFee">0.00 USDC</div>
                                        <small class="form-text text-muted">{{ _('0.01%% of total asset value, minimum 100 USDC') }}</small>
                                    </div>
                                </div>
                            </div>

                            <!-- ä¸åŠ¨äº§å­—æ®µ -->
                            <div class="asset-type-field real-estate">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="area" class="form-label">{{ _('Asset Area (ã¡)') }} <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="area" name="area" step="0.01" min="0.01" placeholder="0.00">
                                        <div class="invalid-feedback">{{ _('Please enter valid asset area (greater than 0)') }}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="total_value" class="form-label">{{ _('Total Value (USDC)') }} <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="total_value" name="total_value" step="0.01" min="0.01" placeholder="0.00">
                                        <div class="invalid-feedback">{{ _('Please enter valid total value (greater than 0)') }}</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">{{ _('Token Count') }}</label>
                                        <div class="form-control bg-light" id="token_count">0</div>
                                        <small class="form-text text-muted">{{ _('1 square meter = 10,000 tokens') }}</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">{{ _('Token Price (USDC)') }}</label>
                                        <div class="form-control bg-light" id="token_price">0.000000</div>
                                        <small class="form-text text-muted">{{ _('Total Value / Token Count') }}</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="annual_revenue" class="form-label">{{ _('Expected Annual Revenue*') }}</label>
                                        <input type="number" class="form-control" id="annual_revenue" name="annual_revenue" step="0.01" min="0" placeholder="0.00">
                                        <small class="form-text text-muted">{{ _('Expected annual revenue in USDC') }}</small>
                                    </div>
                                </div>
                            </div>

                            <!-- è¯åˆ¸å­—æ®µ (Securities) -->
                            <div class="asset-type-field securities hidden">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="token_supply" class="form-label">{{ _('Token Count') }} <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="token_supply" name="token_supply" step="1" min="1" placeholder="0">
                                        <div class="invalid-feedback">{{ _('Please enter valid token count (greater than 0)') }}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="token_price" class="form-label">{{ _('Token Price (USDC)') }} <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="token_price" name="token_price" step="0.000001" min="0.000001" placeholder="0.000000">
                                        <div class="invalid-feedback">{{ _('Please enter valid token price (greater than 0)') }}</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">{{ _('Total Value (USDC)') }}</label>
                                        <div class="form-control bg-light" id="calculatedTotalValue">0.00</div>
                                        <small class="form-text text-muted">{{ _('Token Count Ã— Token Price') }}</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="annual_revenue" class="form-label">{{ _('Expected Annual Revenue*') }}</label>
                                        <input type="number" class="form-control" id="annual_revenue" name="annual_revenue" step="0.01" min="0" placeholder="0.00">
                                        <small class="form-text text-muted">{{ _('Expected annual revenue in USDC') }}</small>
                                    </div>
                                </div>
                            </div>

                            <!-- å‡†ä¸åŠ¨äº§å­—æ®µ (Quasi Property) -->
                            <div class="asset-type-field quasi-property hidden">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="token_supply" class="form-label">{{ _('Token Count') }} <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="token_supply" name="token_supply" step="1" min="1" placeholder="0">
                                        <div class="invalid-feedback">{{ _('Please enter valid token count (greater than 0)') }}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="token_price" class="form-label">{{ _('Token Price (USDC)') }} <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="token_price" name="token_price" step="0.000001" min="0.000001" placeholder="0.000000">
                                        <div class="invalid-feedback">{{ _('Please enter valid token price (greater than 0)') }}</div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">{{ _('Total Value (USDC)') }}</label>
                                        <div class="form-control bg-light" id="calculatedTotalValue">0.00</div>
                                        <small class="form-text text-muted">{{ _('Token Count Ã— Token Price') }}</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="annual_revenue" class="form-label">{{ _('Expected Annual Revenue*') }}</label>
                                        <input type="number" class="form-control" id="annual_revenue" name="annual_revenue" step="0.01" min="0" placeholder="0.00">
                                        <small class="form-text text-muted">{{ _('Expected annual revenue in USDC') }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å›¾ç‰‡ä¸Šä¼  -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">{{ _('Asset Images') }} <span class="text-danger">*</span></h5>
                        </div>
                        <div class="card-body">
                            <div class="dropzone" data-page="create-asset" id="imageDropzone">
                                <i class="fas fa-images"></i>
                                <h6 class="mb-2 fw-bold">{{ _('Upload Asset Images') }}</h6>
                                <p class="mb-2 text-muted fs-6">{{ _('Drag and drop images here or click to select files') }}</p>
                                <small class="text-muted d-block">{{ _('Required: 1-5 images, max 5MB each. Supported: JPG, PNG, WEBP') }}</small>
                                <input type="file" id="imageInput" multiple accept="image/*" class="d-none">
                            </div>
                            <div id="imageUploadProgress" class="upload-progress">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted" id="imageUploadStatus">{{ _('Uploading...') }}</small>
                                    <small class="text-muted"><span id="imageUploadPercent">0</span>%</small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="imagePreview" class="row mt-3 g-3"></div>
                        </div>
                    </div>
                    
                    <!-- æ–‡æ¡£ä¸Šä¼  -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">{{ _('Asset Documents') }} <small class="text-muted">{{ _('(Optional)') }}</small></h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="real-estate-docs">
                                        <h6 class="text-muted">{{ _('Suggested Documents for Real Estate') }}:</h6>
                                        <ul class="list-unstyled text-muted">
                                            <li><i class="far fa-circle me-2"></i>{{ _('Property Certificate') }}</li>
                                            <li><i class="far fa-circle me-2"></i>{{ _('Land Certificate') }}</li>
                                            <li><i class="far fa-circle me-2"></i>{{ _('Assessment Report') }}</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="securities-docs">
                                        <h6 class="text-muted">{{ _('Suggested Documents for Securities') }}:</h6>
                                        <ul class="list-unstyled text-muted">
                                            <li><i class="far fa-circle me-2"></i>{{ _('Securities Certificate') }}</li>
                                            <li><i class="far fa-circle me-2"></i>{{ _('Valuation Report') }}</li>
                                            <li><i class="far fa-circle me-2"></i>{{ _('Legal Documentation') }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="dropzone" data-page="create-asset" id="documentDropzone">
                                <i class="fas fa-file-upload text-muted"></i>
                                <p class="mb-0 text-muted">{{ _('Drag and drop documents here or click to select') }}</p>
                                <small class="text-muted d-block mt-2">{{ _('Maximum 10 files, 10MB each. Supported formats: PDF, DOC, DOCX') }}</small>
                                <input type="file" id="documentInput" multiple accept=".pdf,.doc,.docx" class="d-none">
                            </div>
                            <div id="documentUploadProgress" class="upload-progress">
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted" id="documentUploadStatus">{{ _('Uploading...') }}</small>
                                    <small class="text-muted"><span id="documentUploadPercent">0</span>%</small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="documentPreview" class="document-list mt-3"></div>
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰é’® -->
                    <div class="col-12 text-center mt-4">
                        <button type="button" class="btn btn-outline-primary me-2" id="previewForm">
                            <i class="fas fa-eye me-2"></i>{{ _('Preview') }}
                        </button>
                        <button type="button" class="btn btn-gradient-primary" data-page="create-asset" id="payAndPublish">
                            <i class="fas fa-credit-card me-2"></i>{{ _('Pay and Publish') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æˆåŠŸæ¨¡æ€æ¡† -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">å‘å¸ƒæˆåŠŸ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="successMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<!-- é”™è¯¯æ¨¡æ€æ¡† -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">é”™è¯¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<!-- é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade preview-modal" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye me-2"></i>{{ _('Asset Preview') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Preview content will be dynamically populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
                <button type="button" class="btn btn-gradient-primary" data-page="create-asset" id="previewPublishBtn">
                    <i class="fas fa-credit-card me-2"></i>{{ _('Pay and Publish') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤æ”¯ä»˜æ¨¡æ€æ¡† -->
<div class="modal fade" id="paymentConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Payment Confirmation') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-credit-card text-primary mb-3" style="font-size: 3rem;"></i>
                    <h4 class="mb-3">{{ _('Ready to Publish') }}</h4>
                    <p class="mb-2">{{ _('Asset Name') }}: <strong id="confirmAssetName"></strong></p>
                    <p class="mb-2">{{ _('Token Symbol') }}: <strong id="confirmTokenSymbol"></strong></p>
                    <p class="mb-4">{{ _('Publishing Fee') }}: <strong id="confirmFeeAmount"></strong></p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ _('After confirming, the system will connect to your wallet and request payment.') }}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-gradient-primary" data-page="create-asset" id="confirmPaymentBtn">
                    <i class="fas fa-credit-card me-2"></i>{{ _('Pay and Publish') }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½è¦†ç›–å±‚ -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="bg-white p-4 rounded shadow">
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">{{ _('Loading...') }}</span>
                </div>
                <span class="loading-text">{{ _('Processing...') }}</span>
            </div>
        </div>
    </div>
</div>

<!-- è¿›åº¦æ˜¾ç¤º -->
<div id="progressContainer" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="bg-white p-4 rounded shadow" style="width: 300px;">
            <h5 class="text-center mb-3" id="progressTitle">{{ _('Processing') }}</h5>
            <div class="progress mb-3" style="height: 10px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <p id="progressStatus" class="text-center text-muted small mb-0">{{ _('Please wait...') }}</p>
        </div>
    </div>
</div>

<!-- æˆåŠŸæç¤º -->
<div id="successMessage" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">æˆåŠŸ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-check-circle text-success" style="font-size: 48px;"></i>
                </div>
                <div id="successTitle" class="text-center fs-5 mb-2">æ“ä½œæˆåŠŸ</div>
                <div id="successContent" class="text-center">æ‚¨çš„æ“ä½œå·²æˆåŠŸå®Œæˆã€‚</div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<!-- åº•éƒ¨æŒ‰é’® -->
<div class="fixed-bottom bg-white py-3 border-top" style="display: none;" id="previewFooter">
    <div class="container">
        <div class="row justify-content-end">
            <div class="col-auto">
                <button type="button" class="btn btn-outline-secondary me-2" id="closePreviewBtn">
                    {{ _('Close') }}
                </button>
                <button type="button" class="btn btn-gradient-primary" data-page="create-asset" id="publishFromPreviewBtn">
                    <i class="fas fa-credit-card me-2"></i>{{ _('Pay and Publish') }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- å…ˆå¼•å…¥ä¾èµ–åº“ -->
<script src="{{ url_for('static', filename='js/contracts/solana-web3.iife.min.js') }}" onerror="this.onerror=null;this.src='https://unpkg.com/@solana/web3.js@1.78.0/lib/index.iife.min.js';"></script>
<!-- æ·»åŠ SPL Tokenåº“æ”¯æŒ -->
<script src="{{ url_for('static', filename='js/contracts/spl-token.iife.min.js') }}" onerror="this.onerror=null;this.src='https://unpkg.com/@solana/spl-token@0.3.8/lib/index.iife.min.js';"></script>
<script>
    // ç«‹å³åˆå§‹åŒ–SPL Tokenåº“
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // ç¡®ä¿Solana Web3.jsåº“å…¨å±€å¯ç”¨
            if (window.solanaWeb3js) {
                window.solanaWeb3 = window.solanaWeb3js;
                console.log('Solana Web3.jsåº“å·²åˆå§‹åŒ–ä¸ºå…¨å±€å˜é‡', window.solanaWeb3);
            } else if (window.solana && window.solana.web3) {
                window.solanaWeb3 = window.solana.web3;
                console.log('Solana Web3.jsåº“å·²ä»window.solana.web3åˆå§‹åŒ–', window.solanaWeb3);
            }
            
            // æ£€æŸ¥SPL Tokenåº“æ˜¯å¦å·²åŠ è½½
            if (window.spl && window.spl.token) {
                window.splToken = window.spl.token;
                console.log('SPL Tokenåº“å·²åˆå§‹åŒ–æˆåŠŸ', window.splToken);
                
                // æ£€æŸ¥å…³é”®æ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (window.splToken.getAssociatedTokenAddress) {
                    console.log('SPL Tokenåº“çš„å…³é”®æ–¹æ³•å·²ç¡®è®¤å¯ç”¨');
                } else {
                    console.warn('è­¦å‘Šï¼šSPL Tokenåº“ç¼ºå°‘getAssociatedTokenAddressæ–¹æ³•');
                }
            } else {
                console.warn('è­¦å‘Šï¼šSPL Tokenåº“æœªæ­£ç¡®åŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½');
                
                // åŠ¨æ€åŠ è½½SPL Tokenåº“
                var script = document.createElement('script');
                script.src = "{{ url_for('static', filename='js/contracts/spl-token.iife.min.js') }}";
                
                script.onload = function() {
                    if (window.spl && window.spl.token) {
                        window.splToken = window.spl.token;
                        console.log('SPL Tokenåº“å·²æˆåŠŸé‡æ–°åŠ è½½', window.splToken);
                    } else {
                        console.error('åŠ¨æ€åŠ è½½SPL Tokenåº“åä»æ— æ³•è·å–window.spl.token');
                    }
                };
                
                script.onerror = function() {
                    console.log('æœ¬åœ°SPL Tokenåº“åŠ è½½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨CDN');
                    this.onerror = null;
                    this.src = "https://unpkg.com/@solana/spl-token@0.3.8/lib/index.iife.min.js";
                };
                
                document.head.appendChild(script);
            }
            
            // é¢„å…ˆæ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
            setTimeout(function() {
                if (window.wallet && window.wallet.connected) {
                    console.log('é’±åŒ…å·²è¿æ¥ï¼Œå‡†å¤‡æ”¯ä»˜åŠŸèƒ½');
                } else {
                    console.log('é’±åŒ…æœªè¿æ¥ï¼Œæ”¯ä»˜æ—¶å°†æç¤ºè¿æ¥é’±åŒ…');
                }
            }, 1000);
        } catch (e) {
            console.error('åˆå§‹åŒ–Solanaåº“å‡ºé”™:', e);
        }
    });
</script>

<!-- å¼•å…¥èµ„äº§åˆ›å»ºè„šæœ¬ -->
    <script src="{{ url_for('static', filename='js/assets/create.js') }}?v=20241231-ux-opt&t=1735662000"></script>
{% endblock %}

{% block styles %}
<link href="{{ url_for('static', filename='css/create.css') }}" rel="stylesheet">
{% endblock %}

