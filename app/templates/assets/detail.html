{% extends "base.html" %}

{% block title %}资产详情 - 58HUB{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="/static/js/AssetTokenABI.js"></script>
<script src="/static/js/USDTABI.js"></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- 资产基本信息 -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 id="assetName" class="text-2xl font-bold text-gray-900"></h1>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 基本信息 -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">基本信息</h3>
                    <dl class="grid grid-cols-1 gap-x-4 gap-y-4">
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">资产类型</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="assetType"></dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">位置</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="location"></dd>
                        </div>
                        <div class="sm:col-span-1" id="areaContainer">
                            <dt class="text-sm font-medium text-gray-500">面积</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="area"></dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">资产总价值</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="totalValue"></dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">所有者地址</dt>
                            <dd class="mt-1 text-sm text-gray-900 break-all" id="ownerAddress"></dd>
                        </div>
                    </dl>
                </div>

                <!-- 代币信息 -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-4">代币信息</h3>
                    <dl class="grid grid-cols-1 gap-x-4 gap-y-4">
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">代币代码</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="tokenSymbol"></dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">代币价格</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="tokenPrice"></dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">剩余可售数量</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="availableSupply"></dd>
                        </div>
                        <div class="sm:col-span-1">
                            <dt class="text-sm font-medium text-gray-500">预期年收益</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="annualRevenue"></dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片展示 -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="relative" style="padding-bottom: 56.25%">
            <div id="imageCarousel" class="absolute inset-0">
                <!-- 图片将通过JavaScript动态加载 -->
            </div>
            <button id="prevButton" onclick="showPreviousImage()" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-r hidden hover:bg-opacity-75 transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <button id="nextButton" onclick="showNextImage()" class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-l hidden hover:bg-opacity-75 transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
        <!-- 缩略图导航 -->
        <div id="thumbnailNav" class="flex justify-center gap-2 p-4 overflow-x-auto">
            <!-- 缩略图将通过JavaScript动态加载 -->
        </div>
    </div>

    <!-- 交易/分红操作区域（二选一显示） -->
    <div class="operation-container">
        <!-- 交易模块（默认显示） -->
        <div id="tradeModule" class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-center space-x-4">
                    <div class="w-1/3">
                        <label for="tradeAmount" class="block text-sm font-medium text-gray-700 mb-1">交易数量</label>
                        <input type="number" id="tradeAmount" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md" placeholder="输入数量">
                    </div>
                    <div class="w-1/3">
                        <label for="totalPrice" class="block text-sm font-medium text-gray-700 mb-1">总价 (USDC)</label>
                        <input type="text" id="totalPrice" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md bg-gray-50" readonly>
                    </div>
                    <div class="w-1/3 flex items-end">
                        <!-- 购买按钮和连接提示共用同一个位置 -->
                        <button id="buyBtn" class="hidden flex-1 inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            购买
                        </button>
                        <div id="walletAlert" class="flex-1 text-center text-sm text-yellow-700">
                            请先连接钱包以进行交易
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分红发起模块（默认隐藏） -->
        <div id="dividendModule" class="hidden bg-white rounded-lg shadow overflow-hidden">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium leading-6 text-gray-900">发起分红</h3>
                <div class="mt-4">
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">当前持有人数量</label>
                            <p id="holdersCount" class="mt-1 text-sm text-gray-900">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">预估Gas费用</label>
                            <p id="estimatedGas" class="mt-1 text-sm text-gray-900">-</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">平台手续费</label>
                            <p class="mt-1 text-sm text-gray-900">1.5%</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">建议分红金额范围</label>
                            <p id="suggestedAmount" class="mt-1 text-sm text-gray-900">-</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="dividendAmount" class="block text-sm font-medium text-gray-700">分红金额 (USDC)</label>
                        <div class="mt-1">
                            <input type="number" name="dividendAmount" id="dividendAmount" min="10000" step="0.000001"
                                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="最小分红金额为10000 USDC">
                        </div>
                        <p id="perTokenDividend" class="mt-1 text-sm text-gray-500">每代币分红金额：- USDC</p>
                    </div>
                    
                    <div class="mt-4">
                        <button type="button" id="distributeDividendBtn"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            发起分红
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分红历史模块（始终显示） -->
    <div id="dividendHistoryModule" class="mt-8 bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-medium leading-6 text-gray-900">分红历史</h3>
            <div class="mt-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分红日期</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分红金额</th>
                            </tr>
                        </thead>
                        <tbody id="dividendHistoryBody" class="bg-white divide-y divide-gray-200">
                            <!-- 分红历史记录将通过JavaScript动态添加 -->
                        </tbody>
                    </table>
                </div>
                <div id="noDividendHistory" class="text-center py-4 text-gray-500" style="display: none;">
                    暂无分红记录
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentAsset = null;
let currentImageIndex = 0;
let tokenContract = null;
let usdtContract = null;
const USDT_ADDRESS = '0xdAC17F958D2ee523a2206206994597C13D831ec7'; // USDT合约地址

function formatNumber(value) {
    if (value == null || isNaN(value)) return '暂无数据';
    // 根据不同类型的数据使用不同的格式化方式
    if (typeof value === 'number' && Number.isInteger(value)) {
        // 整数类型（如代币数量）
        return new Intl.NumberFormat('zh-CN', {
            maximumFractionDigits: 0
        }).format(value);
    } else {
        // 其他数值类型（如价格、面积等）
        return new Intl.NumberFormat('zh-CN', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    }
}

// 更新交易按钮显示状态
function updateTradeButtons() {
    const tradeModule = document.getElementById('tradeModule');
    const buyBtn = document.getElementById('buyBtn');
    const walletAlert = document.getElementById('walletAlert');

    try {
        // 检查钱包连接状态
        if (!window.ethereum || !window.currentAccount) {
            // 未连接钱包时，显示交易模块但隐藏购买按钮
            tradeModule.classList.remove('hidden');
            buyBtn.classList.add('hidden');
            walletAlert.classList.remove('hidden');
            return;
        }

        // 检查是否是资产所有者
        const isOwner = window.currentAccount && currentAsset && 
                       window.currentAccount.toLowerCase() === currentAsset.owner_address.toLowerCase();
        
        // 更新显示状态
        if (isOwner) {
            tradeModule.classList.add('hidden');
            walletAlert.classList.add('hidden');
        } else {
            tradeModule.classList.remove('hidden');
            buyBtn.classList.remove('hidden');
            walletAlert.classList.add('hidden');
        }
    } catch (error) {
        console.error('更新交易按钮状态失败:', error);
    }
}

// 监听钱包状态变化
if (window.ethereum) {
    window.ethereum.on('accountsChanged', function (accounts) {
        if (accounts.length > 0) {
            window.currentAccount = accounts[0];
            // 更新钱包状态显示
            updateWalletStatus();
            updateTradeButtons();
            checkDividendModuleVisibility();
        } else {
            window.currentAccount = null;
            // 更新钱包状态显示
            updateWalletStatus();
            updateTradeButtons();
            hideDividendModule();
        }
    });
}

// 检查是否显示分红模块
async function checkDividendModuleVisibility() {
    const dividendModule = document.getElementById('dividendModule');
    
    try {
        // 检查当前用户是否是资产所有者
        const isOwner = window.currentAccount && currentAsset && 
                       window.currentAccount.toLowerCase() === currentAsset.owner_address.toLowerCase();
        
        // 只有连接钱包且是资产所有者时才显示分红模块
        dividendModule.style.display = isOwner ? 'block' : 'none';
        
        if (isOwner) {
            await updateDividendModuleInfo();
        }
    } catch (error) {
        console.error('检查分红模块显示状态失败:', error);
        dividendModule.style.display = 'none';
    }
}

// 显示分红模块
function showDividendModule() {
    const dividendModule = document.getElementById('dividendModule');
    if (dividendModule) {
        dividendModule.style.display = 'block';
    }
}

// 隐藏分红模块
function hideDividendModule() {
    const dividendModule = document.getElementById('dividendModule');
    if (dividendModule) {
        dividendModule.style.display = 'none';
    }
}

// 更新分红模块信息
async function updateDividendModuleInfo() {
    try {
        // 获取持有人数量
        const response = await fetch(`/api/assets/${currentAsset.id}/holders-count`);
        console.log('持有人数量API响应:', response);
        const data = await response.json();
        console.log('持有人数量数据:', data);
        const holdersCount = data.count;
        
        // 更新持有人数量显示
        document.getElementById('holdersCount').textContent = `${holdersCount}人`;
        console.log('当前持有人数量:', holdersCount);
        
        // 更新建议分红金额
        let suggestedAmount = '≥10000 USDC';
        if (holdersCount > 500) {
            suggestedAmount = '≥100000 USDC';
        } else if (holdersCount > 100) {
            suggestedAmount = '≥50000 USDC';
        } else if (holdersCount > 50) {
            suggestedAmount = '≥20000 USDC';
        } else if (holdersCount > 10) {
            suggestedAmount = '≥15000 USDC';
        }
        document.getElementById('suggestedAmount').textContent = suggestedAmount;
        console.log('建议分红金额:', suggestedAmount);
        
        // 更新Gas预估（显示为百分比）
        let gasFeePercentage;
        if (holdersCount <= 10) gasFeePercentage = 0.3;
        else if (holdersCount <= 50) gasFeePercentage = 0.5;
        else if (holdersCount <= 100) gasFeePercentage = 1.0;
        else if (holdersCount <= 500) gasFeePercentage = 1.5;
        else gasFeePercentage = 2.0;
        
        console.log('Gas费用计算:', {
            持有人数量: holdersCount,
            费用百分比: gasFeePercentage
        });

        document.getElementById('estimatedGas').textContent = `约 ${gasFeePercentage}%`;
            
        // 设置分红金额输入监听
        const dividendAmountInput = document.getElementById('dividendAmount');
        
        // 移除旧的事件监听器
        const oldListener = dividendAmountInput.onInput;
        if (oldListener) {
            dividendAmountInput.removeEventListener('input', oldListener);
        }
        
        // 创建新的事件监听器
        dividendAmountInput.onInput = function() {
            const amount = parseFloat(this.value) || 0;
            console.log('输入的分红金额:', amount);
            
            // 获取代币总供应量（不需要除以1e18）
            const totalSupply = Number(currentAsset.token_supply);
            
            console.log('分红计算详情:', {
                输入金额: amount,
                代币总供应量: totalSupply,
                计算公式: '(分红金额 / 代币总量) * 100'
            });
            
            if (totalSupply > 0) {
                // 计算每100代币的分红金额
                const per100Tokens = (amount / totalSupply) * 100;
                console.log('计算过程:', `(${amount} / ${totalSupply}) * 100 = ${per100Tokens}`);
                
                // 根据数值大小动态调整小数位数
                let decimals = 6;
                if (per100Tokens >= 0.01) decimals = 4;
                if (per100Tokens >= 1) decimals = 2;
                
                document.getElementById('perTokenDividend').textContent = 
                    `每100代币分红金额：${per100Tokens.toFixed(decimals)} USDC`;
            } else {
                document.getElementById('perTokenDividend').textContent = 
                    `每100代币分红金额：0 USDC`;
            }
        };
        
        // 添加新的事件监听器
        dividendAmountInput.addEventListener('input', dividendAmountInput.onInput);
        
        // 如果输入框已有值，立即计算一次
        if (dividendAmountInput.value) {
            dividendAmountInput.onInput.call(dividendAmountInput);
        }
        
    } catch (error) {
        console.error('更新分红模块信息失败:', error);
        // 设置默认值
        document.getElementById('holdersCount').textContent = '获取失败';
        document.getElementById('estimatedGas').textContent = '计算失败';
    }
}

// 加载分红历史
async function loadDividendHistory() {
    if (!tokenContract || !currentAsset) return;

    try {
        const history = await tokenContract.methods.getDividendHistory().call();
        const tbody = document.getElementById('dividendHistoryBody');
        const noHistoryDiv = document.getElementById('noDividendHistory');

        tbody.innerHTML = '';

        if (history && history.length > 0) {
            history.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(record.timestamp * 1000).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formatNumber(web3.utils.fromWei(record.totalAmount, 'ether'))} USDC
                    </td>
                `;
                tbody.appendChild(row);
            });
            noHistoryDiv.style.display = 'none';
        } else {
            noHistoryDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('加载分红历史失败:', error);
    }
}

// 更新图片轮播
function updateImageCarousel() {
    if (!currentAsset || !currentAsset.images || currentAsset.images.length === 0) {
        // 显示默认图片
        const carousel = document.getElementById('imageCarousel');
        carousel.innerHTML = `
            <img src="/static/images/placeholder.jpg" 
                 alt="暂无图片" 
                 class="absolute inset-0 w-full h-full object-contain">
        `;
        // 隐藏导航按钮
        document.getElementById('prevButton').classList.add('hidden');
        document.getElementById('nextButton').classList.add('hidden');
        // 清空缩略图
        document.getElementById('thumbnailNav').innerHTML = '';
        return;
    }

    const carousel = document.getElementById('imageCarousel');
    const currentImage = currentAsset.images[currentImageIndex];
    
    // 更新主图片
    carousel.innerHTML = `
        <img src="${currentImage}" 
             alt="${currentAsset.name || '资产图片'} - 图片 ${currentImageIndex + 1}/${currentAsset.images.length}" 
             class="absolute inset-0 w-full h-full object-contain transition-opacity duration-300"
             loading="lazy"
             onerror="this.onerror=null; this.src='/static/images/placeholder.jpg'; this.alt='图片加载失败';">
    `;
    
    // 更新导航按钮显示状态
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    if (currentAsset.images.length > 1) {
        prevButton.classList.remove('hidden');
        nextButton.classList.remove('hidden');
    } else {
        prevButton.classList.add('hidden');
        nextButton.classList.add('hidden');
    }
    
    // 更新缩略图
    const thumbnailNav = document.getElementById('thumbnailNav');
    thumbnailNav.innerHTML = currentAsset.images.map((image, index) => `
        <button onclick="showImage(${index})" 
                class="thumbnail w-20 h-20 flex-shrink-0 focus:outline-none ${index === currentImageIndex ? 'ring-2 ring-blue-500' : ''}"
                title="查看第 ${index + 1} 张图片">
            <img src="${image}" 
                 alt="缩略图 ${index + 1}" 
                 class="w-full h-full object-cover rounded"
                 loading="lazy"
                 onerror="this.onerror=null; this.src='/static/images/placeholder.jpg';">
        </button>
    `).join('');
}

// 添加图片切换函数
window.showImage = function(index) {
    if (!currentAsset || !currentAsset.images || index < 0 || index >= currentAsset.images.length) return;
    currentImageIndex = index;
    updateImageCarousel();
}

// 切换到上一张图片
window.showPreviousImage = function() {
    if (!currentAsset || !currentAsset.images || currentAsset.images.length <= 1) return;
    currentImageIndex = (currentImageIndex - 1 + currentAsset.images.length) % currentAsset.images.length;
    updateImageCarousel();
}

// 切换到下一张图片
window.showNextImage = function() {
    if (!currentAsset || !currentAsset.images || currentAsset.images.length <= 1) return;
    currentImageIndex = (currentImageIndex + 1) % currentAsset.images.length;
    updateImageCarousel();
}

// 添加键盘导航支持
document.addEventListener('keydown', function(event) {
    if (event.key === 'ArrowLeft') {
        showPreviousImage();
    } else if (event.key === 'ArrowRight') {
        showNextImage();
    }
});

// 更新资产详情显示函数
async function loadAssetDetails() {
    const assetId = window.location.pathname.split('/').pop();
    try {
        // 准备请求头
        const headers = {};
        
        // 优先从URL参数获取钱包地址
        const ethAddress = new URLSearchParams(window.location.search).get('eth_address') || 
                          localStorage.getItem('eth_address') ||
                          sessionStorage.getItem('eth_address') ||
                          (window.ethereum && window.ethereum.selectedAddress);
                          
        if (ethAddress) {
            headers['X-Eth-Address'] = ethAddress;
            window.currentAccount = ethAddress;
            // 更新钱包状态显示
            updateWalletStatus();
        }
        
        // 添加时间戳防止缓存
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/assets/${assetId}?t=${timestamp}`, {
            headers: headers
        });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || '加载资产详情失败');
        }
        
        const data = await response.json();
        console.log('Asset data:', data);
        
        // 确保数据不为空
        if (!data || Object.keys(data).length === 0) {
            throw new Error('获取到的资产数据为空');
        }
        
        currentAsset = data;
        
        // 更新资产基本信息
        document.getElementById('assetName').textContent = data.name || '未命名资产';
        document.getElementById('assetType').textContent = data.asset_type === 'REAL_ESTATE' ? '不动产' : '类不动产';
        document.getElementById('location').textContent = data.location || '暂无数据';
        
        // 根据资产类型显示或隐藏面积信息
        const areaContainer = document.getElementById('areaContainer');
        if (data.asset_type === 'REAL_ESTATE') {
            areaContainer.classList.remove('hidden');
            document.getElementById('area').textContent = data.area ? `${formatNumber(data.area)} m²` : '暂无数据';
        } else {
            areaContainer.classList.add('hidden');
        }
        
        // 更新其他资产信息
        document.getElementById('totalValue').textContent = data.total_value ? `${formatNumber(data.total_value)} USDT` : '暂无数据';
        document.getElementById('ownerAddress').textContent = data.owner_address || '暂无数据';
        document.getElementById('tokenSymbol').textContent = data.token_symbol || '暂无数据';
        document.getElementById('tokenPrice').textContent = data.token_price ? `${formatNumber(data.token_price)} USDC` : '暂无数据';
        
        // 正确设置和显示代币总量（添加详细日志）
        console.log('API返回的原始数据:', data);
        console.log('代币总量原始值:', data.token_supply);

        // 确保token_supply是字符串类型并转换为数字
        currentAsset.token_supply = data.token_supply ? data.token_supply.toString() : '0';
        const tokenSupply = Number(currentAsset.token_supply);

        console.log('代币总量处理过程:', {
            原始值: data.token_supply,
            转换后数值: tokenSupply
        });

        // 显示代币总量（不需要除以1e18）
        document.getElementById('availableSupply').textContent = 
            tokenSupply > 0 ? formatNumber(tokenSupply) : '暂无数据';
            
        document.getElementById('annualRevenue').textContent = data.annual_revenue ? `${formatNumber(data.annual_revenue)} USDT` : '暂无数据';
        
        // 处理图片数据
        try {
            if (typeof data.images === 'string') {
                currentAsset.images = JSON.parse(data.images);
            } else if (Array.isArray(data.images)) {
                currentAsset.images = data.images;
            } else {
                currentAsset.images = [];
            }
            
            // 确保所有图片路径都是正确的
            currentAsset.images = currentAsset.images.map(img => {
                if (img.startsWith('http') || img.startsWith('/')) {
                    return img;
                }
                return `/${img}`;
            });
            
            console.log('处理后的图片数据:', currentAsset.images);
        } catch (error) {
            console.error('处理图片数据失败:', error);
            currentAsset.images = [];
        }
        
        // 更新图片轮播
        currentImageIndex = 0;
        updateImageCarousel();
        
        // 只有在资产未审核通过且当前用户是所有者或管理员时，才显示钱包连接提示
        const walletAlert = document.getElementById('walletAlert');
        if (data.status !== 'APPROVED' && ethAddress && (!window.ethereum || !window.ethereum.selectedAddress)) {
            walletAlert.classList.remove('hidden');
        } else {
            walletAlert.classList.add('hidden');
        }
        
        // 初始化合约（如果钱包已连接）
        if (window.ethereum && window.currentAccount) {
            try {
                await initContracts();
                updateTradeButtons(); // 添加这行，确保按钮状态被更新
            } catch (error) {
                console.error('初始化合约失败:', error);
            }
        }
        
        // 检查是否显示分红模块（当前用户是否是资产所有者）
        const isOwner = window.currentAccount && 
                       window.currentAccount.toLowerCase() === data.owner_address.toLowerCase();
        const dividendModule = document.getElementById('dividendModule');
        if (isOwner) {
            dividendModule.style.display = 'block';
            // 初始化分红模块信息
            await updateDividendModuleInfo();
        } else {
            dividendModule.style.display = 'none';
        }

        // 加载分红历史
        await loadDividendHistory();
        
    } catch (error) {
        console.error('加载资产详情失败:', error);
        alert(error.message || '加载资产详情失败');
    }
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // 检查MetaMask是否安装
        if (typeof window.ethereum !== 'undefined') {
            // 获取当前账户
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
                window.currentAccount = accounts[0];
                // 保存地址到storage
                localStorage.setItem('eth_address', window.currentAccount);
                sessionStorage.setItem('eth_address', window.currentAccount);
                // 更新钱包状态显示
                updateWalletStatus();
            }
        }
        
        // 初始化页面显示
        await loadAssetDetails();
        updateTradeButtons();
        await updateDividendModule();
        await loadHoldersCount();
        await loadDividendHistory();
    } catch (error) {
        console.error('初始化页面失败:', error);
    }
});

// 添加交易金额输入监听
document.getElementById('tradeAmount').addEventListener('input', function(e) {
    const amount = parseFloat(e.target.value);
    const totalPriceInput = document.getElementById('totalPrice');
    if (currentAsset && !isNaN(amount)) {
        const total = amount * currentAsset.token_price;
        totalPriceInput.value = formatNumber(total);
    } else {
        totalPriceInput.value = '';
    }
});

// 初始化Web3和合约
async function initContracts() {
    if (typeof window.ethereum === 'undefined') {
        throw new Error('请安装MetaMask钱包');
    }

    const web3 = new Web3(window.ethereum);
    
    // 初始化USDT合约
    usdtContract = new web3.eth.Contract(USDT_ABI, USDT_ADDRESS);
    
    // 初始化资产代币合约
    if (currentAsset && currentAsset.token_address) {
        tokenContract = new web3.eth.Contract(AssetTokenABI, currentAsset.token_address);
    }
}

// 检查USDT余额
async function checkUSDTBalance(address) {
    if (!usdtContract) {
        throw new Error('USDT合约未初始化');
    }
    const balance = await usdtContract.methods.balanceOf(address).call();
    return web3.utils.fromWei(balance, 'mwei'); // USDT使用6位小数
}

// 检查USDT授权
async function checkUSDTAllowance(owner, spender) {
    if (!usdtContract) {
        throw new Error('USDT合约未初始化');
    }
    const allowance = await usdtContract.methods.allowance(owner, spender).call();
    return web3.utils.fromWei(allowance, 'mwei');
}

// 授权USDT
async function approveUSDT(spender, amount) {
    if (!usdtContract) {
        throw new Error('USDT合约未初始化');
    }
    const amountInWei = web3.utils.toWei(amount.toString(), 'mwei');
    return await usdtContract.methods.approve(spender, amountInWei)
        .send({ from: window.currentAccount });
}

// 转移USDT
async function transferUSDT(to, amount) {
    if (!usdtContract) {
        throw new Error('USDT合约未初始化');
    }
    const amountInWei = web3.utils.toWei(amount.toString(), 'mwei');
    return await usdtContract.methods.transfer(to, amountInWei)
        .send({ from: window.currentAccount });
}

// 更新购买按钮点击事件
document.getElementById('buyBtn').addEventListener('click', async function() {
    if (!window.ethereum || !window.currentAccount) {
        alert('请先连接钱包');
        return;
    }

    const amount = parseInt(document.getElementById('tradeAmount').value);
    if (isNaN(amount) || amount <= 0) {
        alert('请输入有效的交易数量');
        return;
    }

    try {
        // 初始化合约
        await initContracts();

        // 计算总价
        const totalPrice = amount * currentAsset.token_price;

        // 检查是否是自己的资产
        const isSelfTrade = window.currentAccount.toLowerCase() === currentAsset.owner_address.toLowerCase();

        if (!isSelfTrade) {
            // 如果不是自己的资产，需要进行USDT转账
            // 检查USDT余额
            const balance = await checkUSDTBalance(window.currentAccount);
            if (parseFloat(balance) < totalPrice) {
                alert('USDT余额不足');
                return;
            }

            // 检查USDT授权
            const allowance = await checkUSDTAllowance(window.currentAccount, currentAsset.owner_address);
            if (parseFloat(allowance) < totalPrice) {
                // 请求授权
                try {
                    await approveUSDT(currentAsset.owner_address, totalPrice);
                } catch (error) {
                    alert('USDT授权失败');
                    return;
                }
            }

            // 转移USDT
            try {
                await transferUSDT(currentAsset.owner_address, totalPrice);
            } catch (error) {
                alert('USDT转账失败');
                return;
            }
        }

        // 创建交易记录
        const response = await fetch('/api/trades/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Eth-Address': window.currentAccount
            },
            body: JSON.stringify({
                asset_id: currentAsset.id,
                amount: amount,
                trade_type: 'buy',
                is_self_trade: isSelfTrade
            })
        });

        if (!response.ok) {
            throw new Error('创建交易失败');
        }

        // 转移资产代币
        if (tokenContract && !isSelfTrade) {
            try {
                await tokenContract.methods.transfer(window.currentAccount, amount)
                    .send({ from: currentAsset.owner_address });
            } catch (error) {
                alert('资产代币转移失败');
                return;
            }
        }

        alert(isSelfTrade ? '内部转移成功！' : '交易成功！');
        // 刷新页面显示最新状态
        window.location.reload();
    } catch (error) {
        console.error('交易失败:', error);
        alert('交易失败: ' + error.message);
    }
});

// 添加管理员检查函数
async function checkIsAdmin() {
    if (!window.ethereum || !window.currentAccount) {
        return false;
    }
    
    const adminAddresses = [
        '0x6394993426DBA3b654eF0052698Fe9E0B6A98870',
        '0x124e5B8A4E6c68eC66e181E0B54817b12D879c57'
    ];
    
    return adminAddresses.map(addr => addr.toLowerCase())
        .includes(window.currentAccount.toLowerCase());
}

// 检查是否是资产发起人
async function checkIsAssetOwner() {
    const assetId = window.location.pathname.split('/').pop();
    const eth_address = window.currentAccount || 
                       localStorage.getItem('eth_address') || 
                       sessionStorage.getItem('eth_address');
    if (!eth_address) return false;
    
    try {
        const response = await fetch(`/api/assets/${assetId}/owner`);
        const data = await response.json();
        return data.owner_address.toLowerCase() === eth_address.toLowerCase();
    } catch (error) {
        console.error('检查资产所有者失败:', error);
        return false;
    }
}

// 更新分红模块显示
async function updateDividendModule() {
    const isOwner = await checkIsAssetOwner();
    document.getElementById('dividendModule').style.display = isOwner ? 'block' : 'none';
}

// 加载持有人数量
async function loadHoldersCount() {
    const assetId = window.location.pathname.split('/').pop();
    try {
        const response = await fetch(`/api/assets/${assetId}/holders-count`);
        const data = await response.json();
        document.getElementById('holdersCount').textContent = `${data.count}人`;
        
        // 更新建议分红金额
        const count = data.count;
        let suggestedAmount = '';
        if (count <= 10) suggestedAmount = '≥10000 USDC';
        else if (count <= 50) suggestedAmount = '≥15000 USDC';
        else if (count <= 100) suggestedAmount = '≥20000 USDC';
        else if (count <= 500) suggestedAmount = '≥50000 USDC';
        else suggestedAmount = '≥100000 USDC';
        
        document.getElementById('suggestedAmount').textContent = suggestedAmount;
        
        // 更新Gas预估
        if (window.ethereum) {
            const web3 = new Web3(window.ethereum);
            const gasPrice = await web3.eth.getGasPrice();
            const estimatedGas = 35000 * count; // 每个接收者约35000 Gas
            const estimatedGasCost = web3.utils.fromWei(
                (BigInt(gasPrice) * BigInt(estimatedGas)).toString(),
                'ether'
            );
            const ethPrice = 2000; // 假设ETH价格为2000 USD
            const estimatedUSDCost = (Number(estimatedGasCost) * ethPrice).toFixed(2);
            document.getElementById('estimatedGas').textContent = 
                `约 ${Number(estimatedGasCost).toFixed(4)} ETH (≈${estimatedUSDCost} USD)`;
        }
    } catch (error) {
        console.error('加载持有人数量失败:', error);
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', async () => {
    await updateDividendModule();
    await loadHoldersCount();
    await loadDividendHistory();
    
    // 监听分红金额输入
    document.getElementById('dividendAmount').addEventListener('input', async (e) => {
        const amount = parseFloat(e.target.value) || 0;
        const totalSupply = await assetTokenContract.methods.totalSupply().call();
        const perToken = amount / (totalSupply / 1e18);
        document.getElementById('perTokenDividend').textContent = 
            `每代币分红金额：${perToken.toFixed(6)} USDC`;
    });
    
    // 监听发起分红按钮
    document.getElementById('distributeDividendBtn').addEventListener('click', distributeDividend);
});

// 更新钱包状态显示
async function updateWalletStatus() {
    const walletStatus = document.getElementById('walletStatus');
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletDropdown = document.getElementById('walletDropdown');
    
    try {
        // 检查钱包连接状态
        let currentAccount = null;
        
        // 按优先级检查账户
        if (window.ethereum && window.ethereum.selectedAddress) {
            currentAccount = window.ethereum.selectedAddress;
        } else {
            currentAccount = localStorage.getItem('currentAccount');
        }
        
        // 更新全局变量
        window.currentAccount = currentAccount;
        
        if (currentAccount) {
            // 已连接状态
            const shortAddress = `${currentAccount.substring(0, 6)}...${currentAccount.substring(38)}`;
            connectWalletBtn.textContent = shortAddress;
            
            // 设置已连接状态的样式
            connectWalletBtn.className = 'inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none cursor-pointer';
            
            // 移除旧的事件监听器
            const newBtn = connectWalletBtn.cloneNode(true);
            connectWalletBtn.parentNode.replaceChild(newBtn, connectWalletBtn);
            
            // 添加新的点击事件
            newBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                walletDropdown.classList.toggle('hidden');
                
                // 设置下拉菜单位置
                const rect = newBtn.getBoundingClientRect();
                walletDropdown.style.position = 'absolute';
                walletDropdown.style.top = `${rect.bottom + window.scrollY}px`;
                walletDropdown.style.left = `${rect.left}px`;
                walletDropdown.style.minWidth = `${rect.width}px`;
            });
            
            // 更新交易按钮状态
            updateTradeButtons();
        } else {
            // 未连接状态
            connectWalletBtn.textContent = '连接钱包';
            
            // 设置未连接状态的样式
            connectWalletBtn.className = 'inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none cursor-pointer';
            
            // 隐藏下拉菜单
            walletDropdown.classList.add('hidden');
            
            // 移除旧的事件监听器并添加连接钱包事件
            const newBtn = connectWalletBtn.cloneNode(true);
            connectWalletBtn.parentNode.replaceChild(newBtn, connectWalletBtn);
            newBtn.addEventListener('click', connectWallet);
        }
        
        // 添加全局点击事件来关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!connectWalletBtn.contains(e.target) && !walletDropdown.contains(e.target)) {
                walletDropdown.classList.add('hidden');
            }
        });
        
    } catch (error) {
        console.error('更新钱包状态失败:', error);
    }
}

// 断开钱包连接
async function disconnectWallet() {
    window.currentAccount = null;
    localStorage.removeItem('currentAccount');
    await updateWalletStatus();
    updateTradeButtons();
    document.getElementById('walletDropdown').classList.add('hidden');
}

// 确保在页面加载完成后初始化钱包状态
document.addEventListener('DOMContentLoaded', async function() {
    console.log('页面加载完成，初始化钱包状态');
    
    // 检查是否已经连接钱包
    if (window.ethereum) {
        try {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            console.log('当前连接的账户:', accounts);
            
            if (accounts && accounts.length > 0) {
                window.currentAccount = accounts[0];
                localStorage.setItem('currentAccount', window.currentAccount);
                console.log('检测到已连接的钱包:', window.currentAccount);
            }
        } catch (error) {
            console.error('检查钱包状态失败:', error);
        }
    }
    
    // 更新界面显示
    await updateWalletStatus();
    
    // 监听钱包账户变化
    if (window.ethereum) {
        window.ethereum.on('accountsChanged', async function (accounts) {
            console.log('钱包账户发生变化:', accounts);
            if (accounts.length > 0) {
                window.currentAccount = accounts[0];
                localStorage.setItem('currentAccount', window.currentAccount);
            } else {
                window.currentAccount = null;
                localStorage.removeItem('currentAccount');
            }
            await updateWalletStatus();
            updateTradeButtons();
        });
    }
});

// 连接钱包函数
async function connectWallet() {
    try {
        if (!window.ethereum) {
            alert('请先安装MetaMask钱包');
            return;
        }

        const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
        });
        
        if (accounts && accounts.length > 0) {
            window.currentAccount = accounts[0];
            localStorage.setItem('currentAccount', window.currentAccount);
            
            // 初始化Web3合约
            await initContracts();
            
            // 更新显示状态
            await updateModulesVisibility();
            
            // 刷新页面以确保所有状态都正确更新
            window.location.reload();
        }
    } catch (error) {
        console.error('连接钱包失败:', error);
        alert('连接钱包失败: ' + (error.message || '未知错误'));
    }
}

function updateConnectButton() {
    const connectBtn = document.getElementById('connectWalletBtn');
    if (!connectBtn) return;
    
    if (window.currentAccount) {
        const shortAddress = `${window.currentAccount.substring(0, 6)}...${window.currentAccount.substring(38)}`;
        connectBtn.textContent = shortAddress;
        connectBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white');
        connectBtn.classList.add('bg-gray-100', 'text-blue-600', 'hover:bg-gray-200', 'border', 'border-gray-300');
        connectBtn.disabled = false;
    } else {
        connectBtn.textContent = '连接钱包';
        connectBtn.classList.remove('bg-gray-100', 'text-blue-600', 'hover:bg-gray-200', 'border', 'border-gray-300');
        connectBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
        connectBtn.disabled = false;
    }
}

// 更新模块显示状态
async function updateModulesVisibility() {
    const tradeModule = document.getElementById('tradeModule');
    const dividendModule = document.getElementById('dividendModule');
    const walletAlert = document.getElementById('walletAlert');
    const buyBtn = document.getElementById('buyBtn');

    try {
        // 检查是否连接钱包
        const isWalletConnected = window.ethereum && window.ethereum.selectedAddress;
        
        // 检查是否是资产所有者
        const isOwner = isWalletConnected && currentAsset && 
                       window.ethereum.selectedAddress.toLowerCase() === currentAsset.owner_address.toLowerCase();

        // 默认显示交易模块
        tradeModule.classList.remove('hidden');
        dividendModule.classList.add('hidden');

        if (!isWalletConnected) {
            // 未连接钱包：显示交易模块的提示，隐藏购买按钮
            walletAlert.classList.remove('hidden');
            buyBtn.classList.add('hidden');
        } else if (isOwner) {
            // 是资产所有者：显示分红模块，隐藏交易模块
            tradeModule.classList.add('hidden');
            dividendModule.classList.remove('hidden');
            // 初始化分红模块信息
            await updateDividendModuleInfo();
        } else {
            // 已连接但不是所有者：显示交易模块的购买按钮，隐藏提示
            walletAlert.classList.add('hidden');
            buyBtn.classList.remove('hidden');
        }
    } catch (error) {
        console.error('更新模块显示状态失败:', error);
        // 发生错误时，显示交易模块的提示，隐藏购买按钮
        walletAlert.classList.remove('hidden');
        buyBtn.classList.add('hidden');
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // 检查是否已经连接钱包
        if (window.ethereum) {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts && accounts.length > 0) {
                window.ethereum.selectedAddress = accounts[0];
                localStorage.setItem('currentAccount', accounts[0]);
                // 初始化Web3合约
                await initContracts();
            }
        }
        
        // 加载资产详情
        await loadAssetDetails();
        
        // 更新显示状态
        await updateModulesVisibility();
        
        // 监听钱包账户变化
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', async function (accounts) {
                if (accounts.length > 0) {
                    window.ethereum.selectedAddress = accounts[0];
                    localStorage.setItem('currentAccount', accounts[0]);
                    await initContracts();
                } else {
                    window.ethereum.selectedAddress = null;
                    localStorage.removeItem('currentAccount');
                }
                await updateModulesVisibility();
            });
        }
        
        // 加载其他信息
        await loadDividendHistory();
    } catch (error) {
        console.error('初始化页面失败:', error);
    }
});

// 连接钱包函数
async function connectWallet() {
    try {
        if (!window.ethereum) {
            alert('请先安装MetaMask钱包');
            return;
        }

        const accounts = await window.ethereum.request({ 
            method: 'eth_requestAccounts' 
        });
        
        if (accounts && accounts.length > 0) {
            window.ethereum.selectedAddress = accounts[0];
            localStorage.setItem('currentAccount', accounts[0]);
            
            // 初始化Web3合约
            await initContracts();
            
            // 更新显示状态
            await updateModulesVisibility();
            
            // 刷新页面以确保所有状态都正确更新
            window.location.reload();
        }
    } catch (error) {
        console.error('连接钱包失败:', error);
        alert('连接钱包失败: ' + (error.message || '未知错误'));
    }
}

// 断开钱包连接
async function disconnectWallet() {
    window.ethereum.selectedAddress = null;
    localStorage.removeItem('currentAccount');
    await updateModulesVisibility();
    // 刷新页面以确保所有状态都正确更新
    window.location.reload();
}

// 初始化Web3和合约
async function initContracts() {
    if (typeof window.ethereum === 'undefined') {
        throw new Error('请安装MetaMask钱包');
    }

    if (!window.ethereum.selectedAddress) {
        return; // 如果未连接钱包，直接返回
    }

    const web3 = new Web3(window.ethereum);
    window.web3 = web3;
    
    // 初始化USDT合约
    usdtContract = new web3.eth.Contract(USDT_ABI, USDT_ADDRESS);
    
    // 初始化资产代币合约
    if (currentAsset && currentAsset.token_address) {
        tokenContract = new web3.eth.Contract(AssetTokenABI, currentAsset.token_address);
    }
}
</script>
{% endblock %} 