{% extends "base.html" %}

{% block title %}{{ asset.token_symbol }} - {{ asset.name }} | RWA-HUB{% endblock %}

{% block head %}
<!-- 费用计算函数的定义 - 放在最前面 -->
<script>
// 定义全局常量和函数
window.PLATFORM_FEE_RATE = 0.035; // 3.5%平台费率
window.ACTUAL_PAYMENT_RATE = 0.965; // 96.5%实际支付率

window.calculatePlatformFee = function(amount) {
    return amount * window.PLATFORM_FEE_RATE;
};

window.calculateActualPayment = function(amount) {
    return amount * window.ACTUAL_PAYMENT_RATE;
};

// 确保函数已经定义
console.log('费用计算函数已定义:', {
    calculatePlatformFee: typeof window.calculatePlatformFee === 'function',
    calculateActualPayment: typeof window.calculateActualPayment === 'function'
});

// 验证函数是否正确定义
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded - 验证费用计算函数:', {
        calculatePlatformFee: typeof window.calculatePlatformFee === 'function',
        calculateActualPayment: typeof window.calculateActualPayment === 'function'
    });
});
</script>

<!-- 添加jQuery库 -->
<script src="{{ url_for('static', filename='vendor/jquery.min.js') }}"></script>
<!-- 使用内置bs58实现 -->
<!-- <script src="https://unpkg.com/bs58@5.0.0/dist/index.js"></script> -->
<!-- 添加Solana Web3 SDK -->
<script src="{{ url_for('proxy.cached_vendor', filename='solana-web3-stable.js') }}"></script>
<!-- 添加SPL Token库 -->
<script src="{{ url_for('proxy.cached_vendor', filename='solana-spl-token.js') }}"></script>
<!-- 初始化Solana库 -->
<script>
    // 创建全局对象
    window.splToken = {};
    window.solanaWeb3 = {};
    
    // 初始化函数
    async function initSolanaLibs() {
        console.log('初始化Solana库...');
        
        try {
            // 检查Solana Web3.js
            if (typeof SolanaWeb3 === 'undefined') {
                throw new Error('Solana Web3.js未加载');
            }
            
            // 复制Solana Web3.js到全局对象
            for (const key in SolanaWeb3) {
                window.solanaWeb3[key] = SolanaWeb3[key];
            }
            console.log('Solana Web3.js初始化成功');
            
            // 检查SPL Token
            if (typeof SolanaToken === 'undefined') {
                throw new Error('SPL Token库未加载');
            }
            
            // 复制SPL Token到全局对象
            for (const key in SolanaToken) {
                window.splToken[key] = SolanaToken[key];
            }
            console.log('SPL Token库初始化成功');
            
            // 确保solanaWeb3.SPL存在
            window.solanaWeb3.SPL = window.splToken;
            
            return true;
        } catch (error) {
            console.error('Solana库初始化失败:', error);
            
            // 如果初始化失败，创建基本对象
            if (window.solanaWeb3 && window.solanaWeb3.PublicKey) {
                window.splToken = {
                    TOKEN_PROGRAM_ID: new window.solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'),
                    ASSOCIATED_TOKEN_PROGRAM_ID: new window.solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL'),
                    createTransferInstruction: function(fromPubkey, toPubkey, ownerPubkey, amount, multiSigners = [], programId = this.TOKEN_PROGRAM_ID) {
                        const keys = [
                            { pubkey: fromPubkey, isSigner: false, isWritable: true },
                            { pubkey: toPubkey, isSigner: false, isWritable: true },
                            { pubkey: ownerPubkey, isSigner: multiSigners.length === 0, isWritable: false }
                        ];
                        multiSigners.forEach(signer => {
                            keys.push({ pubkey: signer.publicKey, isSigner: true, isWritable: false });
                        });
                        return new window.solanaWeb3.TransactionInstruction({
                            keys,
                            programId,
                            data: new Uint8Array([3, ...new Array(8).fill(0)]) // 3是transfer指令的代码
                        });
                    }
                };
                console.log('使用基本SPL Token对象');
                return true;
            }
            
            throw error;
        }
    }
    
    // 在页面加载时初始化
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOMContentLoaded 事件触发');
        try {
            // 尝试初始化Solana库
            await initSolanaLibs();
            console.log('Solana库初始化完成');
            
            // 在这里可以安全地执行依赖Solana库的代码
            // 例如，更新UI元素，绑定事件监听器等
            // 确保这些操作也在try块内部，或者在initSolanaLibs成功后执行
            
        } catch (error) {
            console.error('Solana库初始化过程中发生错误:', error);
            // 在这里可以向用户显示错误信息，或者禁用依赖Solana库的功能
            // 例如: document.getElementById('buyButton').disabled = true;
            //         document.getElementById('solanaErrorMsg').textContent = 'Solana功能加载失败，请稍后重试。';
        }
        
        // 其他不依赖Solana库的DOM操作可以放在这里
        console.log('DOMContentLoaded 事件处理完成');
    });
</script>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    /* 主要容器样式 */
    /* 修复详情页卡片样式 */
    .asset-detail-page .card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }
    
    .asset-detail-page .card-header {
        background-color: rgba(248, 249, 250, 0.5);
        border-bottom: 1px solid rgba(0,0,0,0.08);
        padding: 1rem 1.25rem;
    }
    
    .asset-detail-page .card-body {
        padding: 1.25rem;
    }
    
    /* 修复Asset Trading模块样式 */
    .asset-detail-page .trade-card .card-body {
        padding: 1.2rem;
    }
    
    /* 确保表单元素样式正确 */
    .asset-detail-page .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .asset-detail-page .form-control {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
        padding: 0.375rem 0.75rem;
    }
    
    .asset-detail-page .form-text {
        color: #6c757d;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    
    /* 修复分页控件样式 */
    #pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 1rem;
    }
    
    /* 交易历史表格样式 */
    .trade-history-section table {
        margin-bottom: 0;
    }
    
    .trade-history-section th, 
    .trade-history-section td {
        padding: 0.75rem;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 asset-detail-page">
  <div class="row">
    <div class="col-lg-8">
      <!-- 主要资产信息卡片 -->
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h1 class="card-title">{{ asset.name }}</h1>
            <div class="asset-status">
              {% if asset.status == 'pending' %}
                <span class="badge bg-warning">审核中</span>
              {% elif asset.status == 'approved' %}
                <span class="badge bg-success">已上链</span>
              {% elif asset.status == 'rejected' %}
                <span class="badge bg-danger">已拒绝</span>
              {% else %}
                <span class="badge bg-secondary">{{ asset.status }}</span>
              {% endif %}
            </div>
          </div>
          <p class="card-text">{{ asset.description }}</p>
          
          <div class="row mt-4">
            <div class="col-md-6">
              <!-- 资产图片 -->
              {% if asset.image_url %}
              <img src="{{ asset.image_url }}" alt="{{ asset.name }}" class="img-fluid rounded mb-3" style="max-height: 300px; width: auto;">
              {% else %}
              <div class="placeholder-image bg-light d-flex align-items-center justify-content-center rounded mb-3" style="height: 300px;">
                <span class="text-muted">无图片</span>
              </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <!-- 资产详细信息 -->
              <div class="card h-100">
                <div class="card-header bg-light">
                  <h5 class="mb-0">资产详情</h5>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>代币符号:</span>
                      <span class="fw-bold">{{ asset.token_symbol }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>总供应量:</span>
                      <span class="fw-bold">{{ asset.total_supply }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>剩余供应量:</span>
                      <span class="fw-bold" id="remainingSupply">{{ asset.remaining_supply }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>单价:</span>
                      <span class="fw-bold">{{ asset.price_per_token }} USDC</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>总分红已发放:</span>
                      <span class="fw-bold" id="totalDividendsDistributed">加载中...</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 资产属性卡片 -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">资产属性</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for property in asset.properties %}
            <div class="col-md-6 mb-2">
              <div class="d-flex justify-content-between">
                <span>{{ property.name }}:</span>
                <span class="fw-bold">{{ property.value }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <!-- 相关文档卡片 -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">相关文档</h5>
        </div>
        <div class="card-body">
          <div class="list-group">
            {% for document in asset.documents %}
            <a href="{{ document.url }}" class="list-group-item list-group-item-action" target="_blank">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ document.name }}</h6>
                <small>{{ document.upload_date }}</small>
              </div>
              <small class="text-muted">{{ document.description }}</small>
            </a>
            {% endfor %}
            {% if not asset.documents %}
            <div class="list-group-item">
              <p class="mb-0 text-muted">暂无相关文档</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- 分红历史卡片 -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">分红历史</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>每份分红</th>
                  <th>总分红</th>
                  <th>状态</th>
                </tr>
              </thead>
              <tbody id="dividendsTable">
                {% for dividend in dividends %}
                <tr>
                  <td>{{ dividend.date }}</td>
                  <td>{{ dividend.amount_per_token }} USDC</td>
                  <td>{{ dividend.total_amount }} USDC</td>
                  <td>
                    {% if dividend.status == 'paid' %}
                    <span class="badge bg-success">已支付</span>
                    {% elif dividend.status == 'pending' %}
                    <span class="badge bg-warning">处理中</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ dividend.status }}</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
                {% if not dividends %}
                <tr>
                  <td colspan="4" class="text-center">暂无分红记录</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <!-- 交易卡片 -->
      <div class="card mb-4 shadow-sm sticky-top" style="top: 20px; z-index: 100;">
        <div class="card-header bg-light">
          <h5 class="mb-0">交易</h5>
        </div>
        <div class="card-body">
          <div id="wallet-status" class="mb-3">
            <!-- 连接钱包提示 -->
            <div id="wallet-connect-prompt" class="alert alert-warning" role="alert">
              请先连接您的钱包以进行交易
              <button id="connect-wallet-btn" class="btn btn-primary btn-sm ms-2">连接钱包</button>
            </div>
            
            <!-- 钱包信息 -->
            <div id="wallet-info" class="d-none">
              <div class="d-flex justify-content-between mb-2">
                <span>钱包地址:</span>
                <span class="fw-bold text-truncate" style="max-width: 150px;" id="wallet-address">-</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>USDC余额:</span>
                <span class="fw-bold" id="usdc-balance">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 购买表单 -->
          <form id="buy-form" class="d-none">
            <div class="mb-3">
              <label for="buy-amount" class="form-label">购买数量</label>
              <input type="number" class="form-control" id="buy-amount" min="1" step="1" required>
            </div>
            <div class="mb-3">
              <label for="buy-cost" class="form-label">估计费用 (USDC)</label>
              <input type="text" class="form-control" id="buy-cost" readonly>
            </div>
            <div id="buy-error" class="alert alert-danger d-none" role="alert"></div>
            <div id="buy-success" class="alert alert-success d-none" role="alert"></div>
            <button type="button" id="buy-button" class="btn btn-primary w-100">购买</button>
          </form>
        </div>
      </div>
      
      <!-- 资产链接卡片 -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">资产链接</h5>
        </div>
        <div class="card-body">
          <div class="d-flex mb-2">
            <input type="text" id="asset-link" class="form-control me-2" value="{{ request.host_url }}assets/{{ asset.token_symbol }}" readonly>
            <button type="button" id="copy-link-btn" class="btn btn-outline-primary" onclick="copyAssetLink()">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-outline-secondary" onclick="shareAsset('wechat')">
              <i class="bi bi-wechat me-1"></i> 微信
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="shareAsset('weibo')">
              <i class="bi bi-sina-weibo me-1"></i> 微博
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="shareAsset('twitter')">
              <i class="bi bi-twitter me-1"></i> Twitter
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 交易历史部分 -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">交易历史</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>日期</th>
                  <th>类型</th>
                  <th>数量</th>
                  <th>价格</th>
                  <th>买家</th>
                  <th>卖家</th>
                  <th>交易哈希</th>
                </tr>
              </thead>
              <tbody id="transactionTable">
                <!-- 交易记录将通过JS动态加载 -->
                <tr>
                  <td colspan="7" class="text-center">加载中...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- 分页控件 -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="d-flex align-items-center">
              <span class="me-2">每页显示:</span>
              <select id="page-size" class="form-select form-select-sm" style="width: auto;">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
            <nav aria-label="Transaction history pagination">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item disabled">
                  <a class="page-link" href="#" id="prev-page">上一页</a>
                </li>
                <li class="page-item active">
                  <a class="page-link" href="#">1</a>
                </li>
                <li class="page-item disabled">
                  <a class="page-link" href="#" id="next-page">下一页</a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// 资产数据对象，用于JavaScript操作
var assetData = {};
assetData.id = "{{ asset.id }}";
assetData.token_symbol = "{{ asset.token_symbol }}";
assetData.name = "{{ asset.name }}";
assetData.price_per_token = {{ asset.price_per_token }};
assetData.remaining_supply = {{ asset.remaining_supply }};
assetData.total_supply = {{ asset.total_supply }};

// 复制资产链接到剪贴板
function copyAssetLink() {
  const linkInput = document.getElementById('asset-link');
  linkInput.select();
  document.execCommand('copy');
  
  // 显示复制成功提示
  const copyBtn = document.getElementById('copy-link-btn');
  const originalHTML = copyBtn.innerHTML;
  copyBtn.innerHTML = '<i class="bi bi-check2"></i>';
  copyBtn.classList.add('btn-success');
  copyBtn.classList.remove('btn-outline-primary');
  
  setTimeout(() => {
    copyBtn.innerHTML = originalHTML;
    copyBtn.classList.remove('btn-success');
    copyBtn.classList.add('btn-outline-primary');
  }, 2000);
}

// 分享资产到社交媒体
function shareAsset(platform) {
  const url = document.getElementById('asset-link').value;
  const title = `查看资产: ${assetData.name} (${assetData.token_symbol})`;
  
  let shareUrl;
  
  switch(platform) {
    case 'wechat':
      // 微信通常使用二维码分享，这里可以打开一个显示二维码的模态框
      alert('请使用微信扫一扫功能扫描二维码分享');
      return;
    case 'weibo':
      shareUrl = `http://service.weibo.com/share/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
      break;
    case 'twitter':
      shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`;
      break;
    default:
      shareUrl = url;
  }
  
  window.open(shareUrl, '_blank');
}

// 加载总分红数据
function loadTotalDividends() {
  // 检查是否有分红历史卡片
  const dividendsTable = document.getElementById('dividendsTable');
  if (!dividendsTable) {
    console.warn('分红历史表格元素不存在，跳过加载总分红');
    return;
  }
  
  // 获取资产的总分红数据
  fetch('/api/assets/' + assetData.token_symbol + '/dividends/total')
    .then(function(response) {
      if (!response.ok) {
        throw new Error('获取总分红数据失败');
      }
      return response.json();
    })
    .then(function(data) {
      // 在页面上显示总分红数据
      const totalDividendsElement = document.getElementById('totalDividendsDistributed');
      if (totalDividendsElement) {
        var amount = data.total_amount || '0';
        totalDividendsElement.textContent = amount + ' USDC';
      } else {
        console.warn('找不到显示总分红的元素');
      }
    })
    .catch(function(error) {
      console.error('加载总分红数据时出错:', error);
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  // 尝试执行refreshAssetInfo如果它存在
  if (typeof refreshAssetInfo === 'function') {
    refreshAssetInfo();
  } else {
    // 如果不存在，使用安全的刷新方法
    console.warn('refreshAssetInfo not defined, using safe refresh method');
    if (typeof safeRefreshAssetInfo === 'function') {
      safeRefreshAssetInfo();
    }
  }
  
  // 初始化交易表单
  if (typeof setupTradeForm === 'function') {
    setupTradeForm();
  }
  
  // 加载总分红
  loadTotalDividends();
  
  // 加载交易历史
  if (typeof loadTransactionHistory === 'function') {
    loadTransactionHistory(1);
  }
});
</script>
{% endblock %}
