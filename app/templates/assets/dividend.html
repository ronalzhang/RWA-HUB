{% extends "base.html" %}

{% block title %}{{ _('Dividend Management') }} - RWA-HUB{% endblock %}

{% block head %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- 不再直接引用Web3.js，由base.html中的动态加载器处理 -->
<script>
    // 确保Web3.js可用后再加载其他脚本
    document.addEventListener('web3Loaded', function() {
        // Web3.js加载成功后，动态加载其他依赖脚本
        const scripts = [
            '/static/js/AssetTokenABI.js',
            '/static/js/USDCABI.js'
        ];
        
        scripts.forEach(function(src) {
            const script = document.createElement('script');
            script.src = src;
            document.head.appendChild(script);
        });
    });
    
    // 处理Web3.js加载失败的情况
    document.addEventListener('web3LoadFailed', function() {
        console.error('Web3.js加载失败，分红功能可能无法正常工作');
        // 显示错误信息给用户
        const container = document.querySelector('.container');
        if (container) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger mt-3';
            alert.innerHTML = '<strong>错误:</strong> 无法加载Web3.js，分红功能可能无法正常使用。请刷新页面重试。';
            container.prepend(alert);
        }
    });
</script>
<style>
    .stats-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        padding: 10px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
        height: 100%;
        min-height: 120px;
        display: flex;
        flex-direction: column;
    }
    
    .stats-card:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .stats-card .card-body {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
        padding: 1rem;
    }
    
    .stats-card .card-title {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .stats-card .card-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 5px 0;
    }
    
    .stats-card .icon-bg {
        position: absolute;
        right: 0;
        bottom: 0;
        opacity: 0.1;
        transform: translate(20%, 20%);
        font-size: 3rem !important;
    }
    
    #dividend-form {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .loading-indicator {
        width: 16px;
        height: 16px;
        margin-right: 5px;
    }
    
    .stats-tooltip {
        position: relative;
        display: inline-block;
        margin-left: 3px;
        cursor: help;
    }
    
    .stats-tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem;
        font-weight: normal;
    }
    
    .stats-tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .stats-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -5px;
        }
        
        .stats-card-wrapper {
            width: 50%;
            padding: 0 5px;
            margin-bottom: 10px;
        }
        
        .stats-card {
            min-height: 100px;
        }
        
        .stats-card .card-value {
            font-size: 1.3rem;
        }
        
        .stats-card .icon-bg {
            font-size: 2.5rem !important;
        }
    }
    
    .usdc-icon {
        width: 18px;
        height: 18px;
        margin-right: 2px;
        vertical-align: text-bottom;
    }
    
    .stats-card .usdc-icon {
        width: 16px;
        height: 16px;
        margin-right: 2px;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6">分红管理</h1>
        
        <!-- 资产统计 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-gray-500 text-sm">总分红次数</h3>
                <p class="text-2xl font-bold" id="dividend-count">-</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-gray-500 text-sm">总分红金额</h3>
                <p class="text-2xl font-bold" id="total-amount">-</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-gray-500 text-sm">持有人数量</h3>
                <p class="text-2xl font-bold" id="holder-count">-</p>
            </div>
        </div>
        
        <!-- 发起分红表单 -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">发起分红</h2>
            <form id="dividend-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">分红金额 (USDC)</label>
                    <input type="number" step="0.01" min="0" id="amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">分红间隔 (小时)</label>
                    <input type="number" min="1" id="interval" value="24" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-gray-500 text-sm">预估信息</h3>
                    <p class="text-sm">平台手续费: <span id="platform-fee">-</span> USDC</p>
                    <p class="text-sm">实际分红金额: <span id="actual-amount">-</span> USDC</p>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    确认发起分红
                </button>
            </form>
        </div>
        
        <!-- 分红历史 -->
        <div>
            <h2 class="text-xl font-semibold mb-4">分红历史</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">间隔</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">发起人</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">交易哈希</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="dividend-history">
                        <!-- 历史记录将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const PLATFORM_FEE_RATE = 0.035; // 3.5%平台手续费

// 加载资产统计信息
async function loadAssetStats() {
    try {
        const response = await fetch(`/api/assets/symbol/${symbol}/dividend_stats`);
        const data = await response.json();
        
        document.getElementById('dividend-count').textContent = data.count;
        document.getElementById('total-amount').textContent = data.total_amount.toFixed(2);
        document.getElementById('holder-count').textContent = data.holder_count;
    } catch (error) {
        console.error('加载资产统计失败:', error);
        showError('加载资产统计失败');
    }
}

// 加载分红历史
async function loadDividendHistory() {
    try {
        const response = await fetch(`/api/assets/symbol/${symbol}/dividend_history`);
        const history = await response.json();
        
        const tbody = document.getElementById('dividend-history');
        tbody.innerHTML = '';
        
        history.forEach(record => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.created_at}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.amount.toFixed(2)} USDC</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.interval / 3600}小时</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.distributor_address}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <a href="https://solscan.io/tx/${record.transaction_hash}" target="_blank" class="text-blue-600 hover:text-blue-800">
                        ${record.transaction_hash.slice(0, 8)}...${record.transaction_hash.slice(-8)}
                    </a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('加载分红历史失败:', error);
        showError('加载分红历史失败');
    }
}

// 计算预估信息
function updateEstimate() {
    const amount = parseFloat(document.getElementById('amount').value) || 0;
    const platformFee = amount * PLATFORM_FEE_RATE;
    const actualAmount = amount - platformFee;
    
    document.getElementById('platform-fee').textContent = platformFee.toFixed(2);
    document.getElementById('actual-amount').textContent = actualAmount.toFixed(2);
}

// 检查权限
async function checkPermission() {
    try {
        const response = await fetch(`/api/assets/symbol/${symbol}/check_permission`);
        const data = await response.json();
        
        if (!data.can_manage_dividend) {
            document.getElementById('dividend-form').style.display = 'none';
            showError('您没有权限管理分红');
        }
    } catch (error) {
        console.error('检查权限失败:', error);
        showError('检查权限失败');
    }
}

// 显示错误信息
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
    errorDiv.innerHTML = `
        <strong class="font-bold">错误!</strong>
        <span class="block sm:inline">${message}</span>
    `;
    document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.bg-white'));
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    loadAssetStats();
    loadDividendHistory();
    checkPermission();
    
    // 监听表单输入
    document.getElementById('amount').addEventListener('input', updateEstimate);
    document.getElementById('interval').addEventListener('input', updateEstimate);
    
    // 处理表单提交
    document.getElementById('dividend-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const amount = parseFloat(document.getElementById('amount').value);
        const interval = parseInt(document.getElementById('interval').value) * 3600; // 转换为秒
        
        if (!amount || amount <= 0) {
            showError('请输入有效的分红金额');
            return;
        }
        
        try {
            const response = await fetch(`/api/assets/symbol/${symbol}/distribute_dividend`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ amount, interval })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                alert('分红发起成功！');
                loadAssetStats();
                loadDividendHistory();
                document.getElementById('amount').value = '';
            } else {
                showError(data.error || '发起分红失败');
            }
        } catch (error) {
            console.error('发起分红失败:', error);
            showError('发起分红失败');
        }
    });
});
</script>
{% endblock %} 