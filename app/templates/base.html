<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}58HUB{% endblock %}</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    {% block head %}{% endblock %}
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/" class="text-2xl font-bold text-blue-600">58HUB</a>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            首页
                        </a>
                        <a href="/assets" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            资产列表
                        </a>
                        <a href="/assets/create" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            创建资产
                        </a>
                        <a href="/admin" id="adminLink" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium hidden">
                            后台管理
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    <button id="connectWalletBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        连接钱包
                    </button>
                    <!-- 移动端菜单按钮 -->
                    <div class="sm:hidden ml-4">
                        <button type="button" onclick="toggleMobileMenu()" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- 移动端菜单 -->
            <div id="mobileMenu" class="hidden sm:hidden">
                <div class="pt-2 pb-3 space-y-1">
                    <a href="/" class="text-gray-500 hover:bg-gray-50 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium">首页</a>
                    <a href="/assets" class="text-gray-500 hover:bg-gray-50 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium">资产列表</a>
                    <a href="/assets/create" class="text-gray-500 hover:bg-gray-50 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium">创建资产</a>
                    <a href="/admin" id="mobileAdminLink" class="text-gray-500 hover:bg-gray-50 hover:text-gray-700 block px-3 py-2 rounded-md text-base font-medium hidden">后台管理</a>
                </div>
            </div>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <script>
    let web3;
    let currentAccount;

    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        mobileMenu.classList.toggle('hidden');
    }

    async function initWeb3() {
        console.log("初始化Web3...");
        if (window.ethereum) {
            // 检查是否是断开状态
            const isDisconnected = sessionStorage.getItem('walletDisconnected') === 'true';
            console.log("断开状态检查:", isDisconnected);
            
            if (isDisconnected) {
                console.log("检测到断开状态，保持断开");
                window.currentAccount = null;
                localStorage.removeItem('currentAccount');
                web3 = null;  // 确保 web3 实例被清除
                
                // 强制更新UI
                updateConnectButton();
                await checkAndUpdateAdminLink();
                
                // 强制隐藏分红模块
                const dividendModule = document.getElementById('dividendModule');
                if (dividendModule) {
                    dividendModule.classList.add('hidden');
                }
                return;
            }

            try {
                web3 = new Web3(window.ethereum);
                
                // 检查MetaMask是否真的连接了账户
                const accounts = await window.ethereum.request({ 
                    method: 'eth_accounts'
                });
                
                console.log("当前连接的账户:", accounts);
                
                if (!accounts || accounts.length === 0) {
                    console.log("没有连接的账户，设置为断开状态");
                    window.currentAccount = null;
                    localStorage.removeItem('currentAccount');
                    sessionStorage.setItem('walletDisconnected', 'true');
                    web3 = null;  // 确保 web3 实例被清除
                    
                    // 强制更新UI
                    updateConnectButton();
                    await checkAndUpdateAdminLink();
                    
                    // 强制隐藏分红模块
                    const dividendModule = document.getElementById('dividendModule');
                    if (dividendModule) {
                        dividendModule.classList.add('hidden');
                    }
                    return;
                }
                
                // 如果有连接的账户，更新状态
                window.currentAccount = accounts[0];
                localStorage.setItem('currentAccount', accounts[0]);
                sessionStorage.removeItem('walletDisconnected');
                
                // 更新UI
                updateConnectButton();
                await checkAndUpdateAdminLink();
                
                // 初始化事件监听器
                initEventListeners();
                
            } catch (error) {
                console.error("检查钱包状态失败:", error);
                window.currentAccount = null;
                localStorage.removeItem('currentAccount');
                sessionStorage.setItem('walletDisconnected', 'true');
                web3 = null;  // 确保 web3 实例被清除
                
                // 强制更新UI
                updateConnectButton();
                await checkAndUpdateAdminLink();
                
                // 强制隐藏分红模块
                const dividendModule = document.getElementById('dividendModule');
                if (dividendModule) {
                    dividendModule.classList.add('hidden');
                }
            }
        }
    }

    function updateConnectButton() {
        const connectBtn = document.getElementById('connectWalletBtn');
        if (!connectBtn) return;
        
        if (window.currentAccount) {
            const shortAddress = `${window.currentAccount.substring(0, 6)}...${window.currentAccount.substring(38)}`;
            connectBtn.textContent = shortAddress;
            connectBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white');
            connectBtn.classList.add('bg-gray-100', 'text-blue-600', 'hover:bg-gray-200', 'border', 'border-gray-300');
            connectBtn.disabled = false;
            
            connectBtn.onclick = function(e) {
                e.stopPropagation();
                const dropdown = document.createElement('div');
                dropdown.id = 'walletDropdown';
                dropdown.className = 'absolute mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5';
                dropdown.innerHTML = `
                    <div class="py-1" role="menu">
                        <button onclick="disconnectWallet()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">断开连接</button>
                        <button onclick="switchWallet()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">切换钱包</button>
                    </div>
                `;
                
                const rect = connectBtn.getBoundingClientRect();
                dropdown.style.position = 'absolute';
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.left = `${rect.left}px`;
                
                const existingDropdown = document.getElementById('walletDropdown');
                if (existingDropdown) {
                    existingDropdown.remove();
                }
                
                document.body.appendChild(dropdown);
                
                setTimeout(() => {
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!dropdown.contains(e.target) && e.target !== connectBtn) {
                            dropdown.remove();
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                }, 0);
            };
        } else {
            connectBtn.textContent = '连接钱包';
            connectBtn.classList.remove('bg-gray-100', 'text-blue-600', 'hover:bg-gray-200', 'border', 'border-gray-300');
            connectBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white');
            connectBtn.disabled = false;
            connectBtn.onclick = connectWallet;
        }
    }

    async function disconnectWallet() {
        try {
            console.log("断开钱包连接...");
            
            // 先移除所有事件监听器
            if (window.ethereum) {
                window.ethereum.removeAllListeners('accountsChanged');
                window.ethereum.removeAllListeners('connect');
                window.ethereum.removeAllListeners('disconnect');
            }
            
            // 清除所有状态
            window.currentAccount = null;
            localStorage.removeItem('currentAccount');
            sessionStorage.setItem('walletDisconnected', 'true');
            
            // 强制隐藏分红模块
            const dividendModule = document.getElementById('dividendModule');
            if (dividendModule) {
                dividendModule.classList.add('hidden');
            }
            
            // 尝试撤销MetaMask权限
            if (window.ethereum && window.ethereum.isMetaMask) {
                try {
                    // 先获取当前权限
                    const permissions = await window.ethereum.request({
                        method: 'wallet_getPermissions'
                    });
                    
                    if (permissions && permissions.length > 0) {
                        // 撤销所有权限
                        await window.ethereum.request({
                            method: 'wallet_revokePermissions',
                            params: [{
                                eth_accounts: {}
                            }]
                        });
                        
                        // 强制断开连接
                        await window.ethereum.request({
                            method: 'eth_accounts'
                        });
                    }
                    
                    // 重置 web3 实例
                    web3 = null;
                    
                    // 强制刷新页面以确保完全断开
                    window.location.reload();
                    
                } catch (error) {
                    console.log("撤销权限失败，尝试其他方法:", error);
                    
                    // 如果撤销失败，尝试清除状态
                    try {
                        await window.ethereum.request({
                            method: 'wallet_requestPermissions',
                            params: [{
                                eth_accounts: {}
                            }]
                        });
                        
                        // 立即拒绝新的权限请求
                        await window.ethereum.request({
                            method: 'eth_accounts'
                        });
                        
                        // 重置 web3 实例
                        web3 = null;
                        
                        // 强制刷新页面以确保完全断开
                        window.location.reload();
                        
                    } catch (permError) {
                        console.log("清除权限也失败，强制刷新页面:", permError);
                        window.location.reload();
                    }
                }
            } else {
                // 如果没有 MetaMask，直接刷新页面
                window.location.reload();
            }
            
        } catch (error) {
            console.error("断开钱包失败:", error);
            await showMessage('断开钱包失败', 'error');
            // 出错时也刷新页面
            window.location.reload();
        }
    }

    async function switchWallet() {
        try {
            console.log("切换钱包...");
            
            // 关闭下拉菜单
            const dropdown = document.getElementById('walletDropdown');
            if (dropdown) dropdown.remove();

            // 直接打开MetaMask选择账户
            if (window.ethereum && window.ethereum.isMetaMask) {
                // 先请求权限以打开MetaMask界面
                await window.ethereum.request({
                    method: 'wallet_requestPermissions',
                    params: [{
                        eth_accounts: {}
                    }]
                });

                // 获取新选择的账户
                const accounts = await window.ethereum.request({
                    method: 'eth_accounts'
                });

                // 检查是否选择了新账户
                if (accounts && accounts.length > 0) {
                    const newAccount = accounts[0];
                    // 只有当选择了不同的账户时才更新
                    if (!window.currentAccount || newAccount.toLowerCase() !== window.currentAccount.toLowerCase()) {
                        window.currentAccount = newAccount;
                        localStorage.setItem('currentAccount', newAccount);
                        sessionStorage.removeItem('walletDisconnected');
                        updateConnectButton();
                        await checkAndUpdateAdminLink();
                    }
                }
            }
        } catch (error) {
            console.error("切换钱包失败:", error);
            if (error.code === -32002) {
                await showMessage('请在MetaMask中完成操作', 'error');
            } else {
                await showMessage('切换钱包失败，请重试', 'error');
            }
        }
    }

    // 修改事件监听器初始化函数
    function initEventListeners() {
        if (!window.ethereum) return;
        
        console.log("初始化事件监听器");
        
        // 先移除所有已存在的监听器
        window.ethereum.removeAllListeners('accountsChanged');
        window.ethereum.removeAllListeners('connect');
        window.ethereum.removeAllListeners('disconnect');
        
        // 添加新的监听器
        window.ethereum.on('accountsChanged', async (accounts) => {
            console.log("钱包账户变化:", accounts);
            
            if (!accounts || accounts.length === 0) {
                console.log("没有连接的账户，设置为断开状态");
                window.currentAccount = null;
                localStorage.removeItem('currentAccount');
                sessionStorage.setItem('walletDisconnected', 'true');
            } else {
                // 账户切换
                window.currentAccount = accounts[0];
                localStorage.setItem('currentAccount', accounts[0]);
                sessionStorage.removeItem('walletDisconnected');
            }
            
            updateConnectButton();
            await checkAndUpdateAdminLink();
            
            // 更新模块显示状态
            const publisherAddress = document.getElementById('dividendModule')?.dataset.publisher;
            if (publisherAddress) {
                updateModulesVisibility(publisherAddress);
            }
        });

        window.ethereum.on('connect', (connectInfo) => {
            console.log('MetaMask连接成功:', connectInfo);
            sessionStorage.removeItem('walletDisconnected');
            
            // 更新模块显示状态
            const publisherAddress = document.getElementById('dividendModule')?.dataset.publisher;
            if (publisherAddress) {
                updateModulesVisibility(publisherAddress);
            }
        });

        window.ethereum.on('disconnect', (error) => {
            console.log('MetaMask断开连接:', error);
            window.currentAccount = null;
            localStorage.removeItem('currentAccount');
            sessionStorage.setItem('walletDisconnected', 'true');
            
            // 更新模块显示状态
            const publisherAddress = document.getElementById('dividendModule')?.dataset.publisher;
            if (publisherAddress) {
                updateModulesVisibility(publisherAddress);
            }
            
            updateConnectButton();
            checkAndUpdateAdminLink();
        });
        
        console.log("事件监听器初始化完成");
    }

    async function connectWallet() {
        try {
            console.log("开始连接钱包...");
            
            if (!window.ethereum) {
                throw new Error("请安装MetaMask钱包");
            }

            // 检查是否处于断开状态
            const isDisconnected = sessionStorage.getItem('walletDisconnected') === 'true';
            
            // 如果处于断开状态，需要重新请求权限
            if (isDisconnected) {
                // 清除断开状态
                sessionStorage.removeItem('walletDisconnected');
                
                // 请求新的权限
                await window.ethereum.request({
                    method: 'wallet_requestPermissions',
                    params: [{
                        eth_accounts: {}
                    }]
                });
            }
            
            // 请求账户
            const accounts = await window.ethereum.request({
                method: 'eth_requestAccounts'
            });
            
            if (accounts && accounts.length > 0) {
                window.currentAccount = accounts[0];
                localStorage.setItem('currentAccount', accounts[0]);
                updateConnectButton();
                await checkAndUpdateAdminLink();
            } else {
                throw new Error('未能获取钱包地址');
            }
        } catch (error) {
            console.error("连接钱包失败:", error);
            if (error.code === -32002) {
                await showMessage('请在MetaMask中完成操作', 'error');
            } else {
                await showMessage(error.message || '连接钱包失败', 'error');
            }
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        console.log("页面加载完成，初始化钱包...");
        
        // 默认隐藏分红模块
        const dividendModule = document.getElementById('dividendModule');
        if (dividendModule) {
            dividendModule.classList.add('hidden');
            console.log("初始化时隐藏分红模块");
        }
        
        // 清除之前的状态
        window.currentAccount = null;
        
        // 初始化Web3
        await initWeb3();
        
        // 更新模块显示状态
        const publisherAddress = document.getElementById('dividendModule')?.dataset.publisher;
        if (publisherAddress) {
            updateModulesVisibility(publisherAddress);
        }
        
        const connectBtn = document.getElementById('connectWalletBtn');
        console.log("找到连接按钮:", !!connectBtn);
        if (connectBtn) {
            connectBtn.addEventListener('click', connectWallet);
            console.log("已添加点击事件监听器");
        }
    });

    async function checkAndUpdateAdminLink() {
        const adminAddresses = [
            '0x6394993426DBA3b654eF0052698Fe9E0B6A98870',
            '0x124e5B8A4E6c68eC66e181E0B54817b12D879c57'
        ];
        
        const adminLink = document.getElementById('adminLink');
        const mobileAdminLink = document.getElementById('mobileAdminLink');
        if (!adminLink || !mobileAdminLink) return;
        
        if (window.currentAccount && adminAddresses.map(addr => addr.toLowerCase()).includes(window.currentAccount.toLowerCase())) {
            adminLink.classList.remove('hidden');
            mobileAdminLink.classList.remove('hidden');
            // 更新后台管理链接，添加钱包地址
            const href = `/admin?eth_address=${window.currentAccount}`;
            adminLink.href = href;
            mobileAdminLink.href = href;
        } else {
            adminLink.classList.add('hidden');
            mobileAdminLink.classList.add('hidden');
        }
    }

    // 修改检查钱包连接状态的函数
    function isWalletConnected() {
        const isDisconnected = sessionStorage.getItem('walletDisconnected') === 'true';
        const hasCurrentAccount = !!window.currentAccount;
        const storedAccount = localStorage.getItem('currentAccount');
        const accountsMatch = storedAccount === window.currentAccount;
        
        console.log("钱包连接状态检查:", {
            isDisconnected,
            hasCurrentAccount,
            storedAccount,
            currentAccount: window.currentAccount,
            accountsMatch
        });
        
        return hasCurrentAccount && !isDisconnected && accountsMatch;
    }

    // 修改分红模块显示判断函数
    function shouldShowDividendModule(publisherAddress) {
        // 获取连接按钮的文本来判断钱包是否真的连接
        const connectBtn = document.getElementById('connectWalletBtn');
        const isReallyConnected = connectBtn && connectBtn.textContent !== '连接钱包';
        
        // 如果钱包未连接，直接返回false
        if (!isReallyConnected) {
            console.log("钱包未连接，隐藏分红模块");
            return false;
        }
        
        // 检查当前账户和发布者地址
        if (!window.currentAccount || !publisherAddress) {
            console.log("缺少当前账户或发布者地址，隐藏分红模块");
            return false;
        }
        
        const isPublisher = window.currentAccount.toLowerCase() === publisherAddress.toLowerCase();
        
        console.log("分红模块显示状态检查:", {
            isReallyConnected,
            currentAccount: window.currentAccount,
            publisherAddress: publisherAddress,
            isPublisher: isPublisher
        });
        
        return isPublisher;
    }

    // 修改更新模块显示状态的函数
    function updateModulesVisibility(publisherAddress) {
        const dividendModule = document.getElementById('dividendModule');
        const tradeModule = document.querySelector('.trade-module');
        
        if (!dividendModule || !tradeModule) return;
        
        const shouldShowDividend = shouldShowDividendModule(publisherAddress);
        console.log("更新模块显示状态:", shouldShowDividend);
        
        if (shouldShowDividend) {
            // 如果是发布者且已连接钱包，显示分红模块，隐藏交易模块
            dividendModule.classList.remove('hidden');
            tradeModule.classList.add('hidden');
        } else {
            // 否则显示交易模块，隐藏分红模块
            dividendModule.classList.add('hidden');
            tradeModule.classList.remove('hidden');
            // 更新交易模块的UI状态
            updateTradeModuleUI();
        }
    }

    // 添加更新交易模块UI的函数
    function updateTradeModuleUI() {
        const tradeModule = document.querySelector('.trade-module');
        if (!tradeModule) return;
        
        const buyButton = tradeModule.querySelector('.buy-button');
        const connectPrompt = tradeModule.querySelector('.connect-wallet-prompt');
        
        if (!window.currentAccount) {
            // 隐藏购买按钮，显示连接提示
            if (buyButton) buyButton.classList.add('hidden');
            if (!connectPrompt) {
                const promptDiv = document.createElement('div');
                promptDiv.className = 'connect-wallet-prompt text-center text-gray-500 py-2';
                promptDiv.textContent = '请先连接钱包';
                // 替换购买按钮的位置
                if (buyButton) {
                    buyButton.parentNode.insertBefore(promptDiv, buyButton);
                } else {
                    tradeModule.appendChild(promptDiv);
                }
            }
        } else {
            // 显示购买按钮，移除连接提示
            if (buyButton) buyButton.classList.remove('hidden');
            if (connectPrompt) connectPrompt.remove();
        }
    }

    async function showMessage(text, type = 'success') {
        const message = document.createElement('div');
        message.className = `fixed top-4 left-1/2 transform -translate-x-1/2 w-64 px-4 py-2 rounded-lg shadow-md text-center text-sm z-50 ${
            type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' : 'bg-red-50 border border-red-200 text-red-700'
        }`;
        message.textContent = text;
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.remove();
        }, 2000);
    }

    // 全局钱包状态管理
    window.addEventListener('load', async () => {
        // 检查是否已经连接钱包
        if (window.ethereum) {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts && accounts.length > 0) {
                    window.ethereum.selectedAddress = accounts[0];
                    localStorage.setItem('currentAccount', accounts[0]);
                    document.dispatchEvent(new CustomEvent('walletConnected', { 
                        detail: { account: accounts[0] } 
                    }));
                }
            } catch (error) {
                console.error('检查钱包状态失败:', error);
            }

            // 监听钱包账户变化
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length > 0) {
                    window.ethereum.selectedAddress = accounts[0];
                    localStorage.setItem('currentAccount', accounts[0]);
                    document.dispatchEvent(new CustomEvent('walletConnected', { 
                        detail: { account: accounts[0] } 
                    }));
                } else {
                    window.ethereum.selectedAddress = null;
                    localStorage.removeItem('currentAccount');
                    document.dispatchEvent(new Event('walletDisconnected'));
                }
            });
        }
    });

    // 全局连接钱包函数
    async function connectWallet() {
        try {
            if (!window.ethereum) {
                alert('请先安装MetaMask钱包');
                return;
            }

            const accounts = await window.ethereum.request({ 
                method: 'eth_requestAccounts' 
            });
            
            if (accounts && accounts.length > 0) {
                window.ethereum.selectedAddress = accounts[0];
                localStorage.setItem('currentAccount', accounts[0]);
                document.dispatchEvent(new CustomEvent('walletConnected', { 
                    detail: { account: accounts[0] } 
                }));
                // 刷新页面以确保所有状态都正确更新
                window.location.reload();
            }
        } catch (error) {
            console.error('连接钱包失败:', error);
            alert('连接钱包失败: ' + (error.message || '未知错误'));
        }
    }

    // 全局断开钱包连接函数
    async function disconnectWallet() {
        window.ethereum.selectedAddress = null;
        localStorage.removeItem('currentAccount');
        document.dispatchEvent(new Event('walletDisconnected'));
        // 刷新页面以确保所有状态都正确更新
        window.location.reload();
    }

    // 检查钱包连接状态
    function isWalletConnected() {
        return window.ethereum && window.ethereum.selectedAddress;
    }

    // 获取当前连接的钱包地址
    function getCurrentWalletAddress() {
        return window.ethereum && window.ethereum.selectedAddress;
    }
    </script>

    {% block scripts %}{% endblock %}
</body>
</html></html>
