<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- AOS Animation -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.1/aos.css" rel="stylesheet">
    
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <style>
        /* 钱包按钮样式 */
        .wallet-btn {
            min-width: 160px;
            text-align: center;
        }
        
        /* 钱包下拉容器 */
        .wallet-dropdown {
            position: relative;
            display: inline-block;
        }
        
        /* 钱包下拉菜单 */
        .wallet-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            min-width: 200px;
            padding: 0.5rem 0;
            z-index: 1000;
            margin-top: 0.5rem;
            transition: opacity 0.15s ease-in-out;
            opacity: 0;
        }
        
        .wallet-menu.show {
            display: block;
            opacity: 1;
        }
        
        /* 钱包菜单项 */
        .wallet-menu-item {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem;
            clear: both;
            font-weight: 400;
            color: #212529;
            text-align: inherit;
            text-decoration: none;
            white-space: nowrap;
            background-color: transparent;
            border: 0;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
        
        .wallet-menu-item:hover {
            background-color: #f8f9fa;
            color: #0d6efd;
        }
        
        /* 钱包菜单头部 */
        .wallet-menu-header {
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        /* 钱包地址显示 */
        .wallet-address {
            font-family: monospace;
        }

        /* 语言切换下拉菜单 */
        .language-dropdown .dropdown-item {
            padding: 0.5rem 1rem;
            transition: all 0.15s ease-in-out;
        }

        .language-dropdown .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #0d6efd;
        }

        /* 钱包下拉菜单样式 */
        .wallet-dropdown {
            position: relative;
            margin-left: 10px;
        }

        .wallet-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 280px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .wallet-menu-header {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            background-color: #f8f9fa;
        }

        .wallet-address {
            font-size: 0.8rem;
            color: #6c757d;
            font-family: monospace;
        }

        .wallet-menu-item {
            display: block;
            width: 100%;
            padding: 10px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .wallet-menu-item:hover {
            background-color: #f8f9fa;
        }

        .wallet-btn {
            border-radius: 20px;
            padding: 8px 16px;
        }

        /* 资产列表样式 */
        .wallet-assets-list {
            max-height: 150px;
            overflow-y: auto;
            padding: 0 10px;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .asset-item:last-child {
            border-bottom: none;
        }

        .asset-name {
            display: flex;
            align-items: center;
        }

        .asset-icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            border-radius: 50%;
            object-fit: cover;
        }

        .asset-holding {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .asset-value {
            font-weight: 500;
        }

        /* 查看全部链接 */
        .view-all-link {
            display: block;
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
            color: #0d6efd;
            text-decoration: none;
            background-color: #f8f9fa;
            border-radius: 0 0 4px 4px;
        }

        .view-all-link:hover {
            background-color: #e9ecef;
        }

        /* 添加资产链接样式 */
        .asset-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .asset-link:hover {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding-left: 5px;
            padding-right: 5px;
        }
        
        .asset-link:last-child {
            border-bottom: none;
        }
    </style>
    
    <!-- AOS Animation Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.1/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init();
        });
    </script>
    
    {% block head %}{% endblock %}
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">RWA-HUB.com</a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('assets.list_assets_page') }}">{{ _('All Assets') }}</a>
                    </li>
                    <li class="nav-item" id="adminEntry" style="display: none;">
                        <a class="nav-link" href="/admin/dashboard" id="adminNavLink">
                            <i class="fas fa-user-shield me-1"></i>{{ _('Admin') }}
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center">
                    <!-- 语言切换 -->
                    <div class="dropdown me-3 language-dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-globe me-1"></i>
                            <span>{{ _('Language') }}</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')">English</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeLanguage('zh')">繁體中文</a></li>
                        </ul>
                    </div>
                    
                    <!-- 钱包按钮和下拉菜单 -->
                    <div class="wallet-dropdown">
                        <button id="walletBtn" class="btn btn-outline-primary wallet-btn" type="button">
                            <i class="fas fa-wallet me-2"></i>
                            <span id="walletBtnText">{{ _('Connect Wallet') }}</span>
                        </button>
                        <div id="walletMenu" class="wallet-menu">
                            <div class="wallet-menu-header d-flex justify-content-between align-items-center">
                                <span>{{ _('Current Connection') }}</span>
                                <span class="wallet-address text-truncate ms-2" id="walletAddressDisplay" onclick="copyWalletAddress()" style="max-width: 150px; cursor: pointer;">{{ _('Not Connected') }}</span>
                            </div>
                            <div class="wallet-menu-item" id="walletBalanceDisplay">
                                <i class="fas fa-coins me-2"></i>{{ _('USDC Balance') }}: <span id="usdcBalance">0.00</span>
                            </div>
                            
                            <!-- 资产持有信息 -->
                            <div class="wallet-menu-section border-top border-bottom mt-1" id="userAssetsSection" style="display: none;">
                                <div class="small text-muted ps-3 pt-2">{{ _('My Assets') }}</div>
                                <div id="walletAssetsList" class="wallet-assets-list">
                                    <!-- 资产列表将通过JavaScript动态添加 -->
                                    <div class="text-center py-1">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">{{ _('Loading') }}...</span>
                                        </div>
                                        <span class="small text-muted ms-1">{{ _('Loading') }}...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="wallet-menu-footer">
                                <!-- 添加切换钱包按钮 -->
                                <button class="wallet-menu-item text-primary" id="switchWalletBtn">
                                    <i class="fas fa-exchange-alt me-2"></i>{{ _('Switch Wallet') }}
                                </button>
                                <button class="wallet-menu-item text-danger" id="disconnectWalletBtn">
                                    <i class="fas fa-sign-out-alt me-2"></i>{{ _('Disconnect Wallet') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域容器，添加顶部边距防止与导航栏重叠 -->
    <div class="main-content" style="margin-top: 76px; min-height: calc(100vh - 180px);">
        {% block content %}{% endblock %}
    </div>

    <!-- 页脚 -->
    <footer class="footer mt-auto py-1 bg-light border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-1">RWA-HUB.com</h5>
                    <p class="text-muted mb-0">{{ _('Blockchain-based Physical Asset Digitization Platform') }}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="mb-2">
                        <a href="#" class="text-decoration-none text-muted me-3">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="#" class="text-decoration-none text-muted me-3">
                            <i class="fab fa-telegram"></i>
                        </a>
                        <a href="#" class="text-decoration-none text-muted">
                            <i class="fab fa-discord"></i>
                        </a>
                    </div>
                    <p class="text-muted small mb-0">
                        © 2024 RWA-HUB.com {{ _('All Rights Reserved') }}
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    
    <!-- 全新的钱包连接脚本，使用最简单的方法 -->
    <script>
    console.log('钱包连接脚本开始加载');
    
    // 初始化walletState对象，确保其他代码可以访问它
    window.walletState = window.walletState || {
        isConnected: false,
        address: null,
        usdcBalance: "0.00",
        getConnectionStatus: function() { return this.isConnected; },
        getAddress: function() { return this.address; },
        getUsdcBalance: function() { return this.usdcBalance; }
    };
    
    // 通用函数：获取Cookie
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    
    // 通用函数：缩短地址显示
    function shortenAddress(address) {
        if (!address) return '';
        // 保留原始大小写，不进行任何转换
        return address.substring(0, 6) + '...' + address.substring(address.length - 4);
    }
    
    // 通用函数：修正地址大小写（主要用于SOL地址）
    function correctAddressCase(address) {
        // SOL地址格式是Base58编码，应该保持原样
        return address;
    }
    
    // 通用函数：显示通知
    function showNotification(message, type = 'info') {
        if (typeof Toastify === 'function') {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "center",
                backgroundColor: type === 'success' ? "#4caf50" : 
                                 type === 'error' ? "#f44336" : 
                                 type === 'warning' ? "#ff9800" : "#2196f3",
            }).showToast();
        } else {
            console.log(`通知 [${type}]: ${message}`);
            // 备用方案：使用alert
            if (type === 'error') {
                alert(message);
            }
        }
    }
    
    // 钱包连接函数
    async function connectPhantomWallet() {
        try {
            console.log('尝试连接模拟钱包...');
            
            // 使用SOL超级管理员地址
            const address = 'EeYfRdpGtdTM9pLDrXFq39C2SKYD9SQkijw7keUKJtLR';
            console.log('钱包地址:', address);
            
            // 存储到localStorage，确保页面刷新后能记住状态
            localStorage.setItem('walletConnected', 'true');
            localStorage.setItem('walletAddress', address);
            localStorage.setItem('eth_address', address);
            
            // 设置cookie，确保后端可以读取（关键步骤）
            document.cookie = `eth_address=${address}; path=/; max-age=86400`;
            
            // 设置当前页面的URL参数
            if (history.replaceState) {
                let url = new URL(window.location.href);
                url.searchParams.set('eth_address', address);
                history.replaceState(null, '', url.href);
                console.log('已更新URL参数，添加钱包地址:', address);
            }
            
            // 更新Ajax请求头，确保后续API调用都带有钱包地址
            if (typeof $ !== 'undefined') {
                $.ajaxSetup({
                    headers: {
                        'X-Eth-Address': address
                    }
                });
            }
            
            // 更新全局钱包状态
            window.walletState.address = address;
            window.walletState.isConnected = true;
            window.walletState.getConnectionStatus = function() { return true; };
            window.walletState.getAddress = function() { return address; };
            
            // 更新UI
            updateWalletUI();
            
            // 检查管理员权限
            checkIfAdmin();
            
            // 更新页面上所有需要钱包地址的链接
            updateAllWalletDependentLinks(address);
            
            // 加载用户资产
            console.log('钱包连接成功，加载用户资产信息');
            loadUserAssets();
            
            // 显示钱包菜单
            const menu = document.getElementById('walletMenu');
            if (menu) {
                menu.classList.add('show');
            }
            
            // 触发钱包连接事件 - 通知页面钱包已连接
            const event = new CustomEvent('walletConnected', { detail: { address: address } });
            window.dispatchEvent(event);
            
            return true; // 返回连接成功
        } catch (error) {
            console.error('钱包连接失败:', error);
            return false; // 返回连接失败
        }
    }
    
    // 断开钱包连接
    function disconnectPhantomWallet() {
        try {
            console.log('断开钱包连接');
            
            // 首先获取当前连接的地址，用于日志
            const currentAddress = window.walletState.address;
            console.log('断开钱包地址:', currentAddress);
            
            // 移除存储的钱包信息
            localStorage.removeItem('walletConnected');
            localStorage.removeItem('walletAddress');
            localStorage.removeItem('eth_address');
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('walletUsdcBalance');
            
            // 清除cookie
            document.cookie = "eth_address=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            
            // 更新全局状态 - 保持函数引用
            window.walletState = {
                isConnected: false,
                address: null,
                usdcBalance: "0.00",
                getConnectionStatus: function() { return this.isConnected; },
                getAddress: function() { return this.address; },
                getUsdcBalance: function() { return this.usdcBalance || "0.00"; }
            };
            
            // 更新UI
            updateWalletUI();
            
            // 隐藏用户资产部分
            const userAssetsSection = document.getElementById('userAssetsSection');
            if (userAssetsSection) {
                userAssetsSection.style.display = 'none';
            }
            
            // 隐藏管理入口
            const adminEntry = document.getElementById('adminEntry');
            if (adminEntry) {
                adminEntry.style.display = 'none';
            }
            
            // 隐藏钱包菜单
            const menu = document.getElementById('walletMenu');
            if (menu) {
                menu.classList.remove('show');
            }
            
            // 触发钱包断开连接事件
            const event = new CustomEvent('walletDisconnected');
            window.dispatchEvent(event);
            
            // 提示用户
            try {
                showNotification("{{ _('Wallet disconnected') }}", 'success');
            } catch (e) {
                console.log('钱包已断开连接');
            }
            
            return true; // 返回断开连接成功
        } catch (error) {
            console.error('断开钱包连接时出错:', error);
            return false; // 返回断开连接失败
        }
    }
    
    // 更新钱包UI
    function updateWalletUI() {
        console.log('更新钱包UI...');
        const isConnected = window.walletState.isConnected;
        const address = window.walletState.address;
        
        // 更新按钮文本
        const btnText = document.getElementById('walletBtnText');
        if (btnText) {
            if (isConnected && address) {
                btnText.textContent = address.slice(0, 4) + '...' + address.slice(-4);
            } else {
                btnText.textContent = "{{ _('Connect Wallet') }}";
            }
        }
        
        // 更新钱包地址显示
        const addressDisplay = document.getElementById('walletAddressDisplay');
        if (addressDisplay) {
            if (isConnected && address) {
                addressDisplay.textContent = address.slice(0, 6) + '...' + address.slice(-6);
            } else {
                addressDisplay.textContent = "{{ _('Not Connected') }}";
            }
        }
        
        // 更新钱包按钮样式
        const walletBtn = document.getElementById('walletBtn');
        if (walletBtn) {
            if (isConnected) {
                walletBtn.classList.remove('btn-outline-primary');
                walletBtn.classList.add('btn-primary');
            } else {
                walletBtn.classList.remove('btn-primary');
                walletBtn.classList.add('btn-outline-primary');
            }
        }
        
        // 更新USDC余额显示
        const balanceElement = document.getElementById('usdcBalance');
        if (balanceElement) {
            if (isConnected && window.walletState.usdcBalance) {
                balanceElement.textContent = window.walletState.usdcBalance || "0.00";
            } else {
                balanceElement.textContent = "0.00";
            }
        }
        
        // 触发自定义事件，通知其他页面元素钱包UI已更新
        const event = new CustomEvent('walletUIUpdated', { 
            detail: { 
                isConnected: isConnected,
                address: address,
                usdcBalance: window.walletState.usdcBalance
            }
        });
        window.dispatchEvent(event);
    }
    
    // 切换钱包菜单显示
    function toggleWalletMenu() {
        console.log('toggleWalletMenu 函数被调用');
        
        // 检查钱包连接状态
        const isConnected = window.walletState && window.walletState.isConnected && window.walletState.address;
        
        // 获取菜单元素
        const menu = document.getElementById('walletMenu');
        
        if (!menu) {
            console.warn('未找到钱包菜单元素');
            return;
        }
        
        if (isConnected) {
            // 已连接状态 - 切换菜单显示/隐藏
            console.log('钱包已连接，切换菜单显示/隐藏');
            menu.classList.toggle('show');
        } else {
            // 未连接状态 - 打开钱包选择器
            console.log('钱包未连接，打开钱包选择器');
            showWalletOptions();
        }
    }
    
    // 显示钱包选择器
    function showWalletOptions() {
        console.log('显示钱包选择器');
        
        // 检查是否在移动设备上
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        // 创建钱包选择对话框
        let modalHtml = `
            <div class="modal fade" id="walletChooserModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">选择钱包</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="wallet-options">
                                <!-- MetaMask选项 -->
                                <button class="wallet-option mb-2" onclick="connectSpecificWallet('metamask')">
                                    <img src="https://cdn.iconscout.com/icon/free/png-256/metamask-2728406-2261817.png" width="24" height="24" class="me-2">
                                    MetaMask
                                </button>`;
        
        // 如果是iOS设备，添加特殊的iOS钱包选项
        if (isIOS) {
            modalHtml += `
                <!-- iOS特有的钱包选项 -->
                <button class="wallet-option mb-2" onclick="connectSpecificWallet('rainbow')">
                    <img src="https://rainbowkit.com/rainbow.svg" width="24" height="24" class="me-2">
                    Rainbow钱包
                </button>
                <button class="wallet-option mb-2" onclick="connectSpecificWallet('imtoken')">
                    <img src="https://token.im/favicon.ico" width="24" height="24" class="me-2">
                    imToken钱包
                </button>`;
        }
        
        // 添加WalletConnect选项，适用于所有设备
        modalHtml += `
                <!-- WalletConnect选项，适合移动端 -->
                <button class="wallet-option mb-2" onclick="connectSpecificWallet('walletconnect')">
                    <img src="https://1000logos.net/wp-content/uploads/2022/05/WalletConnect-Logo.jpg" width="24" height="24" class="me-2">
                    WalletConnect (手机端)
                </button>
                
                <!-- 模拟钱包选项 -->
                <button class="wallet-option mb-2" onclick="connectSpecificWallet('mock')">
                    <i class="fas fa-wallet me-2"></i>
                    模拟钱包 (测试用)
                </button>
            </div>
            
            <!-- 移动端提示 -->
            ${isMobile ? `
            <div class="mt-3 p-2 bg-light rounded">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    在移动设备上，选择后可能需要切换到相应的钱包App完成连接
                </small>
            </div>` : ''}
        </div>
    </div>
</div>`;
        
        // 创建并添加样式
        const styleEl = document.createElement('style');
        styleEl.textContent = `
            .wallet-option {
                display: flex;
                align-items: center;
                padding: 10px 15px;
                border: 1px solid #dee2e6;
                border-radius: 8px;
                background-color: white;
                transition: all 0.2s;
                width: 100%;
                text-align: left;
            }
            
            .wallet-option:hover {
                background-color: #f8f9fa;
                border-color: #ced4da;
            }
        `;
        document.head.appendChild(styleEl);
        
        // 清除已存在的模态框
        let existingModal = document.getElementById('walletChooserModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // 添加模态框到DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // 初始化并显示Bootstrap模态框
        let bootstrapModal;
        try {
            bootstrapModal = new bootstrap.Modal(document.getElementById('walletChooserModal'));
            bootstrapModal.show();
        } catch (error) {
            console.error('显示钱包模态框失败:', error);
            alert('无法打开钱包选择器，请尝试刷新页面');
        }
    }
    
    // 全局暴露copyWalletAddress函数，因为它在HTML中被直接调用
    window.copyWalletAddress = async function() {
        const address = window.walletState.address;
        if (!address) {
            console.log('没有可复制的钱包地址');
            return;
        }
        
        try {
            await navigator.clipboard.writeText(address);
            // 显示复制成功提示
            const addressDisplay = document.getElementById('walletAddressDisplay');
            const originalText = addressDisplay.textContent;
            addressDisplay.textContent = '地址已复制！';
            setTimeout(() => {
                addressDisplay.textContent = originalText;
            }, 1000);
            console.log('钱包地址已复制到剪贴板');
        } catch (err) {
            console.error('复制钱包地址失败:', err);
            alert('复制地址失败，请手动复制');
        }
    }
    
    // 连接特定钱包
    function connectSpecificWallet(walletType) {
        console.log(`尝试连接钱包: ${walletType}`);
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('walletChooserModal'));
        if (modal) modal.hide();
        
        // 根据类型连接不同钱包
        switch(walletType) {
            case 'metamask':
                connectMetaMaskWallet();
                break;
            case 'rainbow':
                connectRainbowWallet();
                break;
            case 'imtoken':
                connectImTokenWallet();
                break;
            case 'walletconnect':
                connectWalletConnect();
                break;
            case 'mock':
            default:
                // 使用已有的模拟钱包功能
                connectPhantomWallet();
                break;
        }
    }
    
    // 连接MetaMask钱包
    async function connectMetaMaskWallet() {
        try {
            console.log('尝试连接MetaMask');
            
            // 检查是否已安装MetaMask
            if (!window.ethereum) {
                if (isMobile) {
                    // 在移动端，打开MetaMask下载页或通过深度链接
                    window.open('https://metamask.app.link/dapp/' + window.location.host + window.location.pathname);
                } else {
                    alert('请先安装MetaMask钱包: https://metamask.io/download/');
                }
                return;
            }
            
            // 请求连接账户
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            if (accounts.length === 0) {
                throw new Error('未能获取钱包地址');
            }
            
            const address = accounts[0];
            console.log('MetaMask钱包连接成功:', address);
            
            // 更新状态
            localStorage.setItem('walletConnected', 'true');
            localStorage.setItem('walletAddress', address);
            localStorage.setItem('eth_address', address);
            localStorage.setItem('walletType', 'ethereum');
            
            // 设置cookie
            document.cookie = `eth_address=${address}; path=/; max-age=86400`;
            
            // 更新全局钱包状态
            window.walletState.address = address;
            window.walletState.isConnected = true;
            window.walletState.walletType = 'ethereum';
            
            // 设置账户变更监听器
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', function (accounts) {
                    console.log('钱包账户已变更:', accounts);
                    
                    if (accounts.length === 0) {
                        // 用户断开了连接
                        disconnectPhantomWallet();
                    } else {
                        // 更新为新账户
                        const newAddress = accounts[0];
                        window.walletState.address = newAddress;
                        localStorage.setItem('walletAddress', newAddress);
                        localStorage.setItem('eth_address', newAddress);
                        document.cookie = `eth_address=${newAddress}; path=/; max-age=86400`;
                        
                        // 更新UI
                        updateWalletUI();
                        
                        // 发送钱包切换事件
                        const event = new CustomEvent('walletChanged', { detail: { address: newAddress } });
                        window.dispatchEvent(event);
                    }
                });
            }
            
            // 更新UI
            updateWalletUI();
            
            // 触发钱包连接事件
            const event = new CustomEvent('walletConnected', { detail: { address: address } });
            window.dispatchEvent(event);
            
            return true;
        } catch (error) {
            console.error('连接MetaMask失败:', error);
            alert('无法连接MetaMask钱包: ' + error.message);
            return false;
        }
    }
    
    // 连接Rainbow钱包 (iOS)
    function connectRainbowWallet() {
        console.log('尝试连接Rainbow钱包');
        
        // 保存当前状态，以便回到当前页面
        localStorage.setItem('wallet_return_url', window.location.href);
        localStorage.setItem('wallet_connect_attempt', 'rainbow');
        
        // 针对iOS设备优化的唤起方式
        const currentUrl = encodeURIComponent(window.location.href);
        const fallbackUrl = encodeURIComponent(`https://${window.location.host}/wallet-connect-callback`);
        
        // 现代方式：使用Universal Links
        const universalLink = `https://rnbwapp.com/wc?uri=${currentUrl}&fallback=${fallbackUrl}`;
        
        // 备选方式：使用Deep Link
        const deepLink = `rainbow://wc?uri=${currentUrl}`;
        
        // 先尝试Universal Link，这是Apple推荐的方式
        window.location.href = universalLink;
        
        // 设置一个短暂的超时，如果Universal Link失败，尝试Deep Link
        setTimeout(function() {
            // 检查页面是否仍在浏览器中（未成功跳转）
            if (document.hasFocus()) {
                console.log('Universal Link可能未成功，尝试使用Deep Link');
                window.location.href = deepLink;
                
                // 再次设置超时，如果Deep Link也失败，显示安装提示
                setTimeout(function() {
                    if (document.hasFocus()) {
                        // 通知用户可能需要安装Rainbow钱包
                        alert('未能打开Rainbow钱包。请确保您已安装Rainbow钱包，或尝试其他钱包。');
                        // 提供下载链接
                        window.open('https://rainbow.me', '_blank');
                    }
                }, 1500);
            }
        }, 1500);
        
        return true;
    }
    
    // 连接imToken钱包
    function connectImTokenWallet() {
        console.log('尝试连接imToken钱包');
        
        // 保存当前状态
        localStorage.setItem('wallet_return_url', window.location.href);
        localStorage.setItem('wallet_connect_attempt', 'imtoken');
        
        // 优化的唤起方式
        const currentUrl = encodeURIComponent(window.location.href);
        
        // 尝试打开imToken钱包
        window.location.href = `imtokenv2://navigate/DappView?url=${currentUrl}`;
        
        // 设置超时检测是否成功唤起
        setTimeout(function() {
            if (document.hasFocus()) {
                console.log('imToken可能未成功唤起，显示提示');
                alert('未能打开imToken钱包。请确保您已安装imToken，或尝试其他钱包。');
                window.open('https://token.im/download', '_blank');
            }
        }, 2000);
        
        return true;
    }
    
    // 连接WalletConnect - 特别适合移动设备
    function connectWalletConnect() {
        console.log('尝试通过WalletConnect连接钱包');
        
        // 保存当前状态
        localStorage.setItem('wallet_return_url', window.location.href);
        localStorage.setItem('wallet_connect_attempt', 'walletconnect');
        
        // 检查是否在移动设备上
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        if (isMobile) {
            // 在移动设备上，提供更多选项
            const modalHtml = `
                <div class="modal fade" id="mobileWalletModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">选择您的钱包</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="wallet-list">
                                    <button class="wallet-option mb-2" onclick="openWalletApp('metamask')">
                                        <img src="https://cdn.iconscout.com/icon/free/png-256/metamask-2728406-2261817.png" width="24" height="24" class="me-2">
                                        MetaMask
                                    </button>
                                    <button class="wallet-option mb-2" onclick="openWalletApp('trustwallet')">
                                        <img src="https://trustwallet.com/assets/images/favicon.png" width="24" height="24" class="me-2">
                                        Trust Wallet
                                    </button>
                                    <button class="wallet-option mb-2" onclick="openWalletApp('tokenpocket')">
                                        <img src="https://www.tokenpocket.pro/favicon.ico" width="24" height="24" class="me-2">
                                        TokenPocket
                                    </button>
                                </div>
                                <div class="mt-3 p-2 bg-light rounded">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        选择您的钱包应用，系统将尝试打开它。如果未安装，将提示您安装。
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加钱包应用打开函数
            window.openWalletApp = function(walletName) {
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('mobileWalletModal'));
                if (modal) modal.hide();
                
                const currentUrl = encodeURIComponent(window.location.href);
                let walletUrl = '';
                let storeUrl = '';
                
                // 根据不同钱包设置不同的URL
                switch(walletName) {
                    case 'metamask':
                        walletUrl = `metamask://dapp/${window.location.host}${window.location.pathname}`;
                        storeUrl = 'https://metamask.io/download/';
                        break;
                    case 'trustwallet':
                        walletUrl = `trust://wc?uri=${currentUrl}`;
                        storeUrl = 'https://trustwallet.com/download';
                        break;
                    case 'tokenpocket':
                        walletUrl = `tpoutside://wc?uri=${currentUrl}`;
                        storeUrl = 'https://www.tokenpocket.pro/en/download/app';
                        break;
                }
                
                // 尝试打开钱包应用
                window.location.href = walletUrl;
                
                // 设置超时检测是否成功唤起
                setTimeout(function() {
                    if (document.hasFocus()) {
                        if (confirm(`未能打开${walletName}，是否前往下载？`)) {
                            window.open(storeUrl, '_blank');
                        }
                    }
                }, 2000);
            };
            
            // 添加并显示模态框
            if (!document.getElementById('mobileWalletModal')) {
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('mobileWalletModal'));
            modal.show();
        } else {
            // 在桌面设备上，显示二维码或基于浏览器的连接选项
            alert('WalletConnect集成功能正在开发中，敬请期待！\n桌面端将支持二维码扫描连接。');
        }
        
        return true;
    }
    
    // 更新所有依赖钱包地址的链接
    function updateAllWalletDependentLinks(address) {
        if (!address) return;
        
        console.log('更新所有依赖钱包地址的链接...');
        
        try {
            // 更新管理后台链接
            const adminNavLink = document.getElementById('adminNavLink');
            if (adminNavLink) {
                // 重要：直接使用带参数的URL地址，不使用表单提交
                adminNavLink.href = `/admin/dashboard?eth_address=${address}`;
                // 移除之前添加的onclick事件处理器
                adminNavLink.onclick = null;
                console.log('已更新导航栏管理入口链接');
            }
            
            // 更新资产详情页中的管理按钮链接
            const adminBackendBtn = document.getElementById('adminBackendBtn');
            if (adminBackendBtn) {
                adminBackendBtn.href = `/admin/dashboard?eth_address=${address}`;
                console.log('已更新资产详情页管理后台按钮链接');
            }
            
            // 更新分红管理按钮链接
            const dividendManagementBtn = document.getElementById('dividendManagementBtn');
            if (dividendManagementBtn) {
                const tokenSymbol = dividendManagementBtn.getAttribute('data-token-symbol') || 
                                    (window.ASSET_CONFIG ? window.ASSET_CONFIG.token_symbol : '');
                if (tokenSymbol) {
                    dividendManagementBtn.href = `/assets/${tokenSymbol}/dividend?eth_address=${address}`;
                    console.log('已更新分红管理按钮链接');
                }
            }
            
            // 重要：如果存在refreshManagementOptions函数，调用它以刷新管理选项的显示
            if (typeof refreshManagementOptions === 'function') {
                console.log('调用页面特定的refreshManagementOptions函数');
                refreshManagementOptions();
            }
            
            console.log('所有依赖钱包地址的链接更新完成');
        } catch (error) {
            console.error('更新链接时出错:', error);
        }
    }
    
    // 获取USDC余额
    async function fetchUsdcBalance(address) {
        if (!address) return;
        
        try {
            console.log('获取钱包USDC余额...');
            
            // 使用钱包对象的getWalletBalance方法获取余额
            if (window.walletState && typeof window.walletState.getWalletBalance === 'function') {
                const balance = await window.walletState.getWalletBalance();
                if (balance) {
                    console.log('获取到USDC余额:', balance.value);
                    window.walletState.usdcBalance = balance.value;
                    
                    // 更新UI显示
                    const balanceElement = document.getElementById('usdcBalance');
                    if (balanceElement) {
                        balanceElement.textContent = balance.value;
                    }
                    
                    // 触发余额更新事件
                    const event = new CustomEvent('balanceUpdated', { 
                        detail: { 
                            balance: balance.value,
                            symbol: balance.symbol
                        }
                    });
                    window.dispatchEvent(event);
                }
            } else {
                console.warn('钱包对象没有getWalletBalance方法');
            }
        } catch (error) {
            console.error('获取USDC余额失败:', error);
        }
    }
    
    // 检查钱包状态并初始化
    function initializeWalletStatus() {
        console.log('初始化钱包状态...');
        
        // 首先检查是否是从钱包应用返回的
        checkWalletReturn();
        
        // 尝试从不同来源获取钱包地址
        let savedAddress = null;
        
        // 优先从cookie获取
        savedAddress = getCookie('eth_address');
        
        // 如果cookie中没有，尝试从localStorage获取
        if (!savedAddress && localStorage.getItem('walletConnected') === 'true') {
            savedAddress = localStorage.getItem('walletAddress') || localStorage.getItem('eth_address');
        }
        
        if (savedAddress) {
            console.log('找到保存的钱包地址:', savedAddress);
            
            // 修正地址大小写（主要针对SOL地址）
            const correctedAddress = correctAddressCase(savedAddress);
            
            // 更新全局状态
            window.walletState.address = correctedAddress;
            window.walletState.isConnected = true;
            
            // 设置cookie，确保后端可以读取
            document.cookie = `eth_address=${correctedAddress}; path=/; max-age=86400`;
            
            // 如果当前是Ajax请求，设置请求头
            if (typeof $ !== 'undefined') {
                $.ajaxSetup({
                    headers: {
                        'X-Eth-Address': correctedAddress
                    }
                });
            }
            
            // 更新UI
            updateWalletUI();
            
            // 检查管理员权限
            checkIfAdmin();
            
            // 更新依赖钱包地址的链接
            updateAllWalletDependentLinks(correctedAddress);
            
            // 获取余额
            const savedBalance = localStorage.getItem('walletUsdcBalance');
            if (savedBalance) {
                window.walletState.usdcBalance = savedBalance;
                
                // 更新余额显示
                const balanceElement = document.getElementById('usdcBalance');
                if (balanceElement) {
                    balanceElement.textContent = savedBalance;
                }
            }
            
            // 尝试更新余额
            fetchUsdcBalance(correctedAddress);
            
            // 加载用户资产
            loadUserAssets();
            
            // 触发钱包连接事件 - 通知页面钱包已连接
            const event = new CustomEvent('walletConnected', { detail: { address: correctedAddress } });
            window.dispatchEvent(event);
            
            return true;
        } else {
            console.log('未找到保存的钱包状态或钱包已断开');
            
            // 确保钱包菜单是关闭的
            const menu = document.getElementById('walletMenu');
            if (menu) {
                menu.classList.remove('show');
            }
            
            return false;
        }
    }
    
    // 检查是否是管理员
    function checkIfAdmin() {
        try {
            // 首先检查本地存储中是否已有管理员状态
            const storedAdminStatus = localStorage.getItem('isAdmin');
            const address = window.walletState.address || localStorage.getItem('walletAddress') || getCookie('eth_address');
            
            if (storedAdminStatus === 'true') {
                // 如果本地已存储管理员状态为true，直接显示管理入口
                const adminEntry = document.getElementById('adminEntry');
                const adminNavLink = document.getElementById('adminNavLink');
                
                if (adminEntry) {
                    adminEntry.style.display = 'block'; // 确保显示
                    console.log('从本地存储检测到管理员状态：是管理员，显示管理入口');
                    
                    // 重要：确保管理入口链接包含钱包地址
                    if (adminNavLink && address) {
                        // 恢复最初的链接方式，直接使用URL参数
                        adminNavLink.href = `/admin/dashboard?eth_address=${address}`;
                        // 移除onclick事件，让链接自然工作
                        adminNavLink.onclick = null;
                        console.log('已更新管理入口链接，添加钱包地址参数:', address);
                    }
                }
                return;
            }
            
            if (!address) {
                console.log('未找到钱包地址，无法检查管理员状态');
                return;
            }
            
            console.log('检查管理员状态:', address);
            
            // 根据地址类型决定是否转换为小写
            // ETH地址以0x开头，需要转为小写
            // SOL地址不以0x开头，保持原样（大小写敏感）
            const addressStr = address.startsWith('0x') ? address.toLowerCase() : address;
            
            fetch('/api/check_admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Eth-Address': addressStr
                },
                body: JSON.stringify({address: addressStr})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('检查管理员状态请求失败：' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('管理员状态检查结果:', data);
                if (data.is_admin) {
                    // 存储管理员状态到本地存储
                    localStorage.setItem('isAdmin', 'true');
                    localStorage.setItem('adminAddress', addressStr);
                    
                    // 显示管理入口
                    const adminEntry = document.getElementById('adminEntry');
                    const adminNavLink = document.getElementById('adminNavLink');
                    
                    if (adminEntry) {
                        adminEntry.style.display = 'block'; // 确保始终显示
                        console.log('API确认是管理员，显示管理入口');
                        
                        // 重要：确保管理入口链接包含钱包地址
                        if (adminNavLink && address) {
                            // 恢复最初的链接方式，直接使用URL参数
                            adminNavLink.href = `/admin/dashboard?eth_address=${address}`;
                            // 移除onclick事件，让链接自然工作
                            adminNavLink.onclick = null; 
                            console.log('已更新管理入口链接，添加钱包地址参数:', address);
                        }
                    }
                } else {
                    // 非管理员，清除可能存在的管理员状态
                    localStorage.removeItem('isAdmin');
                    localStorage.removeItem('adminAddress');
                    
                    // 隐藏管理入口
                    const adminEntry = document.getElementById('adminEntry');
                    if (adminEntry) {
                        adminEntry.style.display = 'none'; // 使用style.display来控制
                        console.log('API确认不是管理员，隐藏管理入口');
                    }
                }
                
                // 重要：即使不是全局管理员，也检查是否有当前资产的分红管理权限
                checkDividendPermission(addressStr);
            })
            .catch(error => {
                console.error('检查管理员状态失败:', error);
                // 发生错误时，为安全起见，隐藏管理入口
                const adminEntry = document.getElementById('adminEntry');
                if (adminEntry) {
                    adminEntry.style.display = 'none';
                }
            });
        } catch (error) {
            console.error('执行管理员检查时出错:', error);
        }
    }
    
    // 检查分红管理权限 - 这个函数检查用户是否对当前资产有分红管理权限
    function checkDividendPermission(address) {
        try {
            // 检查是否在资产详情页面
            const tokenSymbol = window.ASSET_CONFIG ? window.ASSET_CONFIG.token_symbol : null;
            if (!tokenSymbol || !address) {
                // 如果不在资产详情页或没有地址，则跳过
                return;
            }
            
            console.log(`检查地址 ${address} 对资产 ${tokenSymbol} 的分红管理权限`);
            
            // 调用API检查分红管理权限
            fetch(`/api/assets/${tokenSymbol}/check_dividend_permission`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Eth-Address': address
                },
                body: JSON.stringify({address: address})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('检查分红管理权限请求失败');
                }
                return response.json();
            })
            .then(data => {
                console.log('分红管理权限检查结果:', data);
                
                // 将结果保存到localStorage，供页面使用
                if (data.has_permission) {
                    localStorage.setItem(`dividend_permission_${tokenSymbol}`, 'true');
                    console.log(`用户拥有资产 ${tokenSymbol} 的分红管理权限`);
                } else {
                    localStorage.removeItem(`dividend_permission_${tokenSymbol}`);
                    console.log(`用户没有资产 ${tokenSymbol} 的分红管理权限`);
                }
                
                // 触发自定义事件，通知页面更新管理选项显示
                const event = new CustomEvent('dividendPermissionChecked', {
                    detail: {
                        tokenSymbol: tokenSymbol,
                        hasPermission: data.has_permission
                    }
                });
                window.dispatchEvent(event);
            })
            .catch(error => {
                console.error('检查分红管理权限失败:', error);
                // 错误时清除权限
                localStorage.removeItem(`dividend_permission_${tokenSymbol}`);
            });
        } catch (error) {
            console.error('执行分红权限检查时出错:', error);
        }
    }
    
    // 检查是否从钱包应用返回
    function checkWalletReturn() {
        // 检查是否有返回URL和钱包连接尝试记录
        const returnUrl = localStorage.getItem('wallet_return_url');
        const connectAttempt = localStorage.getItem('wallet_connect_attempt');
        
        if (returnUrl && connectAttempt) {
            console.log('检测到从钱包应用返回，尝试类型:', connectAttempt);
            
            // 清除状态，避免重复处理
            localStorage.removeItem('wallet_return_url');
            localStorage.removeItem('wallet_connect_attempt');
            
            // 检查URL中是否包含钱包返回的参数
            const urlParams = new URLSearchParams(window.location.search);
            let walletAddress = null;
            
            // 不同钱包可能使用不同参数名
            if (urlParams.has('address')) {
                walletAddress = urlParams.get('address');
            } else if (urlParams.has('wallet')) {
                walletAddress = urlParams.get('wallet');
            } else if (urlParams.has('account')) {
                walletAddress = urlParams.get('account');
            } else if (urlParams.has('eth_address')) {
                walletAddress = urlParams.get('eth_address');
            }
            
            if (walletAddress) {
                console.log('从URL中获取到钱包地址:', walletAddress);
                
                // 更新钱包状态
                localStorage.setItem('walletConnected', 'true');
                localStorage.setItem('walletAddress', walletAddress);
                localStorage.setItem('eth_address', walletAddress);
                
                // 设置cookie
                document.cookie = `eth_address=${walletAddress}; path=/; max-age=86400`;
                
                // 更新全局钱包状态
                window.walletState.address = walletAddress;
                window.walletState.isConnected = true;
                
                // 清理URL参数
                if (history.replaceState) {
                    let cleanUrl = new URL(window.location.href);
                    cleanUrl.search = '';
                    history.replaceState(null, document.title, cleanUrl.href);
                }
                
                // 更新UI
                setTimeout(function() {
                    updateWalletUI();
                    checkIfAdmin();
                    loadUserAssets();
                }, 300);
                
                console.log('已自动完成钱包连接');
                return true;
            } else {
                console.log('未从URL获取到钱包地址，可能连接失败或用户取消');
            }
        }
        
        return false;
    }

    // 加载用户资产列表
    async function loadUserAssets() {
        const walletAssetsList = document.getElementById('walletAssetsList');
        const userAssetsSection = document.getElementById('userAssetsSection');
        
        if (!walletAssetsList || !userAssetsSection) return;
        
        console.log('尝试加载用户资产信息...');
        
        // 检查钱包是否连接
        if (!window.walletState.isConnected || !window.walletState.address) {
            console.log('钱包未连接，不加载资产信息');
            userAssetsSection.style.display = 'none';
            return;
        }
        
        // 显示资产部分并添加加载指示器
        userAssetsSection.style.display = 'block';
        walletAssetsList.innerHTML = `
            <div class="text-center py-2">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <span class="small text-muted ms-2">加载资产中...</span>
            </div>
        `;
        
        try {
            // 获取用户资产列表
            console.log('正在获取用户资产数据，钱包地址:', window.walletState.address);
            const response = await fetch('/api/user/assets', {
                headers: {
                    'X-Eth-Address': window.walletState.address || ''
                },
                cache: 'no-cache'
            });
            
            if (!response.ok) {
                console.error('获取用户资产失败:', response.status);
                walletAssetsList.innerHTML = '<div class="text-center py-2 small text-muted">加载资产失败</div>';
                return;
            }
            
            const assets = await response.json();
            console.log('获取到的资产数据:', assets);
            
            if (!Array.isArray(assets) || assets.length === 0) {
                walletAssetsList.innerHTML = '<div class="text-center py-2 small text-muted">暂无持有资产</div>';
                return;
            }
            
            // 创建资产列表HTML
            let assetsHTML = '';
            
            // 最多显示5项
            const showAssets = assets.slice(0, 5);
            
            showAssets.forEach(asset => {
                // 获取代币符号 - 尝试多个可能的字段名
                const tokenSymbol = asset.token_symbol || asset.symbol || asset.token_code || 'USDC';
                
                // 确保正确获取资产ID，尝试多个可能的字段名
                const assetId = asset.asset_id || asset.id || '';
                
                // 打印日志以便调试
                console.log('资产数据:', asset, '使用ID:', assetId, '代币符号:', tokenSymbol);
                
                // 使用正确的URL格式，与后端路由定义匹配
                const href = tokenSymbol ? `/assets/${tokenSymbol}` : (assetId ? `/assets/${assetId}` : 'javascript:void(0)');
                
                // 保持原有资产项式样
                assetsHTML += `
                <a href="${href}" class="asset-item" style="text-decoration: none; color: inherit; display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
                    <div class="asset-name">
                        <img src="${asset.image_url || '/static/images/default.png'}" class="asset-icon" alt="${asset.name}" onerror="this.src='/static/images/default.png';">
                        <span class="text-truncate" style="max-width: 120px;" title="${asset.name}">${asset.name}</span>
                        <span class="asset-holding ms-1">(${asset.holding_amount})</span>
                    </div>
                    <div style="font-weight: 500;">${tokenSymbol}</div>
                </a>`;
            });
            
            // 如果有更多资产，添加查看全部链接
            if (assets.length > 5) {
                assetsHTML += `<a href="/user/assets" class="view-all-link">查看全部 ${assets.length} 项资产 <i class="fas fa-chevron-right fa-xs"></i></a>`;
            }
            
            walletAssetsList.innerHTML = assetsHTML;
            
        } catch (error) {
            console.error('加载用户资产失败:', error);
            walletAssetsList.innerHTML = '<div class="text-center py-2 small text-muted">加载资产失败</div>';
        }
    }

    // 语言切换
    function changeLanguage(lang) {
        document.cookie = `language=${lang};path=/;max-age=31536000`;
        window.location.reload();
    }
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        console.log('页面加载完成，初始化钱包状态...');
        
        // 检查是否是从钱包应用返回的
        checkWalletReturn();
        
        // 从URL参数获取钱包地址
        const urlParams = new URLSearchParams(window.location.search);
        const urlEthAddress = urlParams.get('eth_address');
        
        if (urlEthAddress) {
            console.log('从URL获取到钱包地址:', urlEthAddress);
            
            // 设置cookie
            document.cookie = `eth_address=${urlEthAddress}; path=/; max-age=86400`;
            
            // 存储到localStorage
            localStorage.setItem('walletConnected', 'true');
            localStorage.setItem('walletAddress', urlEthAddress);
            localStorage.setItem('eth_address', urlEthAddress);
            
            // 更新全局钱包状态
            window.walletState.address = urlEthAddress;
            window.walletState.isConnected = true;
            
            // 原始处理逻辑：保留管理后台的eth_address参数
            if (!window.location.pathname.startsWith('/admin') && history.replaceState) {
                let cleanUrl = new URL(window.location.href);
                cleanUrl.searchParams.delete('eth_address');
                history.replaceState(null, document.title, cleanUrl.href);
            }
        }
        
        // 初始化钱包状态（从cookie和localStorage获取）
        initializeWalletStatus();
        
        // 注册钱包按钮点击事件
        const walletBtn = document.getElementById('walletBtn');
        const walletMenu = document.getElementById('walletMenu');
        
        // 钱包按钮点击事件
        if (walletBtn) {
            walletBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation(); // 防止点击事件冒泡
                toggleWalletMenu();
            });
        }
        
        // 点击页面其他区域关闭菜单
        document.addEventListener('click', function(event) {
            if (walletMenu && walletMenu.classList.contains('show') && 
                !walletMenu.contains(event.target) && 
                walletBtn && !walletBtn.contains(event.target)) {
                console.log('点击了页面其他区域，关闭钱包菜单');
                walletMenu.classList.remove('show');
            }
        });
        
        // 对菜单项中的断开连接按钮进行初始化
        const disconnectBtn = document.getElementById('disconnectWalletBtn');
        if (disconnectBtn) {
            disconnectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                disconnectPhantomWallet();
                
                // 关闭菜单
                const menu = document.getElementById('walletMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
            });
        }
        
        // 对菜单项中的切换钱包按钮进行初始化
        const switchWalletBtn = document.getElementById('switchWalletBtn');
        if (switchWalletBtn) {
            switchWalletBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // 关闭当前钱包菜单
                const menu = document.getElementById('walletMenu');
                if (menu) {
                    menu.classList.remove('show');
                }
                
                // 显示钱包选择器
                showWalletOptions();
            });
        }
        
        // 每30秒检查一次钱包状态，确保所有页面同步
        setInterval(function() {
            if (window.walletState.isConnected) {
                // 如果已连接，检查localStorage中的地址是否与当前一致
                const storedAddress = localStorage.getItem('walletAddress');
                if (storedAddress && storedAddress !== window.walletState.address) {
                    console.log('检测到钱包地址不同步，更新状态...');
                    window.walletState.address = storedAddress;
                    updateWalletUI();
                }
            }
        }, 30000);
    });
    </script>
    
    <!-- 页面特定脚本 -->
    {% block scripts %}{% endblock %}

    <!-- 错误提示模态框 -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>错误
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="errorMessage"></div>
            </div>
        </div>
    </div>
</body>
</html>