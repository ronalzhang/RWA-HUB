# RWA-HUB 代码质量规范

## 📋 总则

本规范基于Admin模块重构经验制定，旨在避免代码质量问题，提升项目可维护性。

## 🚫 禁止事项

### 1. 巨型文件
```
❌ 禁止：单个文件超过500行代码
✅ 推荐：按功能模块拆分，每个文件200行以内
```

### 2. 重复代码
```python
# ❌ 禁止：重复函数定义
def validate_address(addr):  # 第100行
    # 实现...

def validate_address(addr):  # 第300行
    # 重复实现...

# ✅ 推荐：统一实现
def validate_address(addr):
    # 单一实现...
```

### 3. 混乱导入
```python
# ❌ 禁止：重复和无序导入
from datetime import datetime
import json
from datetime import date
import datetime
from json import dumps

# ✅ 推荐：统一有序导入
from datetime import datetime, date
import json
```

### 4. 硬编码
```python
# ❌ 禁止：硬编码魔数和字符串
if status == 4:  # 什么是4？
    
# ✅ 推荐：使用常量
ASSET_STATUS_DELETED = 4
if status == ASSET_STATUS_DELETED:
```

## ✅ 推荐实践

### 1. 模块化设计

#### 目录结构规范
```
app/routes/[模块名]/
├── __init__.py          # 蓝图定义和导出
├── models.py           # 数据模型
├── views.py            # 页面视图
├── api.py              # API接口
├── utils.py            # 工具函数
└── decorators.py       # 装饰器
```

#### 模块职责划分
```python
# auth.py - 只处理认证相关
# assets.py - 只处理资产管理
# users.py - 只处理用户管理
# 避免功能混杂
```

### 2. 命名规范

#### 函数命名
```python
# API函数
def api_get_assets_v2():
    """API版本命名规范"""

# 页面函数  
def assets_management_page():
    """页面版本命名规范"""

# 工具函数
def validate_solana_address():
    """功能描述清晰"""
```

#### 变量命名
```python
# ✅ 清晰的变量名
user_wallet_address = "0x123..."
asset_approval_status = 2
total_assets_count = 100

# ❌ 模糊的变量名
addr = "0x123..."
status = 2
count = 100
```

### 3. 注释规范

#### 模块注释
```python
"""
资产管理模块

主要功能：
- 资产CRUD操作
- 审核流程管理
- 数据导出功能

版本: v2.0
作者: 开发团队
"""
```

#### 函数注释
```python
def api_delete_asset_v2(asset_id):
    """
    删除资产（软删除）
    
    Args:
        asset_id (int): 资产ID
        
    Returns:
        dict: {"success": bool, "message": str}
        
    Raises:
        404: 资产不存在
        500: 服务器错误
    """
```

### 4. 错误处理

#### 统一错误响应
```python
def api_function():
    try:
        # 业务逻辑
        return jsonify({'success': True, 'data': result})
    except ValidationError as e:
        return jsonify({'success': False, 'error': str(e)}), 400
    except Exception as e:
        current_app.logger.error(f'操作失败: {str(e)}')
        return jsonify({'success': False, 'error': '服务器内部错误'}), 500
```

### 5. 数据库操作

#### 事务处理
```python
def update_asset_status(asset_id, status):
    try:
        asset = Asset.query.get_or_404(asset_id)
        asset.status = status
        db.session.commit()
        return True
    except Exception as e:
        db.session.rollback()
        raise e
```

## 🔧 重构指南

### 重构触发条件
1. **文件超过300行**：考虑拆分
2. **函数超过50行**：考虑拆解
3. **重复代码超过3处**：立即抽取
4. **导入超过20个**：检查是否合理

### 重构步骤
1. **备份原代码**
2. **分析功能模块**
3. **设计新架构**
4. **分步实施**
5. **测试验证**
6. **文档更新**

## 📊 质量检查清单

### 代码审查要点
- [ ] 文件大小合理（<500行）
- [ ] 无重复代码和函数
- [ ] 导入语句整洁有序
- [ ] 函数职责单一清晰
- [ ] 变量命名见名知义
- [ ] 注释完整准确
- [ ] 错误处理完善
- [ ] 性能考虑合理

### 提交前检查
```bash
# 检查文件行数
find . -name "*.py" -exec wc -l {} + | sort -n

# 检查重复代码
grep -r "def function_name" --include="*.py"

# 检查导入顺序
grep -n "^import\|^from" file.py
```

## 🛠️ 工具推荐

### 代码质量工具
```bash
# 代码格式化
black .

# 导入排序
isort .

# 代码检查
flake8 .
pylint app/

# 重复代码检测
vulture .
```

### IDE配置
```json
// VSCode设置
{
    "python.linting.enabled": true,
    "python.linting.flake8Enabled": true,
    "python.formatting.provider": "black",
    "editor.formatOnSave": true
}
```

## 📈 性能规范

### 查询优化
```python
# ✅ 使用分页
pagination = query.paginate(page=page, per_page=20)

# ✅ 避免N+1查询
assets = Asset.query.options(joinedload(Asset.creator)).all()

# ❌ 避免全表扫描
Asset.query.all()  # 危险操作
```

### 缓存策略
```python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_asset_types():
    """缓存不常变化的数据"""
    return AssetType.query.all()
```

## 🔄 维护流程

### 日常维护
1. **每周代码审查**：检查新增代码质量
2. **每月重构评估**：识别需要重构的模块
3. **季度性能优化**：分析和优化慢查询

### 版本管理
```bash
# 功能分支
git checkout -b feature/admin-refactor

# 提交规范
git commit -m "重构(admin): 拆分资产管理模块"

# 代码合并
git merge --no-ff feature/admin-refactor
```

## 📚 学习资源

### 推荐阅读
- 《重构：改善既有代码的设计》
- 《代码整洁之道》
- 《Flask Web开发实战》

### 在线资源
- [Python PEP 8风格指南](https://pep8.org/)
- [Flask最佳实践](https://flask.palletsprojects.com/patterns/)
- [重构技术手册](https://refactoring.guru/)

---

**文档版本**: v1.0  
**制定时间**: 2025-05-24  
**适用范围**: RWA-HUB项目全体代码  
**执行级别**: 强制 