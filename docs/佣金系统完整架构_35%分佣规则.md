# RWA-HUB ä½£é‡‘ç³»ç»Ÿå®Œæ•´æ¶æ„ - 35%åˆ†ä½£è§„åˆ™

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

RWA-HUBå¹³å°å®æ–½**äººäººéƒ½æ˜¯åˆ†é”€å•†**çš„ä½£é‡‘ç³»ç»Ÿï¼Œæ‰€æœ‰ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨äº«æœ‰35%æ¨èå¥–åŠ±åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹ç‚¹
- âœ… **äººäººåˆ†é”€å•†**ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½æ˜¯åˆ†é”€å•†ï¼Œæ— éœ€ç‰¹æ®Šè®¾ç½®
- âœ… **35%å›ºå®šä½£é‡‘**ï¼šç»Ÿä¸€çš„æ¨èå¥–åŠ±æ¯”ä¾‹ï¼Œç®€å•æ˜äº†
- âœ… **å®æ—¶åˆ°è´¦**ï¼šä½£é‡‘å®æ—¶è®¡ç®—å¹¶åˆ°è´¦ï¼Œå¯éšæ—¶æŸ¥çœ‹ä½™é¢
- âœ… **é’±åŒ…é›†æˆ**ï¼šä½£é‡‘ä½™é¢æ˜¾ç¤ºåœ¨ç”¨æˆ·é’±åŒ…ä¸­ï¼Œæ”¯æŒæç°
- âœ… **é…ç½®åŒ–ç®¡ç†**ï¼šæ‰€æœ‰æ–‡æ¡ˆå’Œè§„åˆ™å¯åœ¨åå°é…ç½®

## ğŸ“Š åˆ†ä½£è§„åˆ™è¯¦è§£

### 1. åŸºç¡€è§„åˆ™
```
æ‰€æœ‰ä¸‹çº§ç»™ä¸Šçº§åˆ†35%ä½£é‡‘
åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼š
1. æœ¬çº§ç”¨æˆ·çš„ç›´æ¥æ”¯ä»˜é‡‘é¢ Ã— 35%
2. æœ¬çº§ç”¨æˆ·çš„ä¸‹çº§ä¸Šè´¡ä¸Šæ¥çš„ä½£é‡‘æ€»é¢ Ã— 35%
```

### 2. åˆ†ä½£ç¤ºä¾‹
```
ç”¨æˆ·A (æ¨èäºº)
â”œâ”€â”€ ç”¨æˆ·B (è¢«æ¨èäºº) - è´­ä¹°100 USDC â†’ ç”¨æˆ·Aè·å¾—35 USDC
â”œâ”€â”€ ç”¨æˆ·C (è¢«æ¨èäºº) - è´­ä¹°200 USDC â†’ ç”¨æˆ·Aè·å¾—70 USDC
â””â”€â”€ ç”¨æˆ·D (è¢«æ¨èäºº)
    â””â”€â”€ ç”¨æˆ·E (äºŒçº§è¢«æ¨èäºº) - è´­ä¹°50 USDC 
        â†’ ç”¨æˆ·Dè·å¾—17.5 USDC (50Ã—35%)
        â†’ ç”¨æˆ·Aå†è·å¾—6.125 USDC (17.5Ã—35%)
```

### 3. ä½£é‡‘ç±»å‹
- **ç›´æ¥æ¨èä½£é‡‘**ï¼šå¥½å‹è´­ä¹°é‡‘é¢çš„35%
- **é—´æ¥æ¨èä½£é‡‘**ï¼šä¸‹çº§ä½£é‡‘æ”¶ç›Šçš„35%
- **å®æ—¶ç»“ç®—**ï¼šä½£é‡‘å®æ—¶åˆ°è´¦ï¼Œæ— å»¶è¿Ÿ

## ğŸ—ï¸ æ•°æ®åº“æ¶æ„

### 1. ç”¨æˆ·è¡¨ (users)
```sql
-- æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¯åˆ†é”€å•†
is_distributor BOOLEAN DEFAULT TRUE  -- æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¯åˆ†é”€å•†
referrer_address VARCHAR(64)         -- æ¨èäººåœ°å€
```

### 2. ä½£é‡‘é…ç½®è¡¨ (commission_config)
```sql
CREATE TABLE commission_config (
    id SERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,    -- é…ç½®é”®
    config_value TEXT NOT NULL,                 -- é…ç½®å€¼(JSONæ ¼å¼)
    description VARCHAR(255),                   -- é…ç½®æè¿°
    is_active BOOLEAN DEFAULT TRUE,             -- æ˜¯å¦å¯ç”¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. ç”¨æˆ·ä½£é‡‘ä½™é¢è¡¨ (user_commission_balance)
```sql
CREATE TABLE user_commission_balance (
    id SERIAL PRIMARY KEY,
    user_address VARCHAR(64) UNIQUE NOT NULL,   -- ç”¨æˆ·åœ°å€
    total_earned DECIMAL(20,8) DEFAULT 0,       -- æ€»æ”¶ç›Š
    available_balance DECIMAL(20,8) DEFAULT 0,  -- å¯ç”¨ä½™é¢
    withdrawn_amount DECIMAL(20,8) DEFAULT 0,   -- å·²æç°é‡‘é¢
    frozen_amount DECIMAL(20,8) DEFAULT 0,      -- å†»ç»“é‡‘é¢
    currency VARCHAR(10) DEFAULT 'USDC',        -- å¸ç§
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## ğŸ”§ APIæ¥å£æ–‡æ¡£

### 1. ç®¡ç†å‘˜é…ç½®API

#### è·å–ä½£é‡‘é…ç½®
```http
GET /api/admin/commission/config
Authorization: Bearer <admin_token>
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "commission_rate": 35.0,
    "commission_description": "æ¨èå¥½å‹äº«å—35%ä½£é‡‘å¥–åŠ±",
    "share_button_text": "åˆ†äº«èµšä½£é‡‘",
    "share_description": "åˆ†äº«æ­¤é¡¹ç›®ç»™å¥½å‹ï¼Œå¥½å‹è´­ä¹°åæ‚¨å°†è·å¾—35%ä½£é‡‘å¥–åŠ±",
    "share_success_message": "åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼Œå¿«å»é‚€è¯·å¥½å‹å§ï¼",
    "min_withdraw_amount": 10.0,
    "withdraw_fee_rate": 0.0,
    "withdraw_description": "æœ€ä½æç°é‡‘é¢10 USDCï¼Œæç°å°†è½¬å…¥æ‚¨çš„é’±åŒ…åœ°å€",
    "commission_rules": {
      "direct_commission": "ç›´æ¥æ¨èä½£é‡‘ï¼šå¥½å‹è´­ä¹°é‡‘é¢çš„35%",
      "indirect_commission": "é—´æ¥æ¨èä½£é‡‘ï¼šä¸‹çº§ä½£é‡‘æ”¶ç›Šçš„35%",
      "settlement_time": "ä½£é‡‘å®æ—¶åˆ°è´¦ï¼Œå¯éšæ—¶æç°",
      "currency": "USDC"
    }
  }
}
```

#### æ›´æ–°ä½£é‡‘é…ç½®
```http
POST /api/admin/commission/config
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "commission_rate": 35.0,
  "share_button_text": "åˆ†äº«èµšä½£é‡‘",
  "share_description": "åˆ†äº«æ­¤é¡¹ç›®ç»™å¥½å‹ï¼Œå¥½å‹è´­ä¹°åæ‚¨å°†è·å¾—35%ä½£é‡‘å¥–åŠ±",
  "min_withdraw_amount": 10.0
}
```

### 2. å‰ç«¯è°ƒç”¨API

#### è·å–åˆ†äº«é…ç½®
```http
GET /api/commission/share-config
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "share_button_text": "åˆ†äº«èµšä½£é‡‘",
    "share_description": "åˆ†äº«æ­¤é¡¹ç›®ç»™å¥½å‹ï¼Œå¥½å‹è´­ä¹°åæ‚¨å°†è·å¾—35%ä½£é‡‘å¥–åŠ±",
    "share_success_message": "åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼Œå¿«å»é‚€è¯·å¥½å‹å§ï¼",
    "commission_rate": 35.0,
    "commission_description": "æ¨èå¥½å‹äº«å—35%ä½£é‡‘å¥–åŠ±"
  }
}
```

#### è·å–ç”¨æˆ·ä½£é‡‘ä½™é¢
```http
GET /api/user/commission/balance/<user_address>
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "user_address": "EsfAFJFBa49RMc2UZNUjsWhGFZeA1uLgEkNPY5oYsDW4",
    "total_earned": 150.0,
    "available_balance": 120.0,
    "withdrawn_amount": 30.0,
    "frozen_amount": 0.0,
    "currency": "USDC",
    "last_updated": "2024-01-15T10:30:00Z"
  }
}
```

#### æç°ä½£é‡‘
```http
POST /api/user/commission/withdraw
Content-Type: application/json

{
  "user_address": "EsfAFJFBa49RMc2UZNUjsWhGFZeA1uLgEkNPY5oYsDW4",
  "amount": 50.0,
  "to_address": "0x1234567890123456789012345678901234567890"
}
```

## ğŸ¨ å‰ç«¯é›†æˆæŒ‡å—

### 1. åˆ†äº«æŒ‰é’®å®ç°

```javascript
// è·å–åˆ†äº«é…ç½®
async function getShareConfig() {
    const response = await fetch('/api/commission/share-config');
    const data = await response.json();
    return data.data;
}

// æ¸²æŸ“åˆ†äº«æŒ‰é’®
async function renderShareButton(assetId) {
    const config = await getShareConfig();
    
    const shareButton = document.createElement('button');
    shareButton.textContent = config.share_button_text;
    shareButton.title = config.share_description;
    
    shareButton.onclick = () => {
        const shareUrl = `${window.location.origin}/assets/${assetId}?ref=${userAddress}`;
        navigator.clipboard.writeText(shareUrl);
        alert(config.share_success_message);
    };
    
    return shareButton;
}
```

### 2. é’±åŒ…ä½£é‡‘ä½™é¢æ˜¾ç¤º

```javascript
// è·å–ç”¨æˆ·ä½£é‡‘ä½™é¢
async function getCommissionBalance(userAddress) {
    const response = await fetch(`/api/user/commission/balance/${userAddress}`);
    const data = await response.json();
    return data.data;
}

// æ¸²æŸ“é’±åŒ…ä¸‹æ‹‰èœå•
async function renderWalletDropdown(userAddress) {
    const balance = await getCommissionBalance(userAddress);
    
    const dropdown = document.createElement('div');
    dropdown.innerHTML = `
        <div class="wallet-dropdown">
            <div class="balance-item">
                <span>å¯ç”¨ä½™é¢</span>
                <span>${balance.available_balance} ${balance.currency}</span>
            </div>
            <div class="balance-item">
                <span>æ€»æ”¶ç›Š</span>
                <span>${balance.total_earned} ${balance.currency}</span>
            </div>
            <div class="balance-item">
                <span>å·²æç°</span>
                <span>${balance.withdrawn_amount} ${balance.currency}</span>
            </div>
            <button onclick="withdrawCommission()">æç°</button>
        </div>
    `;
    
    return dropdown;
}

// æç°åŠŸèƒ½
async function withdrawCommission() {
    const amount = prompt('è¯·è¾“å…¥æç°é‡‘é¢:');
    const toAddress = prompt('è¯·è¾“å…¥æç°åœ°å€:');
    
    if (!amount || !toAddress) return;
    
    const response = await fetch('/api/user/commission/withdraw', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_address: userAddress,
            amount: parseFloat(amount),
            to_address: toAddress
        })
    });
    
    const result = await response.json();
    if (result.success) {
        alert(result.message);
        // åˆ·æ–°ä½™é¢æ˜¾ç¤º
        location.reload();
    } else {
        alert('æç°å¤±è´¥: ' + result.error);
    }
}
```

### 3. æ¨èé“¾æ¥ç”Ÿæˆ

```javascript
// ç”Ÿæˆæ¨èé“¾æ¥
function generateReferralLink(assetId, userAddress) {
    return `${window.location.origin}/assets/${assetId}?ref=${userAddress}`;
}

// å¤„ç†æ¨èé“¾æ¥
function handleReferralLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const referrerAddress = urlParams.get('ref');
    
    if (referrerAddress) {
        // ä¿å­˜æ¨èäººä¿¡æ¯åˆ°localStorageæˆ–å‘é€åˆ°åç«¯
        localStorage.setItem('referrer_address', referrerAddress);
        console.log('æ¨èäººåœ°å€:', referrerAddress);
    }
}
```

## ğŸš€ éƒ¨ç½²å’Œåˆå§‹åŒ–

### 1. è¿è¡Œåˆå§‹åŒ–è„šæœ¬
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /root/RWA-HUB
PYTHONPATH=/root/RWA-HUB python3 scripts/init_commission_system.py
```

### 2. é‡å¯æœåŠ¡
```bash
pm2 restart rwa-hub
```

### 3. éªŒè¯åŠŸèƒ½
- âœ… è®¿é—®ç®¡ç†åå°ï¼Œæ£€æŸ¥ä½£é‡‘é…ç½®åŠŸèƒ½
- âœ… æµ‹è¯•åˆ†äº«æŒ‰é’®å’Œæ¨èé“¾æ¥
- âœ… éªŒè¯é’±åŒ…ä½£é‡‘ä½™é¢æ˜¾ç¤º
- âœ… æµ‹è¯•æç°åŠŸèƒ½

## ğŸ“‹ é…ç½®é¡¹è¯´æ˜

| é…ç½®é”® | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `commission_rate` | ä½£é‡‘æ¯”ä¾‹ | 35.0 |
| `commission_description` | ä½£é‡‘åŠŸèƒ½æè¿° | "æ¨èå¥½å‹äº«å—35%ä½£é‡‘å¥–åŠ±" |
| `share_button_text` | åˆ†äº«æŒ‰é’®æ–‡æ¡ˆ | "åˆ†äº«èµšä½£é‡‘" |
| `share_description` | åˆ†äº«è¯´æ˜æ–‡æ¡ˆ | "åˆ†äº«æ­¤é¡¹ç›®ç»™å¥½å‹ï¼Œå¥½å‹è´­ä¹°åæ‚¨å°†è·å¾—35%ä½£é‡‘å¥–åŠ±" |
| `share_success_message` | åˆ†äº«æˆåŠŸæç¤º | "åˆ†äº«é“¾æ¥å·²å¤åˆ¶ï¼Œå¿«å»é‚€è¯·å¥½å‹å§ï¼" |
| `min_withdraw_amount` | æœ€ä½æç°é‡‘é¢ | 10.0 |
| `withdraw_fee_rate` | æç°æ‰‹ç»­è´¹ç‡ | 0.0 |
| `withdraw_description` | æç°è¯´æ˜ | "æœ€ä½æç°é‡‘é¢10 USDCï¼Œæç°å°†è½¬å…¥æ‚¨çš„é’±åŒ…åœ°å€" |

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### 1. ç”¨æˆ·æ³¨å†Œ
- ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨è®¾ç½®ä¸ºåˆ†é”€å•† (`is_distributor = TRUE`)
- åˆ›å»ºä½£é‡‘ä½™é¢è®°å½•ï¼Œåˆå§‹ä½™é¢ä¸º0

### 2. æ¨èæµç¨‹
- ç”¨æˆ·Aåˆ†äº«æ¨èé“¾æ¥ç»™ç”¨æˆ·B
- ç”¨æˆ·Bé€šè¿‡æ¨èé“¾æ¥è®¿é—®å¹¶è´­ä¹°èµ„äº§
- ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—35%ä½£é‡‘å¹¶æ·»åŠ åˆ°ç”¨æˆ·Açš„ä½™é¢

### 3. ä½£é‡‘ç»“ç®—
- ä½£é‡‘å®æ—¶è®¡ç®—å¹¶åˆ°è´¦
- ç”¨æˆ·å¯åœ¨é’±åŒ…ä¸­æŸ¥çœ‹ä½£é‡‘ä½™é¢
- æ”¯æŒæç°åˆ°å¤–éƒ¨é’±åŒ…åœ°å€

### 4. å¤šçº§åˆ†ä½£
- ç”¨æˆ·Aæ¨èç”¨æˆ·Bï¼Œç”¨æˆ·Bæ¨èç”¨æˆ·C
- ç”¨æˆ·Cè´­ä¹°æ—¶ï¼šç”¨æˆ·Bè·å¾—35%ï¼Œç”¨æˆ·Aè·å¾—ç”¨æˆ·Bä½£é‡‘çš„35%
- æ— é™çº§åˆ†ä½£ï¼Œæ¯çº§éƒ½æ˜¯35%

## ğŸ¯ æ€»ç»“

è¿™å¥—ä½£é‡‘ç³»ç»Ÿå®ç°äº†ï¼š
- **ç®€å•æ˜“æ‡‚**ï¼š35%å›ºå®šæ¯”ä¾‹ï¼Œäººäººéƒ½æ˜¯åˆ†é”€å•†
- **å®æ—¶é€æ˜**ï¼šä½£é‡‘å®æ—¶åˆ°è´¦ï¼Œä½™é¢éšæ—¶å¯æŸ¥
- **é…ç½®çµæ´»**ï¼šæ‰€æœ‰æ–‡æ¡ˆå’Œè§„åˆ™å¯åå°é…ç½®
- **é›†æˆä¾¿æ·**ï¼šæä¾›å®Œæ•´çš„APIå’Œå‰ç«¯é›†æˆæ–¹æ¡ˆ
- **ç”¨æˆ·å‹å¥½**ï¼šé’±åŒ…é›†æˆï¼Œæ”¯æŒæç°åŠŸèƒ½ 