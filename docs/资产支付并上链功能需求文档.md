# 资产支付并上链功能需求文档

## 1. 项目概述

RWA-HUB平台需要实现资产支付并上链功能，使用户支付完成后能够自动将资产上链至Solana主网，实现资产通证化。系统应自动处理从支付确认到上链的全流程，无需人工审核干预。

## 2. 功能需求

### 2.1 支付流程

- 用户在创建资产时需支付至少100 USDC作为服务费
- 支付应通过USDC代币完成，不要求用户支付SOL
- 支付完成后立即触发上链流程，无需等待人工审核
- 支付过程中应显示清晰的进度和状态信息

### 2.2 上链流程

- 资产通过支付验证后自动上链至Solana主网
- 上链过程包括：创建SPL代币、设置元数据、发行代币
- 生成的代币符号应按现有规则处理（RH-XXYYYY格式）
- 代币总供应量应与提交的资产token_supply一致
- 上链后自动更新资产状态为APPROVED(2)
- 记录生成的Solana代币地址到资产token_address字段

### 2.3 用户反馈

- 上链成功后向用户展示成功信息及代币地址
- 提供代币浏览器链接便于用户查看代币信息
- 上链失败时提供明确的错误信息和处理建议

## 3. 技术要求

### 3.1 Solana集成

- 使用Solana Web3.js库与Solana主网进行交互
- 实现SPL代币程序的调用，创建代币和mint代币
- 支持Metaplex标准设置代币元数据
- 正确处理Solana交易确认和错误处理

### 3.2 安全要求

- 使用环境变量存储服务钱包私钥，**绝不硬编码私钥**
- 实现私钥的安全加载和使用
- 防止重复上链和交易
- 完整的错误处理和日志记录
- 交易确认机制确保上链操作完成

### 3.3 服务钱包管理

- 设计服务钱包余额监控机制
- 当服务钱包SOL余额低于阈值（如0.1 SOL）时发出预警
- 详细记录每次上链操作的费用消耗

## 4. 实现细节

### 4.1 技术架构

- 基于Python Flask后端实现
- 使用solana-py库与Solana链交互
- 使用spl-token库创建和管理代币
- 异步处理上链操作，避免阻塞用户界面

### 4.2 关键组件

1. **SolanaClient类**：负责与Solana链交互
2. **TokenManager类**：处理SPL代币的创建和管理
3. **AssetService类**：协调资产数据和上链操作
4. **环境配置模块**：安全管理私钥和网络配置

### 4.3 数据流程

1. 用户完成资产创建并支付100 USDC
2. 系统验证支付成功
3. 系统调用SolanaClient创建SPL代币
4. 系统设置代币元数据（名称、符号、描述等）
5. 系统mint代币总量到创建者钱包
6. 系统更新数据库中资产状态和代币地址
7. 系统向用户返回成功信息

## 5. 安全考虑

### 5.1 私钥管理

- 使用环境变量`SOLANA_SERVICE_WALLET_PRIVATE_KEY`存储服务钱包私钥
- 生产环境使用加密的环境变量管理方案
- 定期轮换服务钱包，减少风险

### 5.2 错误处理

- 所有上链操作必须包含在try-except块中
- 详细记录错误日志，包括交易ID和错误类型
- 实现上链失败后的恢复机制

### 5.3 防重复机制

- 使用数据库事务确保资产状态正确更新
- 检查资产token_address字段避免重复上链
- 使用锁机制防止并发上链操作

## 6. 部署指南

### 6.1 环境配置

必须在生产服务器上配置以下环境变量：

```
# Solana网络配置
SOLANA_NETWORK_URL=https://api.mainnet-beta.solana.com

# 服务钱包配置（注意保密）
SOLANA_SERVICE_WALLET_PRIVATE_KEY=你的服务钱包私钥

# 余额警告阈值
SOLANA_BALANCE_THRESHOLD=0.1
```

### 6.2 依赖安装

```bash
pip install solana
pip install spl-token
pip install base58
pip install pyserum
```

### 6.3 部署流程

1. 确保环境变量正确配置
2. 安装所有必要依赖
3. 部署应用代码
4. 验证服务钱包余额充足
5. 执行小额测试上链确认功能正常
6. 启用生产级监控

### 6.4 监控和维护

- 实现服务钱包余额监控
- 设置交易失败报警
- 定期备份链上资产数据
- 监控Solana网络状态

## 7. 测试计划

### 7.1 单元测试

- 测试SolanaClient各功能单元
- 测试TokenManager代币创建和管理
- 测试环境变量加载和安全处理

### 7.2 集成测试

- 模拟完整支付和上链流程
- 测试各类错误场景和恢复机制
- 测试高并发下的系统性能

### 7.3 上线前检查清单

- [ ] 验证服务钱包SOL余额充足
- [ ] 确认所有环境变量正确配置
- [ ] 验证网络连接到Solana主网
- [ ] 测试小额交易确认功能正常
- [ ] 确认日志和监控系统正常运行 