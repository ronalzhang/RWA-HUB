<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Wallet Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .wallet-option {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .wallet-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .wallet-option.phantom {
            border-color: #ab7dff;
            color: #ab7dff;
        }
        
        .wallet-option.metamask {
            border-color: #f6851b;
            color: #f6851b;
        }
        
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .device-info {
            margin: 20px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Mobile Wallet Test</h1>
        
        <div class="device-info">
            <strong>Device Info:</strong><br>
            <span id="deviceInfo">Loading...</span>
        </div>
        
        <div class="status info" id="status">
            Click a wallet option to test mobile connection
        </div>
        
        <button class="wallet-option phantom" onclick="testPhantomConnection()">
            ğŸ¦„ Test Phantom Wallet
        </button>
        
        <button class="wallet-option metamask" onclick="testMetaMaskConnection()">
            ğŸ¦Š Test MetaMask Wallet
        </button>
        
        <div style="margin-top: 20px;">
            <h3>Test Results:</h3>
            <div id="testResults" style="font-size: 14px; background: #f8f9fa; padding: 10px; border-radius: 5px; min-height: 100px;">
                No tests run yet...
            </div>
        </div>
    </div>

    <script>
        // ç®€åŒ–ç‰ˆçš„ç§»åŠ¨ç«¯æ£€æµ‹
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        function showDeviceInfo() {
            const info = {
                isMobile: isMobile(),
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                language: navigator.language
            };
            
            document.getElementById('deviceInfo').innerHTML = `
                Mobile: ${info.isMobile ? 'Yes' : 'No'}<br>
                Platform: ${info.platform}<br>
                Language: ${info.language}<br>
                UserAgent: ${info.userAgent.substring(0, 50)}...
            `;
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message) {
            const resultsEl = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const currentResults = resultsEl.innerHTML === 'No tests run yet...' ? '' : resultsEl.innerHTML;
            resultsEl.innerHTML = `${currentResults}<div><strong>[${timestamp}]</strong> ${message}</div>`;
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }
        
        // æµ‹è¯•æ·±åº¦é“¾æ¥è·³è½¬
        async function attemptDeepLink(deepLinkUrl, walletName) {
            return new Promise((resolve) => {
                addTestResult(`Attempting deep link for ${walletName}: ${deepLinkUrl}`);
                
                const timeout = setTimeout(() => {
                    addTestResult(`${walletName} deep link timeout`);
                    resolve(false);
                }, 2500);
                
                // åˆ›å»ºéšè—çš„iframeå°è¯•è·³è½¬
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = deepLinkUrl;
                
                document.body.appendChild(iframe);
                
                // æ£€æµ‹é¡µé¢æ˜¯å¦å¤±å»ç„¦ç‚¹ï¼ˆè¡¨ç¤ºè·³è½¬æˆåŠŸï¼‰
                const startTime = Date.now();
                const checkVisibility = () => {
                    if (document.hidden || Date.now() - startTime > 1000) {
                        clearTimeout(timeout);
                        document.body.removeChild(iframe);
                        addTestResult(`${walletName} deep link appeared to work (page lost focus)`);
                        resolve(true);
                    } else {
                        setTimeout(checkVisibility, 100);
                    }
                };
                
                setTimeout(() => {
                    checkVisibility();
                    // æ¸…ç†iframe
                    setTimeout(() => {
                        if (iframe && iframe.parentNode) {
                            document.body.removeChild(iframe);
                        }
                    }, 1000);
                }, 500);
            });
        }
        
        // æµ‹è¯•é€šç”¨é“¾æ¥è·³è½¬
        async function attemptUniversalLink(universalLinkUrl, walletName) {
            return new Promise((resolve) => {
                addTestResult(`Attempting universal link for ${walletName}: ${universalLinkUrl}`);
                
                const timeout = setTimeout(() => {
                    addTestResult(`${walletName} universal link timeout`);
                    resolve(false);
                }, 3000);
                
                // åˆ›å»ºéšè—çš„é“¾æ¥å¹¶ç‚¹å‡»
                const link = document.createElement('a');
                link.href = universalLinkUrl;
                link.target = '_blank';
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                // æ£€æµ‹é¡µé¢æ˜¯å¦å¤±å»ç„¦ç‚¹
                const startTime = Date.now();
                const checkVisibility = () => {
                    if (document.hidden || Date.now() - startTime > 1500) {
                        clearTimeout(timeout);
                        document.body.removeChild(link);
                        addTestResult(`${walletName} universal link appeared to work (page lost focus)`);
                        resolve(true);
                    } else if (Date.now() - startTime < 2500) {
                        setTimeout(checkVisibility, 100);
                    }
                };
                
                setTimeout(() => {
                    checkVisibility();
                    // æ¸…ç†é“¾æ¥
                    setTimeout(() => {
                        if (link && link.parentNode) {
                            document.body.removeChild(link);
                        }
                    }, 1000);
                }, 500);
            });
        }
        
        // æµ‹è¯•Phantomé’±åŒ…è¿æ¥
        async function testPhantomConnection() {
            updateStatus('Testing Phantom wallet connection...', 'info');
            addTestResult('=== Starting Phantom Wallet Test ===');
            
            if (!isMobile()) {
                updateStatus('This test is designed for mobile devices', 'error');
                addTestResult('ERROR: Not on mobile device, deep links may not work');
                return;
            }
            
            try {
                // ç”Ÿæˆè¿æ¥å‚æ•°
                const currentUrl = encodeURIComponent(window.location.href);
                const baseUrl = window.location.origin;
                const randomKey = Array.from(crypto.getRandomValues(new Uint8Array(32)), 
                    byte => byte.toString(16).padStart(2, '0')).join('');
                
                const connectParams = new URLSearchParams({
                    dapp_encryption_public_key: randomKey,
                    cluster: 'mainnet-beta',
                    app_url: baseUrl,
                    redirect_link: currentUrl
                }).toString();
                
                const deepLinkUrl = `phantom://v1/connect?${connectParams}`;
                const universalLinkUrl = `https://phantom.app/ul/v1/connect?${connectParams}`;
                
                // è®¾ç½®æ£€æµ‹æ ‡è®°
                sessionStorage.setItem('pendingWalletConnection', 'phantom');
                sessionStorage.setItem('walletConnectionStartTime', Date.now().toString());
                
                // å°è¯•æ·±åº¦é“¾æ¥
                const deepLinkSuccess = await attemptDeepLink(deepLinkUrl, 'Phantom');
                
                if (deepLinkSuccess) {
                    updateStatus('Phantom deep link successful!', 'success');
                    return;
                }
                
                // å°è¯•é€šç”¨é“¾æ¥
                const universalLinkSuccess = await attemptUniversalLink(universalLinkUrl, 'Phantom');
                
                if (universalLinkSuccess) {
                    updateStatus('Phantom universal link successful!', 'success');
                    return;
                }
                
                // æ‰€æœ‰å°è¯•éƒ½å¤±è´¥
                updateStatus('All Phantom connection attempts failed', 'error');
                addTestResult('All connection methods failed for Phantom');
                
                // æç¤ºä¸‹è½½
                if (confirm('Phantom wallet app not detected. Would you like to download it?')) {
                    const appStoreUrl = navigator.userAgent.toLowerCase().includes('iphone') || 
                                       navigator.userAgent.toLowerCase().includes('ipad') 
                        ? 'https://apps.apple.com/app/phantom-solana-wallet/id1598432977'
                        : 'https://play.google.com/store/apps/details?id=app.phantom';
                    
                    window.open(appStoreUrl, '_blank');
                    addTestResult(`Redirected to app store: ${appStoreUrl}`);
                }
                
            } catch (error) {
                updateStatus('Error testing Phantom connection', 'error');
                addTestResult(`ERROR: ${error.message}`);
            }
        }
        
        // æµ‹è¯•MetaMaské’±åŒ…è¿æ¥
        async function testMetaMaskConnection() {
            updateStatus('Testing MetaMask wallet connection...', 'info');
            addTestResult('=== Starting MetaMask Wallet Test ===');
            
            if (!isMobile()) {
                updateStatus('This test is designed for mobile devices', 'error');
                addTestResult('ERROR: Not on mobile device, deep links may not work');
                return;
            }
            
            try {
                const deepLinkUrl = `https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}`;
                
                // è®¾ç½®æ£€æµ‹æ ‡è®°
                sessionStorage.setItem('pendingWalletConnection', 'metamask');
                sessionStorage.setItem('walletConnectionStartTime', Date.now().toString());
                
                // MetaMaskä½¿ç”¨ç›¸åŒçš„URLä½œä¸ºæ·±åº¦é“¾æ¥å’Œé€šç”¨é“¾æ¥
                const success = await attemptUniversalLink(deepLinkUrl, 'MetaMask');
                
                if (success) {
                    updateStatus('MetaMask connection successful!', 'success');
                    return;
                }
                
                // è¿æ¥å¤±è´¥
                updateStatus('MetaMask connection failed', 'error');
                addTestResult('MetaMask connection attempt failed');
                
                // æç¤ºä¸‹è½½
                if (confirm('MetaMask wallet app not detected. Would you like to download it?')) {
                    const appStoreUrl = navigator.userAgent.toLowerCase().includes('iphone') || 
                                       navigator.userAgent.toLowerCase().includes('ipad') 
                        ? 'https://apps.apple.com/app/metamask/id1438144202'
                        : 'https://play.google.com/store/apps/details?id=io.metamask';
                    
                    window.open(appStoreUrl, '_blank');
                    addTestResult(`Redirected to app store: ${appStoreUrl}`);
                }
                
            } catch (error) {
                updateStatus('Error testing MetaMask connection', 'error');
                addTestResult(`ERROR: ${error.message}`);
            }
        }
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                const pendingConnection = sessionStorage.getItem('pendingWalletConnection');
                const startTime = sessionStorage.getItem('walletConnectionStartTime');
                
                if (pendingConnection && startTime) {
                    const timeDiff = Date.now() - parseInt(startTime);
                    addTestResult(`Returned from ${pendingConnection} wallet app after ${Math.round(timeDiff/1000)}s`);
                    
                    // æ¸…é™¤æ ‡è®°
                    sessionStorage.removeItem('pendingWalletConnection');
                    sessionStorage.removeItem('walletConnectionStartTime');
                    
                    updateStatus(`Returned from ${pendingConnection} wallet app`, 'success');
                }
            }
        });
        
        // åˆå§‹åŒ–
        showDeviceInfo();
    </script>
</body>
</html>